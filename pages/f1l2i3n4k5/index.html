<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>flink笔记 | 🦏</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,后端,大数据,技术文档,学习,js,vue,python,css3,java,javaEE,SpringBoot,Spring,Hadoop,html5,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.e7d9515b.js" as="script"><link rel="preload" href="/assets/js/2.125ae6e8.js" as="script"><link rel="preload" href="/assets/js/47.1722c1b9.js" as="script"><link rel="prefetch" href="/assets/js/10.95c2d7b0.js"><link rel="prefetch" href="/assets/js/100.b4e10546.js"><link rel="prefetch" href="/assets/js/101.d6d23fe2.js"><link rel="prefetch" href="/assets/js/102.b368fb26.js"><link rel="prefetch" href="/assets/js/103.b87bfabc.js"><link rel="prefetch" href="/assets/js/104.3d0ae07d.js"><link rel="prefetch" href="/assets/js/105.e9f9588c.js"><link rel="prefetch" href="/assets/js/106.76130cbc.js"><link rel="prefetch" href="/assets/js/107.11dd35ba.js"><link rel="prefetch" href="/assets/js/108.de8bb9b7.js"><link rel="prefetch" href="/assets/js/109.e26f138c.js"><link rel="prefetch" href="/assets/js/11.5682c637.js"><link rel="prefetch" href="/assets/js/110.2c9036b9.js"><link rel="prefetch" href="/assets/js/111.d91b7424.js"><link rel="prefetch" href="/assets/js/112.0edf9093.js"><link rel="prefetch" href="/assets/js/113.dbc0bf4d.js"><link rel="prefetch" href="/assets/js/114.439ad4ee.js"><link rel="prefetch" href="/assets/js/115.0cff9cd8.js"><link rel="prefetch" href="/assets/js/116.fd44dc61.js"><link rel="prefetch" href="/assets/js/117.e893d264.js"><link rel="prefetch" href="/assets/js/118.ec4b3d32.js"><link rel="prefetch" href="/assets/js/119.ea5c3eba.js"><link rel="prefetch" href="/assets/js/12.5a51d307.js"><link rel="prefetch" href="/assets/js/120.9aaee23f.js"><link rel="prefetch" href="/assets/js/121.4fc7842c.js"><link rel="prefetch" href="/assets/js/122.2b8f75d1.js"><link rel="prefetch" href="/assets/js/123.78dbfead.js"><link rel="prefetch" href="/assets/js/124.84b6382a.js"><link rel="prefetch" href="/assets/js/125.c2a2a818.js"><link rel="prefetch" href="/assets/js/126.83ea2963.js"><link rel="prefetch" href="/assets/js/127.dffd5eae.js"><link rel="prefetch" href="/assets/js/128.bb0a0738.js"><link rel="prefetch" href="/assets/js/129.45a56702.js"><link rel="prefetch" href="/assets/js/13.d1b5b29f.js"><link rel="prefetch" href="/assets/js/130.7fee331a.js"><link rel="prefetch" href="/assets/js/131.6aaa557b.js"><link rel="prefetch" href="/assets/js/132.9526e280.js"><link rel="prefetch" href="/assets/js/133.610c1c84.js"><link rel="prefetch" href="/assets/js/134.1dcf27f7.js"><link rel="prefetch" href="/assets/js/14.83de980a.js"><link rel="prefetch" href="/assets/js/15.0fa06ae1.js"><link rel="prefetch" href="/assets/js/16.d1d3c9c1.js"><link rel="prefetch" href="/assets/js/17.c9772d78.js"><link rel="prefetch" href="/assets/js/18.7cbf0ef4.js"><link rel="prefetch" href="/assets/js/19.66ee7cfc.js"><link rel="prefetch" href="/assets/js/20.8fbb5432.js"><link rel="prefetch" href="/assets/js/21.74a586bf.js"><link rel="prefetch" href="/assets/js/22.f85a2ced.js"><link rel="prefetch" href="/assets/js/23.a65163b5.js"><link rel="prefetch" href="/assets/js/24.5c2898c6.js"><link rel="prefetch" href="/assets/js/25.929f22ff.js"><link rel="prefetch" href="/assets/js/26.20d74c65.js"><link rel="prefetch" href="/assets/js/27.e790af79.js"><link rel="prefetch" href="/assets/js/28.6b84abe6.js"><link rel="prefetch" href="/assets/js/29.acc0fc34.js"><link rel="prefetch" href="/assets/js/3.dd3750e6.js"><link rel="prefetch" href="/assets/js/30.fadb6cbd.js"><link rel="prefetch" href="/assets/js/31.386f82c2.js"><link rel="prefetch" href="/assets/js/32.e934f71c.js"><link rel="prefetch" href="/assets/js/33.684ac64c.js"><link rel="prefetch" href="/assets/js/34.38f8fd76.js"><link rel="prefetch" href="/assets/js/35.3fe27233.js"><link rel="prefetch" href="/assets/js/36.993695b7.js"><link rel="prefetch" href="/assets/js/37.d735018c.js"><link rel="prefetch" href="/assets/js/38.0d23a384.js"><link rel="prefetch" href="/assets/js/39.808de65c.js"><link rel="prefetch" href="/assets/js/4.4a137b18.js"><link rel="prefetch" href="/assets/js/40.2fc7d5f7.js"><link rel="prefetch" href="/assets/js/41.6647cff7.js"><link rel="prefetch" href="/assets/js/42.f4d93aa6.js"><link rel="prefetch" href="/assets/js/43.a5d40107.js"><link rel="prefetch" href="/assets/js/44.3ae864d3.js"><link rel="prefetch" href="/assets/js/45.c66f1afe.js"><link rel="prefetch" href="/assets/js/46.750f2be2.js"><link rel="prefetch" href="/assets/js/48.7c8df7cc.js"><link rel="prefetch" href="/assets/js/49.f9b58d70.js"><link rel="prefetch" href="/assets/js/5.51ca929a.js"><link rel="prefetch" href="/assets/js/50.fad73ad9.js"><link rel="prefetch" href="/assets/js/51.b88c6213.js"><link rel="prefetch" href="/assets/js/52.21244293.js"><link rel="prefetch" href="/assets/js/53.1c2189f3.js"><link rel="prefetch" href="/assets/js/54.95ba12bc.js"><link rel="prefetch" href="/assets/js/55.d8f79989.js"><link rel="prefetch" href="/assets/js/56.63c36b2d.js"><link rel="prefetch" href="/assets/js/57.270857ec.js"><link rel="prefetch" href="/assets/js/58.156073cc.js"><link rel="prefetch" href="/assets/js/59.5a300643.js"><link rel="prefetch" href="/assets/js/6.2dccf462.js"><link rel="prefetch" href="/assets/js/60.92f4ce87.js"><link rel="prefetch" href="/assets/js/61.0f312cea.js"><link rel="prefetch" href="/assets/js/62.0c55901b.js"><link rel="prefetch" href="/assets/js/63.613b1add.js"><link rel="prefetch" href="/assets/js/64.1e5070b6.js"><link rel="prefetch" href="/assets/js/65.dc215238.js"><link rel="prefetch" href="/assets/js/66.4a1319e4.js"><link rel="prefetch" href="/assets/js/67.841428fe.js"><link rel="prefetch" href="/assets/js/68.7380e054.js"><link rel="prefetch" href="/assets/js/69.0a503182.js"><link rel="prefetch" href="/assets/js/7.1096b6fa.js"><link rel="prefetch" href="/assets/js/70.09f4c416.js"><link rel="prefetch" href="/assets/js/71.a279d635.js"><link rel="prefetch" href="/assets/js/72.057aa49f.js"><link rel="prefetch" href="/assets/js/73.767f542c.js"><link rel="prefetch" href="/assets/js/74.3eb6f7e5.js"><link rel="prefetch" href="/assets/js/75.50ecd31e.js"><link rel="prefetch" href="/assets/js/76.602f67fb.js"><link rel="prefetch" href="/assets/js/77.3b5a8e7d.js"><link rel="prefetch" href="/assets/js/78.40c6990e.js"><link rel="prefetch" href="/assets/js/79.ecb155e0.js"><link rel="prefetch" href="/assets/js/8.4b82b135.js"><link rel="prefetch" href="/assets/js/80.d7279b34.js"><link rel="prefetch" href="/assets/js/81.f58f78af.js"><link rel="prefetch" href="/assets/js/82.8399bcab.js"><link rel="prefetch" href="/assets/js/83.67c3c861.js"><link rel="prefetch" href="/assets/js/84.5a8f7c4b.js"><link rel="prefetch" href="/assets/js/85.c6f0af81.js"><link rel="prefetch" href="/assets/js/86.f9f3d0b8.js"><link rel="prefetch" href="/assets/js/87.fec83ae4.js"><link rel="prefetch" href="/assets/js/88.ca11e236.js"><link rel="prefetch" href="/assets/js/89.ae243724.js"><link rel="prefetch" href="/assets/js/9.b8d3ed93.js"><link rel="prefetch" href="/assets/js/90.c242e238.js"><link rel="prefetch" href="/assets/js/91.ad0080a6.js"><link rel="prefetch" href="/assets/js/92.a435d70c.js"><link rel="prefetch" href="/assets/js/93.3232bfbf.js"><link rel="prefetch" href="/assets/js/94.6101d03c.js"><link rel="prefetch" href="/assets/js/95.8c95af7a.js"><link rel="prefetch" href="/assets/js/96.a582908e.js"><link rel="prefetch" href="/assets/js/97.1b560b4f.js"><link rel="prefetch" href="/assets/js/98.a686266f.js"><link rel="prefetch" href="/assets/js/99.e03a81a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="🦏" class="logo"> <span class="site-name can-hide">🦏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" aria-current="page" class="nav-link router-link-exact-active router-link-active">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/zzx.jpg"> <div class="blogger-info"><h3>Axcmsm🐼</h3> <span>纵有疾风起，人生不言弃🐅</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" aria-current="page" class="nav-link router-link-exact-active router-link-active">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路线or导图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学习笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《linux》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《Hadoop》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《zookeeper》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《hive》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《生态圈组件》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《消息队列》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《spark》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>《flink》</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/f1l2i3n4k5/" aria-current="page" class="active sidebar-link">flink笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#快速入门" class="sidebar-link">快速入门</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#运行架构" class="sidebar-link">运行架构</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#流程处理api" class="sidebar-link">流程处理API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#source-读取数据源" class="sidebar-link">source：读取数据源</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#transform-转换算子" class="sidebar-link">Transform  :转换算子</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#sink-输出" class="sidebar-link">Sink：输出</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#window-窗口" class="sidebar-link">Window 窗口</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#时间语义🎇wartermark" class="sidebar-link">时间语义🎇Wartermark</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#processfunction-api" class="sidebar-link">ProcessFunction API</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#状态编程" class="sidebar-link">状态编程</a></li><li class="sidebar-sub-header"><a href="/pages/f1l2i3n4k5/#容错机制" class="sidebar-link">容错机制</a></li></ul></li><li><a href="/pages/f1table3n4k5/" class="sidebar-link">flink-table-sql</a></li><li><a href="/pages/f1table3n426/" class="sidebar-link">Flink15</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《数据可视化》</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安装</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/BigData" title="大数据-目录页" data-v-1cd794fe>大数据</a></li> <li data-v-1cd794fe><a href="/BigData/#学习笔记" title="大数据#学习笔记" data-v-1cd794fe>学习笔记</a></li> <li data-v-1cd794fe><a href="/BigData/#《flink》" title="大数据#《flink》" data-v-1cd794fe>《flink》</a></li></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/axcmsm" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Wei Ye</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-10-6</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="/img/bj3.jpg">
          flink笔记
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>官网:<a href="https://flink.apache.org/" target="_blank" rel="noopener noreferrer">https://flink.apache.org/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>他是一个<strong>分布式</strong>处理引擎，用于对<strong>无界和有界数据流</strong>进行<strong>状态</strong>计算的框架。</p> <p>囊括了：storm低延迟，spark高吞吐，以及lambda架构的俩套系统的优化(准确、实时)等特点。</p> <p><strong>特点</strong>：</p> <ul><li><p>事件驱动</p></li> <li><p>基于流的世界观：有界or无界</p> <blockquote><p>以流为世界观的架构，获得的最大好处就是具有极低的延迟</p></blockquote></li> <li><p>分层API:</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>Table<span class="token operator">/</span>SQL<span class="token punctuation">(</span>dynamic<span class="token punctuation">,</span>tables<span class="token punctuation">)</span> 
<span class="token operator">-&gt;</span> DataStream API<span class="token punctuation">(</span>stream<span class="token punctuation">,</span>windows<span class="token punctuation">)</span>
	<span class="token operator">-&gt;</span>ProcessFunction<span class="token punctuation">(</span>events<span class="token punctuation">,</span>state<span class="token punctuation">,</span>time<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>其他特点：</p> <blockquote><p>事件时间、处理时间</p> <p>精确一次的状态一致性</p> <p>低延迟，高处理</p> <p>可扩展、高可用</p></blockquote></li></ul> <p><strong>模块</strong>：2021/10/6</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>Flink Table <span class="token operator">&amp;</span> SQL<span class="token punctuation">(</span>还没开发完<span class="token punctuation">)</span>
Flink Gelly<span class="token punctuation">(</span>图计算<span class="token punctuation">)</span>
Flink CEP<span class="token punctuation">(</span>复杂事件处理<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>Flink /sparkStream</strong>:</p> <ul><li><p>数据模型：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>– spark 采用 RDD 模型，spark streaming 的 DStream 实际上也就是一组 组小批数 据 RDD 的集合 
– flink 基本数据模型是数据流，以及事件（Event）序列
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>运行架构：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>– spark 是批计算，将 DAG 划分为不同的 stage，一个完成后才可以计算下一个 
– flink 是标准的流执行模式，一个事件在一个节点处理完后可以直接发往下一个节 点进行处理
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ul> <h2 id="快速入门"><a href="#快速入门" class="header-anchor">#</a> 快速入门</h2> <ul><li><p>导入pox文件</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-scala_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 
    <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-streaming-scala --&gt;</span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-scala_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p>编写代码 <code>wordcount</code></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> 批处理  #注意导包和 导入隐式转换
	<span class="token comment">//创建批处理环境执行环境</span>
    <span class="token keyword">val</span> env<span class="token operator">=</span>ExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> inpath<span class="token operator">=</span><span class="token string">&quot;D:\\IDea20.1\\flink\\dome1\\src\\main\\resources\\hello.txt&quot;</span>
    <span class="token keyword">val</span> Dataset <span class="token operator">=</span> env<span class="token punctuation">.</span>readTextFile<span class="token punctuation">(</span>inpath<span class="token punctuation">)</span>
    <span class="token comment">//对数据进行操作</span>
    <span class="token keyword">val</span> wc <span class="token operator">=</span> Dataset<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//以第一个元素做为key进行分钟</span>
    <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//求和统计 可以串字段每次和下标位置</span>
    wc<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//打印</span>
<span class="token number">2.</span> 流处理
	#设置 开启端口 nc <span class="token operator">-</span>lp <span class="token number">7777</span> 输入数据
	<span class="token comment">//创建流处理环境执行环境</span>
    <span class="token keyword">val</span> env<span class="token operator">=</span>StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    env<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">//设置cup核数 并行度 不设置默认是机器的CPU核数</span>
    <span class="token comment">//外部传入参数</span>
    <span class="token keyword">val</span> tool <span class="token operator">=</span> ParameterTool<span class="token punctuation">.</span>fromArgs<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
    <span class="token keyword">val</span> host <span class="token operator">=</span> tool<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;host&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> port <span class="token operator">=</span> tool<span class="token punctuation">.</span>getInt<span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">//读取数据</span>
    <span class="token keyword">val</span> DS <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token comment">//进行处理操作</span>
    <span class="token keyword">val</span> result <span class="token operator">=</span> DS<span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>nonEmpty<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//对key进行分组   //基于哈希值进行取模分配机器</span>
      <span class="token punctuation">.</span>sum<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//求和 也可以指定算子的并行度</span>
    result<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//也可以设置并行度 一个一个输出到控制台</span>
    <span class="token comment">//启动任务</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;wc&quot;</span><span class="token punctuation">)</span>
	#<span class="token operator">-</span>host <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>port <span class="token number">7777</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div></li></ul> <h2 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h2> <ul><li><p>Standalone 模式 独立</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> 上传解压到指定目录，进入 conf
<span class="token number">2.</span> 修改配置文件 flink<span class="token operator">/</span>conf<span class="token operator">/</span>flink<span class="token operator">-</span>conf<span class="token punctuation">.</span>yaml  #z
	jobmanager<span class="token punctuation">.</span>rpc<span class="token punctuation">.</span>address hadoop111  #老大
<span class="token number">3.</span> 修改配置文件 <span class="token operator">/</span>conf<span class="token operator">/</span>slaves  配置小弟
	hadoop112
	hadoop113 
<span class="token number">4.</span> 分发给另外两台机子
<span class="token number">5</span>、 启动
	bin<span class="token operator">/</span>start<span class="token operator">-</span>cluster<span class="token punctuation">.</span>sh
#http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>hadoop111<span class="token operator">:</span><span class="token number">8081</span>  #进行监控
<span class="token number">5.</span> 执行任务
	<span class="token punctuation">.</span>/flink run <span class="token operator">-</span>c 类名路径 –p <span class="token number">2</span> jar包 –port <span class="token number">7777</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li> <li><p><strong>Yarn 模式</strong>：两种运行的模式</p> <blockquote><p>Session-cluster 模式：共享资源；适合规模小执行时间短的作业</p> <p><strong>Per-Job-Cluster</strong> <strong>模式</strong>：一个作业读写一份资源，适合规模大 长时间运行的作业，任务之间互相独立，互不影响，方便管理</p> <p>配置在<code>flink/conf/flink-conf.yaml</code> 中查看or修改</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. Session Cluster
	启动 hadoop 集群（略）
	启动 yarn-session
	./yarn-session.sh -n 2 -s 2 -jm 1024 -tm 1024 -nm test -d
	&gt;&gt; -n TaskManager 的数量     -s 每个TaskManager的slot 数量  默认为1
	&gt;&gt; jm：JobManager 的内存  	 -tm：每个 taskmanager 的内存
	&gt;&gt; -nm：yarn 的 appName(现在 yarn 的 ui 上的名字)。   -d：后台执行。
	执行任务：
	./flink run -c 类名路径 –p 2 jar包 –port 7777
	取消 yarn-session 
	yarn application --kill application_1577588252906_0001
	
2. Per Job Cluster
	1) 启动 hadoop 集群
	2) 不启动 yarn-session，直接执行 job
	./flink run –m yarn-cluster -c 类名路径 jar包 --host lcoalhost –port 7777
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li> <li><p>Kubernetes 部署 略</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1） 搭建 Kubernetes 集群（略） 
2） 配置各组件的 yaml 文件
3）启动 Flink Session Cluster
	// 启动 jobmanager-service 服务 
	kubectl create -f jobmanager-service.yaml 
	// 启动 jobmanager-deployment 服务
    kubectl create -f jobmanager-deployment.yaml 
    // 启动 taskmanager-deployment 服务 
    kubectl create -f taskmanager-deployment.yaml
#访问http://{JobManagerHost:Port}/api/v1/namespaces/default/services/flink-jobmanage r:ui/proxy
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul> <h2 id="运行架构"><a href="#运行架构" class="header-anchor">#</a> 运行架构</h2> <p><strong>运行时的组件</strong>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>作业管理器（JobManager）:解析、申请、协调
	先接收执行程序,包括作业图、逻辑数据流图和打包了所有的类、库和其它 资源的 JAR 包。
	然后把作业图转换成物理层面的流程图(执行图),然后向ResourceManager，请求执行任务的资源(TaskManager上的插槽slot)。
	请求成功,执行图发往,TaskManager节点,过程由JobManager进行协调，可设置检查点等操作。
	
资源管理器（ResourceManager）:分配、被申请or申请、释放资源
	责管理TaskManager的插槽slot(处理资源单元),不同的环境有不同的管理器，例:YARN、Mesos、K8s...
	当被申请插槽时，会将空闲的slot的TaskManager,分配给作业管理器。
	如果没有空闲,就对向资源平台发起会话,例：向yarn申请容器资源。
	也可终止空闲的任务管理器，释放计算性能
	
任务管理器（TaskManager）: 执行任务。
	通常会有多个任务管理器同时运行，每个到包含了一定插槽solot，
	slot是真正用来执行任务的，当TaskManager被启动后，会像资源管理器，注册slot。
	然后将slot提供给job调用。job可向slot分配执行任务.
	任务管理器之间可交换数据。
	
以及分发器（Dispatcher）: web UI 监控 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>任务提交流程</strong>：</p> <ul><li><p><strong>flink内部</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006125238.png" alt=""></p></li> <li><p><strong>yarn</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006125328.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. 上传flink的jar包和配置到hdfs
2. 提交job到RM中 RM发送给NM 
3. 在NM中启动 ApplicationMaster 开辟空间
4. ApplicationMaster 里面计算先向Flink申请没有，再向RM申请job的运行资源
5. 启动TaskManager 执行任务
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul> <p><strong>任务调度原理</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006125452.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. Flink集群启动后,启动一个 JobManger 和多个TasKManager
2. 客户端提交任务给JobManager，JobManger再分给各个的和多个TasKManager执行
3. TaskManager 将心跳和统计信息汇报给 JobManager。
4. TaskManager 之间以流的形式进行数据的传输
#都是独立的 JVM 进程
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p><strong>TaskManger&amp;Slots</strong></p> <blockquote><p>TaskManger(worker)是一个进程，可启多个子任务，可通过<strong>task slot</strong>控制接收的task</p> <p>默认允许子任务共享 slot，不同任务的子任务也可以，一个slot可保存作业的整个管道</p> <p>Task Slot 是<strong>静态的概念</strong>，是指 TaskManager 具有的并发执行能力</p> <p><img src="D:%5Chuanjin%5Cgit_book%5Cbook%5Cvuepress_vdoing%5Cvidoing%5Cbook%5Cdocs%5C01.%E5%A4%A7%E6%95%B0%E6%8D%AE%5C40.%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%5C45.%E3%80%8Aflink%E3%80%8B%5Cimg%5Cimage-20211006130740098.png" alt="image-20211006130740098"></p></blockquote></li> <li><p><strong>并行度</strong>：<strong>parallelism</strong> 动态概念</p> <blockquote><p>一个 stream 的并行度，可以认为就是其所有算子中最大的并行度</p> <p>一个特定算子的 子任务的个数：parallelism</p></blockquote></li></ul> <p><strong>程序&amp;数据流:DataFlow</strong>:<code>Source(读取) 、Transformation(转换) 和 Sink(输出)。</code></p> <p><strong>执行图</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>StreamGraph :程序的拓扑结构
	-&gt; 
		JobGraph :优化JobManager的数据结构
			-&gt; 
				ExecutionGraph : JobGraph的并行化版本，是调度层最核心的数据结构
					-&gt;
                    	物理执行图 :部署Task后形成的“图”
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006131718.png" alt=""></p></blockquote> <p><strong>数据传输形式</strong>:<code>一对一、窄依赖、宽依赖</code></p> <p><strong>任务链</strong>:<code>原来的算子成为里面的一步分，减少程序之间的切换和基于缓存的数据交换</code></p> <h2 id="流程处理api"><a href="#流程处理api" class="header-anchor">#</a> 流程处理API</h2> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006195905.png" alt=""></p> <ul><li><p><strong>Environmen</strong>：构建程序上下文。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//批处理
val env= ExecutionEnvironment.getExecutionEnvironment
//流处理
val env = StreamExecutionEnvironment.getExecutionEnvironment
//设置并行度
val env = StreamExecutionEnvironment.createLocalEnvironment(1)
//提交jar给集群执行环境 可设置动态传参进来
val env = ExecutionEnvironment.createRemoteEnvironment(&quot;jobmanage-hostname&quot;, 6123,&quot;YOURPATH//wordcount.jar&quot;)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>没有配置斌消毒，默认读取<code>flink-conf.yaml</code> 默认为1</p></blockquote></li></ul> <h3 id="source-读取数据源"><a href="#source-读取数据源" class="header-anchor">#</a> <strong>source</strong>：读取数据源</h3> <ol><li><p>从集合中读取</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// 定义样例类，传感器 id，时间戳，温度</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> SensorReading<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> timestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> temperature<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span> 
<span class="token keyword">object</span> Sensor <span class="token punctuation">{</span>
	<span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
		<span class="token keyword">val</span> env <span class="token operator">=</span>StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 		<span class="token keyword">val</span> stream1 <span class="token operator">=</span> env <span class="token punctuation">.</span>fromCollection<span class="token punctuation">(</span>List<span class="token punctuation">(</span> SensorReading<span class="token punctuation">(</span><span class="token string">&quot;sensor_1&quot;</span><span class="token punctuation">,</span> <span class="token number">1547718199</span><span class="token punctuation">,</span> <span class="token number">35.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">(</span><span class="token string">&quot;sensor_6&quot;</span><span class="token punctuation">,</span> <span class="token number">1547718201</span><span class="token punctuation">,</span> <span class="token number">15.4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">(</span><span class="token string">&quot;sensor_7&quot;</span><span class="token punctuation">,</span> <span class="token number">1547718202</span><span class="token punctuation">,</span> <span class="token number">6.7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">(</span><span class="token string">&quot;sensor_10&quot;</span><span class="token punctuation">,</span> <span class="token number">1547718205</span><span class="token punctuation">,</span> <span class="token number">38.1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> 
		stream1<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;stream1:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
		env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>从文件中读取</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> stream2 <span class="token operator">=</span> env<span class="token punctuation">.</span>readTextFile<span class="token punctuation">(</span><span class="token string">&quot;YOUR_FILE_PATH&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>从kafka中读取</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//导入依赖</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span> 
<span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>flink<span class="token operator">-</span>connector<span class="token operator">-</span>kafka<span class="token operator">-</span><span class="token number">0.11</span>_2<span class="token punctuation">.</span><span class="token number">12</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span> <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">1.10</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//封装map参数</span>
<span class="token keyword">val</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;group.id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;consumer-group&quot;</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;key.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;value.deserializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation">)</span> properties<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">&quot;auto.offset.reset&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;latest&quot;</span><span class="token punctuation">)</span> 
<span class="token comment">//addsource创建</span>
<span class="token keyword">val</span> stream3 <span class="token operator">=</span> env<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span><span class="token keyword">new</span> FlinkKafkaConsumer011<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;sensor&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> SimpleStringSchema<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>自定义source ：有时可方便测试</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> 传入自定义数据源
<span class="token keyword">val</span> stream4 <span class="token operator">=</span> env<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span> <span class="token keyword">new</span> MySensorSource<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token number">2.</span> 编写自定义数据源  继承SourceFunction
例：
<span class="token keyword">class</span> MySensorSource <span class="token keyword">extends</span> SourceFunction<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">{</span>
<span class="token comment">// flag: 表示数据源是否还在正常运行 </span>
<span class="token keyword">var</span> running<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token keyword">override</span> <span class="token keyword">def</span> cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> running <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> run<span class="token punctuation">(</span>ctx<span class="token operator">:</span> SourceFunction<span class="token punctuation">.</span>SourceContext<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">// 初始化一个随机数发生器 </span>
<span class="token keyword">val</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> Random<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">var</span> curTemp <span class="token operator">=</span> <span class="token number">1.</span>to<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span> i <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span> <span class="token string">&quot;sensor_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">65</span> <span class="token operator">+</span> rand<span class="token punctuation">.</span>nextGaussian<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>running<span class="token punctuation">)</span><span class="token punctuation">{</span> 
<span class="token comment">// 更新温度值 </span>
curTemp <span class="token operator">=</span> curTemp<span class="token punctuation">.</span>map<span class="token punctuation">(</span> t <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> t<span class="token punctuation">.</span>_2 <span class="token operator">+</span> rand<span class="token punctuation">.</span>nextGaussian<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token comment">// 获取当前时间戳 </span>
<span class="token keyword">val</span> curTime <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>
curTemp<span class="token punctuation">.</span>foreach<span class="token punctuation">(</span> t <span class="token keyword">=&gt;</span> ctx<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>SensorReading<span class="token punctuation">(</span>t<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> curTime<span class="token punctuation">,</span> t<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
Thread<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></li></ol> <h3 id="transform-转换算子"><a href="#transform-转换算子" class="header-anchor">#</a> <strong>Transform</strong>  :转换算子</h3> <ul><li><p>map、flatmap、filter、</p></li> <li><p><strong>KeyBy分组</strong>:(dataStream=&gt;KeyedStream)</p> <blockquote><p>内部分区底层hashcode</p> <p>分组后支持：sum、min、max、minBy、maxBy</p></blockquote></li> <li><p><strong>Reduce聚合</strong>:(keyedStream=&gt;DataStream)</p> <blockquote><p>(前/新一个值，后一个值) 俩俩聚合</p></blockquote></li> <li><p><strong>split和select拆分</strong>：(dataStream=&gt;SplitStream)</p> <blockquote><p>split 拆分 后还在一个SplitStream中</p> <p>select 在SplitStream中选择性输出对应的流 DataStream</p> <p>例：按照某个温度，拆分为高温or低温 选择性输出</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token punctuation">.</span>split<span class="token punctuation">(</span> sensorData <span class="token keyword">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sensorData<span class="token punctuation">.</span>temperature <span class="token operator">&gt;</span> <span class="token number">30</span><span class="token punctuation">)</span> Seq<span class="token punctuation">(</span><span class="token string">&quot;high&quot;</span><span class="token punctuation">)</span> <span class="token keyword">else</span> Seq<span class="token punctuation">(</span><span class="token string">&quot;low&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> 
<span class="token keyword">val</span> high <span class="token operator">=</span> splitStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;high&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> low <span class="token operator">=</span> splitStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;low&quot;</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> all <span class="token operator">=</span> splitStream<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">&quot;high&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;low&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></blockquote></li> <li><p><strong>Connect</strong> <strong>和</strong> <strong>CoMap合并</strong> ：类型需要可不一样，合并俩个</p> <blockquote><p>Connect :俩个datastream=&gt;放入一个connectedStreams中，状态不变</p> <p><strong>CoMap,CoFlatMap</strong>：转换输出datastream</p></blockquote></li> <li><p><strong>union</strong>:合并：类型需要一样，合并多个</p></li></ul> <blockquote><p><strong>支持的数据类型</strong>：</p> <p>基础数据类型：java、scala</p> <p>元组、样例类、简单对象./</p> <p>其他集合等等</p></blockquote> <ul><li><p><strong>UDF函数</strong>：自定义函数</p> <blockquote><div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//函数类Function Classes</span>
<span class="token comment">//例：MapFunction, FilterFunction, ProcessFunction 等等。</span>
实现函数类接口可重写内部方法
例<span class="token operator">:</span> 过滤包含有flink的字段  也可直接用匿名对接口实现方法
<span class="token keyword">class</span> FilterFilter <span class="token keyword">extends</span> FilterFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> filter<span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">&quot;flink&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">val</span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span>filter<span class="token punctuation">(</span><span class="token keyword">new</span> FlinkFilter<span class="token punctuation">)</span>
<span class="token comment">//匿名</span>
<span class="token keyword">val</span> flinkTweets <span class="token operator">=</span> tweets<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">&quot;flink&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></blockquote></li> <li><p><strong>富函数</strong>：可获取上下文生命周期等 实现复杂功能</p> <blockquote><div class="language-scala line-numbers-mode"><pre class="language-scala"><code>Rich Function ：生命周期
<span class="token comment">//例：RichMapFunction、RichFlatMapFunction、RichFilterFunction</span>
可重写的方法
open：在调用之前关于表调用
close：最后关闭
getRuntimeContext：运行时上下文
<span class="token comment">//例：</span>
<span class="token keyword">class</span> MyFlatMap <span class="token keyword">extends</span> RichFlatMapFunction<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> 	<span class="token keyword">var</span> subTaskIndex <span class="token operator">=</span> <span class="token number">0</span> 
	<span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>configuration<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> subTaskIndex <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getIndexOfThisSubtask 
 <span class="token comment">// 以下可以做一些初始化工作，例如建立一个和 HDFS 的连接 </span>
<span class="token punctuation">}</span>
 <span class="token keyword">override</span> <span class="token keyword">def</span> flatMap<span class="token punctuation">(</span>in<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
     <span class="token keyword">if</span> <span class="token punctuation">(</span>in <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> subTaskIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>subTaskIndex<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">)</span> 
     <span class="token punctuation">}</span> <span class="token punctuation">}</span>
                                                              <span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token comment">// 以下做一些清理工作，例如断开和 HDFS 的连接。 </span>
                                                              <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></blockquote></li></ul> <h3 id="sink-输出"><a href="#sink-输出" class="header-anchor">#</a> <strong>Sink</strong>：输出</h3> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1</span>、 自定义输出方式
stream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> MySink<span class="token punctuation">(</span>xxxx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>输出到kafka</strong></p> <ol><li><p>导入依赖</p> <div class="language-XML line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-kafka-0.11_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>添加入sink</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> union <span class="token operator">=</span> high<span class="token punctuation">.</span>union<span class="token punctuation">(</span>low<span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toString<span class="token punctuation">)</span> union<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> FlinkKafkaProducer011<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> SimpleStringSchema<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ol> <p><strong>输出到Redis</strong>：</p> <ol><li><p>导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.bahir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-redis_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>编写</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> 定义类
<span class="token keyword">class</span> MyRedisMapper <span class="token keyword">extends</span> RedisMapper<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">{</span> 
    <span class="token keyword">override</span> <span class="token keyword">def</span> getCommandDescription<span class="token operator">:</span> RedisCommandDescription <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> RedisCommandDescription<span class="token punctuation">(</span>RedisCommand<span class="token punctuation">.</span>HSET<span class="token punctuation">,</span> <span class="token string">&quot;sensor_temperature&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> getValueFromData<span class="token punctuation">(</span>t<span class="token operator">:</span> SensorReading<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>temperature<span class="token punctuation">.</span>toString <span class="token keyword">override</span> <span class="token keyword">def</span> getKeyFromData<span class="token punctuation">(</span>t<span class="token operator">:</span> SensorReading<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> t<span class="token punctuation">.</span>id <span class="token punctuation">}</span>
<span class="token number">2</span>、 添加到sink中
<span class="token keyword">val</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> FlinkJedisPoolConfig
<span class="token punctuation">.</span>Builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>setHost<span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>setPort<span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span> 
dataStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span> <span class="token keyword">new</span> RedisSink<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">new</span> MyRedisMapper<span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ol> <p><strong>输出Elasticsearch</strong></p> <ol><li><p>导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-elasticsearch6_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>编写</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//1. 创建list配置参数</span>
<span class="token keyword">val</span> httpHosts <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">[</span>HttpHost<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
httpHosts<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token keyword">new</span> HttpHost<span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token comment">//构建对象传入传输</span>
<span class="token keyword">val</span> esSinkBuilder <span class="token operator">=</span> <span class="token keyword">new</span> ElasticsearchSink<span class="token punctuation">.</span>Builder<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">(</span> httpHosts<span class="token punctuation">,</span> <span class="token keyword">new</span> ElasticsearchSinkFunction<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> process<span class="token punctuation">(</span>t<span class="token operator">:</span> SensorReading<span class="token punctuation">,</span> runtimeContext<span class="token operator">:</span> RuntimeContext<span class="token punctuation">,</span> requestIndexer<span class="token operator">:</span> RequestIndexer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
    
    println<span class="token punctuation">(</span><span class="token string">&quot;saving data: &quot;</span> <span class="token operator">+</span> t<span class="token punctuation">)</span> 
    <span class="token keyword">val</span> json <span class="token operator">=</span> <span class="token keyword">new</span> util<span class="token punctuation">.</span>HashMap<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    json<span class="token punctuation">.</span>put<span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>                                         <span class="token keyword">val</span> indexRequest <span class="token operator">=</span> Requests
    <span class="token punctuation">.</span>indexRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token string">&quot;sensor&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>`<span class="token keyword">type</span>`<span class="token punctuation">(</span><span class="token string">&quot;readingData&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>source<span class="token punctuation">(</span>json<span class="token punctuation">)</span> 
                                                                      requestIndexer<span class="token punctuation">.</span>add<span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span> 
    println<span class="token punctuation">(</span><span class="token string">&quot;saved successfully&quot;</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span> 
dataStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span> esSinkBuilder<span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li></ol> <p><strong>JDBC</strong> <strong>自定义</strong> <strong>sink</strong>:</p> <ol><li><p>导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.44<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>编写</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">// 编写自定义 sink</span>
<span class="token keyword">class</span> MyJdbcSink<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> RichSinkFunction<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">{</span>
<span class="token keyword">var</span> conn<span class="token operator">:</span> Connection <span class="token operator">=</span> _ 
<span class="token keyword">var</span> insertStmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> _ 
<span class="token keyword">var</span> updateStmt<span class="token operator">:</span> PreparedStatement <span class="token operator">=</span> _ 
<span class="token comment">// open 主要是创建连接 </span>
<span class="token keyword">override</span> <span class="token keyword">def</span> open<span class="token punctuation">(</span>parameters<span class="token operator">:</span> Configuration<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> ·<span class="token keyword">super</span><span class="token punctuation">.</span>open<span class="token punctuation">(</span>parameters<span class="token punctuation">)</span> conn <span class="token operator">=</span> DriverManager
<span class="token punctuation">.</span>getConnection<span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/test&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span> 
insertStmt <span class="token operator">=</span> conn<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO temperatures (sensor, temp) VALUES (?, ?)&quot;</span><span class="token punctuation">)</span> 
updateStmt <span class="token operator">=</span> conn<span class="token punctuation">.</span>prepareStatement<span class="token punctuation">(</span><span class="token string">&quot;UPDATE temperatures SET temp = ? WHERE sensor = ?&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token comment">// 调用连接，执行 sql </span>
<span class="token keyword">override</span> <span class="token keyword">def</span> invoke<span class="token punctuation">(</span>value<span class="token operator">:</span> SensorReading<span class="token punctuation">,</span> context<span class="token operator">:</span> SinkFunction<span class="token punctuation">.</span>Context<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
updateStmt<span class="token punctuation">.</span>setDouble<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span>
updateStmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>id<span class="token punctuation">)</span> 
updateStmt<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>updateStmt<span class="token punctuation">.</span>getUpdateCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
insertStmt<span class="token punctuation">.</span>setString<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>id<span class="token punctuation">)</span> 
insertStmt<span class="token punctuation">.</span>setDouble<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span>
insertStmt<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
insertStmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> 
updateStmt<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token comment">//2 添加sink</span>
dataStream<span class="token punctuation">.</span>addSink<span class="token punctuation">(</span><span class="token keyword">new</span> MyJdbcSink<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li></ol> <h2 id="window-窗口"><a href="#window-窗口" class="header-anchor">#</a> Window 窗口</h2> <p>可用于切割无限数据流成为有限数据流。</p> <p><strong>类型</strong>：</p> <ul><li><p>CountWindow：计数窗口</p></li> <li><p>timeWindow：时间窗口</p> <blockquote><p>滚动窗口tumbling：<strong>时间对齐，窗口长度固定，没有重叠</strong>，适合做 BI 统计等（做每个时间段的聚合计算）。</p> <p>滑动窗口sliding：<strong>时间对齐，窗口长度固定，可以有重叠</strong></p> <p>会话窗口se'ssion：<strong>时间无对齐</strong></p></blockquote></li></ul> <p><strong>timeWindow</strong></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//1. 滚动</span>
<span class="token keyword">val</span> minTempPerWindow <span class="token operator">=</span> dataStream <span class="token punctuation">.</span>map<span class="token punctuation">(</span>r <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span> 
<span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>r1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> r1<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>min<span class="token punctuation">(</span>r2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//时间间隔可以通过 Time.milliseconds(x)，Time.seconds(x)，Time.minutes(x)等其 中的一个来指定</span>

<span class="token comment">//2. 滑动  有步长</span>
<span class="token keyword">val</span> minTempPerWindow<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> dataStream
<span class="token punctuation">.</span>map<span class="token punctuation">(</span>r <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>
<span class="token punctuation">.</span>timeWindow<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>reduce<span class="token punctuation">(</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span>r1<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> r1<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>min<span class="token punctuation">(</span>r2<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//or // .window(SlidingEventTimeWindows.of(Time.seconds(15),Time.sec onds(5))</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>CountWindow</strong>：根据key触发</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//1. 滚动
val minTempPerWindow: DataStream[(String, Double)] = dataStream .map(r =&gt; (r.id, r.temperature)) .keyBy(_._1)
.countWindow(5) .reduce((r1, r2) =&gt; (r1._1, r1._2.max(r2._2)))
//2. 滑动
val keyedStream: KeyedStream[(String, Int), Tuple] = dataStream.map(r =&gt; (r.id, r.temperature)).keyBy(0) 
//每当某一个 key 的个数达到 2 的时候,触发计算，计算最近该 key 最近 10 个元素的内容 
val windowedStream: WindowedStream[(String, Int), Tuple, GlobalWindow] = keyedStream.countWindow(10,2) 
val sumDstream: DataStream[(String, Int)] = windowedStream.sum(1)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>window function</strong>：可对窗口做计算的操作</p> <ul><li>增量聚合：incremental aggregation functions</li> <li>全窗口聚合：full window functions</li></ul> <blockquote><p>ProcessWindowFunction 就是一个全窗口函数</p></blockquote> <p><strong>window其它可选</strong> <strong>API</strong></p> <ul><li>.trigger() —— 触发器</li> <li>.evitor() —— 移除器</li> <li>.allowedLateness() —— 允许处理迟到的数据</li> <li>.sideOutputLateData() —— 将迟到的数据放入侧输出流</li> <li>.getSideOutput() —— 获取侧输出流</li></ul> <h2 id="时间语义🎇wartermark"><a href="#时间语义🎇wartermark" class="header-anchor">#</a> 时间语义🎇Wartermark</h2> <ul><li><strong>Event Time</strong>：是事件创建的时间</li> <li><strong>Ingestion Time</strong>：是数据进入 Flink 的时间</li> <li><strong>Processing Time</strong>：是每一个执行基于时间操作的算子的本地系统时间，与机器 相关，默认的时间属性就是 Processing Time。</li></ul> <p><strong>在</strong> <strong>Flink</strong> <strong>的流式处理中，绝大部分的业务都会使用</strong> <strong>eventTime</strong>,</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//event Time</span>
<span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 
<span class="token comment">// 从调用时刻开始给 env 创建的每一个 stream 追加时间特征 </span>
env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>Watermark</strong>:是一种衡量 Event Time 进展的机制.</p> <blockquote><p>io等网络传输可能影响的乱序。</p> <p>而<strong>Watermark</strong> <strong>是用于处理乱序事件的</strong>，而正确的处理乱序事件，通常用 Watermark 机制结合 window 来实现</p> <p>Watermark 类似延迟触发机制，他是与数据时间戳相关，单调递增的特殊记录</p></blockquote> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//1. 引入</span>
dataStream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span> 
<span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> SensorReading<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span> element<span class="token punctuation">.</span>timestamp <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>Event Time 的使用一定要<strong>指定数据源中的时间戳</strong></p></blockquote> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 
<span class="token comment">// 从调用时刻开始给 env 创建的每一个 stream 追加时间特性 </span>
env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
<span class="token keyword">val</span> readings<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>addSource<span class="token punctuation">(</span><span class="token keyword">new</span> SensorSource<span class="token punctuation">)</span>
<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> MyAssigner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>类型</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>AssignerWithPeriodicWatermarks  :周期性生成 默认中期200 
	ExecutionConfig.setAutoWatermarkInterval()方法进行设置
AssignerWithPunctuatedWatermarks ：间断性生成
以上两个接口都继承自 TimestampAssigner。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-scala line-numbers-mode"><pre class="language-scala"><code>例： 周期性按时间戳抽取最大值

<span class="token keyword">class</span> PeriodicAssigner <span class="token keyword">extends</span> AssignerWithPeriodicWatermarks<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token punctuation">{</span> 
<span class="token keyword">val</span> bound<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> 
<span class="token comment">// 延时为 1 分钟 </span>
<span class="token keyword">var</span> maxTs<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token builtin">Long</span><span class="token punctuation">.</span>MinValue 
<span class="token comment">// 观察到的最大时间戳 </span>
<span class="token keyword">override</span> <span class="token keyword">def</span> getCurrentWatermark<span class="token operator">:</span> Watermark <span class="token operator">=</span> <span class="token punctuation">{</span> 
<span class="token keyword">new</span> Watermark<span class="token punctuation">(</span>maxTs <span class="token operator">-</span> bound<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>r<span class="token operator">:</span> SensorReading<span class="token punctuation">,</span> previousTS<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
maxTs <span class="token operator">=</span> maxTs<span class="token punctuation">.</span>max<span class="token punctuation">(</span>r<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> r<span class="token punctuation">.</span>timestamp <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 简单情况可简写</span>
<span class="token keyword">val</span> stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">val</span> withTimestampsAndWatermarks <span class="token operator">=</span> stream <span class="token punctuation">.</span>assignAscendingTimestamps<span class="token punctuation">(</span>e <span class="token keyword">=&gt;</span> e<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span>

<span class="token comment">//处理乱序</span>
<span class="token keyword">val</span> stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">val</span> withTimestampsAndWatermarks <span class="token operator">=</span> stream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span> <span class="token keyword">new</span> SensorTimeAssigner <span class="token punctuation">)</span>
<span class="token keyword">class</span> SensorTimeAssigner <span class="token keyword">extends</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 抽取时间戳</span>
    <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>r<span class="token operator">:</span> SensorReading<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> r<span class="token punctuation">.</span>timestamp <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>EvnetTime 在 window 中的使用</strong>：</p> <ul><li><strong>滚动窗口：TumblingEventTimeWindows</strong></li></ul> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
	<span class="token comment">// 环境 </span>
	<span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment 				env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> dstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span><span class="token number">7777</span><span class="token punctuation">)</span> 
    <span class="token keyword">val</span> textWithTsDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> dstream<span class="token punctuation">.</span>map<span class="token punctuation">{</span> text <span class="token keyword">=&gt;</span>
        <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">val</span> textWithEventTimeDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> textWithTsDstream<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span>
        <span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> element<span class="token punctuation">.</span>_2 <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> textKeyStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">]</span> <span class="token operator">=</span> textWithEventTimeDstream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> 			textKeyStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;textkey:&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> windowStream<span class="token operator">:</span> WindowedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token operator">=</span> textKeyStream
    <span class="token punctuation">.</span>window<span class="token punctuation">(</span>TumblingEventTimeWindows<span class="token punctuation">.</span>of<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> groupDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>mutable<span class="token punctuation">.</span>HashSet<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> windowStream<span class="token punctuation">.</span>fold<span class="token punctuation">(</span><span class="token keyword">new</span> mutable<span class="token punctuation">.</span>HashSet<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>set<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> set <span class="token operator">+=</span> ts <span class="token punctuation">}</span>
    groupDstream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;window::::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li><p><strong>滑动窗口SlidingEventTimeWindows</strong>:</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
<span class="token comment">// 环境 </span>
<span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>
env<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> dstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>socketTextStream<span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span><span class="token number">7777</span><span class="token punctuation">)</span> 
<span class="token keyword">val</span> textWithTsDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> dstream<span class="token punctuation">.</span>map <span class="token punctuation">{</span> 
text <span class="token keyword">=&gt;</span> <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">val</span> textWithEventTimeDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> textWithTsDstream
<span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
<span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> element<span class="token punctuation">.</span>_2 <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> textKeyStream<span class="token operator">:</span> KeyedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">]</span> <span class="token operator">=</span> textWithEventTimeDstream<span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    textKeyStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;textkey:&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> windowStream<span class="token operator">:</span> WindowedStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> TimeWindow<span class="token punctuation">]</span> <span class="token operator">=</span> textKeyStream
    <span class="token punctuation">.</span>window<span class="token punctuation">(</span>SlidingEventTimeWindows<span class="token punctuation">.</span>of<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>seconds<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Time<span class="token punctuation">.</span>millis econds<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token keyword">val</span> groupDstream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>mutable<span class="token punctuation">.</span>HashSet<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> windowStream<span class="token punctuation">.</span>fold<span class="token punctuation">(</span><span class="token keyword">new</span> mutable<span class="token punctuation">.</span>HashSet<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">case</span> <span class="token punctuation">(</span>set<span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> ts<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> set <span class="token operator">+=</span> ts <span class="token punctuation">}</span>
    groupDstream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">&quot;window::::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li> <li><p><strong>会话窗口EventTimeSessionWindows</strong></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code>textKeyStream<span class="token punctuation">.</span>window<span class="token punctuation">(</span>EventTimeSessionWindows<span class="token punctuation">.</span>withGap<span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h2 id="processfunction-api"><a href="#processfunction-api" class="header-anchor">#</a> ProcessFunction API</h2> <p>底层api和获取访问时间戳注册定时事件，特殊事件等、</p> <p>例：Flink SQL 就是使用 Process Function 实现的</p> <p>flink提供了8个：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> ProcessFunction
 KeyedProcessFunction
 CoProcessFunction
 ProcessJoinFunction
 BroadcastProcessFunction
 KeyedBroadcastProcessFunction
 ProcessWindowFunction
 ProcessAllWindowFunction
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p><strong>所有的 Process Function都继承自 RichFunction接口</strong></p></blockquote> <p><strong>KeyedProcessFunction</strong>：操作keyedStream</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>processElement(v: IN, ctx: Context, out: Collector[OUT])//流中每个元素都都会调用这个方法
out输出 in输入 ctx 上下文对象
onTimer(timestamp: Long, ctx: OnTimerContext, out: Collector[OUT])//回调函数
timestamp 设置促发时间戳 

TimerService 事件服务对象 Timers定时器
	currentProcessingTime(): Long 返回当前处理时间 
    currentWatermark(): Long 返回当前 watermark 的时间戳 
    registerProcessingTimeTimer(timestamp: Long): Unit 会注册当前 key 的 processing time 的定时器。
    	当 processing time 到达定时时间时，触发 timer。 
    registerEventTimeTimer(timestamp: Long): Unit 会注册当前 key 的 event time 定时器。
    	当水位线大于等于定时器注册的时间时，触发定时器执行回调函数
    deleteProcessingTimeTimer(timestamp: Long): Unit 删除之前注册处理时间定 时器。如果没有,则不执行。
    deleteEventTimeTimer(timestamp: Long): Unit 删除之前注册的事件时间定时 器，如果没有此时间戳的定时器，则不执行。 当定时器 timer 触发时，会执行回调函数 onTimer()。注意定时器 timer 只能在 keyed streams 上面使用
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>例</strong></p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//需求：监控温度传感器的温度值，如果温度值在一秒钟之内(processing time)连 续上升，则报警。</span>
<span class="token comment">//1. 对读取的文件进行分组且调用processing传入自定义规则</span>
<span class="token keyword">val</span> warnings <span class="token operator">=</span> readings <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>_<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> TempIncreaseAlertFunction<span class="token punctuation">)</span>
<span class="token comment">//2. 实现自定义规则</span>
<span class="token keyword">class</span> TempIncreaseAlertFunction <span class="token keyword">extends</span> KeyedProcessFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token comment">// 保存上一个传感器温度值 </span>
<span class="token keyword">lazy</span> <span class="token keyword">val</span> lastTemp<span class="token operator">:</span> ValueState<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span> <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getState<span class="token punctuation">(</span> <span class="token keyword">new</span> ValueStateDescriptor<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;lastTemp&quot;</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>of<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token comment">// 保存注册的定时器的时间戳 </span>
<span class="token keyword">lazy</span> <span class="token keyword">val</span> currentTimer<span class="token operator">:</span> ValueState<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> getRuntimeContext<span class="token punctuation">.</span>getState<span class="token punctuation">(</span> <span class="token keyword">new</span> ValueStateDescriptor<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;timer&quot;</span><span class="token punctuation">,</span> Types<span class="token punctuation">.</span>of<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> processElement<span class="token punctuation">(</span>r<span class="token operator">:</span> SensorReading<span class="token punctuation">,</span> ctx<span class="token operator">:</span> KeyedProcessFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>#Context<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token comment">// 取出上一次的温度 </span>
<span class="token keyword">val</span> prevTemp <span class="token operator">=</span> lastTemp<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 将当前温度更新到上一次的温度这个变量中 </span>
lastTemp<span class="token punctuation">.</span>update<span class="token punctuation">(</span>r<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span>
<span class="token keyword">val</span> curTimerTimestamp <span class="token operator">=</span> currentTimer<span class="token punctuation">.</span>value<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>prevTemp <span class="token operator">==</span> <span class="token number">0.0</span> <span class="token operator">||</span> r<span class="token punctuation">.</span>temperature <span class="token operator">&lt;</span> prevTemp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 温度下降或者是第一个温度值，删除定时器 </span>
ctx<span class="token punctuation">.</span>timerService<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>deleteProcessingTimeTimer<span class="token punctuation">(</span>curTimerTimestamp<span class="token punctuation">)</span>
<span class="token comment">// 清空状态变量 </span>
currentTimer<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>temperature <span class="token operator">&gt;</span> prevTemp <span class="token operator">&amp;&amp;</span> curTimerTimestamp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 温度上升且我们并没有设置定时器 </span>
<span class="token keyword">val</span> timerTs <span class="token operator">=</span> ctx<span class="token punctuation">.</span>timerService<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>currentProcessingTime<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> ctx<span class="token punctuation">.</span>timerService<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>registerProcessingTimeTimer<span class="token punctuation">(</span>timerTs<span class="token punctuation">)</span> 
currentTimer<span class="token punctuation">.</span>update<span class="token punctuation">(</span>timerTs<span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> onTimer<span class="token punctuation">(</span>ts<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> ctx<span class="token operator">:</span> KeyedProcessFunction<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> SensorReading<span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token punctuation">]</span>#OnTimerContext<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token string">&quot;传感器 id 为: &quot;</span> <span class="token operator">+</span> ctx<span class="token punctuation">.</span>getCurrentKey <span class="token operator">+</span> <span class="token string">&quot;的传感器温度值已经连续 1s 上升了。&quot;</span><span class="token punctuation">)</span> 
currentTimer<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><strong>侧输出流:SideOutput</strong>: 一条流分成多条流，</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token number">1.</span> 例 传入一个输出规则
<span class="token keyword">val</span> monitoredReadings<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token operator">=</span> readings <span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token keyword">new</span> FreezingMonitor<span class="token punctuation">)</span> 
monitoredReadings
<span class="token punctuation">.</span>getSideOutput<span class="token punctuation">(</span><span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;freezing-alarms&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span> 
readings<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2.</span> 自定义输出规则
例：实现 FreezingMonitor 函数，用来监控传感器温度值，将温度值低于 <span class="token number">32F</span> 的温度输出到 side output
<span class="token keyword">class</span> FreezingMonitor <span class="token keyword">extends</span> ProcessFunction<span class="token punctuation">[</span>SensorReading<span class="token punctuation">,</span> SensorReading<span class="token punctuation">]</span> <span class="token punctuation">{</span>
<span class="token comment">// 定义一个侧输出标签 </span>
<span class="token keyword">lazy</span> <span class="token keyword">val</span> freezingAlarmOutput<span class="token operator">:</span> OutputTag<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> OutputTag<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;freezing-alarms&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">override</span> <span class="token keyword">def</span> processElement<span class="token punctuation">(</span>r<span class="token operator">:</span> SensorReading<span class="token punctuation">,</span> ctx<span class="token operator">:</span> ProcessFunction<span class="token punctuation">[</span>SensorReading<span class="token punctuation">,</span> SensorReading<span class="token punctuation">]</span>
#Context<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span> 
<span class="token comment">// 温度在 32F 以下时，输出警告信息 </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>temperature <span class="token operator">&lt;</span> <span class="token number">32.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
		ctx<span class="token punctuation">.</span>output<span class="token punctuation">(</span>freezingAlarmOutput<span class="token punctuation">,</span> s<span class="token string">&quot;Freezing Alarm for ${r.id}&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token comment">// 所有数据直接常规输出到主流 </span>
out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>CoProcessFunction</strong>: 合并成一条流</p> <h2 id="状态编程"><a href="#状态编程" class="header-anchor">#</a> 状态编程</h2> <p>流式计算分为无状态和有状态两种情况。</p> <p><strong>无状态</strong>：根据最后事件输出结果</p> <p><strong>有状态</strong>：根据多个事件输出结果 ：存储状态</p> <p><strong>状态</strong>：</p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006231113.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. 由一个任务维护的某个结果所有数据
2. 可被任务访问
3. 会对状态进行管理，包括状态一致性，故障处理、高效存储和访问
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>算子状态：Operatior State</strong>：</p> <blockquote><p>算子任务(同一并行度)，状态对同一个子任务共享，不能由其他算子的子任务访问</p> <p><strong>数据结构</strong>：</p> <ul><li>list state：列表</li> <li>union list state：合并</li> <li>Broadcast state ：广播</li></ul></blockquote> <p>**键控状态：Keyed State 	**</p> <blockquote><p>只能用于 KeyedStream（keyBy 算子处理之后）</p> <p><strong>数据类型</strong>:</p> <ul><li>value State[T]: get(value) set(update)操作</li> <li>list State[T]:  add、addall、get、update</li> <li>mapstate：get、put、contains、remove</li> <li>reducingState:</li> <li>AggregatingState</li> <li>State.clear()是清空操作</li></ul> <p>通过 RuntimeContext 注册 StateDescriptor。StateDescriptor 以状态 state 的名字</p> <p>和存储的数据类型为参数</p></blockquote> <p>**状态后端：State Backend **:</p> <ul><li><p>MemoryStateBackend :内存级状态后端封装成对象存储在jvm中，检查点存储在作业管理器中</p></li> <li><p>FsStateBackend: 存储到远程文件系统</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token keyword">val</span> env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment <span class="token keyword">val</span> checkpointPath<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span> 
<span class="token keyword">val</span> backend <span class="token operator">=</span> <span class="token keyword">new</span> RocksDBStateBackend<span class="token punctuation">(</span>checkpointPath<span class="token punctuation">)</span>
env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span>backend<span class="token punctuation">)</span> env<span class="token punctuation">.</span>setStateBackend<span class="token punctuation">(</span><span class="token keyword">new</span> FsStateBackend<span class="token punctuation">(</span><span class="token string">&quot;file:///tmp/checkpoints&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> env<span class="token punctuation">.</span>enableCheckpointing<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> 
<span class="token comment">// 配置重启策略 </span>
env<span class="token punctuation">.</span>setRestartStrategy<span class="token punctuation">(</span>RestartStrategies<span class="token punctuation">.</span>fixedDelayRestart<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span>of<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>RocksDBStateBackend ：序列化存储到本地  要导入依赖</p> <blockquote><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-statebackend-rocksdb_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.10.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></blockquote></li></ul> <h2 id="容错机制"><a href="#容错机制" class="header-anchor">#</a> 容错机制</h2> <p><strong>状态一致性</strong>:</p> <ul><li>at-most-once: 故障计算结果可能丢失</li> <li>at-least-once：不会丢失，可能多算，结果大于正确值</li> <li>exactly-once：正确值和计算结果一致</li></ul> <p>前面说到flink是lambda架构的改进，把俩套系统合在一起了，提供快速计算(低延迟)+正确性(合并)</p> <p>Flink 的一个重大价值在于，<strong>它既保证了</strong> <strong>exactly-once</strong>**，<strong>也具有低延迟和高吞的处理能力</strong></p> <p>端到端：end-to -end</p> <blockquote><p>贯穿流处理的的始终，每个组件都确保了他调度一致性：</p> <ul><li>内部保证=&gt;依赖checkpoint</li> <li>source端=&gt;需要设置外源</li> <li>sink端=&gt;需要保证谨遵写入 具体实现：幂等性(一次有效）和事务性(预写入日志wal，俩阶段提交)</li></ul> <blockquote><p>DataStream API 提供了 GenericWriteAheadSink 模板类和</p> <p>TwoPhaseCommitSinkFunction 接口，可以方便地实现这两种方式的事务性写入</p></blockquote> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20211006233742.png" alt=""></p></blockquote> <p><strong>检查点</strong>：做标记</p> <div class="language-scala line-numbers-mode"><pre class="language-scala"><code><span class="token comment">//检查点算法</span>
<span class="token keyword">val</span> stream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token keyword">val</span> counts<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> stream <span class="token punctuation">.</span>keyBy<span class="token punctuation">(</span>record <span class="token keyword">=&gt;</span> record<span class="token punctuation">.</span>_1<span class="token punctuation">)</span> 
<span class="token punctuation">.</span>mapWithState<span class="token punctuation">(</span> <span class="token punctuation">(</span>in<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> state <span class="token keyword">match</span> <span class="token punctuation">{</span> 
<span class="token keyword">case</span> Some<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> c <span class="token operator">+</span> in<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span>c <span class="token operator">+</span> in<span class="token punctuation">.</span>_2<span class="token punctuation">)</span> <span class="token punctuation">)</span> 
<span class="token keyword">case</span> None <span class="token keyword">=&gt;</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> in<span class="token punctuation">.</span>_2<span class="token punctuation">)</span><span class="token punctuation">,</span> Some<span class="token punctuation">(</span>in<span class="token punctuation">.</span>_2<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>检查点是 Flink 最有价值的创新之一，因为<strong>它使</strong> <strong>Flink</strong> <strong>可以保证</strong> <strong>exactly-once</strong> <strong>并且不需要牺牲性能</strong>。</p></blockquote> <p><strong>Flink+Kafka</strong> <strong>如何实现端到端的</strong> <strong>exactly-once</strong> <strong>语义</strong>: kafka进+出</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>具体的两阶段提交步骤总结如下：
 第一条数据来了之后，开启一个 kafka 的事务（transaction），正常写入 kafka 分区日志但标记为未提交，这就是“预提交” 
 jobmanager 触发 checkpoint 操作，barrier 从 source 开始向下传递，遇到 barrier 的算子将状态存入状态后端，并通知 jobmanager 
 sink 连接器收到 barrier，保存当前状态，存入 checkpoint，通知 jobmanager，并开启下一阶段的事务，用于提交下个检查点的数据  jobmanager 收到所有任务的通知，发出确认信息，表示 checkpoint 完成 
 sink 任务收到 jobmanager 的确认信息，正式提交这段时间的数据 
 外部 kafka 关闭事务，提交的数据可以正常消费了。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=flink" title="标签">#flink</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/22, 21:16:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/spa123ra12sd2/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">浅尝spark✨</div></a> <a href="/pages/f1table3n4k5/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">flink-table-sql</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/spa123ra12sd2/" class="prev">浅尝spark✨</a></span> <span class="next"><a href="/pages/f1table3n4k5/">flink-table-sql</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f53939/"><div>Spring6</div></a> <span>06-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba69ad/"><div>若依二开</div></a> <span>06-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/998714/"><div>MongoDB</div></a> <span>06-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=2461475139&amp;site=qq&amp;menu=yes" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/axcmsm" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=6757658477" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>axcmsm | 转载注明出处 </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e7d9515b.js" defer></script><script src="/assets/js/2.125ae6e8.js" defer></script><script src="/assets/js/47.1722c1b9.js" defer></script>
  </body>
</html>