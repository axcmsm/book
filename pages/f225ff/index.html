<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>hadoopæºç è§£æ | ğŸ¦</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="webå‰ç«¯æŠ€æœ¯åšå®¢,ç®€æ´è‡³ä¸Š,ä¸“æ³¨webå‰ç«¯å­¦ä¹ ä¸æ€»ç»“ã€‚JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,githubç­‰æŠ€æœ¯æ–‡ç« ã€‚">
    <meta name="keywords" content="ä¸ªäººæŠ€æœ¯åšå®¢,åç«¯,å¤§æ•°æ®,æŠ€æœ¯æ–‡æ¡£,å­¦ä¹ ,js,vue,python,css3,java,javaEE,SpringBoot,Spring,Hadoop,html5,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.e7d9515b.js" as="script"><link rel="preload" href="/assets/js/2.125ae6e8.js" as="script"><link rel="preload" href="/assets/js/21.74a586bf.js" as="script"><link rel="prefetch" href="/assets/js/10.95c2d7b0.js"><link rel="prefetch" href="/assets/js/100.b4e10546.js"><link rel="prefetch" href="/assets/js/101.d6d23fe2.js"><link rel="prefetch" href="/assets/js/102.b368fb26.js"><link rel="prefetch" href="/assets/js/103.b87bfabc.js"><link rel="prefetch" href="/assets/js/104.3d0ae07d.js"><link rel="prefetch" href="/assets/js/105.e9f9588c.js"><link rel="prefetch" href="/assets/js/106.76130cbc.js"><link rel="prefetch" href="/assets/js/107.11dd35ba.js"><link rel="prefetch" href="/assets/js/108.de8bb9b7.js"><link rel="prefetch" href="/assets/js/109.e26f138c.js"><link rel="prefetch" href="/assets/js/11.5682c637.js"><link rel="prefetch" href="/assets/js/110.2c9036b9.js"><link rel="prefetch" href="/assets/js/111.d91b7424.js"><link rel="prefetch" href="/assets/js/112.0edf9093.js"><link rel="prefetch" href="/assets/js/113.dbc0bf4d.js"><link rel="prefetch" href="/assets/js/114.439ad4ee.js"><link rel="prefetch" href="/assets/js/115.0cff9cd8.js"><link rel="prefetch" href="/assets/js/116.fd44dc61.js"><link rel="prefetch" href="/assets/js/117.e893d264.js"><link rel="prefetch" href="/assets/js/118.ec4b3d32.js"><link rel="prefetch" href="/assets/js/119.ea5c3eba.js"><link rel="prefetch" href="/assets/js/12.5a51d307.js"><link rel="prefetch" href="/assets/js/120.9aaee23f.js"><link rel="prefetch" href="/assets/js/121.4fc7842c.js"><link rel="prefetch" href="/assets/js/122.2b8f75d1.js"><link rel="prefetch" href="/assets/js/123.78dbfead.js"><link rel="prefetch" href="/assets/js/124.84b6382a.js"><link rel="prefetch" href="/assets/js/125.c2a2a818.js"><link rel="prefetch" href="/assets/js/126.83ea2963.js"><link rel="prefetch" href="/assets/js/127.dffd5eae.js"><link rel="prefetch" href="/assets/js/128.bb0a0738.js"><link rel="prefetch" href="/assets/js/129.45a56702.js"><link rel="prefetch" href="/assets/js/13.d1b5b29f.js"><link rel="prefetch" href="/assets/js/130.7fee331a.js"><link rel="prefetch" href="/assets/js/131.6aaa557b.js"><link rel="prefetch" href="/assets/js/132.9526e280.js"><link rel="prefetch" href="/assets/js/133.610c1c84.js"><link rel="prefetch" href="/assets/js/134.1dcf27f7.js"><link rel="prefetch" href="/assets/js/14.83de980a.js"><link rel="prefetch" href="/assets/js/15.0fa06ae1.js"><link rel="prefetch" href="/assets/js/16.d1d3c9c1.js"><link rel="prefetch" href="/assets/js/17.c9772d78.js"><link rel="prefetch" href="/assets/js/18.7cbf0ef4.js"><link rel="prefetch" href="/assets/js/19.66ee7cfc.js"><link rel="prefetch" href="/assets/js/20.8fbb5432.js"><link rel="prefetch" href="/assets/js/22.f85a2ced.js"><link rel="prefetch" href="/assets/js/23.a65163b5.js"><link rel="prefetch" href="/assets/js/24.5c2898c6.js"><link rel="prefetch" href="/assets/js/25.929f22ff.js"><link rel="prefetch" href="/assets/js/26.20d74c65.js"><link rel="prefetch" href="/assets/js/27.e790af79.js"><link rel="prefetch" href="/assets/js/28.6b84abe6.js"><link rel="prefetch" href="/assets/js/29.acc0fc34.js"><link rel="prefetch" href="/assets/js/3.dd3750e6.js"><link rel="prefetch" href="/assets/js/30.fadb6cbd.js"><link rel="prefetch" href="/assets/js/31.386f82c2.js"><link rel="prefetch" href="/assets/js/32.e934f71c.js"><link rel="prefetch" href="/assets/js/33.684ac64c.js"><link rel="prefetch" href="/assets/js/34.38f8fd76.js"><link rel="prefetch" href="/assets/js/35.3fe27233.js"><link rel="prefetch" href="/assets/js/36.993695b7.js"><link rel="prefetch" href="/assets/js/37.d735018c.js"><link rel="prefetch" href="/assets/js/38.0d23a384.js"><link rel="prefetch" href="/assets/js/39.808de65c.js"><link rel="prefetch" href="/assets/js/4.4a137b18.js"><link rel="prefetch" href="/assets/js/40.2fc7d5f7.js"><link rel="prefetch" href="/assets/js/41.6647cff7.js"><link rel="prefetch" href="/assets/js/42.f4d93aa6.js"><link rel="prefetch" href="/assets/js/43.a5d40107.js"><link rel="prefetch" href="/assets/js/44.3ae864d3.js"><link rel="prefetch" href="/assets/js/45.c66f1afe.js"><link rel="prefetch" href="/assets/js/46.750f2be2.js"><link rel="prefetch" href="/assets/js/47.1722c1b9.js"><link rel="prefetch" href="/assets/js/48.7c8df7cc.js"><link rel="prefetch" href="/assets/js/49.f9b58d70.js"><link rel="prefetch" href="/assets/js/5.51ca929a.js"><link rel="prefetch" href="/assets/js/50.fad73ad9.js"><link rel="prefetch" href="/assets/js/51.b88c6213.js"><link rel="prefetch" href="/assets/js/52.21244293.js"><link rel="prefetch" href="/assets/js/53.1c2189f3.js"><link rel="prefetch" href="/assets/js/54.95ba12bc.js"><link rel="prefetch" href="/assets/js/55.d8f79989.js"><link rel="prefetch" href="/assets/js/56.63c36b2d.js"><link rel="prefetch" href="/assets/js/57.270857ec.js"><link rel="prefetch" href="/assets/js/58.156073cc.js"><link rel="prefetch" href="/assets/js/59.5a300643.js"><link rel="prefetch" href="/assets/js/6.2dccf462.js"><link rel="prefetch" href="/assets/js/60.92f4ce87.js"><link rel="prefetch" href="/assets/js/61.0f312cea.js"><link rel="prefetch" href="/assets/js/62.0c55901b.js"><link rel="prefetch" href="/assets/js/63.613b1add.js"><link rel="prefetch" href="/assets/js/64.1e5070b6.js"><link rel="prefetch" href="/assets/js/65.dc215238.js"><link rel="prefetch" href="/assets/js/66.4a1319e4.js"><link rel="prefetch" href="/assets/js/67.841428fe.js"><link rel="prefetch" href="/assets/js/68.7380e054.js"><link rel="prefetch" href="/assets/js/69.0a503182.js"><link rel="prefetch" href="/assets/js/7.1096b6fa.js"><link rel="prefetch" href="/assets/js/70.09f4c416.js"><link rel="prefetch" href="/assets/js/71.a279d635.js"><link rel="prefetch" href="/assets/js/72.057aa49f.js"><link rel="prefetch" href="/assets/js/73.767f542c.js"><link rel="prefetch" href="/assets/js/74.3eb6f7e5.js"><link rel="prefetch" href="/assets/js/75.50ecd31e.js"><link rel="prefetch" href="/assets/js/76.602f67fb.js"><link rel="prefetch" href="/assets/js/77.3b5a8e7d.js"><link rel="prefetch" href="/assets/js/78.40c6990e.js"><link rel="prefetch" href="/assets/js/79.ecb155e0.js"><link rel="prefetch" href="/assets/js/8.4b82b135.js"><link rel="prefetch" href="/assets/js/80.d7279b34.js"><link rel="prefetch" href="/assets/js/81.f58f78af.js"><link rel="prefetch" href="/assets/js/82.8399bcab.js"><link rel="prefetch" href="/assets/js/83.67c3c861.js"><link rel="prefetch" href="/assets/js/84.5a8f7c4b.js"><link rel="prefetch" href="/assets/js/85.c6f0af81.js"><link rel="prefetch" href="/assets/js/86.f9f3d0b8.js"><link rel="prefetch" href="/assets/js/87.fec83ae4.js"><link rel="prefetch" href="/assets/js/88.ca11e236.js"><link rel="prefetch" href="/assets/js/89.ae243724.js"><link rel="prefetch" href="/assets/js/9.b8d3ed93.js"><link rel="prefetch" href="/assets/js/90.c242e238.js"><link rel="prefetch" href="/assets/js/91.ad0080a6.js"><link rel="prefetch" href="/assets/js/92.a435d70c.js"><link rel="prefetch" href="/assets/js/93.3232bfbf.js"><link rel="prefetch" href="/assets/js/94.6101d03c.js"><link rel="prefetch" href="/assets/js/95.8c95af7a.js"><link rel="prefetch" href="/assets/js/96.a582908e.js"><link rel="prefetch" href="/assets/js/97.1b560b4f.js"><link rel="prefetch" href="/assets/js/98.a686266f.js"><link rel="prefetch" href="/assets/js/99.e03a81a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="ç›®å½•" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="ğŸ¦" class="logo"> <span class="site-name can-hide">ğŸ¦</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Bigæ•°æ®" class="dropdown-title"><a href="/BigData/" class="link-title">Bigæ•°æ®</a> <span class="title" style="display:none;">Bigæ•°æ®</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>å¤§æ•°æ®è·¯çº¿</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">å¼€å‘è·¯çº¿</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linuxå¯¼å›¾</a></li></ul></li><li class="dropdown-item"><h4>å­¦ä¹ ç¬”è®°</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">ã€ŠLinuxã€‹</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">ã€ŠHadoopã€‹</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">ã€Šç”Ÿæ€åœˆç»„ä»¶ã€‹</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">ã€Šæ¶ˆæ¯é˜Ÿåˆ—ã€‹</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">ã€Šsparkã€‹</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">ã€Šflinkã€‹</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">æŠ€æœ¯æ ˆğŸˆ</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="â›³ğŸ–¥" class="dropdown-title"><a href="/technology/" class="link-title">â›³ğŸ–¥</a> <span class="title" style="display:none;">â›³ğŸ–¥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">è®¡ç®—æœºå¿…å¤‡</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">æ•°å­¦åŸºç¡€</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">å­¦ä¹ </a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">æŠ€å·§</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">æŠ€æœ¯æ–‡æ¡£</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHubæŠ€å·§</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">æœ¬ç«™å…³è”</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">å…³äº</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/zzx.jpg"> <div class="blogger-info"><h3>AxcmsmğŸ¼</h3> <span>çºµæœ‰ç–¾é£èµ·ï¼Œäººç”Ÿä¸è¨€å¼ƒğŸ…</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">é¦–é¡µ</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Bigæ•°æ®" class="dropdown-title"><a href="/BigData/" class="link-title">Bigæ•°æ®</a> <span class="title" style="display:none;">Bigæ•°æ®</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>å¤§æ•°æ®è·¯çº¿</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">å¼€å‘è·¯çº¿</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linuxå¯¼å›¾</a></li></ul></li><li class="dropdown-item"><h4>å­¦ä¹ ç¬”è®°</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">ã€ŠLinuxã€‹</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">ã€ŠHadoopã€‹</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">ã€Šç”Ÿæ€åœˆç»„ä»¶ã€‹</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">ã€Šæ¶ˆæ¯é˜Ÿåˆ—ã€‹</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">ã€Šsparkã€‹</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">ã€Šflinkã€‹</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">æŠ€æœ¯æ ˆğŸˆ</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="â›³ğŸ–¥" class="dropdown-title"><a href="/technology/" class="link-title">â›³ğŸ–¥</a> <span class="title" style="display:none;">â›³ğŸ–¥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">è®¡ç®—æœºå¿…å¤‡</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">æ•°å­¦åŸºç¡€</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">å­¦ä¹ </a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">æŠ€å·§</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">æŠ€æœ¯æ–‡æ¡£</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHubæŠ€å·§</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">æœ¬ç«™å…³è”</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">å…³äº</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">æ”¶è—</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ç´¢å¼•" class="dropdown-title"><a href="/archives/" class="link-title">ç´¢å¼•</a> <span class="title" style="display:none;">ç´¢å¼•</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">åˆ†ç±»</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">æ ‡ç­¾</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">å½’æ¡£</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>è·¯çº¿orå¯¼å›¾</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>å­¦ä¹ ç¬”è®°</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šlinuxã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>ã€ŠHadoopã€‹</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/hasy2d21do11dop/" class="sidebar-link">Hadoopæ¦‚è¿°</a></li><li><a href="/pages/hdf2shad2o4p3/" class="sidebar-link">Hdfsåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿ</a></li><li><a href="/pages/1b8ea6/" class="sidebar-link">MapReduce</a></li><li><a href="/pages/a611d4/" class="sidebar-link">yarn</a></li><li><a href="/pages/ad2s1a123s2fa/" class="sidebar-link">Hadoopç”Ÿäº§è°ƒä¼˜</a></li><li><a href="/pages/f225ff/" aria-current="page" class="active sidebar-link">hadoopæºç è§£æ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/f225ff/#rpc-é€šä¿¡" class="sidebar-link">RPC é€šä¿¡</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#nn-å¯åŠ¨æºç è§£æ" class="sidebar-link">NN å¯åŠ¨æºç è§£æ</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#dn-å¯åŠ¨æºç è§£æ" class="sidebar-link">DN å¯åŠ¨æºç è§£æ</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#hdfs-ä¸Šä¼ æºç è§£æ" class="sidebar-link">HDFS ä¸Šä¼ æºç è§£æ</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#yarn-æºç è§£æ" class="sidebar-link">Yarn æºç è§£æ</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#mapreduce-æºç è§£æ" class="sidebar-link">MapReduce æºç è§£æ</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#hadoop-æºç ç¼–è¯‘" class="sidebar-link">Hadoop æºç ç¼–è¯‘</a></li></ul></li><li><a href="/pages/e7984e/" class="sidebar-link">æ€»ç»“hadoop</a></li><li><a href="/pages/9067f7/" class="sidebar-link">HAé«˜å¯ç”¨</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šzookeeperã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šhiveã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šç”Ÿæ€åœˆç»„ä»¶ã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šæ¶ˆæ¯é˜Ÿåˆ—ã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šsparkã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šflinkã€‹</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>ã€Šæ•°æ®å¯è§†åŒ–ã€‹</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>é¡¹ç›®</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å®‰è£…</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- æ­£æ–¹å½¢ -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="é¦–é¡µ" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/BigData" title="å¤§æ•°æ®-ç›®å½•é¡µ" data-v-1cd794fe>å¤§æ•°æ®</a></li> <li data-v-1cd794fe><a href="/BigData/#å­¦ä¹ ç¬”è®°" title="å¤§æ•°æ®#å­¦ä¹ ç¬”è®°" data-v-1cd794fe>å­¦ä¹ ç¬”è®°</a></li> <li data-v-1cd794fe><a href="/BigData/#ã€ŠHadoopã€‹" title="å¤§æ•°æ®#ã€ŠHadoopã€‹" data-v-1cd794fe>ã€ŠHadoopã€‹</a></li></ul> <div class="info" data-v-1cd794fe><div title="ä½œè€…" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/axcmsm" target="_blank" title="ä½œè€…" class="beLink" data-v-1cd794fe>Wei Ye</a></div> <div title="åˆ›å»ºæ—¶é—´" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-09-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="/img/bj1.jpg">
          hadoopæºç è§£æ
        </h1> <div class="page-slot page-slot-top"><!-- å›ºå®š100% * 90pxå¯æ˜¾ç¤ºï¼Œmax-height:90pxæœªè§æ˜¾ç¤º-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="rpc-é€šä¿¡"><a href="#rpc-é€šä¿¡" class="header-anchor">#</a> RPC é€šä¿¡</h2> <p><strong>æ¨¡æ‹ŸRPC çš„å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€é€šä¿¡åè®®ä¸‰è€…å¦‚ä½•å·¥ä½œçš„</strong>:</p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904001108.png" alt=""></p> <p><strong>æ­¥éª¤</strong>ï¼š</p> <ul><li>åˆ›å»º RPC åè®®</li> <li>åˆ›å»º RPC æœåŠ¡ç«¯</li> <li>åˆ›å»º RPC å®¢æˆ·ç«¯</li> <li>æµ‹è¯•</li></ul> <p><strong>æ€»ç»“</strong>ï¼šRPC çš„å®¢æˆ·ç«¯è°ƒç”¨é€šä¿¡åè®®æ–¹æ³•ï¼Œæ–¹æ³•çš„æ‰§è¡Œåœ¨æœåŠ¡ç«¯,é€šä¿¡åè®®å°±æ˜¯æ¥å£è§„èŒƒã€‚</p> <h2 id="nn-å¯åŠ¨æºç è§£æ"><a href="#nn-å¯åŠ¨æºç è§£æ" class="header-anchor">#</a> NN å¯åŠ¨æºç è§£æ</h2> <p><strong>NNå·¥ä½œæœºåˆ¶ï¼š</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902190330.png" alt=""></p> <p><strong>NNå¯åŠ¨æºç </strong>ï¼š</p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904001701.png" alt=""></p> <p><strong>è§£æå¯åŠ¨æµç¨‹</strong>ï¼š</p> <details class="custom-block details"><summary>ğŸ¦“</summary> <p>åœ¨ pom.xml ä¸­å¢åŠ ä¾èµ–</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>ctrl + n</code> å…¨å±€æŸ¥æ‰¾<code>namenode</code>ï¼Œè¿›å…¥ <code>NameNode.java</code></p> <p><code>ctrl + f</code>ï¼ŒæŸ¥æ‰¾ main æ–¹æ³• nn.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">parseHelpArgument</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span>USAGE<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startupShutdownMessage</span><span class="token punctuation">(</span><span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> LOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ›å»º NameNode</span>
<span class="token class-name">NameNode</span> namenode <span class="token operator">=</span> <span class="token function">createNameNode</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>namenode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
namenode<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to start namenode.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>ç‚¹å‡» <code>createNameNode</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NameNode</span> <span class="token function">createNameNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 â€¦ â€¦
 <span class="token class-name">StartupOption</span> startOpt <span class="token operator">=</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>startOpt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">setStartupOption</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> startOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> aborted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>startOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">case</span> FORMAT<span class="token operator">:</span>
 aborted <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> startOpt<span class="token punctuation">.</span><span class="token function">getForceFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 startOpt<span class="token punctuation">.</span><span class="token function">getInteractiveFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span>aborted <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// avoid javac warning</span>
 <span class="token keyword">case</span> GENCLUSTERID<span class="token operator">:</span>
 â€¦ â€¦
 <span class="token keyword">default</span><span class="token operator">:</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token string">&quot;NameNode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ›å»º NameNode å¯¹è±¡</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>ç‚¹å‡» <code>NameNode</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">NamenodeRole</span> role<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">initializeGenericKeys</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> nsId<span class="token punctuation">,</span> namenodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopAtException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HadoopIllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopAtException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ç‚¹å‡» <code>initialize</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">==</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// å¯åŠ¨ HTTP æœåŠ¡ç«¯ï¼ˆ9870ï¼‰  å…ˆçœ‹è¿™ä¸ª</span>
 <span class="token function">startHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// åŠ è½½é•œåƒæ–‡ä»¶å’Œç¼–è¾‘æ—¥å¿—åˆ°å†…å­˜ å†çœ‹è¿™ä¸ª</span>
 <span class="token function">loadNamesystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startAliasMapServerIfNecessary</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// åˆ›å»º NN çš„ RPC æœåŠ¡ç«¯   å†çœ‹è¿™ä¸ª</span>
 rpcServer <span class="token operator">=</span> <span class="token function">createRpcServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">initReconfigurableBackoffKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>clientNamenodeAddress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// This is expected for MiniDFSCluster. Set it now using </span>
 <span class="token comment">// the RPC server's bind address.</span>
 clientNamenodeAddress <span class="token operator">=</span> 
 <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getHostPortString</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Clients are to use &quot;</span> <span class="token operator">+</span> clientNamenodeAddress <span class="token operator">+</span> <span class="token string">&quot; to access&quot;</span>
 <span class="token operator">+</span> <span class="token string">&quot; this namenode/service.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">==</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setNameNodeAddress</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setFSImage</span><span class="token punctuation">(</span><span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// NN å¯åŠ¨èµ„æºæ£€æŸ¥</span>
 <span class="token function">startCommonServices</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startMetricsLogger</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>å¯åŠ¨ 9870 ç«¯å£æœåŠ¡</strong></p> <p>ç‚¹å‡» <code>startHttpServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startHttpServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
httpServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getHttpServerBindAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">setStartupProgress</span><span class="token punctuation">(</span>startupProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpServerBindAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> bindAddress <span class="token operator">=</span> <span class="token function">getHttpServerAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> bindAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpServerAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token function">getHttpAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>
 conf<span class="token punctuation">.</span><span class="token function">getTrimmed</span><span class="token punctuation">(</span>DFS_NAMENODE_HTTP_ADDRESS_KEY<span class="token punctuation">,</span> 
DFS_NAMENODE_HTTP_ADDRESS_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DFS_NAMENODE_HTTP_ADDRESS_DEFAULT <span class="token operator">=</span> <span class="token string">&quot;0.0.0.0:&quot;</span> <span class="token operator">+</span> 
DFS_NAMENODE_HTTP_PORT_DEFAULT<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DFS_NAMENODE_HTTP_PORT_DEFAULT <span class="token operator">=</span>
<span class="token class-name">HdfsClientConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HTTP_PORT_DEFAULT<span class="token punctuation">;</span>
<span class="token keyword">int</span> DFS_NAMENODE_HTTP_PORT_DEFAULT <span class="token operator">=</span> <span class="token number">9870</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>ç‚¹å‡» <code>startHttpServer</code> æ–¹æ³•ä¸­çš„ <code>httpServer.start()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeHttpServer.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// Hadoop è‡ªå·±å°è£…äº† HttpServerï¼Œå½¢æˆè‡ªå·±çš„ HttpServer2</span>
 <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">httpServerTemplateForNNAndJN</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span>
 httpAddr<span class="token punctuation">,</span> httpsAddr<span class="token punctuation">,</span> <span class="token string">&quot;hdfs&quot;</span><span class="token punctuation">,</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_KERBEROS_INTERNAL_SPNEGO_PRINCIPAL_K
EY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_KEYTAB_FILE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 httpServer <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>NAMENODE_ATTRIBUTE_KEY<span class="token punctuation">,</span> nn<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">JspHelper</span><span class="token punctuation">.</span>CURRENT_CONF<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ç‚¹å‡»</span>
 <span class="token function">setupServlets</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>ç‚¹å‡» <code>setupServlets</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setupServlets</span><span class="token punctuation">(</span><span class="token class-name">HttpServer2</span> httpServer<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;startupProgress&quot;</span><span class="token punctuation">,</span>
<span class="token class-name">StartupProgressServlet</span><span class="token punctuation">.</span>PATH_SPEC<span class="token punctuation">,</span> <span class="token class-name">StartupProgressServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;fsck&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/fsck&quot;</span><span class="token punctuation">,</span> <span class="token class-name">FsckServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;imagetransfer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ImageServlet</span><span class="token punctuation">.</span>PATH_SPEC<span class="token punctuation">,</span>
 <span class="token class-name">ImageServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>åŠ è½½é•œåƒæ–‡ä»¶å’Œç¼–è¾‘æ—¥å¿—</strong></p> <p>ç‚¹å‡» <code>loadNamesystem</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadNamesystem</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                                
<span class="token keyword">this</span><span class="token punctuation">.</span>namesystem <span class="token operator">=</span> <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">loadFromDisk</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//                          ----------</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">FSNamesystem</span> <span class="token function">loadFromDisk</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkConfiguration</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">//</span>
 <span class="token class-name">FSImage</span> fsImage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSImage</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span>
              <span class="token comment">//</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token class-name">FSNamesystem</span> namesystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSNamesystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> fsImage<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token class-name">StartupOption</span> startOpt <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupOption</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>startOpt <span class="token operator">==</span> <span class="token class-name">StartupOption</span><span class="token punctuation">.</span>RECOVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 namesystem<span class="token punctuation">.</span><span class="token function">setSafeMode</span><span class="token punctuation">(</span><span class="token class-name">SafeModeAction</span><span class="token punctuation">.</span>SAFEMODE_ENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> loadStart <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token comment">//</span>
 namesystem<span class="token punctuation">.</span><span class="token function">loadFSImage</span><span class="token punctuation">(</span>startOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Encountered exception loading fsimage&quot;</span><span class="token punctuation">,</span> ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsImage<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> ioe<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> timeTakenToLoadFSImage <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> loadStart<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Finished loading FSImage in &quot;</span> <span class="token operator">+</span> timeTakenToLoadFSImage <span class="token operator">+</span> <span class="token string">&quot; msecs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">NameNodeMetrics</span> nnMetrics <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getNameNodeMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>nnMetrics <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 nnMetrics<span class="token punctuation">.</span><span class="token function">setFsImageLoadTime</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> timeTakenToLoadFSImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 namesystem<span class="token punctuation">.</span><span class="token function">getFSDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createReservedStatuses</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">getCTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> namesystem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>åˆå§‹åŒ– NN çš„ RPC æœåŠ¡ç«¯</strong></p> <p>ç‚¹å‡» <code>createRpcServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">protected</span> <span class="token class-name">NameNodeRpcServer</span> <span class="token function">createRpcServer</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeRpcServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">NameNodeRpcServer</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">NameNode</span> nn<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 serviceRpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPC<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>
 <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>protocolPB<span class="token punctuation">.</span></span>ClientNamenodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>clientNNPbService<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBindAddress</span><span class="token punctuation">(</span>bindHost<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>serviceRpcAddr<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setNumHandlers</span><span class="token punctuation">(</span>serviceHandlerCount<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setSecretManager</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">getDelegationTokenSecretManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>NN å¯åŠ¨èµ„æºæ£€æŸ¥</strong></p> <p>ç‚¹å‡» <code>startCommonServices</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 namesystem<span class="token punctuation">.</span><span class="token function">startCommonServices</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> haContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">registerNNSMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">!=</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">startHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setNameNodeAddress</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setFSImage</span><span class="token punctuation">(</span><span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 plugins <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>DFS_NAMENODE_PLUGINS_KEY<span class="token punctuation">,</span>
 <span class="token class-name">ServicePlugin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">String</span> pluginsValue <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>DFS_NAMENODE_PLUGINS_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load NameNode plugins. Specified list of plugins: &quot;</span> <span class="token operator">+</span>
 pluginsValue<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>ç‚¹å‡» <code>startCommonServices</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">HAContext</span> haContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerMBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// register the MBean for the FSNamesystemState</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>haContext <span class="token operator">=</span> haContext<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 nnResourceChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç£ç›˜å­˜å‚¨å…ƒæ•°æ®ï¼ˆfsimageï¼ˆé»˜è®¤ 100mï¼‰editLogï¼ˆé»˜è®¤ 100mï¼‰ï¼‰</span>
 <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> <span class="token operator">!</span>blockManager<span class="token punctuation">.</span><span class="token function">isPopulatingReplQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">StartupProgress</span> prog <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 prog<span class="token punctuation">.</span><span class="token function">beginPhase</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> completeBlocksTotal <span class="token operator">=</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å®‰å…¨æ¨¡å¼</span>
 prog<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">,</span> STEP_AWAITING_REPORTED_BLOCKS<span class="token punctuation">,</span>
 completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¯åŠ¨å—æœåŠ¡</span>
 blockManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;startCommonServices&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>inodeAttributeProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 inodeAttributeProvider<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dir<span class="token punctuation">.</span><span class="token function">setINodeAttributeProvider</span><span class="token punctuation">(</span>inodeAttributeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 snapshotManager<span class="token punctuation">.</span><span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InetSocketAddress</span> serviceAddress <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getServiceAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>nameNodeHostName <span class="token operator">=</span> <span class="token punctuation">(</span>serviceAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 serviceAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>ç‚¹å‡» <code>NameNodeResourceChecker</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> conf<span class="token punctuation">;</span>
 volumes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CheckedVolume</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// dfs.namenode.resource.du.reserved é»˜è®¤å€¼ 1024 * 1024 * 100 =ã€‹100m</span>
 duReserved <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_DU_RESERVED_KEY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_DU_RESERVED_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> extraCheckedVolumes <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">stringCollectionAsURIs</span><span class="token punctuation">(</span>conf
 <span class="token punctuation">.</span><span class="token function">getTrimmedStringCollection</span><span class="token punctuation">(</span><span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VO
LUMES_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> localEditDirs <span class="token operator">=</span> <span class="token class-name">Collections2</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">URI</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">NNStorage</span><span class="token punctuation">.</span>LOCAL_URI_SCHEME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¯¹æ‰€æœ‰è·¯å¾„è¿›è¡Œèµ„æºæ£€æŸ¥</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>URI editsDirToCheck <span class="token operator">:</span> localEditDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">addDirToCheck</span><span class="token punctuation">(</span>editsDirToCheck<span class="token punctuation">,</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getRequiredNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>
 editsDirToCheck<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// All extra checked volumes are marked &quot;required&quot;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>URI extraDirToCheck <span class="token operator">:</span> extraCheckedVolumes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">addDirToCheck</span><span class="token punctuation">(</span>extraDirToCheck<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 minimumRedundantVolumes <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_KEY<span class="token punctuation">,</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>ç‚¹å‡» <code>checkAvailableResources</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FNNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> resourceCheckTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkState</span><span class="token punctuation">(</span>nnResourceChecker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string">&quot;nnResourceChecker not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// åˆ¤æ–­èµ„æºæ˜¯å¦è¶³å¤Ÿï¼Œä¸å¤Ÿè¿”å› false</span>
hasResourcesAvailable <span class="token operator">=</span> nnResourceChecker<span class="token punctuation">.</span><span class="token function">hasAvailableDiskSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
resourceCheckTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> resourceCheckTime<span class="token punctuation">;</span>
<span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getNameNodeMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceCheckTime</span><span class="token punctuation">(</span>resourceCheckTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAvailableDiskSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">NameNodeResourcePolicy</span><span class="token punctuation">.</span><span class="token function">areResourcesAvailable</span><span class="token punctuation">(</span>volumes<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 minimumRedundantVolumes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeResourcePolicy.java</span>
<span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">areResourcesAvailable</span><span class="token punctuation">(</span>
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CheckableNameNodeResource</span><span class="token punctuation">&gt;</span></span> resources<span class="token punctuation">,</span>
 <span class="token keyword">int</span> minimumRedundantResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// TODO: workaround:</span>
 <span class="token comment">// - during startup, if there are no edits dirs on disk, then there is</span>
<span class="token comment">// a call to areResourcesAvailable() with no dirs at all, which was</span>
 <span class="token comment">// previously causing the NN to enter safemode</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">int</span> requiredResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> redundantResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> disabledRedundantResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token comment">// åˆ¤æ–­èµ„æºæ˜¯å¦å……è¶³</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CheckableNameNodeResource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 redundantResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 disabledRedundantResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 requiredResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Short circuit - a required resource is not available. ä¸å……è¶³è¿”å› false</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">if</span> <span class="token punctuation">(</span>redundantResourceCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are no redundant resources, return true if there are any</span>
 <span class="token comment">// required resources available.</span>
 <span class="token keyword">return</span> requiredResourceCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> redundantResourceCount <span class="token operator">-</span> disabledRedundantResourceCount <span class="token operator">&gt;=</span>
 minimumRedundantResources<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">CheckableNameNodeResource</span> <span class="token punctuation">{</span>
 
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><code>ctrl + h</code>ï¼ŒæŸ¥æ‰¾å®ç°ç±»<code>CheckedVolume</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// è·å–å½“å‰ç›®å½•çš„ç©ºé—´å¤§å°</span>
 <span class="token keyword">long</span> availableSpace <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Space available on volume '&quot;</span> <span class="token operator">+</span> volume <span class="token operator">+</span> <span class="token string">&quot;' is &quot;</span>
 <span class="token operator">+</span> availableSpace<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token operator">/</span> å¦‚æœå½“å‰ç©ºé—´å¤§å°ï¼Œå°äº <span class="token number">100</span>mï¼Œè¿”å› <span class="token boolean">false</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>availableSpace <span class="token operator">&lt;</span> duReserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Space available on volume '&quot;</span> <span class="token operator">+</span> volume <span class="token operator">+</span> <span class="token string">&quot;' is &quot;</span>
 <span class="token operator">+</span> availableSpace <span class="token operator">+</span>
 <span class="token string">&quot;, which is below the configured reserved amount &quot;</span> <span class="token operator">+</span> duReserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>NN å¯¹å¿ƒè·³è¶…æ—¶åˆ¤æ–­</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Ctrl + n æœç´¢ namenodeï¼Œctrl + f æœç´¢ startCommonServices
ç‚¹å‡» namesystem.startCommonServices(conf, haContext);
ç‚¹å‡» blockManager.activate(conf, completeBlocksTotal);
ç‚¹å‡» datanodeManager.activate(conf);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DatanodeManager.java</span>
<span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanodeAdminManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeManager.java</span>
<span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¯åŠ¨çš„çº¿ç¨‹ï¼Œæœç´¢ run æ–¹æ³•</span>
 heartbeatThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">restartHeartbeatStopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lastHeartbeatCheck <span class="token operator">+</span> heartbeatRecheckInterval <span class="token operator">&lt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// å¿ƒè·³æ£€æŸ¥</span>
 <span class="token function">heartbeatCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastHeartbeatCheck <span class="token operator">=</span> now<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>blockManager<span class="token punctuation">.</span><span class="token function">shouldUpdateBlockKey</span><span class="token punctuation">(</span>now <span class="token operator">-</span> lastBlockKeyUpdate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">HeartbeatManager</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> d <span class="token operator">:</span> datanodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 d<span class="token punctuation">.</span><span class="token function">setNeedKeyUpdate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 lastBlockKeyUpdate <span class="token operator">=</span> now<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception while checking heartbeat&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 seconds</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
 <span class="token comment">// avoid declaring nodes dead for another cycle if a GC pause lasts</span>
 <span class="token comment">// longer than the node recheck interval</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAbortHeartbeatCheck</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping next heartbeat scan due to excessive pause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastHeartbeatCheck <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">heartbeatCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeManager</span> dm <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> allAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>allAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// locate the first dead node.</span>
 <span class="token class-name">DatanodeDescriptor</span> dead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// locate the first failed storage that isn't on a dead node.</span>
 <span class="token class-name">DatanodeStorageInfo</span> failedStorage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// check the number of stale nodes</span>
 <span class="token keyword">int</span> numOfStaleNodes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> numOfStaleStorages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> d <span class="token operator">:</span> datanodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// check if an excessive GC pause has occurred</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAbortHeartbeatCheck</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token comment">// åˆ¤æ–­ DN èŠ‚ç‚¹æ˜¯å¦æŒ‚æ–­</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dead <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> dm<span class="token punctuation">.</span><span class="token function">isDatanodeDead</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 stats<span class="token punctuation">.</span><span class="token function">incrExpiredHeartbeats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dead <span class="token operator">=</span> d<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">isStale</span><span class="token punctuation">(</span>dm<span class="token punctuation">.</span><span class="token function">getStaleInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 numOfStaleNodes<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> storageInfos <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">getStorageInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DatanodeStorageInfo</span> storageInfo <span class="token operator">:</span> storageInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>storageInfo<span class="token punctuation">.</span><span class="token function">areBlockContentsStale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 numOfStaleStorages<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>failedStorage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
 storageInfo<span class="token punctuation">.</span><span class="token function">areBlocksOnFailedStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
 d <span class="token operator">!=</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 failedStorage <span class="token operator">=</span> storageInfo<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// Set the number of stale nodes in the DatanodeManager</span>
 dm<span class="token punctuation">.</span><span class="token function">setNumStaleNodes</span><span class="token punctuation">(</span>numOfStaleNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 dm<span class="token punctuation">.</span><span class="token function">setNumStaleStorages</span><span class="token punctuation">(</span>numOfStaleStorages<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">boolean</span> <span class="token function">isDatanodeDead</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>
 <span class="token punctuation">(</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> heartbeatExpireInterval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> heartbeatExpireInterval<span class="token punctuation">;</span>
<span class="token comment">// 10 åˆ†é’Ÿ + 30 ç§’</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExpireInterval <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> heartbeatRecheckInterval <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> 
heartbeatIntervalSeconds<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> heartbeatRecheckInterval<span class="token punctuation">;</span>
heartbeatRecheckInterval <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_KEY<span class="token punctuation">,</span> 
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 5 minutes</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> heartbeatIntervalSeconds<span class="token punctuation">;</span>
heartbeatIntervalSeconds <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getTimeDuration</span><span class="token punctuation">(</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_HEARTBEAT_INTERVAL_KEY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_HEARTBEAT_INTERVAL_DEFAULT<span class="token punctuation">,</span> 
<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> DFS_HEARTBEAT_INTERVAL_DEFAULT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p><strong>å®‰å…¨æ¨¡å¼</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">HAContext</span> haContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerMBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// register the MBean for the FSNamesystemState</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>haContext <span class="token operator">=</span> haContext<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 nnResourceChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç£ç›˜å­˜å‚¨å…ƒæ•°æ®ï¼ˆfsimageï¼ˆé»˜è®¤ 100mï¼‰editLogï¼ˆé»˜è®¤ 100mï¼‰ï¼‰</span>
 <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> <span class="token operator">!</span>blockManager<span class="token punctuation">.</span><span class="token function">isPopulatingReplQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">StartupProgress</span> prog <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¼€å§‹è¿›å…¥å®‰å…¨æ¨¡å¼</span>
 prog<span class="token punctuation">.</span><span class="token function">beginPhase</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è·å–æ‰€æœ‰å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ block</span>
<span class="token keyword">long</span> completeBlocksTotal <span class="token operator">=</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 prog<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">,</span> STEP_AWAITING_REPORTED_BLOCKS<span class="token punctuation">,</span>
 completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¯åŠ¨å—æœåŠ¡</span>
 blockManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;startCommonServices&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>inodeAttributeProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 inodeAttributeProvider<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dir<span class="token punctuation">.</span><span class="token function">setINodeAttributeProvider</span><span class="token punctuation">(</span>inodeAttributeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 snapshotManager<span class="token punctuation">.</span><span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InetSocketAddress</span> serviceAddress <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getServiceAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>nameNodeHostName <span class="token operator">=</span> <span class="token punctuation">(</span>serviceAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 serviceAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>ç‚¹å‡» <code>getCompleteBlocksTotal</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Calculate number of blocks under construction</span>
 <span class="token keyword">long</span> numUCBlocks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// è·å–æ­£åœ¨æ„å»ºçš„ block</span>
 numUCBlocks <span class="token operator">=</span> leaseManager<span class="token punctuation">.</span><span class="token function">getNumUnderConstructionBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–æ‰€æœ‰çš„å— - æ­£åœ¨æ„å»ºçš„ block = å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ block</span>
 <span class="token keyword">return</span> <span class="token function">getBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> numUCBlocks<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">readUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;getCompleteBlocksTotal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>ç‚¹å‡» <code>activate</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token keyword">long</span> blockTotal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
pendingReconstruction<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
datanodeManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>redundancyThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;RedundancyMonitor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>redundancyThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageInfoDefragmenterThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;StorageInfoMonitor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageInfoDefragmenterThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>blockReportThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mxBeanName <span class="token operator">=</span> <span class="token class-name">MBeans</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;NameNode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BlockStats&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bmSafeMode<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>blockTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>ç‚¹å‡» <code>activate</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> status <span class="token operator">==</span> <span class="token class-name">BMSafeModeStatus</span><span class="token punctuation">.</span>OFF<span class="token punctuation">;</span>
 startTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è®¡ç®—æ˜¯å¦æ»¡è¶³å—ä¸ªæ•°çš„é˜ˆå€¼</span>
 <span class="token function">setBlockTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ DataNode èŠ‚ç‚¹å’Œå—ä¿¡æ¯æ˜¯å¦è¾¾åˆ°é€€å‡ºå®‰å…¨æ¨¡å¼æ ‡å‡†</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areThresholdsMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">boolean</span> exitResult <span class="token operator">=</span> <span class="token function">leaveSafeMode</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkState</span><span class="token punctuation">(</span>exitResult<span class="token punctuation">,</span> <span class="token string">&quot;Failed to leave safe mode.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// enter safe mode</span>
status <span class="token operator">=</span> <span class="token class-name">BMSafeModeStatus</span><span class="token punctuation">.</span>PENDING_THRESHOLD<span class="token punctuation">;</span>
<span class="token function">initializeReplQueuesIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">reportStatus</span><span class="token punctuation">(</span><span class="token string">&quot;STATE* Safe mode ON.&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastStatusReport <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ç‚¹å‡» <code>setBlockTotal</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">setBlockTotal</span><span class="token punctuation">(</span><span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockTotal <span class="token operator">=</span> total<span class="token punctuation">;</span>
<span class="token comment">// è®¡ç®—é˜ˆå€¼ï¼šä¾‹å¦‚ï¼š1000 ä¸ªæ­£å¸¸çš„å— * 0.999 = 999</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockThreshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">*</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockReplQueueThreshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">*</span> replQueueThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getFloat</span><span class="token punctuation">(</span>DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY<span class="token punctuation">,</span>
 DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> 
DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT <span class="token operator">=</span> <span class="token number">0.999f</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ç‚¹å‡»<code>areThresholdsMet</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">areThresholdsMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Calculating the number of live datanodes is time-consuming</span>
 <span class="token comment">// in large clusters. Skip it when datanodeThreshold is zero.</span>
 <span class="token keyword">int</span> datanodeNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>datanodeThreshold <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanodeNum <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNumLiveDataNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å·²ç»æ­£å¸¸æ³¨å†Œçš„å—æ•° ã€‹= å—çš„æœ€å°é˜ˆå€¼ ã€‹=æœ€å°å¯ç”¨ DataNode</span>
 <span class="token keyword">return</span> blockSafe <span class="token operator">&gt;=</span> blockThreshold <span class="token operator">&amp;&amp;</span> datanodeNum <span class="token operator">&gt;=</span> datanodeThreshold<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></details> <h2 id="dn-å¯åŠ¨æºç è§£æ"><a href="#dn-å¯åŠ¨æºç è§£æ" class="header-anchor">#</a> DN å¯åŠ¨æºç è§£æ</h2> <p><strong>DNå·¥ä½œæœºåˆ¶</strong>ï¼š<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902191421.png" alt=""></p> <p><strong>DataNodeå¯åŠ¨æºç è§£æï¼š</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904005131.png" alt=""></p> <p><strong>DNæºç è§£æè¿‡ç¨‹</strong>ï¼š</p> <details class="custom-block details"><summary>ğŸ¦“ğŸ¦“</summary> <p>pom.xml ä¸­å¢åŠ å¦‚ä¸‹ä¾èµ–</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>ctrl + n</code> å…¨å±€æŸ¥æ‰¾<code>datanode</code>ï¼Œè¿›å…¥ <code>DataNode.java</code></p> <p><code>ctrl + f</code>ï¼ŒæŸ¥æ‰¾ main æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">parseHelpArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token class-name">DataNode</span><span class="token punctuation">.</span>USAGE<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">secureMain</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">secureMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> errorCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startupShutdownMessage</span><span class="token punctuation">(</span><span class="token class-name">DataNode</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> LOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DataNode</span> datanode <span class="token operator">=</span> <span class="token function">createDataNode</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 â€¦ â€¦
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in secureMain&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exiting Datanode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">createDataNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// åˆå§‹åŒ– DN</span>
<span class="token class-name">DataNode</span> dn <span class="token operator">=</span> <span class="token function">instantiateDataNode</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¯åŠ¨ DN è¿›ç¨‹</span>
 dn<span class="token punctuation">.</span><span class="token function">runDatanodeDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> dn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">instantiateDataNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token keyword">return</span> <span class="token function">makeInstance</span><span class="token punctuation">(</span>dataLocations<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">makeInstance</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirs<span class="token punctuation">,</span>
 <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> locations<span class="token punctuation">,</span> storageLocationChecker<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirs<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">StorageLocationChecker</span> storageLocationChecker<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">super</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 hostName <span class="token operator">=</span> <span class="token function">getHostName</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Configured hostname is {}&quot;</span><span class="token punctuation">,</span> hostName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¯åŠ¨ DN</span>
 <span class="token function">startDataNode</span><span class="token punctuation">(</span>dataDirs<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> ie<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">startDataNode</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirectories<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// åˆ›å»ºæ•°æ®å­˜å‚¨å¯¹è±¡</span>
 storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// global DN settings</span>
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// åˆå§‹åŒ– DataXceiver</span>
 <span class="token function">initDataXceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// å¯åŠ¨ HttpServer</span>
 <span class="token function">startInfoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pauseMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JvmPauseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pauseMonitor<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pauseMonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// BlockPoolTokenSecretManager is required to create ipc server.</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockPoolTokenSecretManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockPoolTokenSecretManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Login is done by now. Set the DN user name.</span>
 dnUserName <span class="token operator">=</span> <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;dnUserName = {}&quot;</span><span class="token punctuation">,</span> dnUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;supergroup = {}&quot;</span><span class="token punctuation">,</span> supergroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// åˆå§‹åŒ– RPC æœåŠ¡</span>
 <span class="token function">initIpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 metrics <span class="token operator">=</span> <span class="token class-name">DataNodeMetrics</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 peerMetrics <span class="token operator">=</span> dnConf<span class="token punctuation">.</span>peerStatsEnabled <span class="token operator">?</span>
 <span class="token class-name">DataNodePeerMetrics</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 metrics<span class="token punctuation">.</span><span class="token function">getJvmMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPauseMonitor</span><span class="token punctuation">(</span>pauseMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
 ecWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErasureCodingWorker</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockRecoveryWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockRecoveryWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// åˆ›å»º BlockPoolManager</span>
 blockPoolManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockPoolManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¿ƒè·³ç®¡ç†</span>
 blockPoolManager<span class="token punctuation">.</span><span class="token function">refreshNamenodes</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Create the ReadaheadPool from the DataNode context so we can</span>
 <span class="token comment">// exit without having to explicitly shutdown its thread pool.</span>
 readaheadPool <span class="token operator">=</span> <span class="token class-name">ReadaheadPool</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 saslClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaslDataTransferClient</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dnConf<span class="token punctuation">.</span>saslPropsResolver<span class="token punctuation">,</span> dnConf<span class="token punctuation">.</span>trustedChannelResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
 saslServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaslDataTransferServer</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">,</span> blockPoolTokenSecretManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startMetricsLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>diskStatsEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 diskMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNodeDiskMetrics</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
 dnConf<span class="token punctuation">.</span>outliersReportIntervalMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p><strong>åˆå§‹åŒ– <code>DataXceiverServer</code></strong></p> <p>ç‚¹å‡» <code>initDataXceiver</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDataXceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// dataXceiverServer æ˜¯ä¸€ä¸ªæœåŠ¡ï¼ŒDN ç”¨æ¥æ¥æ”¶å®¢æˆ·ç«¯å’Œå…¶ä»– DN å‘é€è¿‡æ¥çš„æ•°æ®æœåŠ¡</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>dataXceiverServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span>threadGroup<span class="token punctuation">,</span> xserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>threadGroup<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// auto destroy when empty</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>åˆå§‹åŒ– HTTP æœåŠ¡</strong></p> <p>ç‚¹å‡» <code>startInfoServer();</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DN.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInfoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// SecureDataNodeStarter will bind the privileged port to the channel if</span>
 <span class="token comment">// the DN is started by JSVC, pass it along.</span>
 <span class="token class-name">ServerSocketChannel</span> httpServerChannel <span class="token operator">=</span> secureResources <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
 secureResources<span class="token punctuation">.</span><span class="token function">getHttpServerChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 httpServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatanodeHttpServer</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> httpServerChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>httpServer<span class="token punctuation">.</span><span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 infoPort <span class="token operator">=</span> httpServer<span class="token punctuation">.</span><span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>httpServer<span class="token punctuation">.</span><span class="token function">getHttpsAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 infoSecurePort <span class="token operator">=</span> httpServer<span class="token punctuation">.</span><span class="token function">getHttpsAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeHttpServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeHttpServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> datanode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> externalHttpChannel<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;datanode&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setConf</span><span class="token punctuation">(</span>confForInfoServer<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setACL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AccessControlList</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>DFS_ADMIN<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">hostName</span><span class="token punctuation">(</span><span class="token function">getHostnameForSpnegoPrincipal</span><span class="token punctuation">(</span>confForInfoServer<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:&quot;</span> <span class="token operator">+</span> proxyPort<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setFindPort</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>åˆå§‹åŒ– DN çš„ RPC æœåŠ¡ç«¯</strong></p> <p>ç‚¹å‡» <code>initIpcServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initIpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> ipcAddr <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTrimmed</span><span class="token punctuation">(</span>DFS_DATANODE_IPC_ADDRESS_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 ipcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPC<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">ClientDatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBindAddress</span><span class="token punctuation">(</span>ipcAddr<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>ipcAddr<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setNumHandlers</span><span class="token punctuation">(</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>DFS_DATANODE_HANDLER_COUNT_KEY<span class="token punctuation">,</span>
 DFS_DATANODE_HANDLER_COUNT_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setSecretManager</span><span class="token punctuation">(</span>blockPoolTokenSecretManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>DN å‘ NN æ³¨å†Œ</strong></p> <p>ç‚¹å‡»<code>refreshNamenodes</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// BlockPoolManager.java</span>
<span class="token keyword">void</span> <span class="token function">refreshNamenodes</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>refreshNamenodesLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">doRefreshNamenodes</span><span class="token punctuation">(</span>newAddressMap<span class="token punctuation">,</span> newLifelineAddressMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doRefreshNamenodes</span><span class="token punctuation">(</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> addrMap<span class="token punctuation">,</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> lifelineAddrMap<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 â€¦ â€¦<span class="token punctuation">.</span>
 
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 â€¦ â€¦
 <span class="token comment">// Step 3. Start new nameservices</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>toAdd<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> nsToAdd <span class="token operator">:</span> toAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 â€¦ â€¦
 <span class="token class-name">BPOfferService</span> bpos <span class="token operator">=</span> <span class="token function">createBPOS</span><span class="token punctuation">(</span>nsToAdd<span class="token punctuation">,</span> addrs<span class="token punctuation">,</span> lifelineAddrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpByNameserviceId<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nsToAdd<span class="token punctuation">,</span> bpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 offerServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">startAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">BPOfferService</span> <span class="token function">createBPOS</span><span class="token punctuation">(</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> nameserviceId<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span></span> nnAddrs<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span></span> lifelineNnAddrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// æ ¹æ® NameNode ä¸ªæ•°åˆ›å»ºå¯¹åº”çš„æœåŠ¡</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BPOfferService</span><span class="token punctuation">(</span>nameserviceId<span class="token punctuation">,</span> nnAddrs<span class="token punctuation">,</span> lifelineNnAddrs<span class="token punctuation">,</span> dn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>ç‚¹å‡» <code>startAll()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span>
 <span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BPOfferService</span> bpos <span class="token operator">:</span> offerServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¯åŠ¨æœåŠ¡</span>
 bpos<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>ç‚¹å‡» <code>start ()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPOfferService.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BPServiceActor</span> actor <span class="token operator">:</span> bpServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 actor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ç‚¹å‡» <code>start ()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPServiceActor.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 bpThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// needed for JUnit testing</span>
<span class="token comment">// è¡¨ç¤ºå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æŸ¥æ‰¾è¯¥çº¿ç¨‹çš„ run æ–¹æ³•</span>
 bpThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lifelineSender <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 lifelineSender<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>ctrl + f</code> æœç´¢ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; starting to offer service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// init stuff</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// setup storage</span>
<span class="token comment">// å‘ NN æ³¨å†Œ</span>
 <span class="token function">connectToNNAndHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Initial handshake, storage recovery or registration failed</span>
 runningState <span class="token operator">=</span> <span class="token class-name">RunningState</span><span class="token punctuation">.</span>INIT_FAILED<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldRetryInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Retry until all namenode's of BPOS failed initialization</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Initialization failed for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span>
 <span class="token operator">+</span> ioe<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ³¨å†Œå¤±è´¥ï¼Œ5s åé‡è¯•</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 runningState <span class="token operator">=</span> <span class="token class-name">RunningState</span><span class="token punctuation">.</span>FAILED<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Initialization failed for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;. Exiting. &quot;</span><span class="token punctuation">,</span> ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å‘é€å¿ƒè·³</span>
 <span class="token function">offerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">connectToNNAndHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// get NN proxy è·å– NN çš„ RPC å®¢æˆ·ç«¯å¯¹è±¡</span>
 bpNamenode <span class="token operator">=</span> dn<span class="token punctuation">.</span><span class="token function">connectToNN</span><span class="token punctuation">(</span>nnAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// First phase of the handshake with NN - get the namespace</span>
 <span class="token comment">// info.</span>
 <span class="token class-name">NamespaceInfo</span> nsInfo <span class="token operator">=</span> <span class="token function">retrieveNamespaceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Verify that this matches the other NN in this HA pair.</span>
 <span class="token comment">// This also initializes our block pool in the DN if we are</span>
 <span class="token comment">// the first NN connection for this BP.</span>
 bpos<span class="token punctuation">.</span><span class="token function">verifyAndSetNamespaceInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">/* set thread name again to include NamespaceInfo when it's available. */</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>bpThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token function">formatThreadName</span><span class="token punctuation">(</span><span class="token string">&quot;heartbeating&quot;</span><span class="token punctuation">,</span> nnAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ³¨å†Œ</span>
 <span class="token function">register</span><span class="token punctuation">(</span>nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span> <span class="token function">connectToNN</span><span class="token punctuation">(</span>
 <span class="token class-name">InetSocketAddress</span> nnAddr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span><span class="token punctuation">(</span>nnAddr<span class="token punctuation">,</span> <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeProtocolClientSideTranslatorPB.java</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> nameNodeAddr<span class="token punctuation">,</span>
 <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
RPC<span class="token punctuation">.</span><span class="token function">setProtocolEngine</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
 <span class="token class-name">ProtobufRpcEngine</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">UserGroupInformation</span> ugi <span class="token operator">=</span> <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 rpcProxy <span class="token operator">=</span> <span class="token function">createNamenode</span><span class="token punctuation">(</span>nameNodeAddr<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> ugi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DatanodeProtocolPB</span> <span class="token function">createNamenode</span><span class="token punctuation">(</span>
 <span class="token class-name">InetSocketAddress</span> nameNodeAddr<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">UserGroupInformation</span> ugi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> RPC<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
 RPC<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nameNodeAddr<span class="token punctuation">,</span> ugi<span class="token punctuation">,</span>
 conf<span class="token punctuation">,</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>ç‚¹å‡» <code>register</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPServiceActor.java</span>
<span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">NamespaceInfo</span> nsInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// åˆ›å»ºæ³¨å†Œä¿¡æ¯</span>
 <span class="token class-name">DatanodeRegistration</span> newBpRegistration <span class="token operator">=</span> bpos<span class="token punctuation">.</span><span class="token function">createRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; beginning handshake with NN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// Use returned registration from namenode with updated fields</span>
 <span class="token comment">// æŠŠæ³¨å†Œä¿¡æ¯å‘é€ç»™ NNï¼ˆDN è°ƒç”¨æ¥å£æ–¹æ³•ï¼Œæ‰§è¡Œåœ¨ NNï¼‰</span>
 newBpRegistration <span class="token operator">=</span> bpNamenode<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>newBpRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
 newBpRegistration<span class="token punctuation">.</span><span class="token function">setNamespaceInfo</span><span class="token punctuation">(</span>nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpRegistration <span class="token operator">=</span> newBpRegistration<span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">EOFException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// namenode might have just restarted</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Problem connecting to server: &quot;</span> <span class="token operator">+</span> nnAddr <span class="token operator">+</span> <span class="token string">&quot; :&quot;</span>
 <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">sleepAndLogInterrupts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;connecting to server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">SocketTimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// namenode is busy</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Problem connecting to server: &quot;</span> <span class="token operator">+</span> nnAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">sleepAndLogInterrupts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;connecting to server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>ctrl + n æœç´¢ NameNodeRpcServer
NameNodeRpcServer.java
ctrl + f åœ¨ NameNodeRpcServer.java ä¸­æœç´¢ registerDatanode
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DatanodeRegistration</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">verifySoftwareVersion</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ³¨å†Œ DN</span>
 namesystem<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> nodeReg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>

<span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 blockManager<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;registerDatanode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BlockManager.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 datanodeManager<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bmSafeMode<span class="token punctuation">.</span><span class="token function">checkSafeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">DisallowedDatanodeException</span><span class="token punctuation">,</span> <span class="token class-name">UnresolvedTopologyException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// register new datanode æ³¨å†Œ DN</span>
 <span class="token function">addDatanode</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockManager<span class="token punctuation">.</span><span class="token function">getBlockReportLeaseManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// also treat the registration message as a heartbeat</span>
 <span class="token comment">// no need to update its timestamp</span>
 <span class="token comment">// because its is done when the descriptor is created</span>
<span class="token comment">// å°† DN æ·»åŠ åˆ°å¿ƒè·³ç®¡ç†</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">addDatanode</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">updateDnStat</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">incrementVersionCount</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">.</span><span class="token function">getSoftwareVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startAdminOperationIfNecessary</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">addDatanode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// To keep host2DatanodeMap consistent with datanodeMap,</span>
 <span class="token comment">// remove from host2DatanodeMap the datanodeDescriptor removed</span>
 <span class="token comment">// from datanodeMap before adding node to host2DatanodeMap.</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 host2DatanodeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>datanodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getDatanodeUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 networktopology<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// may throw InvalidTopologyException</span>
host2DatanodeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkIfClusterIsNowMultiRack</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">resolveUpgradeDomain</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 â€¦ â€¦
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>å‘ NN å‘é€å¿ƒè·³</strong></p> <p>ç‚¹å‡» <code>BPServiceActor.java</code> ä¸­çš„ run æ–¹æ³•ä¸­çš„ <code>offerService</code> æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// BPServiceActor.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">offerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HeartbeatResponse</span> resp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>sendHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">boolean</span> requestBlockReportLease <span class="token operator">=</span> <span class="token punctuation">(</span>fullBlockReportLeaseId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
scheduler<span class="token punctuation">.</span><span class="token function">isBlockReportDue</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dn<span class="token punctuation">.</span><span class="token function">areHeartbeatsDisabledForTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å‘é€å¿ƒè·³ä¿¡æ¯</span>
 resp <span class="token operator">=</span> <span class="token function">sendHeartBeat</span><span class="token punctuation">(</span>requestBlockReportLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> resp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getFullBlockReportLeaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>fullBlockReportLeaseId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 fullBlockReportLeaseId <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getFullBlockReportLeaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatResponse</span> <span class="token function">sendHeartBeat</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> requestBlockReportLease<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// é€šè¿‡ NN çš„ RPC å®¢æˆ·ç«¯å‘é€ç»™ NN</span>
<span class="token class-name">HeartbeatResponse</span> response <span class="token operator">=</span> bpNamenode<span class="token punctuation">.</span><span class="token function">sendHeartbeat</span><span class="token punctuation">(</span>bpRegistration<span class="token punctuation">,</span>
 reports<span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getFSDataset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getFSDataset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getXmitsInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getXceiverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 numFailedVolumes<span class="token punctuation">,</span>
 volumeFailureSummary<span class="token punctuation">,</span>
 requestBlockReportLease<span class="token punctuation">,</span>
 slowPeers<span class="token punctuation">,</span>
 slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>ctrl + n æœç´¢ NameNodeRpcServer
NameNodeRpcServer.java
ctrl + f åœ¨ NameNodeRpcServer.java ä¸­æœç´¢ sendHeartbeat
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HeartbeatResponse</span> <span class="token function">sendHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> report<span class="token punctuation">,</span> <span class="token keyword">long</span> dnCacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> dnCacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xmitsInProgress<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span>
 <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span> <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> requestFullBlockReportLease<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
<span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">verifyRequest</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¤„ç† DN å‘é€çš„å¿ƒè·³</span>
 <span class="token keyword">return</span> namesystem<span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">,</span> report<span class="token punctuation">,</span>
 dnCacheCapacity<span class="token punctuation">,</span> dnCacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span> xmitsInProgress<span class="token punctuation">,</span>
 failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">,</span> requestFullBlockReportLease<span class="token punctuation">,</span>
slowPeers<span class="token punctuation">,</span> slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatResponse</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> xmitsInProgress<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> requestFullBlockReportLease<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">//get datanode commands</span>
 <span class="token keyword">final</span> <span class="token keyword">int</span> maxTransfer <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getMaxReplicationStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> xmitsInProgress<span class="token punctuation">;</span>
<span class="token comment">// å¤„ç† DN å‘é€è¿‡æ¥çš„å¿ƒè·³</span>
 <span class="token class-name">DatanodeCommand</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmds <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>
 nodeReg<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> <span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span>
 xceiverCount<span class="token punctuation">,</span> maxTransfer<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">,</span>
 slowPeers<span class="token punctuation">,</span> slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> blockReportLeaseId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>requestFullBlockReportLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 blockReportLeaseId <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">requestBlockReportLeaseId</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//create ha status</span>
 <span class="token keyword">final</span> <span class="token class-name">NNHAStatusHeartbeat</span> haState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NNHAStatusHeartbeat</span><span class="token punctuation">(</span>
 haContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrectLastAppliedOrWrittenTxId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å“åº” DN çš„å¿ƒè·³</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeartbeatResponse</span><span class="token punctuation">(</span>cmds<span class="token punctuation">,</span> haState<span class="token punctuation">,</span> rollingUpgradeInfo<span class="token punctuation">,</span>
 blockReportLeaseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">readUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;handleHeartbeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>ç‚¹å‡» <code>handleHeartbeat</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">DatanodeManager</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">DatanodeCommand</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> blockPoolId<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> 
 <span class="token keyword">int</span> maxTransfers<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>nodeinfo<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span>
 cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatManager</span><span class="token punctuation">.</span>java
<span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
stats<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockManager<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span>
 xceiverCount<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 stats<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockManager</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">,</span> <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StorageReport</span> report<span class="token operator">:</span> reports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 providedStorageMap<span class="token punctuation">.</span><span class="token function">updateStorage</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> report<span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 node<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">updateHeartbeatState</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 volFailures<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatedSinceRegistration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">updateHeartbeatState</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// æ›´æ–°å­˜å‚¨</span>
 <span class="token function">updateStorageStats</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 volFailures<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ›´æ–°å¿ƒè·³æ—¶é—´</span>
 <span class="token function">setLastUpdate</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">rollBlocksScheduled</span><span class="token punctuation">(</span><span class="token function">getLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateStorageStats</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">long</span> totalCapacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalRemaining <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalBlockPoolUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalDfsUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalNonDfsUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 â€¦ â€¦
 <span class="token function">setCacheCapacity</span><span class="token punctuation">(</span>cacheCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setCacheUsed</span><span class="token punctuation">(</span>cacheUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setXceiverCount</span><span class="token punctuation">(</span>xceiverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>volumeFailures <span class="token operator">=</span> volFailures<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>volumeFailureSummary <span class="token operator">=</span> volumeFailureSummary<span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StorageReport</span> report <span class="token operator">:</span> reports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">DatanodeStorageInfo</span> storage <span class="token operator">=</span>
 storageMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorageID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>checkFailedStorages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 failedStorageInfos<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 storage<span class="token punctuation">.</span><span class="token function">receivedHeartbeat</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// skip accounting for capacity of PROVIDED storages!</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span>PROVIDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getStorageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 totalCapacity <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalRemaining <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalBlockPoolUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getBlockPoolUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalDfsUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getDfsUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalNonDfsUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getNonDfsUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// Update total metrics for the node.</span>
 <span class="token comment">// æ›´æ–°å­˜å‚¨ç›¸å…³ä¿¡æ¯</span>
 <span class="token function">setCapacity</span><span class="token punctuation">(</span>totalCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setRemaining</span><span class="token punctuation">(</span>totalRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setBlockPoolUsed</span><span class="token punctuation">(</span>totalBlockPoolUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setDfsUsed</span><span class="token punctuation">(</span>totalDfsUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setNonDfsUsed</span><span class="token punctuation">(</span>totalNonDfsUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>checkFailedStorages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">updateFailedStorage</span><span class="token punctuation">(</span>failedStorageInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> storageMapSize<span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>storageMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 storageMapSize <span class="token operator">=</span> storageMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>storageMapSize <span class="token operator">!=</span> reports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">pruneStorageMap</span><span class="token punctuation">(</span>reports<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div></details> <h2 id="hdfs-ä¸Šä¼ æºç è§£æ"><a href="#hdfs-ä¸Šä¼ æºç è§£æ" class="header-anchor">#</a> HDFS ä¸Šä¼ æºç è§£æ</h2> <p><strong>HDFSçš„å†™æ•°æ®æµç¨‹</strong>ï¼š<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902180939.png" alt=""></p> <p><strong>ä¸Šä¼ æºç è§£æ</strong>ï¼š<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904144121.png" alt=""></p> <p><strong>æºç è§£æ</strong></p> <details class="custom-block details"><summary>ğŸ¦“ğŸ¦“ğŸ¦“</summary> <p><strong>create åˆ›å»ºè¿‡ç¨‹</strong></p> <p>æ·»åŠ ä¾èµ–:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>DN å‘ NN å‘èµ·åˆ›å»ºè¯·æ±‚</strong></p> <p>ç”¨æˆ·è‡ªå·±å†™çš„ä»£ç :</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPut2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">FSDataOutputStream</span> fos <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FileSystem.java</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token keyword">boolean</span> overwrite<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>IO_FILE_BUFFER_SIZE_KEY<span class="token punctuation">,</span>
 IO_FILE_BUFFER_SIZE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getDefaultReplication</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getDefaultBlockSize</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
<span class="token class-name">Progressable</span> progress
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token class-name">FsCreateModes</span><span class="token punctuation">.</span><span class="token function">applyUMask</span><span class="token punctuation">(</span>
<span class="token class-name">FsPermission</span><span class="token punctuation">.</span><span class="token function">getFileDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FsPermission</span><span class="token punctuation">.</span><span class="token function">getUMask</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
overwrite<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
<span class="token class-name">Progressable</span> progress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>é€‰ä¸­ createï¼Œç‚¹å‡»<code>ctrl+h</code>ï¼Œæ‰¾åˆ°å®ç°ç±» <code>DistributedFileSystem.java</code>ï¼ŒæŸ¥æ‰¾ create æ–¹æ³•ã€‚</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DistributedFileSystem.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">Progressable</span> progress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> permission<span class="token punctuation">,</span>
overwrite <span class="token operator">?</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">,</span> <span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>OVERWRITE<span class="token punctuation">)</span>
<span class="token operator">:</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">)</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> cflags<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
statistics<span class="token punctuation">.</span><span class="token function">incrementWriteOps</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageStatistics<span class="token punctuation">.</span><span class="token function">incrementOpCounter</span><span class="token punctuation">(</span><span class="token class-name">OpType</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Path</span> absF <span class="token operator">=</span> <span class="token function">fixRelativePart</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileSystemLinkResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FSDataOutputStream</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Path</span> p<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// åˆ›å»ºè·å–äº†ä¸€ä¸ªè¾“å‡ºæµå¯¹è±¡</span>
<span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> dfsos <span class="token operator">=</span> dfs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getPathName</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> permission<span class="token punctuation">,</span>
cflags<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span>
checksumOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¿™é‡Œå°†ä¸Šé¢åˆ›å»ºçš„ dfsos è¿›è¡ŒåŒ…è£…å¹¶è¿”å›</span>
<span class="token keyword">return</span> dfs<span class="token punctuation">.</span><span class="token function">createWrappedOutputStream</span><span class="token punctuation">(</span>dfsos<span class="token punctuation">,</span> statistics<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FileSystem</span> fs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Path</span> p<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> cflags<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span>
replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> absF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>ç‚¹å‡» createï¼Œè¿›å…¥<code>DFSClient.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span> <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> buffersize<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span>
 <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span>
progress<span class="token punctuation">,</span> buffersize<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span>
 <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token function">checkOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">FsPermission</span> masked <span class="token operator">=</span> <span class="token function">applyUMask</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{}: masked={}&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> masked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> result <span class="token operator">=</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">.</span><span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span>
dfsClientConf<span class="token punctuation">.</span><span class="token function">createChecksum</span><span class="token punctuation">(</span>checksumOpt<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">getFavoredNodesStr</span><span class="token punctuation">(</span>favoredNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">beginFileLease</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getFileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>ç‚¹å‡» <code>newStreamForCreate</code>ï¼Œè¿›å…¥ 1DFSOutputStream.java`</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span>
 <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span>
dfsClient<span class="token punctuation">.</span><span class="token function">newPathTraceScope</span><span class="token punctuation">(</span><span class="token string">&quot;newStreamForCreate&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">HdfsFileStatus</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// Retry the create if we get a RetryStartFileException up to a maximum</span>
 <span class="token comment">// number of times</span>
 <span class="token keyword">boolean</span> shouldRetry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> retryCount <span class="token operator">=</span> CREATE_RETRY_COUNT<span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>shouldRetry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
shouldRetry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// DN å°†åˆ›å»ºè¯·æ±‚å‘é€ç»™ NNï¼ˆRPCï¼‰</span>
 stat <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>namenode<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
 blockSize<span class="token punctuation">,</span> SUPPORTED_CRYPTO_VERSIONS<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 â€¦ â€¦<span class="token punctuation">.</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> <span class="token string">&quot;HdfsFileStatus should not be null!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> out<span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">getErasureCodingPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSStripedOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// å¼€å¯çº¿ç¨‹ runï¼ŒDataStreamer extends Daemon extends Thread</span>
out<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>NN å¤„ç† DN çš„åˆ›å»ºè¯·æ±‚</strong></p> <p>ç‚¹å‡» create</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//ClientProtocol.java
HdfsFileStatus create(String src, FsPermission masked,
 String clientName, EnumSetWritable&lt;CreateFlag&gt; flag,
 boolean createParent, short replication, long blockSize,
 CryptoProtocolVersion[] supportedVersions, String ecPolicyName)
 throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>Ctrl + h</code> æŸ¥æ‰¾ create å®ç°ç±»ï¼Œç‚¹å‡» <code>NameNodeRpcServer</code>ï¼Œåœ¨ <code>NameNodeRpcServer.java</code>ä¸­æœ ç´¢ create</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span>
 <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// æ£€æŸ¥ NN å¯åŠ¨</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HdfsFileStatus</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">PermissionStatus</span> perm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionStatus</span><span class="token punctuation">(</span><span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">getShortUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> masked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// é‡è¦</span>
 status <span class="token operator">=</span> namesystem<span class="token punctuation">.</span><span class="token function">startFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> perm<span class="token punctuation">,</span> clientName<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span>
 flag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> supportedVersions<span class="token punctuation">,</span>
 ecPolicyName<span class="token punctuation">,</span> cacheEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token class-name">RetryCache</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>cacheEntry<span class="token punctuation">,</span> status <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 metrics<span class="token punctuation">.</span><span class="token function">incrFilesCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
metrics<span class="token punctuation">.</span><span class="token function">incrCreateFileOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token class-name">HdfsFileStatus</span> <span class="token function">startFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span>
 <span class="token class-name">String</span> holder<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> logRetryCache<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">HdfsFileStatus</span> status<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 status <span class="token operator">=</span> <span class="token function">startFileInt</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> flag<span class="token punctuation">,</span>
 createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> supportedVersions<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">,</span>
 logRetryCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessControlException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">logAuditEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">logAuditEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">startFileInt</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span> <span class="token class-name">String</span> holder<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> logRetryCache<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
stat <span class="token operator">=</span> <span class="token class-name">FSDirWriteFileOp</span><span class="token punctuation">.</span><span class="token function">startFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> iip<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> holder<span class="token punctuation">,</span>
 clientMachine<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> feInfo<span class="token punctuation">,</span>
 toRemoveBlocks<span class="token punctuation">,</span> shouldReplicate<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">,</span> logRetryCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">startFile</span><span class="token punctuation">(</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">FSDirectory</span> fsd <span class="token operator">=</span> fsn<span class="token punctuation">.</span><span class="token function">getFSDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨æ ¡éªŒ</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>iip<span class="token punctuation">.</span><span class="token function">getLastINode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">INode</span><span class="token punctuation">&gt;</span></span> toRemoveINodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkedArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> toRemoveUCFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkedArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token class-name">FSDirDeleteOp</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> toRemoveBlocks<span class="token punctuation">,</span>
 toRemoveINodes<span class="token punctuation">,</span> toRemoveUCFiles<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 iip <span class="token operator">=</span> <span class="token class-name">INodesInPath</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>iip<span class="token punctuation">,</span> iip<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">FSDirDeleteOp</span><span class="token punctuation">.</span><span class="token function">incrDeletedFileCount</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsn<span class="token punctuation">.</span><span class="token function">removeLeasesAndINodes</span><span class="token punctuation">(</span>toRemoveUCFiles<span class="token punctuation">,</span> toRemoveINodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// If lease soft limit time is expired, recover the lease</span>
 fsn<span class="token punctuation">.</span><span class="token function">recoverLeaseInternal</span><span class="token punctuation">(</span><span class="token class-name">FSNamesystem<span class="token punctuation">.</span>RecoverLeaseOp</span><span class="token punctuation">.</span>CREATE_FILE<span class="token punctuation">,</span> iip<span class="token punctuation">,</span>
 src<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileAlreadyExistsException</span><span class="token punctuation">(</span>src <span class="token operator">+</span> <span class="token string">&quot; for client &quot;</span> <span class="token operator">+</span>
 clientMachine <span class="token operator">+</span> <span class="token string">&quot; already exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 fsn<span class="token punctuation">.</span><span class="token function">checkFsObjectLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">INodeFile</span> newNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token class-name">INodesInPath</span> parent <span class="token operator">=</span> <span class="token class-name">FSDirMkdirOp</span><span class="token punctuation">.</span><span class="token function">createAncestorDirectories</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// æ·»åŠ æ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯</span>
 iip <span class="token operator">=</span> <span class="token function">addFile</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> iip<span class="token punctuation">.</span><span class="token function">getLastLocalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">,</span>
 replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> shouldReplicate<span class="token punctuation">,</span>
 ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 newNode <span class="token operator">=</span> iip <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> iip<span class="token punctuation">.</span><span class="token function">getLastINode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">setNewINodeStoragePolicy</span><span class="token punctuation">(</span>fsd<span class="token punctuation">.</span><span class="token function">getBlockManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iip<span class="token punctuation">,</span> isLazyPersist<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsd<span class="token punctuation">.</span><span class="token function">getEditLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logOpenFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span> logRetryEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;DIR* NameSystem.startFile: added &quot;</span> <span class="token operator">+</span>
 src <span class="token operator">+</span> <span class="token string">&quot; inode &quot;</span> <span class="token operator">+</span> newNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token class-name">FSDirStatAndListingOp</span><span class="token punctuation">.</span><span class="token function">getFileInfo</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">INodesInPath</span> <span class="token function">addFile</span><span class="token punctuation">(</span>
 <span class="token class-name">FSDirectory</span> fsd<span class="token punctuation">,</span> <span class="token class-name">INodesInPath</span> existing<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> localName<span class="token punctuation">,</span>
 <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> preferredBlockSize<span class="token punctuation">,</span>
 <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldReplicate<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> modTime <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">INodesInPath</span> newiip<span class="token punctuation">;</span>
 fsd<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 â€¦ â€¦
 newiip <span class="token operator">=</span> fsd<span class="token punctuation">.</span><span class="token function">addINode</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> permissions<span class="token punctuation">.</span><span class="token function">getPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 fsd<span class="token punctuation">.</span><span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> newiip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">INodesInPath</span> <span class="token function">addINode</span><span class="token punctuation">(</span><span class="token class-name">INodesInPath</span> existing<span class="token punctuation">,</span> <span class="token class-name">INode</span> child<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> modes<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">QuotaExceededException</span><span class="token punctuation">,</span> <span class="token class-name">UnresolvedLinkException</span> <span class="token punctuation">{</span>
 <span class="token function">cacheName</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å°†æ•°æ®å†™å…¥åˆ° INode çš„ç›®å½•æ ‘ä¸­</span>
 <span class="token keyword">return</span> <span class="token function">addLastINode</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> child<span class="token punctuation">,</span> modes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><p><strong>DataStreamer å¯åŠ¨æµç¨‹</strong></p> <p>NN å¤„ç†å®Œ DN è¯·æ±‚åï¼Œå†æ¬¡å›åˆ° DN ç«¯ï¼Œå¯åŠ¨å¯¹åº”çš„çº¿ç¨‹</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DFSOutputStream.java</span>
<span class="token keyword">static</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span>
 <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// DN å°†åˆ›å»ºè¯·æ±‚å‘é€ç»™ NNï¼ˆRPCï¼‰</span>
stat <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>namenode<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
 blockSize<span class="token punctuation">,</span> SUPPORTED_CRYPTO_VERSIONS<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// åˆ›å»ºè¾“å‡ºæµ</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
 flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¼€å¯çº¿ç¨‹ runï¼ŒDataStreamer extends Daemon extends Thread</span>
out<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>ç‚¹å‡» <code>DFSOutputStream</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
<span class="token class-name">HdfsFileStatus</span> stat<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createStreamer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> stat<span class="token punctuation">,</span> checksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>shouldSyncBlock <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>SYNC_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Directory =&gt; File =&gt; Block(128M) =&gt; packet(64K) =&gt; chunkï¼ˆchunk 512byte + </span>
chunksum <span class="token number">4</span>byteï¼‰
 <span class="token function">computePacketChunkSize</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritePacketSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 bytesPerChecksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>createStreamer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 streamer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStreamer</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> progress<span class="token punctuation">,</span>
 checksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span> byteArrayManager<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span>
 addBlockFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ç‚¹å‡» <code>newStreamForCreate</code> æ–¹æ³•ä¸­çš„ <code>out.start()</code>ï¼Œè¿›å…¥ <code>DFSOutputStream.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">DataStreamer</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> streamer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>ç‚¹å‡» <code>DataStreamerï¼Œ</code>è¿›å…¥ <code>DataStreamer.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">DataStreamer</span> <span class="token keyword">extends</span> <span class="token class-name">Daemon</span> <span class="token punctuation">{</span>
 ã€‚ã€‚ã€‚ ã€‚ã€‚ã€‚
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ç‚¹å‡» <code>Daemon</code>ï¼Œè¿›å…¥ <code>Daemon.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Daemon</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
 ã€‚ã€‚ã€‚ ã€‚ã€‚ã€‚
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>è¯´æ˜ï¼š<code>out.start()</code>;å®é™…æ˜¯å¼€å¯çº¿ç¨‹ï¼Œç‚¹å‡» <code>DataStreamer</code>ï¼Œæœç´¢ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 â€¦ â€¦
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœ dataQueue é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œä»£ç ä¼šé˜»å¡åœ¨è¿™å„¿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
<span class="token comment">// é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä»é˜Ÿåˆ—ä¸­å–å‡º packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
â€¦ â€¦
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><strong>write ä¸Šä¼ è¿‡ç¨‹</strong></p> <p><strong>å‘ DataStreamer çš„é˜Ÿåˆ—é‡Œé¢å†™æ•°æ®</strong></p> <p>ç”¨æˆ·å†™çš„ä»£ç </p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPut2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">FSDataOutputStream</span> fos <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>ç‚¹å‡» write</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FilterOutputStream.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>off <span class="token operator">|</span> len <span class="token operator">|</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>off <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>ç‚¹å‡» write</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//OutputStream.java
public abstract void write(int b) throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>ctrl + h</code> æŸ¥æ‰¾ write å®ç°ç±»ï¼Œé€‰æ‹© <code>FSOutputSummer.java</code>ï¼Œåœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾ write</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSOutputSummer.java</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 buf<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>b<span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keep<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> flushPartial<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> bufLen <span class="token operator">=</span> count<span class="token punctuation">;</span>
 <span class="token keyword">int</span> partialLen <span class="token operator">=</span> bufLen <span class="token operator">%</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> lenToFlush <span class="token operator">=</span> flushPartial <span class="token operator">?</span> bufLen <span class="token operator">:</span> bufLen <span class="token operator">-</span> partialLen<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lenToFlush <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// å‘é˜Ÿåˆ—ä¸­å†™æ•°æ® </span>
<span class="token comment">// Directory =&gt; File =&gt; Block(128M) =&gt; package(64K) =&gt; chunkï¼ˆchunk 512byte + </span>
chunksum <span class="token number">4</span>byteï¼‰
<span class="token function">writeChecksumChunks</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> lenToFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushPartial <span class="token operator">||</span> keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 count <span class="token operator">=</span> partialLen<span class="token punctuation">;</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufLen <span class="token operator">-</span> count<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// total bytes left minus unflushed bytes left</span>
 <span class="token keyword">return</span> count <span class="token operator">-</span> <span class="token punctuation">(</span>bufLen <span class="token operator">-</span> lenToFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeChecksumChunks</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// è®¡ç®— chunk çš„æ ¡éªŒå’Œ</span>
 sum<span class="token punctuation">.</span><span class="token function">calculateChunkedSums</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token function">createWriteTraceScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æŒ‰ç…§ chunk çš„å¤§å°éå†æ•°æ®</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i <span class="token operator">+=</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">int</span> chunkLen <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> ckOffset <span class="token operator">=</span> i <span class="token operator">/</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">getChecksumSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// ä¸€ä¸ª chunk ä¸€ä¸ª chunk çš„å°†æ•°æ®å†™å…¥é˜Ÿåˆ—</span>
 <span class="token function">writeChunk</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> off <span class="token operator">+</span> i<span class="token punctuation">,</span> chunkLen<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> ckOffset<span class="token punctuation">,</span>
 <span class="token function">getChecksumSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">writeChunk</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> bOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> bLen<span class="token punctuation">,</span>
 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> checksum<span class="token punctuation">,</span> <span class="token keyword">int</span> checksumOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> checksumLen<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><code>ctrl + h</code>æŸ¥æ‰¾ <code>writeChunk</code> å®ç°ç±» <code>DFSOutputStream.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">writeChunk</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> checksum<span class="token punctuation">,</span> <span class="token keyword">int</span> ckoff<span class="token punctuation">,</span> <span class="token keyword">int</span> cklen<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
 <span class="token function">writeChunkPrepare</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> ckoff<span class="token punctuation">,</span> cklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¾€ packet é‡Œé¢å†™ chunk çš„æ ¡éªŒå’Œ 4byte</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">writeChecksum</span><span class="token punctuation">(</span>checksum<span class="token punctuation">,</span> ckoff<span class="token punctuation">,</span> cklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¾€ packet é‡Œé¢å†™ä¸€ä¸ª chunk 512 byte</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">writeData</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è®°å½•å†™å…¥ packet ä¸­çš„ chunk ä¸ªæ•°ï¼Œç´¯è®¡åˆ° 127 ä¸ª chuckï¼Œè¿™ä¸ª packet å°±æ»¡äº†</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">incNumChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBytesCurBlock</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// If packet is full, enqueue it for transmission</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPacket<span class="token punctuation">.</span><span class="token function">getNumChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> currentPacket<span class="token punctuation">.</span><span class="token function">getMaxChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytesCurBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> blockSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">enqueueCurrentPacketFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">enqueueCurrentPacketFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;enqueue full {}, src={}, bytesCurBlock={}, blockSize={},&quot;</span>
 <span class="token operator">+</span> <span class="token string">&quot; appendChunk={}, {}&quot;</span><span class="token punctuation">,</span> currentPacket<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">getBytesCurBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppendChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">enqueueCurrentPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">adjustChunkBoundary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">endBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">enqueueCurrentPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitAndQueuePacket</span><span class="token punctuation">(</span>currentPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
 currentPacket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">waitAndQueuePacket</span><span class="token punctuation">(</span><span class="token class-name">DFSPacket</span> packet<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œç­‰å¾…</span>
 <span class="token comment">// If queue is full, then wait till we have enough space</span>
 <span class="token keyword">boolean</span> firstWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span>
 dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteMaxPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>firstWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Span</span> span <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>span <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 span<span class="token punctuation">.</span><span class="token function">addTimelineAnnotation</span><span class="token punctuation">(</span><span class="token string">&quot;dataQueue.wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 firstWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token class-name">Span</span> span <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>span <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>firstWait<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 span<span class="token punctuation">.</span><span class="token function">addTimelineAnnotation</span><span class="token punctuation">(</span><span class="token string">&quot;end.wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">checkClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¦‚æœé˜Ÿåˆ—æ²¡æ»¡ï¼Œå‘é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®</span>
 <span class="token function">queuePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClosedChannelException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token keyword">void</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span><span class="token class-name">DFSPacket</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
 packet<span class="token punctuation">.</span><span class="token function">addTraceParent</span><span class="token punctuation">(</span><span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‘é˜Ÿåˆ—ä¸­æ·»åŠ æ•°æ®</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastQueuedSeqno <span class="token operator">=</span> packet<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Queued {}, {}&quot;</span><span class="token punctuation">,</span> packet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// é€šçŸ¥é˜Ÿåˆ—æ·»åŠ æ•°æ®å®Œæˆ</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>å»ºç«‹ç®¡é“ä¹‹æœºæ¶æ„ŸçŸ¥ï¼ˆå—å­˜å‚¨ä½ç½®ï¼‰</strong></p> <p><code>Ctrl + n</code>å…¨å±€æŸ¥æ‰¾ <code>DataStreamer</code>ï¼Œæœç´¢ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span>stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING <span class="token operator">||</span>
 now <span class="token operator">-</span> lastPacket <span class="token operator">&lt;</span> halfSocketTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> doSleep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> timeout <span class="token operator">=</span> halfSocketTimeout <span class="token operator">-</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>lastPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
timeout <span class="token operator">=</span> timeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> timeout<span class="token punctuation">;</span>
timeout <span class="token operator">=</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">)</span><span class="token operator">?</span>
timeout <span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœ dataQueue é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œä»£ç ä¼šé˜»å¡åœ¨è¿™å„¿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¥æ”¶åˆ° notify æ¶ˆæ¯</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// get packet to be sent.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
one <span class="token operator">=</span> <span class="token function">createHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">backOffIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä»é˜Ÿåˆ—ä¸­å–å‡º packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// get new block from namenode.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;stage=&quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_CREATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating new block: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ­¥éª¤ä¸€ï¼šå‘ NameNode ç”³è¯· block å¹¶å»ºç«‹æ•°æ®ç®¡é“</span>
 <span class="token function">setPipeline</span><span class="token punctuation">(</span><span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ­¥éª¤äºŒï¼šå¯åŠ¨ ResponseProcessor ç”¨æ¥ç›‘å¬ packet å‘é€æ˜¯å¦æˆåŠŸ</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_APPEND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">setupPipelineForAppendOrRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>streamerClosed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> lastByteOffsetInBlock <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lastByteOffsetInBlock <span class="token operator">&gt;</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;BlockSize &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
 <span class="token string">&quot; &lt; lastByteOffsetInBlock, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
â€¦ â€¦
<span class="token comment">// send the packet</span>
<span class="token class-name">SpanId</span> spanId <span class="token operator">=</span> <span class="token class-name">SpanId</span><span class="token punctuation">.</span>INVALID<span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// move packet from dataQueue to ackQueue</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>one<span class="token punctuation">.</span><span class="token function">isHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 spanId <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 one<span class="token punctuation">.</span><span class="token function">setTraceScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¥éª¤ä¸‰ï¼šä» dataQueue æŠŠè¦å‘é€çš„è¿™ä¸ª packet ç§»é™¤å‡ºå»</span>
dataQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¥éª¤å››ï¼šç„¶åå¾€ ackQueue é‡Œé¢æ·»åŠ è¿™ä¸ª packet</span>
ackQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} sending {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// write out data to remote datanode</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer#writeTo&quot;</span><span class="token punctuation">,</span> spanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å°†æ•°æ®å†™å‡ºå»</span>
 one<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>blockStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">markFirstNodeIfNotMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
â€¦ â€¦
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>ç‚¹å‡» <code>nextBlockOutputStream</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>protected LocatedBlock nextBlockOutputStream() throws IOException {
 LocatedBlock lb;
 DatanodeInfo[] nodes;
 StorageType[] nextStorageTypes;
 String[] nextStorageIDs;
 int count = dfsClient.getConf().getNumBlockWriteRetry();
 boolean success;
 final ExtendedBlock oldBlock = block.getCurrentBlock();
 do {
 errorState.resetInternalError();
 lastException.clear();
 DatanodeInfo[] excluded = getExcludedNodes();
// å‘ NN è·å–å‘å“ªä¸ª DN å†™æ•°æ®
 lb = locateFollowingBlock(
 excluded.length &gt; 0 ? excluded : null, oldBlock);
 // åˆ›å»ºç®¡é“
 success = createBlockOutputStream(nodes, nextStorageTypes, nextStorageIDs,
 0L, false);
 â€¦ â€¦
 } while (!success &amp;&amp; --count &gt;= 0);
 if (!success) {
 throw new IOException(&quot;Unable to create new block.&quot;);
 }
 return lb;
}
private LocatedBlock locateFollowingBlock(DatanodeInfo[] excluded,
 ExtendedBlock oldBlock) throws IOException {
 return DFSOutputStream.addBlock(excluded, dfsClient, src, oldBlock,
 stat.getFileId(), favoredNodes, addBlockFlags);
}
static LocatedBlock addBlock(DatanodeInfo[] excludedNodes,
 DFSClient dfsClient, String src, ExtendedBlock prevBlock, long fileId,
 String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; allocFlags)
 throws IOException {
 ... ...
 // å‘ NN è·å–å‘å“ªä¸ª DN å†™æ•°æ®
return dfsClient.namenode.addBlock(src, dfsClient.clientName, prevBlock,
 excludedNodes, fileId, favoredNodes, allocFlags);
 ... ...
}
LocatedBlock addBlock(String src, String clientName,
 ExtendedBlock previous, DatanodeInfo[] excludeNodes, long fileId,
 String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; addBlockFlags)
 throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><code>ctrl + h</code> ç‚¹å‡» <code>NameNodeRpcServer</code>ï¼Œåœ¨è¯¥ç±»ä¸­æœç´¢ <code>addBlock</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">LocatedBlock</span> <span class="token function">addBlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">,</span>
 <span class="token class-name">ExtendedBlock</span> previous<span class="token punctuation">,</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span> <span class="token keyword">long</span> fileId<span class="token punctuation">,</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> addBlockFlags<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">LocatedBlock</span> locatedBlock <span class="token operator">=</span> namesystem<span class="token punctuation">.</span><span class="token function">getAdditionalBlock</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> fileId<span class="token punctuation">,</span>
 clientName<span class="token punctuation">,</span> previous<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> addBlockFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>locatedBlock <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 metrics<span class="token punctuation">.</span><span class="token function">incrAddBlockOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> locatedBlock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystrm.java</span>
<span class="token class-name">LocatedBlock</span> <span class="token function">getAdditionalBlock</span><span class="token punctuation">(</span>
 <span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token keyword">long</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> previous<span class="token punctuation">,</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> operationName <span class="token operator">=</span> <span class="token string">&quot;getAdditionalBlock&quot;</span><span class="token punctuation">;</span>
 <span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;BLOCK* getAdditionalBlock: {} inodeId {}&quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot; for {}&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// é€‰æ‹©å—å­˜å‚¨ä½ç½®</span>
 <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> <span class="token class-name">FSDirWriteFileOp</span><span class="token punctuation">.</span><span class="token function">chooseTargetForNewBlock</span><span class="token punctuation">(</span>
 blockManager<span class="token punctuation">,</span> src<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTargetForNewBlock</span><span class="token punctuation">(</span>
 <span class="token class-name">BlockManager</span> bm<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">,</span>
 <span class="token class-name">ValidateAddBlockResult</span> r<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> bm<span class="token punctuation">.</span><span class="token function">chooseTarget4NewBlock</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> r<span class="token punctuation">.</span>numTargets<span class="token punctuation">,</span> clientNode<span class="token punctuation">,</span>
 excludedNodesSet<span class="token punctuation">,</span> r<span class="token punctuation">.</span>blockSize<span class="token punctuation">,</span>
favoredNodesList<span class="token punctuation">,</span> r<span class="token punctuation">.</span>storagePolicyID<span class="token punctuation">,</span>
r<span class="token punctuation">.</span>blockType<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ecPolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget4NewBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token keyword">final</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> blockplacement<span class="token punctuation">.</span><span class="token function">chooseTarget</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span>
 numOfReplicas<span class="token punctuation">,</span> client<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> 
 favoredDatanodeDescriptors<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> targets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span> <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">&gt;</span></span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
 <span class="token keyword">return</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> 
 <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> srcPath<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosen<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
<span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p><code>Crtl + h</code>æŸ¥æ‰¾ <code>chooseTarget</code> å®ç°ç±» <code>BlockPlacementPolicyDefault.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> srcPath<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosenNodes<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> chosenNodes<span class="token punctuation">,</span> returnChosenNodes<span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosenStorage<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> addBlockFlags<span class="token punctuation">,</span>
 <span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageType</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
â€¦ â€¦
 
 <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token function">getMaxNodesPerRack</span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> numOfReplicas<span class="token punctuation">)</span><span class="token punctuation">;</span>
 numOfReplicas <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> maxNodesPerRack <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DatanodeStorageInfo</span> storage <span class="token operator">:</span> chosenStorage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// add localMachine and related nodes to excludedNodes</span>
<span class="token comment">// è·å–ä¸å¯ç”¨çš„ DN</span>
 <span class="token function">addToExcludedNodes</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> excludedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token class-name">Node</span> localNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> avoidStaleNodes <span class="token operator">=</span> <span class="token punctuation">(</span>stats <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span><span class="token function">isAvoidingStaleDataNodesForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// </span>
 <span class="token keyword">boolean</span> avoidLocalNode <span class="token operator">=</span> <span class="token punctuation">(</span>addBlockFlags <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> addBlockFlags<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">.</span>NO_LOCAL_WRITE<span class="token punctuation">)</span>
 <span class="token operator">&amp;&amp;</span> writer <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>excludedNodes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Attempt to exclude local node if the client suggests so. If no enough</span>
 <span class="token comment">// nodes can be obtained, it falls back to the default block placement</span>
 <span class="token comment">// policy.</span>
 <span class="token comment">// æœ‰æ•°æ®æ­£åœ¨å†™ï¼Œé¿å…éƒ½å†™å…¥æœ¬åœ°</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>avoidLocalNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodeCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>excludedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 excludedNodeCopy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 localNode <span class="token operator">=</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span>
 excludedNodeCopy<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span>
 avoidStaleNodes<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">noneOf</span><span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> numOfReplicas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// not enough nodes; discard results and fall back</span>
 results <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// çœŸæ­£çš„é€‰æ‹© DN èŠ‚ç‚¹</span>
 localNode <span class="token operator">=</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span>
 blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span>
 storagePolicy<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">noneOf</span><span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 sTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnChosenNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
 results<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// sorting nodes to form a pipeline</span>
 <span class="token keyword">return</span> <span class="token function">getPipeline</span><span class="token punctuation">(</span>
<span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> writer <span class="token keyword">instanceof</span> <span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">)</span> <span class="token operator">?</span> writer
 <span class="token operator">:</span> localNode<span class="token punctuation">,</span>
 results<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 writer <span class="token operator">=</span> <span class="token function">chooseTargetInOrder</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span>
 maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> newBlock<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">Node</span> <span class="token function">chooseTargetInOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span> 
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> maxNodesPerRack<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> avoidStaleNodes<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> newBlock<span class="token punctuation">,</span>
<span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageType</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storageTypes<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">NotEnoughReplicasException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token keyword">int</span> numOfResults <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// ç¬¬ä¸€ä¸ªå—å­˜å‚¨åœ¨å½“å‰èŠ‚ç‚¹</span>
 <span class="token class-name">DatanodeStorageInfo</span> storageInfo <span class="token operator">=</span> <span class="token function">chooseLocalStorage</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span>
 storageTypes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 writer <span class="token operator">=</span> <span class="token punctuation">(</span>storageInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> storageInfo<span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> dn0 <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// ç¬¬äºŒä¸ªå—å­˜å‚¨åœ¨å¦å¤–ä¸€ä¸ªæœºæ¶</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">chooseRemoteRack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dn0<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> dn1 <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¦‚æœç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªåœ¨åŒä¸€ä¸ªæœºæ¶ï¼Œé‚£ä¹ˆç¬¬ä¸‰ä¸ªæ”¾åœ¨å…¶ä»–æœºæ¶</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterMap<span class="token punctuation">.</span><span class="token function">isOnSameRack</span><span class="token punctuation">(</span>dn0<span class="token punctuation">,</span> dn1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">chooseRemoteRack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dn0<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newBlock<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœæ˜¯æ–°å—ï¼Œå’Œç¬¬äºŒä¸ªå—å­˜å‚¨åœ¨åŒä¸€ä¸ªæœºæ¶</span>
 <span class="token function">chooseLocalRack</span><span class="token punctuation">(</span>dn1<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœä¸æ˜¯æ–°å—ï¼Œæ”¾åœ¨å½“å‰æœºæ¶</span>
 <span class="token function">chooseLocalRack</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">chooseRandom</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> <span class="token class-name">NodeBase</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span>
 maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br></div></div><p><strong>å»ºç«‹ç®¡é“ä¹‹ Socket å‘é€</strong></p> <p>ç‚¹å‡» <code>nextBlockOutputStream</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">LocatedBlock</span> <span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">LocatedBlock</span> lb<span class="token punctuation">;</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodes<span class="token punctuation">;</span>
 <span class="token class-name">StorageType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextStorageTypes<span class="token punctuation">;</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextStorageIDs<span class="token punctuation">;</span>
 <span class="token keyword">int</span> count <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNumBlockWriteRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> oldBlock <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">getCurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">resetInternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastException<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excluded <span class="token operator">=</span> <span class="token function">getExcludedNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‘ NN è·å–å‘å“ªä¸ª DN å†™æ•°æ®</span>
 lb <span class="token operator">=</span> <span class="token function">locateFollowingBlock</span><span class="token punctuation">(</span>
 excluded<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> excluded <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> oldBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// åˆ›å»ºç®¡é“</span>
 success <span class="token operator">=</span> <span class="token function">createBlockOutputStream</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> nextStorageTypes<span class="token punctuation">,</span> nextStorageIDs<span class="token punctuation">,</span>
 <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 â€¦ â€¦
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>count <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create new block.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">boolean</span> <span class="token function">createBlockOutputStream</span><span class="token punctuation">(</span><span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodes<span class="token punctuation">,</span>
 <span class="token class-name">StorageType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodeStorageTypes<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodeStorageIDs<span class="token punctuation">,</span>
 <span class="token keyword">long</span> newGS<span class="token punctuation">,</span> <span class="token keyword">boolean</span> recoveryFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// å’Œ DN åˆ›å»º socket</span>
s <span class="token operator">=</span> <span class="token function">createSocketForPipeline</span><span class="token punctuation">(</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nodes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> dfsClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–è¾“å‡ºæµï¼Œç”¨äºå†™æ•°æ®åˆ° DN</span>
<span class="token class-name">OutputStream</span> unbufOut <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–è¾“å…¥æµï¼Œç”¨äºè¯»å–å†™æ•°æ®åˆ° DN çš„ç»“æœ</span>
 <span class="token class-name">InputStream</span> unbufIn <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">IOStreamPair</span> saslStreams <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>saslClient<span class="token punctuation">.</span><span class="token function">socketSend</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>
 unbufOut<span class="token punctuation">,</span> unbufIn<span class="token punctuation">,</span> dfsClient<span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 unbufOut <span class="token operator">=</span> saslStreams<span class="token punctuation">.</span>out<span class="token punctuation">;</span>
 unbufIn <span class="token operator">=</span> saslStreams<span class="token punctuation">.</span>in<span class="token punctuation">;</span>
 out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>unbufOut<span class="token punctuation">,</span>
 <span class="token class-name">DFSUtilClient</span><span class="token punctuation">.</span><span class="token function">getSmallBufferSize</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockReplyStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>unbufIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‘é€æ•°æ®</span>
<span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>blockCopy<span class="token punctuation">,</span> nodeStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span>
 dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> nodeStorageTypes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bcs<span class="token punctuation">,</span>
 nodes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytesSent<span class="token punctuation">,</span> newGS<span class="token punctuation">,</span>
 checksum4WriteBlock<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isLazyPersistFile<span class="token punctuation">,</span>
 <span class="token punctuation">(</span>targetPinnings <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetPinnings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 nodeStorageIDs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nodeStorageIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">send</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token class-name">Op</span><span class="token punctuation">.</span>WRITE_BLOCK<span class="token punctuation">,</span> proto<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p><strong>å»ºç«‹ç®¡é“ä¹‹ Socket æ¥æ”¶</strong></p> <p><code>Ctrl +n</code> å…¨å±€æŸ¥æ‰¾ <code>DataXceiverServer.java</code>ï¼Œåœ¨è¯¥ç±»ä¸­æŸ¥æ‰¾ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Peer</span> peer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>datanode<span class="token punctuation">.</span>shouldRun <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>datanode<span class="token punctuation">.</span>shutdownForUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// æ¥æ”¶ socket çš„è¯·æ±‚</span>
 peer <span class="token operator">=</span> peerServer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Make sure the xceiver count is not exceeded</span>
 <span class="token keyword">int</span> curXceiverCount <span class="token operator">=</span> datanode<span class="token punctuation">.</span><span class="token function">getXceiverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>curXceiverCount <span class="token operator">&gt;</span> maxXceiverCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Xceiver count &quot;</span> <span class="token operator">+</span> curXceiverCount
 <span class="token operator">+</span> <span class="token string">&quot; exceeds the limit of concurrent xcievers: &quot;</span>
 <span class="token operator">+</span> maxXceiverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// å®¢æˆ·ç«¯æ¯å‘é€ä¸€ä¸ª blockï¼Œéƒ½å¯åŠ¨ä¸€ä¸ª DataXceiver å»å¤„ç† block</span>
 <span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span>datanode<span class="token punctuation">.</span>threadGroup<span class="token punctuation">,</span>
 <span class="token class-name">DataXceiver</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> datanode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketTimeoutException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>ç‚¹å‡» <code>DataXceiverï¼ˆçº¿ç¨‹ï¼‰</code>ï¼ŒæŸ¥æ‰¾ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> opsProcessed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token class-name">Op</span> op <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 xceiver <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 dataXceiverServer<span class="token punctuation">.</span><span class="token function">addPeer</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 peer<span class="token punctuation">.</span><span class="token function">setWriteTimeout</span><span class="token punctuation">(</span>datanode<span class="token punctuation">.</span><span class="token function">getDnConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>socketWriteTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InputStream</span> input <span class="token operator">=</span> socketIn<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOStreamPair</span> saslStreams <span class="token operator">=</span> datanode<span class="token punctuation">.</span>saslServer<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> socketOut<span class="token punctuation">,</span>
 socketIn<span class="token punctuation">,</span> datanode<span class="token punctuation">.</span><span class="token function">getXferAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
 <span class="token function">updateCurrentThreadName</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for operation #&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token comment">// è¯»å–è¿™æ¬¡æ•°æ®çš„è¯·æ±‚ç±»å‹</span>
 op <span class="token operator">=</span> <span class="token function">readOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Time out while we wait for client rpc</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EOFException</span> <span class="token operator">|</span> <span class="token class-name">ClosedChannelException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Since we optimistically expect the next op, it's quite normal to</span>
 <span class="token comment">// get EOF here.</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cached {} closing after {} ops. &quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;This message is usually benign.&quot;</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> opsProcessed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">incrDatanodeNetworkErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// restore normal timeout</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 opStartTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ ¹æ®æ“ä½œç±»å‹å¤„ç†æˆ‘ä»¬çš„æ•°æ®</span>
 <span class="token function">processOp</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">++</span>opsProcessed<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>peer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processOp</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">switch</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">case</span> WRITE_BLOCK<span class="token operator">:</span>
 <span class="token function">opWriteBlock</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">default</span><span class="token operator">:</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown op &quot;</span> <span class="token operator">+</span> op <span class="token operator">+</span> <span class="token string">&quot; in data stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">opWriteBlock</span><span class="token punctuation">(</span><span class="token class-name">DataInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">OpWriteBlockProto</span> proto <span class="token operator">=</span> <span class="token class-name">OpWriteBlockProto</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span><span class="token function">vintPrefixed</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">TraceScope</span> traceScope <span class="token operator">=</span> <span class="token function">continueTraceSpan</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertStorageType</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getStorageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 targets<span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertStorageTypes</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetStorageTypesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">fromProto</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getPipelineSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getMinBytesRcvd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span><span class="token function">getMaxBytesRcvd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getLatestGenerationStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">fromProto</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getRequestedChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasCachingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 <span class="token function">getCachingStrategy</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getCachingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
 <span class="token class-name">CachingStrategy</span><span class="token punctuation">.</span><span class="token function">newDefaultStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasAllowLazyPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> proto<span class="token punctuation">.</span><span class="token function">getAllowLazyPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasPinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> proto<span class="token punctuation">.</span><span class="token function">getPinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertBooleanList</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetPinningsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getStorageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getTargetStorageIdsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>traceScope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> traceScope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p><code>Ctrl +alt +b</code> æŸ¥æ‰¾ <code>writeBlock</code> çš„å®ç°ç±» <code>DataXceiver.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">Replica</span> replica<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isDatanode <span class="token operator">||</span> 
 stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_CLOSE_RECOVERY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// open a block receiver</span>
 <span class="token comment">// åˆ›å»ºä¸€ä¸ª BlockReceiver</span>
 <span class="token function">setCurrentBlockReceiver</span><span class="token punctuation">(</span><span class="token function">getBlockReceiver</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> storageType<span class="token punctuation">,</span> in<span class="token punctuation">,</span>
 peer<span class="token punctuation">.</span><span class="token function">getRemoteAddressString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 peer<span class="token punctuation">.</span><span class="token function">getLocalAddressString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 stage<span class="token punctuation">,</span> latestGenerationStamp<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 clientname<span class="token punctuation">,</span> srcDataNode<span class="token punctuation">,</span> datanode<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span>
 cachingStrategy<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">,</span> pinning<span class="token punctuation">,</span> storageId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 replica <span class="token operator">=</span> blockReceiver<span class="token punctuation">.</span><span class="token function">getReplica</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 replica <span class="token operator">=</span> datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">recoverClose</span><span class="token punctuation">(</span>
 block<span class="token punctuation">,</span> latestGenerationStamp<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 storageUuid <span class="token operator">=</span> replica<span class="token punctuation">.</span><span class="token function">getStorageUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 isOnTransientStorage <span class="token operator">=</span> replica<span class="token punctuation">.</span><span class="token function">isOnTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//</span>
 <span class="token comment">// Connect to downstream machine, if appropriate</span>
 <span class="token comment">// ç»§ç»­è¿æ¥ä¸‹æ¸¸çš„æœºå™¨</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>targets<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> mirrorTarget <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// Connect to backup machine</span>
 mirrorNode <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getXferAddr</span><span class="token punctuation">(</span>connectToDnViaHostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Connecting to datanode {}&quot;</span><span class="token punctuation">,</span> mirrorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 mirrorTarget <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>mirrorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å‘æ–°çš„å‰¯æœ¬å‘é€ socket</span>
 mirrorSock <span class="token operator">=</span> datanode<span class="token punctuation">.</span><span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>targetPinnings <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetPinnings<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¾€ä¸‹æ¸¸ socket å‘é€æ•°æ®</span>
 <span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>mirrorOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>originalBlock<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 blockToken<span class="token punctuation">,</span> clientname<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">,</span>
 srcDataNode<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> pipelineSize<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 latestGenerationStamp<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span>
 allowLazyPersist<span class="token punctuation">,</span> targetPinnings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 targetStorageId<span class="token punctuation">,</span> targetStorageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>mirrorOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>originalBlock<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 blockToken<span class="token punctuation">,</span> clientname<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">,</span>
 srcDataNode<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> pipelineSize<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 latestGenerationStamp<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span>
 allowLazyPersist<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 targetStorageId<span class="token punctuation">,</span> targetStorageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 mirrorOut<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DataNodeFaultInjector</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlockAfterFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// read connect ack (only for clients, not for replication req)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">BlockOpResponseProto</span> connectAck <span class="token operator">=</span>
 <span class="token class-name">BlockOpResponseProto</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">vintPrefixed</span><span class="token punctuation">(</span>mirrorIn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 mirrorInStatus <span class="token operator">=</span> connectAck<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 firstBadLink <span class="token operator">=</span> connectAck<span class="token punctuation">.</span><span class="token function">getFirstBadLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>mirrorInStatus <span class="token operator">!=</span> SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Datanode {} got response for connect&quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;ack from downstream datanode with firstbadlink as {}&quot;</span><span class="token punctuation">,</span>
 targets<span class="token punctuation">.</span>length<span class="token punctuation">,</span> firstBadLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 â€¦ â€¦
 <span class="token comment">//update metrics</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWriteBlockOp</span><span class="token punctuation">(</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrWritesFromClient</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">isLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockReceiver</span> <span class="token function">getBlockReceiver</span><span class="token punctuation">(</span>
 <span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> block<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> in<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> inAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> myAddr<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockConstructionStage</span> stage<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">long</span> newGs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minBytesRcvd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxBytesRcvd<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> clientname<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span> srcDataNode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> dn<span class="token punctuation">,</span> <span class="token class-name">DataChecksum</span> requestedChecksum<span class="token punctuation">,</span>
 <span class="token class-name">CachingStrategy</span> cachingStrategy<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> pinning<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> storageId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BlockReceiver</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> storageType<span class="token punctuation">,</span> in<span class="token punctuation">,</span>
 inAddr<span class="token punctuation">,</span> myAddr<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> newGs<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 clientname<span class="token punctuation">,</span> srcDataNode<span class="token punctuation">,</span> dn<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span>
 cachingStrategy<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">,</span> pinning<span class="token punctuation">,</span> storageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockReceiver</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> block<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> in<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> inAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> myAddr<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockConstructionStage</span> stage<span class="token punctuation">,</span> 
 <span class="token keyword">final</span> <span class="token keyword">long</span> newGs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minBytesRcvd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxBytesRcvd<span class="token punctuation">,</span> 
 <span class="token keyword">final</span> <span class="token class-name">String</span> clientname<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span> srcDataNode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> datanode<span class="token punctuation">,</span> <span class="token class-name">DataChecksum</span> requestedChecksum<span class="token punctuation">,</span>
 <span class="token class-name">CachingStrategy</span> cachingStrategy<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> pinning<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> storageId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>isDatanode<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//replication or move</span>
 replicaHandler <span class="token operator">=</span>
 datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">createTemporary</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">case</span> PIPELINE_SETUP_CREATE<span class="token operator">:</span>
 <span class="token comment">// åˆ›å»ºç®¡é“</span>
 replicaHandler <span class="token operator">=</span> datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span>
 block<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">)</span><span class="token punctuation">;</span>
datanode<span class="token punctuation">.</span><span class="token function">notifyNamenodeReceivingBlock</span><span class="token punctuation">(</span>
 block<span class="token punctuation">,</span> replicaHandler<span class="token punctuation">.</span><span class="token function">getReplica</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorageUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unsupported stage &quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> 
 <span class="token string">&quot; while receiving block &quot;</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaHandler</span> <span class="token function">createRbw</span><span class="token punctuation">(</span>
 <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span> <span class="token class-name">String</span> storageId<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseableLock</span> lock <span class="token operator">=</span> datasetLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 ref <span class="token operator">=</span> volumes<span class="token punctuation">.</span><span class="token function">getNextVolume</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">FsVolumeImpl</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FsVolumeImpl</span><span class="token punctuation">)</span> ref<span class="token punctuation">.</span><span class="token function">getVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// create an rbw file to hold block in the designated volume</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>allowLazyPersist <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>v<span class="token punctuation">.</span><span class="token function">isTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrRamDiskBlocksWriteFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">ReplicaInPipeline</span> newReplicaInfo<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// åˆ›å»ºè¾“å‡ºæµçš„ä¸´æ—¶å†™æ–‡ä»¶</span>
 newReplicaInfo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;CreateRBW returned a replica of state &quot;</span>
 <span class="token operator">+</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot; for block &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 volumeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaHandler</span><span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaHandler</span> <span class="token function">createRbw</span><span class="token punctuation">(</span>
 <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span> <span class="token class-name">String</span> storageId<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseableLock</span> lock <span class="token operator">=</span> datasetLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// æœ‰å¯èƒ½æœ‰å¤šä¸ªä¸´æ—¶å†™æ–‡ä»¶</span>
 ref <span class="token operator">=</span> volumes<span class="token punctuation">.</span><span class="token function">getNextVolume</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token class-name">FsVolumeImpl</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FsVolumeImpl</span><span class="token punctuation">)</span> ref<span class="token punctuation">.</span><span class="token function">getVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// create an rbw file to hold block in the designated volume</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>allowLazyPersist <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>v<span class="token punctuation">.</span><span class="token function">isTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrRamDiskBlocksWriteFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">ReplicaInPipeline</span> newReplicaInfo<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// åˆ›å»ºè¾“å‡ºæµçš„ä¸´æ—¶å†™æ–‡ä»¶</span>
 newReplicaInfo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;CreateRBW returned a replica of state &quot;</span>
 <span class="token operator">+</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot; for block &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 volumeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaHandler</span><span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaInPipeline</span> <span class="token function">createRbw</span><span class="token punctuation">(</span><span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token function">createRbwFile</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getLocalBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">LocalReplicaInPipeline</span> newReplicaInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaBuilder</span><span class="token punctuation">(</span><span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBlockId</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setGenerationStamp</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getGenerationStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setFsVolume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setDirectoryToUse</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBytesToReserve</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">buildLocalReplicaInPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> newReplicaInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br></div></div><p><strong>å®¢æˆ·ç«¯æ¥æ”¶ DN å†™æ•°æ®åº”ç­” Response</strong></p> <p><code>Ctrl + n</code>å…¨å±€æŸ¥æ‰¾ <code>DataStreamer</code>ï¼Œæœç´¢ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span>stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING <span class="token operator">||</span>
 now <span class="token operator">-</span> lastPacket <span class="token operator">&lt;</span> halfSocketTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> doSleep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> timeout <span class="token operator">=</span> halfSocketTimeout <span class="token operator">-</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>lastPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
timeout <span class="token operator">=</span> timeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> timeout<span class="token punctuation">;</span>
timeout <span class="token operator">=</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">)</span><span class="token operator">?</span>
timeout <span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å¦‚æœ dataQueue é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œä»£ç ä¼šé˜»å¡åœ¨è¿™å„¿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¥æ”¶åˆ° notify æ¶ˆæ¯</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// get packet to be sent.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
one <span class="token operator">=</span> <span class="token function">createHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">backOffIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä»é˜Ÿåˆ—ä¸­å–å‡º packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// get new block from namenode.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;stage=&quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_CREATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating new block: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ­¥éª¤ä¸€ï¼šå‘ NameNode ç”³è¯· block å¹¶å»ºç«‹æ•°æ®ç®¡é“</span>
<span class="token function">setPipeline</span><span class="token punctuation">(</span><span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// æ­¥éª¤äºŒï¼šå¯åŠ¨ ResponseProcessor ç”¨æ¥ç›‘å¬ packet å‘é€æ˜¯å¦æˆåŠŸ</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_APPEND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Append to block {}&quot;</span><span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setupPipelineForAppendOrRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>streamerClosed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> lastByteOffsetInBlock <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lastByteOffsetInBlock <span class="token operator">&gt;</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;BlockSize &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
 <span class="token string">&quot; &lt; lastByteOffsetInBlock, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">isLastPacketInBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for all data packets have been successfully acked</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// wait for acks to arrive from datanodes</span>
dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 stage <span class="token operator">=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_CLOSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// send the packet</span>
<span class="token class-name">SpanId</span> spanId <span class="token operator">=</span> <span class="token class-name">SpanId</span><span class="token punctuation">.</span>INVALID<span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// move packet from dataQueue to ackQueue</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>one<span class="token punctuation">.</span><span class="token function">isHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 spanId <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 one<span class="token punctuation">.</span><span class="token function">setTraceScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¥éª¤ä¸‰ï¼šä» dataQueue æŠŠè¦å‘é€çš„è¿™ä¸ª packet ç§»é™¤å‡ºå»</span>
dataQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ­¥éª¤å››ï¼šç„¶åå¾€ ackQueue é‡Œé¢æ·»åŠ è¿™ä¸ª packet</span>
ackQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} sending {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// write out data to remote datanode</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer#writeTo&quot;</span><span class="token punctuation">,</span> spanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// å°†æ•°æ®å†™å‡ºå»</span>
 one<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>blockStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">markFirstNodeIfNotMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// update bytesSent</span>
<span class="token keyword">long</span> tmpBytesSent <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bytesSent <span class="token operator">&lt;</span> tmpBytesSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 bytesSent <span class="token operator">=</span> tmpBytesSent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Is this block full?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">isLastPacketInBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for the close packet has been acked</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// wait for acks to arrive from datanodes</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">endBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> progress<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// This is used by unit test to trigger race conditions.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>artificialSlowdown <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>artificialSlowdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">closeInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer for file &quot;</span> <span class="token operator">+</span> src <span class="token operator">+</span>
 <span class="token string">&quot; block &quot;</span> <span class="token operator">+</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseProcessor</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 response<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 stage <span class="token operator">=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br></div></div><p>ç‚¹å‡» <code>response</code> å†ç‚¹å‡» <code>ResponseProcessor</code>ï¼Œ<code>ctrl + f</code> æŸ¥æ‰¾ run æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ackQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>seqno<span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></details> <h2 id="yarn-æºç è§£æ"><a href="#yarn-æºç è§£æ" class="header-anchor">#</a> Yarn æºç è§£æ</h2> <p><strong>Yarnå·¥ä½œæœºåˆ¶</strong>ï¼š<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210903162200.png" alt=""></p> <p><strong>æºç è§£æå›¾</strong>ï¼š<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904151511.png" alt=""></p> <p><strong>æºç è§£æ</strong>ï¼š</p> <details class="custom-block details"><summary>ğŸ¦“ğŸ¦“ğŸ¦“ğŸ¦“</summary> <p>Yarn å®¢æˆ·ç«¯å‘ RM æäº¤ä½œä¸š</p> <p>åœ¨ <code>wordcount</code> ç¨‹åºçš„é©±åŠ¨ç±»ä¸­ç‚¹å‡»</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Job.java</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> verbose
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span>
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">JobState</span><span class="token punctuation">.</span>DEFINE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">monitorAndPrintJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// get the completion poll interval from the client.</span>
 <span class="token keyword">int</span> completionPollIntervalMillis <span class="token operator">=</span> 
 <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getCompletionPollInterval</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>completionPollIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token function">ensureState</span><span class="token punctuation">(</span><span class="token class-name">JobState</span><span class="token punctuation">.</span>DEFINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setUseNewAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">JobSubmitter</span> submitter <span class="token operator">=</span> 
 <span class="token function">getJobSubmitter</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 status <span class="token operator">=</span> ugi<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> submitter<span class="token punctuation">.</span><span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 state <span class="token operator">=</span> <span class="token class-name">JobState</span><span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The url to track the job: &quot;</span> <span class="token operator">+</span> <span class="token function">getTrackingURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>ç‚¹å‡» <code>submitJobInternal()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//JobSubmitter.java</span>
<span class="token class-name">JobStatus</span> <span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span> job<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> 
 <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 status <span class="token operator">=</span> submitClient<span class="token punctuation">.</span><span class="token function">submitJob</span><span class="token punctuation">(</span>
 jobId<span class="token punctuation">,</span> submitJobDir<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">submitJob</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> 
ts<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>åˆ›å»ºæäº¤ç¯å¢ƒ</strong></p> <p><code>ctrl + alt +B</code> æŸ¥æ‰¾ <code>submitJob</code> å®ç°ç±»ï¼Œ<code>YARNRunner.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">submitJob</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> 
ts<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 
 <span class="token function">addHistoryToken</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// åˆ›å»ºæäº¤ç¯å¢ƒï¼š</span>
 <span class="token class-name">ApplicationSubmissionContext</span> appContext <span class="token operator">=</span>
 <span class="token function">createApplicationSubmissionContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Submit to ResourceManager</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å‘ RM æäº¤ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼ŒappContext é‡Œé¢å°è£…äº†å¯åŠ¨ mrappMaster å’Œè¿è¡Œ container</span>
çš„å‘½ä»¤
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span>
 resMgrDelegate<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// è·å–æäº¤å“åº”</span>
 <span class="token class-name">ApplicationReport</span> appMaster <span class="token operator">=</span> resMgrDelegate
 <span class="token punctuation">.</span><span class="token function">getApplicationReport</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">String</span> diagnostics <span class="token operator">=</span>
 <span class="token punctuation">(</span>appMaster <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
 <span class="token string">&quot;application report is null&quot;</span> <span class="token operator">:</span> appMaster<span class="token punctuation">.</span><span class="token function">getDiagnostics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>appMaster <span class="token operator">==</span> <span class="token keyword">null</span>
 <span class="token operator">||</span> appMaster<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> 
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>FAILED
 <span class="token operator">||</span> appMaster<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> 
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>KILLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to run job : &quot;</span> <span class="token operator">+</span>
 diagnostics<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> clientCache<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJobStatus</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">YarnException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ApplicationSubmissionContext</span> <span class="token function">createApplicationSubmissionContext</span><span class="token punctuation">(</span>
 <span class="token class-name">Configuration</span> jobConf<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> ts<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> resMgrDelegate<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup LocalResources</span>
 <span class="token comment">// å°è£…äº†æœ¬åœ°èµ„æºç›¸å…³è·¯å¾„</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LocalResource</span><span class="token punctuation">&gt;</span></span> localResources <span class="token operator">=</span>
 <span class="token function">setupLocalResources</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup security tokens</span>
 <span class="token class-name">DataOutputBuffer</span> dob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 ts<span class="token punctuation">.</span><span class="token function">writeTokenStorageToStream</span><span class="token punctuation">(</span>dob<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ByteBuffer</span> securityTokens <span class="token operator">=</span>
 <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>dob<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dob<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup ContainerLaunchContext for AM container</span>
 <span class="token comment">// å°è£…äº†å¯åŠ¨ mrappMaster å’Œè¿è¡Œ container çš„å‘½ä»¤</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vargs <span class="token operator">=</span> <span class="token function">setupAMCommand</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ContainerLaunchContext</span> amContainer <span class="token operator">=</span> <span class="token function">setupContainerLaunchContextForAM</span><span class="token punctuation">(</span>
 jobConf<span class="token punctuation">,</span> localResources<span class="token punctuation">,</span> securityTokens<span class="token punctuation">,</span> vargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> appContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">setupAMCommand</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> jobConf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vargs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Java è¿›ç¨‹å¯åŠ¨å‘½ä»¤å¼€å§‹</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">crossPlatformifyMREnv</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">,</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span>JAVA_HOME<span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot;/bin/java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Path</span> amTmpDir <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">crossPlatformifyMREnv</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span>PWD<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">YarnConfiguration</span><span class="token punctuation">.</span>DEFAULT_CONTAINER_TEMP_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-Djava.io.tmpdir=&quot;</span> <span class="token operator">+</span> amTmpDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">addLog4jSystemProperties</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vargs<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Check for Java Lib Path usage in MAP and REDUCE configs</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_MAP_ADMIN_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_MAP_ADMIN_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;reduce&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_REDUCE_ADMIN_JAVA_OPTS<span class="token punctuation">,</span> 
<span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;reduce&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_REDUCE_ADMIN_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Add AM admin command opts before user command opts</span>
 <span class="token comment">// so that it can be overridden by user</span>
 <span class="token class-name">String</span> mrAppMasterAdminOptions <span class="token operator">=</span> 
conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>mrAppMasterAdminOptions<span class="token punctuation">,</span> <span class="token string">&quot;app master&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">,</span> 
<span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mrAppMasterAdminOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Add AM user command opts ç”¨æˆ·å‘½ä»¤å‚æ•°</span>
 <span class="token class-name">String</span> mrAppMasterUserOptions <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_COMMAND_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_COMMAND_OPTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>mrAppMasterUserOptions<span class="token punctuation">,</span> <span class="token string">&quot;app master&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_COMMAND_OPTS<span class="token punctuation">,</span> <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mrAppMasterUserOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>jobConf<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_PROFILE<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_PROFILE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> profileParams <span class="token operator">=</span> 
jobConf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_PROFILE_PARAMS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_TASK_PROFILE_PARAMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>profileParams <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>profileParams<span class="token punctuation">,</span>
 <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span> <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR
 <span class="token operator">+</span> <span class="token class-name">TaskLog<span class="token punctuation">.</span>LogName</span><span class="token punctuation">.</span>PROFILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// å°è£…äº†è¦å¯åŠ¨çš„ mrappmaster å…¨ç±»å</span>
 <span class="token comment">// org.apache.hadoop.mapreduce.v2.app.MRAppMaster</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>APPLICATION_MASTER_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;1&gt;&quot;</span> <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span>
 <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>STDOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;2&gt;&quot;</span> <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span>
 <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>STDERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> vargs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><p><strong>å‘ Yarn æäº¤</strong></p> <p>ç‚¹å‡» <code>submitJob</code> æ–¹æ³•ä¸­çš„ <code>submitApplication()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//YARNRunner.java</span>
<span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> 
resMgrDelegate<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">ApplicationId</span>
 <span class="token function">submitApplication</span><span class="token punctuation">(</span><span class="token class-name">ApplicationSubmissionContext</span> appContext<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>ctrl + alt +B</code>æŸ¥æ‰¾ <code>submitApplication</code> å®ç°ç±»ï¼Œ<code>YarnClientImpl.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ApplicationId</span>
 <span class="token function">submitApplication</span><span class="token punctuation">(</span><span class="token class-name">ApplicationSubmissionContext</span> appContext<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationIdNotProvidedException</span><span class="token punctuation">(</span>
 <span class="token string">&quot;ApplicationId is not provided in ApplicationSubmissionContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// åˆ›å»ºä¸€ä¸ªæäº¤è¯·æ±‚</span>
<span class="token class-name">SubmitApplicationRequest</span> request <span class="token operator">=</span>
 <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token function">newRecord</span><span class="token punctuation">(</span><span class="token class-name">SubmitApplicationRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 request<span class="token punctuation">.</span><span class="token function">setApplicationSubmissionContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">//TODO: YARN-1763:Handle RM failovers during the submitApplication call.</span>
 <span class="token comment">// ç»§ç»­æäº¤ï¼Œå®ç°ç±»æ˜¯ ApplicationClientProtocolPBClientImpl</span>
 rmClient<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> pollCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">&gt;</span></span> waitingStates <span class="token operator">=</span> 
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>NEW<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>NEW_SAVING<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>SUBMITTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">&gt;</span></span> failToSubmitStates <span class="token operator">=</span> 
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>FAILED<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>KILLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// è·å–æäº¤ç»™ Yarn çš„åé¦ˆ</span>
 <span class="token class-name">ApplicationReport</span> appReport <span class="token operator">=</span> <span class="token function">getApplicationReport</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">YarnApplicationState</span> state <span class="token operator">=</span> appReport<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// FailOver or RM restart happens before RMStateStore saves</span>
 <span class="token comment">// ApplicationState</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Re-submit application &quot;</span> <span class="token operator">+</span> applicationId <span class="token operator">+</span> <span class="token string">&quot;with the &quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;same ApplicationSubmissionContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¦‚æœæäº¤å¤±è´¥ï¼Œåˆ™å†æ¬¡æäº¤</span>
 rmClient<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> applicationId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><code>ctrl + alt +B</code>æŸ¥æ‰¾ <code>submitApplication</code> å®ç°ç±»ï¼Œ<code>ClientRMService.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SubmitApplicationResponse</span> <span class="token function">submitApplication</span><span class="token punctuation">(</span>
 <span class="token class-name">SubmitApplicationRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationSubmissionContext</span> submissionContext <span class="token operator">=</span> request
 <span class="token punctuation">.</span><span class="token function">getApplicationSubmissionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> submissionContext<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CallerContext</span> callerContext <span class="token operator">=</span> <span class="token class-name">CallerContext</span><span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// call RMAppManager to submit application directly</span>
 rmAppManager<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>submissionContext<span class="token punctuation">,</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application with id &quot;</span> <span class="token operator">+</span> applicationId<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
 <span class="token string">&quot; submitted by user &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">RMAuditLogger</span><span class="token punctuation">.</span><span class="token function">logSuccess</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">AuditConstants</span><span class="token punctuation">.</span>SUBMIT_APP_REQUEST<span class="token punctuation">,</span>
 <span class="token string">&quot;ClientRMService&quot;</span><span class="token punctuation">,</span> applicationId<span class="token punctuation">,</span> callerContext<span class="token punctuation">,</span>
 submissionContext<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">YarnException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in submitting &quot;</span> <span class="token operator">+</span> applicationId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">RMAuditLogger</span><span class="token punctuation">.</span><span class="token function">logFailure</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">AuditConstants</span><span class="token punctuation">.</span>SUBMIT_APP_REQUEST<span class="token punctuation">,</span>
 e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ClientRMService&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;Exception in submitting application&quot;</span><span class="token punctuation">,</span> applicationId<span class="token punctuation">,</span> callerContext<span class="token punctuation">,</span>
submissionContext<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> recordFactory
 <span class="token punctuation">.</span><span class="token function">newRecordInstance</span><span class="token punctuation">(</span><span class="token class-name">SubmitApplicationResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>RM å¯åŠ¨ MRAppMaster</strong></p> <p>åœ¨ <code>pom.xml</code> ä¸­å¢åŠ å¦‚ä¸‹ä¾èµ–</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
 <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
 <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>hadoop<span class="token operator">-</span>mapreduce<span class="token operator">-</span>client<span class="token operator">-</span>app<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
 <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.1</span><span class="token number">.3</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>ctrl +n</code>æŸ¥æ‰¾ <code>MRAppMaster</code>ï¼Œæœç´¢ main æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ª container</span>
 <span class="token class-name">ContainerId</span> containerId <span class="token operator">=</span> <span class="token class-name">ContainerId</span><span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>containerIdStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ApplicationAttemptId</span> applicationAttemptId <span class="token operator">=</span>
 containerId<span class="token punctuation">.</span><span class="token function">getApplicationAttemptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationAttemptId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">CallerContext</span><span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallerContext<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>
 <span class="token string">&quot;mr_appmaster_&quot;</span> <span class="token operator">+</span> applicationAttemptId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> appSubmitTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>appSubmitTimeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// åˆ›å»º appMaster å¯¹è±¡</span>
 <span class="token class-name">MRAppMaster</span> appMaster <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">MRAppMaster</span><span class="token punctuation">(</span>applicationAttemptId<span class="token punctuation">,</span> containerId<span class="token punctuation">,</span> nodeHostString<span class="token punctuation">,</span>
 <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>nodePortString<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>nodeHttpPortString<span class="token punctuation">)</span><span class="token punctuation">,</span> appSubmitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// åˆå§‹åŒ–å¹¶å¯åŠ¨ AppMaster</span>
 <span class="token function">initAndStartAppMaster</span><span class="token punctuation">(</span>appMaster<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> jobUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error starting MRAppMaster&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ExitUtil</span><span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initAndStartAppMaster</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MRAppMaster</span> appMaster<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">JobConf</span> conf<span class="token punctuation">,</span> <span class="token class-name">String</span> jobUserName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
 <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 conf<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
 appMasterUgi<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token comment">// åˆå§‹åŒ–</span>
appMaster<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// å¯åŠ¨</span>
 appMaster<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>appMaster<span class="token punctuation">.</span>errorHappenedShutDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Was asked to shut down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateChangeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">enterState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span> <span class="token operator">!=</span> STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">setConfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// è°ƒç”¨ MRAppMaster ä¸­çš„ serviceInit()æ–¹æ³•</span>
 <span class="token function">serviceInit</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//if the service ended up here during init,</span>
 <span class="token comment">//notify the listeners</span>
 <span class="token comment">// å¦‚æœåˆå§‹åŒ–å®Œæˆï¼Œé€šçŸ¥ç›‘å¬å™¨</span>
 <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">noteFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ServiceOperations</span><span class="token punctuation">.</span><span class="token function">stopQuietly</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token class-name">ServiceStateException</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p><code>ctrl + alt +B</code> æŸ¥æ‰¾ <code>serviceInit</code> å®ç°ç±»ï¼Œ<code>MRAppMaster.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">serviceInit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// åˆ›å»ºæäº¤è·¯å¾„</span>
 clientService <span class="token operator">=</span> <span class="token function">createClientService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// åˆ›å»ºè°ƒåº¦å™¨</span>
 clientService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// åˆ›å»º job æäº¤ RPC å®¢æˆ·ç«¯</span>
 containerAllocator <span class="token operator">=</span> <span class="token function">createContainerAllocator</span><span class="token punctuation">(</span>clientService<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>ç‚¹å‡» <code>MRAppMaster.java</code> ä¸­çš„ <code>initAndStartAppMaster</code>æ–¹æ³•ä¸­çš„ <code>appMaster.start()</code>;</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//enter the started state</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateChangeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>stateModel<span class="token punctuation">.</span><span class="token function">enterState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token operator">!=</span> STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è°ƒç”¨ MRAppMaster ä¸­çš„ serviceStart()æ–¹æ³•</span>
 <span class="token function">serviceStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//if the service started (and isn't now in a later state), notify</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Service {} is started&quot;</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">noteFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ServiceOperations</span><span class="token punctuation">.</span><span class="token function">stopQuietly</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token class-name">ServiceStateException</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">serviceStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>initFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">JobEvent</span> initFailedEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobEvent</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token class-name">JobEventType</span><span class="token punctuation">.</span>JOB_INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 jobEventDispatcher<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>initFailedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// All components have started, start the job.</span>
<span class="token comment">// åˆå§‹åŒ–æˆåŠŸåï¼Œæäº¤ Job åˆ°é˜Ÿåˆ—ä¸­</span>
 <span class="token function">startJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">/** create a job-start event to get this ball rolling */</span>
 <span class="token class-name">JobEvent</span> startJobEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobStartEvent</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 recoveredJobStartTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">/** send the job-start event. this triggers the job execution. */</span>
 <span class="token comment">// è¿™é‡Œå°† job å­˜æ”¾åˆ° yarn é˜Ÿåˆ—</span>
 <span class="token comment">// dispatcher = AsyncDispatcher</span>
 <span class="token comment">// getEventHandler()è¿”å›çš„æ˜¯ GenericEventHandler</span>
 dispatcher<span class="token punctuation">.</span><span class="token function">getEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>startJobEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><code>ctrl + alt +B</code> æŸ¥æ‰¾ handle å®ç°ç±»ï¼Œ<code>GenericEventHandler.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">GenericEventHandler</span> <span class="token keyword">implements</span> <span class="token class-name">EventHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// å°† job å­˜å‚¨åˆ° yarn é˜Ÿåˆ—ä¸­</span>
 eventQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>è°ƒåº¦å™¨ä»»åŠ¡æ‰§è¡Œï¼ˆYarnChildï¼‰</strong></p> <p>å¯åŠ¨ <code>MapTask</code></p> <p><code>ctrl +n æŸ¥æ‰¾ YarnChildï¼Œ</code>æœç´¢ main æ–¹æ³•</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">setDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">YarnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Child starting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 task <span class="token operator">=</span> myTask<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">YarnChild</span><span class="token punctuation">.</span>taskid <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// Create a final reference to the task for the doAs block</span>
 <span class="token keyword">final</span> <span class="token class-name">Task</span> taskFinal <span class="token operator">=</span> task<span class="token punctuation">;</span>
 childUGI<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token comment">// use job-specified working directory</span>
 <span class="token function">setEncryptedSpillKeyIfRequired</span><span class="token punctuation">(</span>taskFinal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setWorkingDirectory</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getWorkingDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è°ƒç”¨ task æ‰§è¡Œï¼ˆmaptask æˆ–è€… reducetaskï¼‰</span>
 taskFinal<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// run the task</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>ctrl + alt +B æŸ¥æ‰¾ run å®ç°ç±»ï¼Œmaptask.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JobConf</span> job<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>umbilical <span class="token operator">=</span> umbilical<span class="token punctuation">;</span>
 <span class="token comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ MapTask</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMapTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are no reducers then there won't be any sort. Hence the map </span>
 <span class="token comment">// phase will govern the entire attempt's progress.</span>
<span class="token comment">// å¦‚æœ reducetask ä¸ªæ•°ä¸ºé›¶ï¼Œmaptask å ç”¨æ•´ä¸ªä»»åŠ¡çš„ 100%</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 mapPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are reducers then the entire attempt's progress will be </span>
 <span class="token comment">// split between the map phase (67%) and the sort phase (33%).</span>
 <span class="token comment">// å¦‚æœ reduceTask ä¸ªæ•°ä¸ä¸ºé›¶ï¼ŒMapTask å ç”¨æ•´ä¸ªä»»åŠ¡çš„ 66.7% sort é˜¶æ®µå æ¯”</span>
 mapPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> <span class="token number">0.667f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 sortPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span> <span class="token number">0.333f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// è°ƒç”¨æ–°çš„ API æ‰§è¡Œ maptask</span>
<span class="token function">runNewMapper</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> splitMetaInfo<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token function">runOldMapper</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> splitMetaInfo<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">done</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">runNewMapper</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskSplitIndex</span> splitIndex<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
 <span class="token class-name">TaskReporter</span> reporter
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span>
 <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 input<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>split<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è¿è¡Œ maptask</span>
 mapper<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 mapPhase<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setPhase</span><span class="token punctuation">(</span><span class="token class-name">TaskStatus<span class="token punctuation">.</span>Phase</span><span class="token punctuation">.</span>SORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">statusUpdate</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span>
 input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">closeQuietly</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">closeQuietly</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><code>Mapper.java</code>ï¼ˆå’Œ Map è”ç³»åœ¨ä¸€èµ·ï¼‰</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token function">setup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">map</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">cleanup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>å¯åŠ¨ <code>ReduceTask</code></p> <p>åœ¨<code>YarnChild.java ç±»ä¸­çš„ main æ–¹æ³•ä¸­ ctrl + alt +B æŸ¥æ‰¾ run å®ç°ç±»ï¼Œreducetask.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>SKIP_RECORDS<span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// è°ƒç”¨æ–° API æ‰§è¡Œ reduce</span>
 <span class="token function">runNewReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span>
 keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token function">runOldReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span> 
 keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 shuffleConsumerPlugin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">done</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">runNewReducer</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskReporter</span> reporter<span class="token punctuation">,</span>
 <span class="token class-name">RawKeyValueIterator</span> rIter<span class="token punctuation">,</span>
 <span class="token class-name">RawComparator</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">,</span>
 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> keyClass<span class="token punctuation">,</span>
 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INVALUE<span class="token punctuation">&gt;</span></span> valueClass
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// è°ƒç”¨ reducetask çš„ run æ–¹æ³•</span>
 reducer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 trackedRW<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Reduce.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token function">setup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">nextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">reduce</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// If a back up store is used, reset it</span>
 <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span>VALUEIN<span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>iter <span class="token keyword">instanceof</span> <span class="token class-name">ReduceContext<span class="token punctuation">.</span>ValueIterator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReduceContext<span class="token punctuation">.</span>ValueIterator</span><span class="token generics"><span class="token punctuation">&lt;</span>VALUEIN<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>iter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resetBackupStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">cleanup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details> <h2 id="mapreduce-æºç è§£æ"><a href="#mapreduce-æºç è§£æ" class="header-anchor">#</a> MapReduce æºç è§£æ</h2> <p><strong>maptaskå·¥ä½œæœºåˆ¶ï¼š</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904155306.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ï¼ˆ1ï¼‰Read é˜¶æ®µï¼šMapTask é€šè¿‡ InputFormat è·å¾—çš„ RecordReaderï¼Œ
ä»è¾“å…¥ InputSplit ä¸­è§£æå‡ºä¸€ä¸ªä¸ª key/valueã€‚

ï¼ˆ2ï¼‰Map é˜¶æ®µï¼šè¯¥èŠ‚ç‚¹ä¸»è¦æ˜¯å°†è§£æå‡ºçš„ key/value 
äº¤ç»™ç”¨æˆ·ç¼–å†™ map()å‡½æ•°å¤„ç†ï¼Œå¹¶äº§ç”Ÿä¸€ç³»åˆ—æ–°çš„ key/valueã€‚

ï¼ˆ3ï¼‰Collect æ”¶é›†é˜¶æ®µï¼šåœ¨ç”¨æˆ·ç¼–å†™ map()å‡½æ•°ä¸­ï¼Œ
å½“æ•°æ®å¤„ç†å®Œæˆåï¼Œä¸€èˆ¬ä¼šè°ƒç”¨OutputCollector.collect()è¾“å‡ºç»“æœã€‚
åœ¨è¯¥å‡½æ•°å†…éƒ¨ï¼Œå®ƒä¼šå°†ç”Ÿæˆçš„ key/value åˆ†åŒºï¼ˆè°ƒç”¨Partitionerï¼‰ï¼Œ
å¹¶å†™å…¥ä¸€ä¸ªç¯å½¢å†…å­˜ç¼“å†²åŒºä¸­ã€‚

ï¼ˆ4ï¼‰Spill é˜¶æ®µï¼šå³â€œæº¢å†™â€ï¼Œå½“ç¯å½¢ç¼“å†²åŒºæ»¡åï¼ŒMapReduce ä¼šå°†æ•°æ®
å†™åˆ°æœ¬åœ°ç£ç›˜ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°†æ•°æ®å†™å…¥æœ¬åœ°ç£ç›˜ä¹‹å‰ï¼Œ
å…ˆè¦å¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡æœ¬åœ°æ’åºï¼Œå¹¶åœ¨å¿…è¦æ—¶å¯¹æ•°æ®è¿›è¡Œåˆå¹¶ã€å‹ç¼©ç­‰æ“ä½œã€‚
æº¢å†™é˜¶æ®µè¯¦æƒ…ï¼š
	æ­¥éª¤ 1ï¼šåˆ©ç”¨å¿«é€Ÿæ’åºç®—æ³•å¯¹ç¼“å­˜åŒºå†…çš„æ•°æ®è¿›è¡Œæ’åºï¼Œæ’åºæ–¹å¼æ˜¯ï¼Œ
	å…ˆæŒ‰ç…§åˆ†åŒºç¼–å·Partition è¿›è¡Œæ’åºï¼Œç„¶åæŒ‰ç…§ key è¿›è¡Œæ’åºã€‚
	è¿™æ ·ï¼Œç»è¿‡æ’åºåï¼Œæ•°æ®ä»¥åˆ†åŒºä¸ºå•ä½èšé›†åœ¨ä¸€èµ·ï¼Œä¸”åŒä¸€åˆ†åŒºå†…æ‰€æœ‰æ•°æ®æŒ‰ç…§ key æœ‰åºã€‚
	
	æ­¥éª¤ 2ï¼šæŒ‰ç…§åˆ†åŒºç¼–å·ç”±å°åˆ°å¤§ä¾æ¬¡å°†æ¯ä¸ªåˆ†åŒºä¸­çš„æ•°æ®å†™å…¥ä»»åŠ¡å·¥ä½œç›®å½•ä¸‹çš„ä¸´æ—¶æ–‡ä»¶
	output/spillN.outï¼ˆN è¡¨ç¤ºå½“å‰æº¢å†™æ¬¡æ•°ä¸­ã€‚å¦‚æœç”¨æˆ·è®¾ç½®äº† Combinerï¼Œ
	åˆ™å†™å…¥æ–‡ä»¶ä¹‹å‰ï¼Œå¯¹æ¯ä¸ªåˆ†åŒºä¸­çš„æ•°æ®è¿›è¡Œä¸€æ¬¡èšé›†æ“ä½œã€‚
	
	æ­¥éª¤ 3ï¼šå°†åˆ†åŒºæ•°æ®çš„å…ƒä¿¡æ¯å†™åˆ°å†…å­˜ç´¢å¼•æ•°æ®ç»“æ„ SpillRecord ä¸­ï¼Œå…¶ä¸­æ¯ä¸ªåˆ†åŒºçš„å…ƒä¿¡æ¯
	åŒ…æ‹¬åœ¨ä¸´æ—¶æ–‡ä»¶ä¸­çš„åç§»é‡ã€å‹ç¼©å‰æ•°æ®å¤§å°å’Œå‹ç¼©åæ•°æ®å¤§å°ã€‚å¦‚æœå½“å‰å†…å­˜ç´¢å¼•å¤§å°è¶…è¿‡ 1MBï¼Œ
	åˆ™å°†å†…å­˜ç´¢å¼•å†™åˆ°æ–‡ä»¶ output/spillN.out.index ä¸­ã€‚
		
ï¼ˆ5ï¼‰Merge é˜¶æ®µï¼šå½“æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆåï¼ŒMapTask å¯¹æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶è¿›è¡Œä¸€æ¬¡åˆå¹¶ï¼Œ
ä»¥ç¡®ä¿æœ€ç»ˆåªä¼šç”Ÿæˆä¸€ä¸ªæ•°æ®æ–‡ä»¶ã€‚å½“æ‰€æœ‰æ•°æ®å¤„ç†å®Œåï¼ŒMapTask ä¼šå°†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶åˆ
å¹¶æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶output/file.out ä¸­ï¼ŒåŒæ—¶ç”Ÿæˆç›¸åº”çš„ç´¢å¼•æ–‡ä»¶ 
output/file.out.indexã€‚åœ¨è¿›è¡Œæ–‡ä»¶åˆå¹¶è¿‡ç¨‹ä¸­ï¼ŒMapTask ä»¥åˆ†åŒºä¸ºå•ä½è¿›è¡Œåˆå¹¶ã€‚
å¯¹äºæŸä¸ªåˆ†åŒºï¼Œå®ƒå°†é‡‡ç”¨å¤šè½®é€’å½’åˆå¹¶çš„æ–¹å¼ã€‚æ¯è½®åˆå¹¶ mapreduce.task.io.sort.factor
ï¼ˆé»˜è®¤ 10ï¼‰ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†äº§ç”Ÿçš„æ–‡ä»¶é‡æ–°åŠ å…¥å¾…åˆå¹¶åˆ—è¡¨ä¸­ï¼Œå¯¹æ–‡ä»¶æ’åºåï¼Œé‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œ
ç›´åˆ°æœ€ç»ˆå¾—åˆ°ä¸€ä¸ªå¤§æ–‡ä»¶ã€‚è®©æ¯ä¸ª MapTask æœ€ç»ˆåªç”Ÿæˆä¸€ä¸ªæ•°æ®æ–‡ä»¶ï¼Œå¯é¿å…åŒæ—¶æ‰“å¼€å¤§é‡æ–‡ä»¶
å’ŒåŒæ—¶è¯»å–å¤§é‡å°æ–‡ä»¶äº§ç”Ÿçš„éšæœºè¯»å–å¸¦æ¥çš„å¼€é”€ã€‚

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>reducetaskå·¥ä½œæœºåˆ¶ï¼š</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/image-20210904160240511.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ï¼ˆ1ï¼‰Copy é˜¶æ®µï¼šReduceTask ä»å„ä¸ª MapTask ä¸Šè¿œç¨‹æ‹·è´ä¸€ç‰‡æ•°æ®ï¼Œ
å¹¶é’ˆå¯¹æŸä¸€ç‰‡æ•°æ®ï¼Œå¦‚æœå…¶å¤§å°è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œåˆ™å†™åˆ°ç£ç›˜ä¸Šï¼Œå¦åˆ™ç›´æ¥æ”¾åˆ°å†…å­˜ä¸­ã€‚

ï¼ˆ2ï¼‰Sort é˜¶æ®µï¼šåœ¨è¿œç¨‹æ‹·è´æ•°æ®çš„åŒæ—¶ï¼ŒReduceTask å¯åŠ¨äº†ä¸¤ä¸ªåå°çº¿ç¨‹
å¯¹å†…å­˜å’Œç£ç›˜ä¸Šçš„æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œä»¥é˜²æ­¢å†…å­˜ä½¿ç”¨è¿‡å¤šæˆ–ç£ç›˜ä¸Šæ–‡ä»¶è¿‡å¤šã€‚
æŒ‰ç…§ MapReduce è¯­ä¹‰ï¼Œç”¨æˆ·ç¼–å†™ reduce()å‡½æ•°è¾“å…¥æ•°æ®æ˜¯æŒ‰ key è¿›è¡Œèšé›†çš„ä¸€ç»„æ•°æ®ã€‚
ä¸ºäº†å°† key ç›¸åŒçš„æ•°æ®èšåœ¨ä¸€èµ·ï¼ŒHadoop é‡‡ç”¨äº†åŸºäºæ’åºçš„ç­–ç•¥ã€‚
ç”±äºå„ä¸ª MapTask å·²ç»å®ç°å¯¹è‡ªå·±çš„å¤„ç†ç»“æœè¿›è¡Œäº†å±€éƒ¨æ’åºï¼Œ
å› æ­¤ï¼ŒReduceTask åªéœ€å¯¹æ‰€æœ‰æ•°æ®è¿›è¡Œä¸€æ¬¡å½’å¹¶æ’åºå³å¯ã€‚

ï¼ˆ3ï¼‰Reduce é˜¶æ®µï¼šreduce()å‡½æ•°å°†è®¡ç®—ç»“æœå†™åˆ° HDFS ä¸Šã€‚
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Job æäº¤æµç¨‹æºç å’Œåˆ‡ç‰‡æºç è¯¦è§£ï¼š</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904153311.png" alt=""></p> <details class="custom-block details"><summary>ğŸ¦“ğŸ¦“ğŸ¦“ğŸ¦“ğŸ¦“</summary> <p>Job æäº¤æµç¨‹æºç è¯¦è§£</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>waitForCompletion()
submit();
// 1 å»ºç«‹è¿æ¥
connect();
// 1ï¼‰åˆ›å»ºæäº¤ Job çš„ä»£ç†
new Cluster(getConfiguration());
// ï¼ˆ1ï¼‰åˆ¤æ–­æ˜¯æœ¬åœ°è¿è¡Œç¯å¢ƒè¿˜æ˜¯ yarn é›†ç¾¤è¿è¡Œç¯å¢ƒ
initialize(jobTrackAddr, conf); 
// 2 æäº¤ job
submitter.submitJobInternal(Job.this, cluster)
// 1ï¼‰åˆ›å»ºç»™é›†ç¾¤æäº¤æ•°æ®çš„ Stag è·¯å¾„
Path jobStagingArea = JobSubmissionFiles.getStagingDir(cluster, conf);
// 2ï¼‰è·å– jobid ï¼Œå¹¶åˆ›å»º Job è·¯å¾„
JobID jobId = submitClient.getNewJobID();
// 3ï¼‰æ‹·è´ jar åŒ…åˆ°é›†ç¾¤
copyAndConfigureFiles(job, submitJobDir);
rUploader.uploadFiles(job, jobSubmitDir);
// 4ï¼‰è®¡ç®—åˆ‡ç‰‡ï¼Œç”Ÿæˆåˆ‡ç‰‡è§„åˆ’æ–‡ä»¶
writeSplits(job, submitJobDir);
maps = writeNewSplits(job, jobSubmitDir);
input.getSplits(job);
// 5ï¼‰å‘ Stag è·¯å¾„å†™ XML é…ç½®æ–‡ä»¶
writeConf(conf, submitJobFile);
conf.writeXml(out);
// 6ï¼‰æäº¤ Job,è¿”å›æäº¤çŠ¶æ€
status = submitClient.submitJob(jobId, submitJobDir.toString(), 
job.getCredentials());
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>FileInputFormat</code> åˆ‡ç‰‡æºç è§£æ<code>ï¼ˆinput.getSplits(job)ï¼‰</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>ï¼ˆ1ï¼‰ç¨‹åºå…ˆæ‰¾åˆ°ä½ æ•°æ®å­˜å‚¨çš„ç›®å½•ã€‚
ï¼ˆ2ï¼‰å¼€å§‹éå†å¤„ç†ï¼ˆè§„åˆ’åˆ‡ç‰‡ï¼‰ç›®å½•ä¸‹çš„æ¯ä¸€ä¸ªæ–‡ä»¶
ï¼ˆ3ï¼‰éå†ç¬¬ä¸€ä¸ªæ–‡ä»¶ss.txt
	aï¼‰è·å–æ–‡ä»¶å¤§å°fs.sizeOf(ss.txt)
	bï¼‰è®¡ç®—åˆ‡ç‰‡å¤§å°
	computeSplitSize(Math.max(minSize,Math.min(maxSize,blocksize)))=blocksize=128M
	cï¼‰é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ‡ç‰‡å¤§å°=blocksize
	dï¼‰å¼€å§‹åˆ‡ï¼Œå½¢æˆç¬¬1ä¸ªåˆ‡ç‰‡ï¼šss.txtâ€”0:128M ç¬¬2ä¸ªåˆ‡ç‰‡ss.txtâ€”128:256M ç¬¬3ä¸ªåˆ‡ç‰‡ss.txtâ€”256M:300M
		ï¼ˆæ¯æ¬¡åˆ‡ç‰‡æ—¶ï¼Œéƒ½è¦åˆ¤æ–­åˆ‡å®Œå‰©ä¸‹çš„éƒ¨åˆ†æ˜¯å¦å¤§äºå—çš„1.1å€ï¼Œä¸å¤§äº1.1å€å°±åˆ’åˆ†ä¸€å—åˆ‡ç‰‡ï¼‰
	eï¼‰å°†åˆ‡ç‰‡ä¿¡æ¯å†™åˆ°ä¸€ä¸ªåˆ‡ç‰‡è§„åˆ’æ–‡ä»¶ä¸­
	fï¼‰æ•´ä¸ªåˆ‡ç‰‡çš„æ ¸å¿ƒè¿‡ç¨‹åœ¨getSplit()æ–¹æ³•ä¸­å®Œæˆ
	gï¼‰InputSplitåªè®°å½•äº†åˆ‡ç‰‡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¯”å¦‚èµ·å§‹ä½ç½®ã€é•¿åº¦ä»¥åŠæ‰€åœ¨çš„èŠ‚ç‚¹åˆ—è¡¨ç­‰ã€‚
ï¼ˆ4ï¼‰æäº¤åˆ‡ç‰‡è§„åˆ’æ–‡ä»¶åˆ°YARNä¸Šï¼ŒYARNä¸Šçš„MrAppMasterå°±å¯ä»¥æ ¹æ®åˆ‡ç‰‡è§„åˆ’æ–‡ä»¶è®¡ç®—å¼€å¯MapTaskä¸ªæ•°ã€‚
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details> <p><strong>MapTask &amp; ReduceTask æºç è§£æ</strong></p> <details class="custom-block details"><summary>ğŸ¦“ğŸ¦“ğŸ¦“ğŸ¦“ğŸ¦“</summary> <p><strong>MapTask æºç è§£ææµç¨‹</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>=================== MapTask ===================
context.write(k, NullWritable.get()); //è‡ªå®šä¹‰çš„ map æ–¹æ³•çš„å†™å‡ºï¼Œè¿›å…¥
output.write(key, value); 
//MapTask727 è¡Œï¼Œæ”¶é›†æ–¹æ³•ï¼Œè¿›å…¥ä¸¤æ¬¡
collector.collect(key, value,partitioner.getPartition(key, value, partitions));
HashPartitioner(); //é»˜è®¤åˆ†åŒºå™¨
collect() //MapTask1082 è¡Œ map ç«¯æ‰€æœ‰çš„ kv å…¨éƒ¨å†™å‡ºåä¼šèµ°ä¸‹é¢çš„ close æ–¹æ³•
close() //MapTask732 è¡Œ
collector.flush() // æº¢å‡ºåˆ·å†™æ–¹æ³•ï¼ŒMapTask735 è¡Œï¼Œæå‰æ‰“ä¸ªæ–­ç‚¹ï¼Œè¿›å…¥
sortAndSpill() //æº¢å†™æ’åºï¼ŒMapTask1505 è¡Œï¼Œè¿›å…¥
sorter.sort() QuickSort //æº¢å†™æ’åºæ–¹æ³•ï¼ŒMapTask1625 è¡Œï¼Œè¿›å…¥
mergeParts(); //åˆå¹¶æ–‡ä»¶ï¼ŒMapTask1527 è¡Œï¼Œè¿›å…¥
collector.close(); //MapTask739 è¡Œ,æ”¶é›†å™¨å…³é—­,å³å°†è¿›å…¥ ReduceTask
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>ReduceTask æºç è§£ææµç¨‹</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>=================== ReduceTask ===================
if (isMapOrReduce()) //reduceTask324 è¡Œï¼Œæå‰æ‰“æ–­ç‚¹
initialize() // reduceTask333 è¡Œ,è¿›å…¥
init(shuffleContext); // reduceTask375 è¡Œ,èµ°åˆ°è¿™éœ€è¦å…ˆç»™ä¸‹é¢çš„æ‰“æ–­ç‚¹
 totalMaps = job.getNumMapTasks(); // ShuffleSchedulerImpl ç¬¬ 120 è¡Œï¼Œæå‰æ‰“æ–­ç‚¹
 merger = createMergeManager(context); //åˆå¹¶æ–¹æ³•ï¼ŒShuffle ç¬¬ 80 è¡Œ
// MergeManagerImpl ç¬¬ 232 235 è¡Œï¼Œæå‰æ‰“æ–­ç‚¹
this.inMemoryMerger = createInMemoryMerger(); //å†…å­˜åˆå¹¶
this.onDiskMerger = new OnDiskMerger(this); //ç£ç›˜åˆå¹¶
rIter = shuffleConsumerPlugin.run();
eventFetcher.start(); //å¼€å§‹æŠ“å–æ•°æ®ï¼ŒShuffle ç¬¬ 107 è¡Œï¼Œæå‰æ‰“æ–­ç‚¹
eventFetcher.shutDown(); //æŠ“å–ç»“æŸï¼ŒShuffle ç¬¬ 141 è¡Œï¼Œæå‰æ‰“æ–­ç‚¹
copyPhase.complete(); //copy é˜¶æ®µå®Œæˆï¼ŒShuffle ç¬¬ 151 è¡Œ
taskStatus.setPhase(TaskStatus.Phase.SORT); //å¼€å§‹æ’åºé˜¶æ®µï¼ŒShuffle ç¬¬ 152 è¡Œ
sortPhase.complete(); //æ’åºé˜¶æ®µå®Œæˆï¼Œå³å°†è¿›å…¥ reduce é˜¶æ®µ reduceTask382 è¡Œ
reduce(); //reduce é˜¶æ®µè°ƒç”¨çš„å°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ reduce æ–¹æ³•ï¼Œä¼šè¢«è°ƒç”¨å¤šæ¬¡
cleanup(context); //reduce å®Œæˆä¹‹å‰ï¼Œä¼šæœ€åè°ƒç”¨ä¸€æ¬¡ Reducer é‡Œé¢çš„ cleanup æ–¹æ³•
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details> <h2 id="hadoop-æºç ç¼–è¯‘"><a href="#hadoop-æºç ç¼–è¯‘" class="header-anchor">#</a> Hadoop æºç ç¼–è¯‘</h2> <p><strong>å®˜ç½‘ä¸‹è½½æºç </strong>&lt;<a href="https://hadoop.apache.org/release/3.1.3.html" target="_blank" rel="noopener noreferrer">Apache Hadoop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&gt;</p> <ul><li><p>ä¸‹è½½æºç </p></li> <li><p>ä¿®æ”¹æºç </p></li> <li><p>å‡†å¤‡è™šæ‹Ÿæœº</p> <ul><li>è”ç½‘</li> <li>jaråŒ…å‡†å¤‡ï¼ˆHadoop æºç ã€JDK8ã€Mavenã€Ant ã€Protobufï¼‰</li> <li>å…¨éƒ¨è§£å‹åˆ°æŒ‡å®šç›®å½•ï¼Œé…ç½®ç¯å¢ƒå˜é‡ï¼ˆjdkã€mavenï¼‰</li></ul></li> <li><p>å®‰è£…ä¾èµ–ï¼ˆæŒ‰ç…§é¡ºåºï¼Œå¦åˆ™ä¼šå‡ºç°ä¾èµ–æ‰¾ä¸åˆ°é—®é¢˜)</p> <ul><li>å®‰è£… gcc make  <code>yum install -y gcc* make</code></li> <li>å®‰è£…å‹ç¼©å·¥å…· <code>yum -y install snappy* bzip2* lzo* zlib* lz4* gzip*</code></li> <li>å®‰è£…ä¸€äº›åŸºæœ¬å·¥å…· <code>yum -y install openssl* svn ncurses* autoconf automake libtool</code></li> <li>å®‰è£…æ‰©å±•æºï¼Œæ‰å¯å®‰è£… zstd <code>yum -y install epel-release</code></li> <li>å®‰è£… zstd <code>yum -y install *zstd*</code></li></ul></li> <li><p>å®‰è£… cmake ï¼ˆè¿›å…¥<code>.bootstrap</code>æ‰§è¡Œ<code>make &amp;&amp; make install</code>)</p></li> <li><p>å®‰è£… protobuf</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/configure -- <span class="token assign-left variable">prefix</span><span class="token operator">=</span>/opt/module/hadoop_source/protobuf-2.5.0 
<span class="token comment">##  --prefix æŒ‡å®šå®‰è£…åˆ°å½“å‰ç›®å½•</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>ç¼–è¯‘æºç  <code>mvn clean package -DskipTests - Pdist,native -Dta</code></p></li></ul></div></div> <div class="page-slot page-slot-bottom"><!-- æ¨ªå‘è‡ªé€‚åº” -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2023/03/22, 21:16:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/ad2s1a123s2fa/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Hadoopç”Ÿäº§è°ƒä¼˜</div></a> <a href="/pages/e7984e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">æ€»ç»“hadoop</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/pages/ad2s1a123s2fa/" class="prev">Hadoopç”Ÿäº§è°ƒä¼˜</a></span> <span class="next"><a href="/pages/e7984e/">æ€»ç»“hadoop</a>â†’
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">æœ€è¿‘æ›´æ–°</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f53939/"><div>Spring6</div></a> <span>06-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba69ad/"><div>è‹¥ä¾äºŒå¼€</div></a> <span>06-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/998714/"><div>MongoDB</div></a> <span>06-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">æ›´å¤šæ–‡ç« &gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=2461475139&amp;site=qq&amp;menu=yes" title="å‘é‚®ä»¶" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/axcmsm" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=6757658477" title="å¬éŸ³ä¹" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="æœ¬ç«™ä¸»é¢˜">Vdoing</a> 
    | Copyright Â© 2021-2023
    <span>axcmsm | è½¬è½½æ³¨æ˜å‡ºå¤„ </span></div> <div class="buttons"><div title="è¿”å›é¡¶éƒ¨" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="å»è¯„è®º" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="ä¸»é¢˜æ¨¡å¼" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          è·Ÿéšç³»ç»Ÿ
        </li><li class="iconfont icon-rijianmoshi">
          æµ…è‰²æ¨¡å¼
        </li><li class="iconfont icon-yejianmoshi">
          æ·±è‰²æ¨¡å¼
        </li><li class="iconfont icon-yuedu">
          é˜…è¯»æ¨¡å¼
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">Ã—</i> <div><!-- å›ºå®š160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e7d9515b.js" defer></script><script src="/assets/js/2.125ae6e8.js" defer></script><script src="/assets/js/21.74a586bf.js" defer></script>
  </body>
</html>