<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>hadoop源码解析 | 🦏</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,后端,大数据,技术文档,学习,js,vue,python,css3,java,javaEE,SpringBoot,Spring,Hadoop,html5,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.e7d9515b.js" as="script"><link rel="preload" href="/assets/js/2.125ae6e8.js" as="script"><link rel="preload" href="/assets/js/21.74a586bf.js" as="script"><link rel="prefetch" href="/assets/js/10.95c2d7b0.js"><link rel="prefetch" href="/assets/js/100.b4e10546.js"><link rel="prefetch" href="/assets/js/101.d6d23fe2.js"><link rel="prefetch" href="/assets/js/102.b368fb26.js"><link rel="prefetch" href="/assets/js/103.b87bfabc.js"><link rel="prefetch" href="/assets/js/104.3d0ae07d.js"><link rel="prefetch" href="/assets/js/105.e9f9588c.js"><link rel="prefetch" href="/assets/js/106.76130cbc.js"><link rel="prefetch" href="/assets/js/107.11dd35ba.js"><link rel="prefetch" href="/assets/js/108.de8bb9b7.js"><link rel="prefetch" href="/assets/js/109.e26f138c.js"><link rel="prefetch" href="/assets/js/11.5682c637.js"><link rel="prefetch" href="/assets/js/110.2c9036b9.js"><link rel="prefetch" href="/assets/js/111.d91b7424.js"><link rel="prefetch" href="/assets/js/112.0edf9093.js"><link rel="prefetch" href="/assets/js/113.dbc0bf4d.js"><link rel="prefetch" href="/assets/js/114.439ad4ee.js"><link rel="prefetch" href="/assets/js/115.0cff9cd8.js"><link rel="prefetch" href="/assets/js/116.fd44dc61.js"><link rel="prefetch" href="/assets/js/117.e893d264.js"><link rel="prefetch" href="/assets/js/118.ec4b3d32.js"><link rel="prefetch" href="/assets/js/119.ea5c3eba.js"><link rel="prefetch" href="/assets/js/12.5a51d307.js"><link rel="prefetch" href="/assets/js/120.9aaee23f.js"><link rel="prefetch" href="/assets/js/121.4fc7842c.js"><link rel="prefetch" href="/assets/js/122.2b8f75d1.js"><link rel="prefetch" href="/assets/js/123.78dbfead.js"><link rel="prefetch" href="/assets/js/124.84b6382a.js"><link rel="prefetch" href="/assets/js/125.c2a2a818.js"><link rel="prefetch" href="/assets/js/126.83ea2963.js"><link rel="prefetch" href="/assets/js/127.dffd5eae.js"><link rel="prefetch" href="/assets/js/128.bb0a0738.js"><link rel="prefetch" href="/assets/js/129.45a56702.js"><link rel="prefetch" href="/assets/js/13.d1b5b29f.js"><link rel="prefetch" href="/assets/js/130.7fee331a.js"><link rel="prefetch" href="/assets/js/131.6aaa557b.js"><link rel="prefetch" href="/assets/js/132.9526e280.js"><link rel="prefetch" href="/assets/js/133.610c1c84.js"><link rel="prefetch" href="/assets/js/134.1dcf27f7.js"><link rel="prefetch" href="/assets/js/14.83de980a.js"><link rel="prefetch" href="/assets/js/15.0fa06ae1.js"><link rel="prefetch" href="/assets/js/16.d1d3c9c1.js"><link rel="prefetch" href="/assets/js/17.c9772d78.js"><link rel="prefetch" href="/assets/js/18.7cbf0ef4.js"><link rel="prefetch" href="/assets/js/19.66ee7cfc.js"><link rel="prefetch" href="/assets/js/20.8fbb5432.js"><link rel="prefetch" href="/assets/js/22.f85a2ced.js"><link rel="prefetch" href="/assets/js/23.a65163b5.js"><link rel="prefetch" href="/assets/js/24.5c2898c6.js"><link rel="prefetch" href="/assets/js/25.929f22ff.js"><link rel="prefetch" href="/assets/js/26.20d74c65.js"><link rel="prefetch" href="/assets/js/27.e790af79.js"><link rel="prefetch" href="/assets/js/28.6b84abe6.js"><link rel="prefetch" href="/assets/js/29.acc0fc34.js"><link rel="prefetch" href="/assets/js/3.dd3750e6.js"><link rel="prefetch" href="/assets/js/30.fadb6cbd.js"><link rel="prefetch" href="/assets/js/31.386f82c2.js"><link rel="prefetch" href="/assets/js/32.e934f71c.js"><link rel="prefetch" href="/assets/js/33.684ac64c.js"><link rel="prefetch" href="/assets/js/34.38f8fd76.js"><link rel="prefetch" href="/assets/js/35.3fe27233.js"><link rel="prefetch" href="/assets/js/36.993695b7.js"><link rel="prefetch" href="/assets/js/37.d735018c.js"><link rel="prefetch" href="/assets/js/38.0d23a384.js"><link rel="prefetch" href="/assets/js/39.808de65c.js"><link rel="prefetch" href="/assets/js/4.4a137b18.js"><link rel="prefetch" href="/assets/js/40.2fc7d5f7.js"><link rel="prefetch" href="/assets/js/41.6647cff7.js"><link rel="prefetch" href="/assets/js/42.f4d93aa6.js"><link rel="prefetch" href="/assets/js/43.a5d40107.js"><link rel="prefetch" href="/assets/js/44.3ae864d3.js"><link rel="prefetch" href="/assets/js/45.c66f1afe.js"><link rel="prefetch" href="/assets/js/46.750f2be2.js"><link rel="prefetch" href="/assets/js/47.1722c1b9.js"><link rel="prefetch" href="/assets/js/48.7c8df7cc.js"><link rel="prefetch" href="/assets/js/49.f9b58d70.js"><link rel="prefetch" href="/assets/js/5.51ca929a.js"><link rel="prefetch" href="/assets/js/50.fad73ad9.js"><link rel="prefetch" href="/assets/js/51.b88c6213.js"><link rel="prefetch" href="/assets/js/52.21244293.js"><link rel="prefetch" href="/assets/js/53.1c2189f3.js"><link rel="prefetch" href="/assets/js/54.95ba12bc.js"><link rel="prefetch" href="/assets/js/55.d8f79989.js"><link rel="prefetch" href="/assets/js/56.63c36b2d.js"><link rel="prefetch" href="/assets/js/57.270857ec.js"><link rel="prefetch" href="/assets/js/58.156073cc.js"><link rel="prefetch" href="/assets/js/59.5a300643.js"><link rel="prefetch" href="/assets/js/6.2dccf462.js"><link rel="prefetch" href="/assets/js/60.92f4ce87.js"><link rel="prefetch" href="/assets/js/61.0f312cea.js"><link rel="prefetch" href="/assets/js/62.0c55901b.js"><link rel="prefetch" href="/assets/js/63.613b1add.js"><link rel="prefetch" href="/assets/js/64.1e5070b6.js"><link rel="prefetch" href="/assets/js/65.dc215238.js"><link rel="prefetch" href="/assets/js/66.4a1319e4.js"><link rel="prefetch" href="/assets/js/67.841428fe.js"><link rel="prefetch" href="/assets/js/68.7380e054.js"><link rel="prefetch" href="/assets/js/69.0a503182.js"><link rel="prefetch" href="/assets/js/7.1096b6fa.js"><link rel="prefetch" href="/assets/js/70.09f4c416.js"><link rel="prefetch" href="/assets/js/71.a279d635.js"><link rel="prefetch" href="/assets/js/72.057aa49f.js"><link rel="prefetch" href="/assets/js/73.767f542c.js"><link rel="prefetch" href="/assets/js/74.3eb6f7e5.js"><link rel="prefetch" href="/assets/js/75.50ecd31e.js"><link rel="prefetch" href="/assets/js/76.602f67fb.js"><link rel="prefetch" href="/assets/js/77.3b5a8e7d.js"><link rel="prefetch" href="/assets/js/78.40c6990e.js"><link rel="prefetch" href="/assets/js/79.ecb155e0.js"><link rel="prefetch" href="/assets/js/8.4b82b135.js"><link rel="prefetch" href="/assets/js/80.d7279b34.js"><link rel="prefetch" href="/assets/js/81.f58f78af.js"><link rel="prefetch" href="/assets/js/82.8399bcab.js"><link rel="prefetch" href="/assets/js/83.67c3c861.js"><link rel="prefetch" href="/assets/js/84.5a8f7c4b.js"><link rel="prefetch" href="/assets/js/85.c6f0af81.js"><link rel="prefetch" href="/assets/js/86.f9f3d0b8.js"><link rel="prefetch" href="/assets/js/87.fec83ae4.js"><link rel="prefetch" href="/assets/js/88.ca11e236.js"><link rel="prefetch" href="/assets/js/89.ae243724.js"><link rel="prefetch" href="/assets/js/9.b8d3ed93.js"><link rel="prefetch" href="/assets/js/90.c242e238.js"><link rel="prefetch" href="/assets/js/91.ad0080a6.js"><link rel="prefetch" href="/assets/js/92.a435d70c.js"><link rel="prefetch" href="/assets/js/93.3232bfbf.js"><link rel="prefetch" href="/assets/js/94.6101d03c.js"><link rel="prefetch" href="/assets/js/95.8c95af7a.js"><link rel="prefetch" href="/assets/js/96.a582908e.js"><link rel="prefetch" href="/assets/js/97.1b560b4f.js"><link rel="prefetch" href="/assets/js/98.a686266f.js"><link rel="prefetch" href="/assets/js/99.e03a81a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="🦏" class="logo"> <span class="site-name can-hide">🦏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/zzx.jpg"> <div class="blogger-info"><h3>Axcmsm🐼</h3> <span>纵有疾风起，人生不言弃🐅</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>路线or导图</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>学习笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《linux》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>《Hadoop》</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/hasy2d21do11dop/" class="sidebar-link">Hadoop概述</a></li><li><a href="/pages/hdf2shad2o4p3/" class="sidebar-link">Hdfs分布式存储系统</a></li><li><a href="/pages/1b8ea6/" class="sidebar-link">MapReduce</a></li><li><a href="/pages/a611d4/" class="sidebar-link">yarn</a></li><li><a href="/pages/ad2s1a123s2fa/" class="sidebar-link">Hadoop生产调优</a></li><li><a href="/pages/f225ff/" aria-current="page" class="active sidebar-link">hadoop源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/f225ff/#rpc-通信" class="sidebar-link">RPC 通信</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#nn-启动源码解析" class="sidebar-link">NN 启动源码解析</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#dn-启动源码解析" class="sidebar-link">DN 启动源码解析</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#hdfs-上传源码解析" class="sidebar-link">HDFS 上传源码解析</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#yarn-源码解析" class="sidebar-link">Yarn 源码解析</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#mapreduce-源码解析" class="sidebar-link">MapReduce 源码解析</a></li><li class="sidebar-sub-header"><a href="/pages/f225ff/#hadoop-源码编译" class="sidebar-link">Hadoop 源码编译</a></li></ul></li><li><a href="/pages/e7984e/" class="sidebar-link">总结hadoop</a></li><li><a href="/pages/9067f7/" class="sidebar-link">HA高可用</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《zookeeper》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《hive》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《生态圈组件》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《消息队列》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《spark》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《flink》</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>《数据可视化》</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安装</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/BigData" title="大数据-目录页" data-v-1cd794fe>大数据</a></li> <li data-v-1cd794fe><a href="/BigData/#学习笔记" title="大数据#学习笔记" data-v-1cd794fe>学习笔记</a></li> <li data-v-1cd794fe><a href="/BigData/#《Hadoop》" title="大数据#《Hadoop》" data-v-1cd794fe>《Hadoop》</a></li></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/axcmsm" target="_blank" title="作者" class="beLink" data-v-1cd794fe>Wei Ye</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-09-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="/img/bj1.jpg">
          hadoop源码解析
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="rpc-通信"><a href="#rpc-通信" class="header-anchor">#</a> RPC 通信</h2> <p><strong>模拟RPC 的客户端、服务端、通信协议三者如何工作的</strong>:</p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904001108.png" alt=""></p> <p><strong>步骤</strong>：</p> <ul><li>创建 RPC 协议</li> <li>创建 RPC 服务端</li> <li>创建 RPC 客户端</li> <li>测试</li></ul> <p><strong>总结</strong>：RPC 的客户端调用通信协议方法，方法的执行在服务端,通信协议就是接口规范。</p> <h2 id="nn-启动源码解析"><a href="#nn-启动源码解析" class="header-anchor">#</a> NN 启动源码解析</h2> <p><strong>NN工作机制：</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902190330.png" alt=""></p> <p><strong>NN启动源码</strong>：</p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904001701.png" alt=""></p> <p><strong>解析启动流程</strong>：</p> <details class="custom-block details"><summary>🦓</summary> <p>在 pom.xml 中增加依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>ctrl + n</code> 全局查找<code>namenode</code>，进入 <code>NameNode.java</code></p> <p><code>ctrl + f</code>，查找 main 方法 nn.java</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">parseHelpArgument</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span>USAGE<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startupShutdownMessage</span><span class="token punctuation">(</span><span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> LOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建 NameNode</span>
<span class="token class-name">NameNode</span> namenode <span class="token operator">=</span> <span class="token function">createNameNode</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>namenode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
namenode<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to start namenode.&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>点击 <code>createNameNode</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">NameNode</span> <span class="token function">createNameNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 … …
 <span class="token class-name">StartupOption</span> startOpt <span class="token operator">=</span> <span class="token function">parseArguments</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>startOpt <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">printUsage</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">setStartupOption</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> startOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> aborted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>startOpt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">case</span> FORMAT<span class="token operator">:</span>
 aborted <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> startOpt<span class="token punctuation">.</span><span class="token function">getForceFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 startOpt<span class="token punctuation">.</span><span class="token function">getInteractiveFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span>aborted <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// avoid javac warning</span>
 <span class="token keyword">case</span> GENCLUSTERID<span class="token operator">:</span>
 … …
 <span class="token keyword">default</span><span class="token operator">:</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token string">&quot;NameNode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建 NameNode 对象</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>点击 <code>NameNode</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">NameNode</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">NamenodeRole</span> role<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">initializeGenericKeys</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> nsId<span class="token punctuation">,</span> namenodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopAtException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HadoopIllegalArgumentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopAtException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>点击 <code>initialize</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">==</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 启动 HTTP 服务端（9870）  先看这个</span>
 <span class="token function">startHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 加载镜像文件和编辑日志到内存 再看这个</span>
 <span class="token function">loadNamesystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startAliasMapServerIfNecessary</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 创建 NN 的 RPC 服务端   再看这个</span>
 rpcServer <span class="token operator">=</span> <span class="token function">createRpcServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">initReconfigurableBackoffKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>clientNamenodeAddress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// This is expected for MiniDFSCluster. Set it now using </span>
 <span class="token comment">// the RPC server's bind address.</span>
 clientNamenodeAddress <span class="token operator">=</span> 
 <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getHostPortString</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Clients are to use &quot;</span> <span class="token operator">+</span> clientNamenodeAddress <span class="token operator">+</span> <span class="token string">&quot; to access&quot;</span>
 <span class="token operator">+</span> <span class="token string">&quot; this namenode/service.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">==</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setNameNodeAddress</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setFSImage</span><span class="token punctuation">(</span><span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// NN 启动资源检查</span>
 <span class="token function">startCommonServices</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startMetricsLogger</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>启动 9870 端口服务</strong></p> <p>点击 <code>startHttpServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startHttpServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
httpServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getHttpServerBindAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">setStartupProgress</span><span class="token punctuation">(</span>startupProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpServerBindAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> bindAddress <span class="token operator">=</span> <span class="token function">getHttpServerAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> bindAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpServerAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token function">getHttpAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>
 conf<span class="token punctuation">.</span><span class="token function">getTrimmed</span><span class="token punctuation">(</span>DFS_NAMENODE_HTTP_ADDRESS_KEY<span class="token punctuation">,</span> 
DFS_NAMENODE_HTTP_ADDRESS_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> DFS_NAMENODE_HTTP_ADDRESS_DEFAULT <span class="token operator">=</span> <span class="token string">&quot;0.0.0.0:&quot;</span> <span class="token operator">+</span> 
DFS_NAMENODE_HTTP_PORT_DEFAULT<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DFS_NAMENODE_HTTP_PORT_DEFAULT <span class="token operator">=</span>
<span class="token class-name">HdfsClientConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HTTP_PORT_DEFAULT<span class="token punctuation">;</span>
<span class="token keyword">int</span> DFS_NAMENODE_HTTP_PORT_DEFAULT <span class="token operator">=</span> <span class="token number">9870</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>点击 <code>startHttpServer</code> 方法中的 <code>httpServer.start()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeHttpServer.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// Hadoop 自己封装了 HttpServer，形成自己的 HttpServer2</span>
 <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">httpServerTemplateForNNAndJN</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span>
 httpAddr<span class="token punctuation">,</span> httpsAddr<span class="token punctuation">,</span> <span class="token string">&quot;hdfs&quot;</span><span class="token punctuation">,</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_KERBEROS_INTERNAL_SPNEGO_PRINCIPAL_K
EY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_KEYTAB_FILE_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 httpServer <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>NAMENODE_ATTRIBUTE_KEY<span class="token punctuation">,</span> nn<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">JspHelper</span><span class="token punctuation">.</span>CURRENT_CONF<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 点击</span>
 <span class="token function">setupServlets</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>点击 <code>setupServlets</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setupServlets</span><span class="token punctuation">(</span><span class="token class-name">HttpServer2</span> httpServer<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;startupProgress&quot;</span><span class="token punctuation">,</span>
<span class="token class-name">StartupProgressServlet</span><span class="token punctuation">.</span>PATH_SPEC<span class="token punctuation">,</span> <span class="token class-name">StartupProgressServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;fsck&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/fsck&quot;</span><span class="token punctuation">,</span> <span class="token class-name">FsckServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
<span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
httpServer<span class="token punctuation">.</span><span class="token function">addInternalServlet</span><span class="token punctuation">(</span><span class="token string">&quot;imagetransfer&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ImageServlet</span><span class="token punctuation">.</span>PATH_SPEC<span class="token punctuation">,</span>
 <span class="token class-name">ImageServlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>加载镜像文件和编辑日志</strong></p> <p>点击 <code>loadNamesystem</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadNamesystem</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                                
<span class="token keyword">this</span><span class="token punctuation">.</span>namesystem <span class="token operator">=</span> <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">loadFromDisk</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//                          ----------</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">FSNamesystem</span> <span class="token function">loadFromDisk</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkConfiguration</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">//</span>
 <span class="token class-name">FSImage</span> fsImage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSImage</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span>
              <span class="token comment">//</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token class-name">FSNamesystem</span> namesystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSNamesystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> fsImage<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token class-name">StartupOption</span> startOpt <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupOption</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>startOpt <span class="token operator">==</span> <span class="token class-name">StartupOption</span><span class="token punctuation">.</span>RECOVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 namesystem<span class="token punctuation">.</span><span class="token function">setSafeMode</span><span class="token punctuation">(</span><span class="token class-name">SafeModeAction</span><span class="token punctuation">.</span>SAFEMODE_ENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> loadStart <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
     <span class="token comment">//</span>
 namesystem<span class="token punctuation">.</span><span class="token function">loadFSImage</span><span class="token punctuation">(</span>startOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Encountered exception loading fsimage&quot;</span><span class="token punctuation">,</span> ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsImage<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> ioe<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> timeTakenToLoadFSImage <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> loadStart<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Finished loading FSImage in &quot;</span> <span class="token operator">+</span> timeTakenToLoadFSImage <span class="token operator">+</span> <span class="token string">&quot; msecs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">NameNodeMetrics</span> nnMetrics <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getNameNodeMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>nnMetrics <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 nnMetrics<span class="token punctuation">.</span><span class="token function">setFsImageLoadTime</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> timeTakenToLoadFSImage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 namesystem<span class="token punctuation">.</span><span class="token function">getFSDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createReservedStatuses</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">getCTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> namesystem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><strong>初始化 NN 的 RPC 服务端</strong></p> <p>点击 <code>createRpcServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">protected</span> <span class="token class-name">NameNodeRpcServer</span> <span class="token function">createRpcServer</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeRpcServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">NameNodeRpcServer</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">NameNode</span> nn<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 serviceRpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPC<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span>
 <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hdfs<span class="token punctuation">.</span>protocolPB<span class="token punctuation">.</span></span>ClientNamenodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>clientNNPbService<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBindAddress</span><span class="token punctuation">(</span>bindHost<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>serviceRpcAddr<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setNumHandlers</span><span class="token punctuation">(</span>serviceHandlerCount<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setSecretManager</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">getDelegationTokenSecretManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>NN 启动资源检查</strong></p> <p>点击 <code>startCommonServices</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNode.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 namesystem<span class="token punctuation">.</span><span class="token function">startCommonServices</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> haContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">registerNNSMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NamenodeRole</span><span class="token punctuation">.</span>NAMENODE <span class="token operator">!=</span> role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">startHttpServer</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setNameNodeAddress</span><span class="token punctuation">(</span><span class="token function">getNameNodeAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">setFSImage</span><span class="token punctuation">(</span><span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 plugins <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>DFS_NAMENODE_PLUGINS_KEY<span class="token punctuation">,</span>
 <span class="token class-name">ServicePlugin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">String</span> pluginsValue <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>DFS_NAMENODE_PLUGINS_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to load NameNode plugins. Specified list of plugins: &quot;</span> <span class="token operator">+</span>
 pluginsValue<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 … …
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>点击 <code>startCommonServices</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">HAContext</span> haContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerMBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// register the MBean for the FSNamesystemState</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>haContext <span class="token operator">=</span> haContext<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 nnResourceChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 检查是否有足够的磁盘存储元数据（fsimage（默认 100m）editLog（默认 100m））</span>
 <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> <span class="token operator">!</span>blockManager<span class="token punctuation">.</span><span class="token function">isPopulatingReplQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">StartupProgress</span> prog <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 prog<span class="token punctuation">.</span><span class="token function">beginPhase</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> completeBlocksTotal <span class="token operator">=</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 安全模式</span>
 prog<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">,</span> STEP_AWAITING_REPORTED_BLOCKS<span class="token punctuation">,</span>
 completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 启动块服务</span>
 blockManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;startCommonServices&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>inodeAttributeProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 inodeAttributeProvider<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dir<span class="token punctuation">.</span><span class="token function">setINodeAttributeProvider</span><span class="token punctuation">(</span>inodeAttributeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 snapshotManager<span class="token punctuation">.</span><span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InetSocketAddress</span> serviceAddress <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getServiceAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>nameNodeHostName <span class="token operator">=</span> <span class="token punctuation">(</span>serviceAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 serviceAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>点击 <code>NameNodeResourceChecker</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> conf<span class="token punctuation">;</span>
 volumes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">CheckedVolume</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// dfs.namenode.resource.du.reserved 默认值 1024 * 1024 * 100 =》100m</span>
 duReserved <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_DU_RESERVED_KEY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_DU_RESERVED_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> extraCheckedVolumes <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">stringCollectionAsURIs</span><span class="token punctuation">(</span>conf
 <span class="token punctuation">.</span><span class="token function">getTrimmedStringCollection</span><span class="token punctuation">(</span><span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VO
LUMES_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> localEditDirs <span class="token operator">=</span> <span class="token class-name">Collections2</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">URI</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getScheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">NNStorage</span><span class="token punctuation">.</span>LOCAL_URI_SCHEME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 对所有路径进行资源检查</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>URI editsDirToCheck <span class="token operator">:</span> localEditDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">addDirToCheck</span><span class="token punctuation">(</span>editsDirToCheck<span class="token punctuation">,</span>
 <span class="token class-name">FSNamesystem</span><span class="token punctuation">.</span><span class="token function">getRequiredNamespaceEditsDirs</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>
 editsDirToCheck<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// All extra checked volumes are marked &quot;required&quot;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span>URI extraDirToCheck <span class="token operator">:</span> extraCheckedVolumes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">addDirToCheck</span><span class="token punctuation">(</span>extraDirToCheck<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 minimumRedundantVolumes <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_KEY<span class="token punctuation">,</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_CHECKED_VOLUMES_MINIMUM_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>点击 <code>checkAvailableResources</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FNNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> resourceCheckTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkState</span><span class="token punctuation">(</span>nnResourceChecker <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token string">&quot;nnResourceChecker not initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 判断资源是否足够，不够返回 false</span>
hasResourcesAvailable <span class="token operator">=</span> nnResourceChecker<span class="token punctuation">.</span><span class="token function">hasAvailableDiskSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
resourceCheckTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> resourceCheckTime<span class="token punctuation">;</span>
<span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getNameNodeMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addResourceCheckTime</span><span class="token punctuation">(</span>resourceCheckTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasAvailableDiskSpace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token class-name">NameNodeResourcePolicy</span><span class="token punctuation">.</span><span class="token function">areResourcesAvailable</span><span class="token punctuation">(</span>volumes<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 minimumRedundantVolumes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeResourcePolicy.java</span>
<span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">areResourcesAvailable</span><span class="token punctuation">(</span>
 <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CheckableNameNodeResource</span><span class="token punctuation">&gt;</span></span> resources<span class="token punctuation">,</span>
 <span class="token keyword">int</span> minimumRedundantResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// TODO: workaround:</span>
 <span class="token comment">// - during startup, if there are no edits dirs on disk, then there is</span>
<span class="token comment">// a call to areResourcesAvailable() with no dirs at all, which was</span>
 <span class="token comment">// previously causing the NN to enter safemode</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>resources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">int</span> requiredResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> redundantResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> disabledRedundantResourceCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token comment">// 判断资源是否充足</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CheckableNameNodeResource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 redundantResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 disabledRedundantResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 requiredResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">.</span><span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Short circuit - a required resource is not available. 不充足返回 false</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">if</span> <span class="token punctuation">(</span>redundantResourceCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are no redundant resources, return true if there are any</span>
 <span class="token comment">// required resources available.</span>
 <span class="token keyword">return</span> requiredResourceCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> redundantResourceCount <span class="token operator">-</span> disabledRedundantResourceCount <span class="token operator">&gt;=</span>
 minimumRedundantResources<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">CheckableNameNodeResource</span> <span class="token punctuation">{</span>
 
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p><code>ctrl + h</code>，查找实现类<code>CheckedVolume</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeResourceChecker.java</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isResourceAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 获取当前目录的空间大小</span>
 <span class="token keyword">long</span> availableSpace <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token function">getAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Space available on volume '&quot;</span> <span class="token operator">+</span> volume <span class="token operator">+</span> <span class="token string">&quot;' is &quot;</span>
 <span class="token operator">+</span> availableSpace<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token operator">/</span> 如果当前空间大小，小于 <span class="token number">100</span>m，返回 <span class="token boolean">false</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>availableSpace <span class="token operator">&lt;</span> duReserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Space available on volume '&quot;</span> <span class="token operator">+</span> volume <span class="token operator">+</span> <span class="token string">&quot;' is &quot;</span>
 <span class="token operator">+</span> availableSpace <span class="token operator">+</span>
 <span class="token string">&quot;, which is below the configured reserved amount &quot;</span> <span class="token operator">+</span> duReserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>NN 对心跳超时判断</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Ctrl + n 搜索 namenode，ctrl + f 搜索 startCommonServices
点击 namesystem.startCommonServices(conf, haContext);
点击 blockManager.activate(conf, completeBlocksTotal);
点击 datanodeManager.activate(conf);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DatanodeManager.java</span>
<span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanodeAdminManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeManager.java</span>
<span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 启动的线程，搜索 run 方法</span>
 heartbeatThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span><span class="token punctuation">(</span>namesystem<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">restartHeartbeatStopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lastHeartbeatCheck <span class="token operator">+</span> heartbeatRecheckInterval <span class="token operator">&lt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 心跳检查</span>
 <span class="token function">heartbeatCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastHeartbeatCheck <span class="token operator">=</span> now<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>blockManager<span class="token punctuation">.</span><span class="token function">shouldUpdateBlockKey</span><span class="token punctuation">(</span>now <span class="token operator">-</span> lastBlockKeyUpdate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">HeartbeatManager</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> d <span class="token operator">:</span> datanodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 d<span class="token punctuation">.</span><span class="token function">setNeedKeyUpdate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 lastBlockKeyUpdate <span class="token operator">=</span> now<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception while checking heartbeat&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5 seconds</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
 <span class="token comment">// avoid declaring nodes dead for another cycle if a GC pause lasts</span>
 <span class="token comment">// longer than the node recheck interval</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAbortHeartbeatCheck</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping next heartbeat scan due to excessive pause&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastHeartbeatCheck <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">heartbeatCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeManager</span> dm <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> allAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>allAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// locate the first dead node.</span>
 <span class="token class-name">DatanodeDescriptor</span> dead <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// locate the first failed storage that isn't on a dead node.</span>
 <span class="token class-name">DatanodeStorageInfo</span> failedStorage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// check the number of stale nodes</span>
 <span class="token keyword">int</span> numOfStaleNodes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> numOfStaleStorages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> d <span class="token operator">:</span> datanodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// check if an excessive GC pause has occurred</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAbortHeartbeatCheck</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token comment">// 判断 DN 节点是否挂断</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dead <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> dm<span class="token punctuation">.</span><span class="token function">isDatanodeDead</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 stats<span class="token punctuation">.</span><span class="token function">incrExpiredHeartbeats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dead <span class="token operator">=</span> d<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">.</span><span class="token function">isStale</span><span class="token punctuation">(</span>dm<span class="token punctuation">.</span><span class="token function">getStaleInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 numOfStaleNodes<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> storageInfos <span class="token operator">=</span> d<span class="token punctuation">.</span><span class="token function">getStorageInfos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DatanodeStorageInfo</span> storageInfo <span class="token operator">:</span> storageInfos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>storageInfo<span class="token punctuation">.</span><span class="token function">areBlockContentsStale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 numOfStaleStorages<span class="token operator">++</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>failedStorage <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
 storageInfo<span class="token punctuation">.</span><span class="token function">areBlocksOnFailedStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
 d <span class="token operator">!=</span> dead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 failedStorage <span class="token operator">=</span> storageInfo<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// Set the number of stale nodes in the DatanodeManager</span>
 dm<span class="token punctuation">.</span><span class="token function">setNumStaleNodes</span><span class="token punctuation">(</span>numOfStaleNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 dm<span class="token punctuation">.</span><span class="token function">setNumStaleStorages</span><span class="token punctuation">(</span>numOfStaleStorages<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">boolean</span> <span class="token function">isDatanodeDead</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span>
 <span class="token punctuation">(</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> heartbeatExpireInterval<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> heartbeatExpireInterval<span class="token punctuation">;</span>
<span class="token comment">// 10 分钟 + 30 秒</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExpireInterval <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> heartbeatRecheckInterval <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> 
heartbeatIntervalSeconds<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> heartbeatRecheckInterval<span class="token punctuation">;</span>
heartbeatRecheckInterval <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_KEY<span class="token punctuation">,</span> 
 
<span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_NAMENODE_HEARTBEAT_RECHECK_INTERVAL_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 5 minutes</span>
<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> heartbeatIntervalSeconds<span class="token punctuation">;</span>
heartbeatIntervalSeconds <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getTimeDuration</span><span class="token punctuation">(</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_HEARTBEAT_INTERVAL_KEY<span class="token punctuation">,</span>
 <span class="token class-name">DFSConfigKeys</span><span class="token punctuation">.</span>DFS_HEARTBEAT_INTERVAL_DEFAULT<span class="token punctuation">,</span> 
<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> DFS_HEARTBEAT_INTERVAL_DEFAULT <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p><strong>安全模式</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token keyword">void</span> <span class="token function">startCommonServices</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">HAContext</span> haContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerMBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// register the MBean for the FSNamesystemState</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>haContext <span class="token operator">=</span> haContext<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 nnResourceChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameNodeResourceChecker</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 检查是否有足够的磁盘存储元数据（fsimage（默认 100m）editLog（默认 100m））</span>
 <span class="token function">checkAvailableResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> <span class="token operator">!</span>blockManager<span class="token punctuation">.</span><span class="token function">isPopulatingReplQueues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">StartupProgress</span> prog <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getStartupProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 开始进入安全模式</span>
 prog<span class="token punctuation">.</span><span class="token function">beginPhase</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 获取所有可以正常使用的 block</span>
<span class="token keyword">long</span> completeBlocksTotal <span class="token operator">=</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 prog<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SAFEMODE<span class="token punctuation">,</span> STEP_AWAITING_REPORTED_BLOCKS<span class="token punctuation">,</span>
 completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 启动块服务</span>
 blockManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> completeBlocksTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;startCommonServices&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DefaultMetricsSystem</span><span class="token punctuation">.</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>inodeAttributeProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 inodeAttributeProvider<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 dir<span class="token punctuation">.</span><span class="token function">setINodeAttributeProvider</span><span class="token punctuation">(</span>inodeAttributeProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 snapshotManager<span class="token punctuation">.</span><span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InetSocketAddress</span> serviceAddress <span class="token operator">=</span> <span class="token class-name">NameNode</span><span class="token punctuation">.</span><span class="token function">getServiceAddress</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>nameNodeHostName <span class="token operator">=</span> <span class="token punctuation">(</span>serviceAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 serviceAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>点击 <code>getCompleteBlocksTotal</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getCompleteBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Calculate number of blocks under construction</span>
 <span class="token keyword">long</span> numUCBlocks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 获取正在构建的 block</span>
 numUCBlocks <span class="token operator">=</span> leaseManager<span class="token punctuation">.</span><span class="token function">getNumUnderConstructionBlocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取所有的块 - 正在构建的 block = 可以正常使用的 block</span>
 <span class="token keyword">return</span> <span class="token function">getBlocksTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> numUCBlocks<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">readUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;getCompleteBlocksTotal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>点击 <code>activate</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token keyword">long</span> blockTotal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
pendingReconstruction<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
datanodeManager<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>redundancyThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;RedundancyMonitor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>redundancyThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageInfoDefragmenterThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;StorageInfoMonitor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageInfoDefragmenterThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>blockReportThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mxBeanName <span class="token operator">=</span> <span class="token class-name">MBeans</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">&quot;NameNode&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BlockStats&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bmSafeMode<span class="token punctuation">.</span><span class="token function">activate</span><span class="token punctuation">(</span>blockTotal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>点击 <code>activate</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> status <span class="token operator">==</span> <span class="token class-name">BMSafeModeStatus</span><span class="token punctuation">.</span>OFF<span class="token punctuation">;</span>
 startTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 计算是否满足块个数的阈值</span>
 <span class="token function">setBlockTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断 DataNode 节点和块信息是否达到退出安全模式标准</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">areThresholdsMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">boolean</span> exitResult <span class="token operator">=</span> <span class="token function">leaveSafeMode</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkState</span><span class="token punctuation">(</span>exitResult<span class="token punctuation">,</span> <span class="token string">&quot;Failed to leave safe mode.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// enter safe mode</span>
status <span class="token operator">=</span> <span class="token class-name">BMSafeModeStatus</span><span class="token punctuation">.</span>PENDING_THRESHOLD<span class="token punctuation">;</span>
<span class="token function">initializeReplQueuesIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">reportStatus</span><span class="token punctuation">(</span><span class="token string">&quot;STATE* Safe mode ON.&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastStatusReport <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>点击 <code>setBlockTotal</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">setBlockTotal</span><span class="token punctuation">(</span><span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockTotal <span class="token operator">=</span> total<span class="token punctuation">;</span>
<span class="token comment">// 计算阈值：例如：1000 个正常的块 * 0.999 = 999</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockThreshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">*</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockReplQueueThreshold <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total <span class="token operator">*</span> replQueueThreshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getFloat</span><span class="token punctuation">(</span>DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_KEY<span class="token punctuation">,</span>
 DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> 
DFS_NAMENODE_SAFEMODE_THRESHOLD_PCT_DEFAULT <span class="token operator">=</span> <span class="token number">0.999f</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>点击<code>areThresholdsMet</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">areThresholdsMet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Calculating the number of live datanodes is time-consuming</span>
 <span class="token comment">// in large clusters. Skip it when datanodeThreshold is zero.</span>
 <span class="token keyword">int</span> datanodeNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>datanodeThreshold <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanodeNum <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNumLiveDataNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 已经正常注册的块数 》= 块的最小阈值 》=最小可用 DataNode</span>
 <span class="token keyword">return</span> blockSafe <span class="token operator">&gt;=</span> blockThreshold <span class="token operator">&amp;&amp;</span> datanodeNum <span class="token operator">&gt;=</span> datanodeThreshold<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></details> <h2 id="dn-启动源码解析"><a href="#dn-启动源码解析" class="header-anchor">#</a> DN 启动源码解析</h2> <p><strong>DN工作机制</strong>：<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902191421.png" alt=""></p> <p><strong>DataNode启动源码解析：</strong></p> <p><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904005131.png" alt=""></p> <p><strong>DN源码解析过程</strong>：</p> <details class="custom-block details"><summary>🦓🦓</summary> <p>pom.xml 中增加如下依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>ctrl + n</code> 全局查找<code>datanode</code>，进入 <code>DataNode.java</code></p> <p><code>ctrl + f</code>，查找 main 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DFSUtil</span><span class="token punctuation">.</span><span class="token function">parseHelpArgument</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token class-name">DataNode</span><span class="token punctuation">.</span>USAGE<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">secureMain</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">secureMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> errorCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startupShutdownMessage</span><span class="token punctuation">(</span><span class="token class-name">DataNode</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> LOG<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DataNode</span> datanode <span class="token operator">=</span> <span class="token function">createDataNode</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 … …
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in secureMain&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exiting Datanode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">terminate</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">createDataNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// 初始化 DN</span>
<span class="token class-name">DataNode</span> dn <span class="token operator">=</span> <span class="token function">instantiateDataNode</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 启动 DN 进程</span>
 dn<span class="token punctuation">.</span><span class="token function">runDatanodeDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> dn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">instantiateDataNode</span><span class="token punctuation">(</span><span class="token class-name">String</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token keyword">return</span> <span class="token function">makeInstance</span><span class="token punctuation">(</span>dataLocations<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">DataNode</span> <span class="token function">makeInstance</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirs<span class="token punctuation">,</span>
 <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> locations<span class="token punctuation">,</span> storageLocationChecker<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirs<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">StorageLocationChecker</span> storageLocationChecker<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">SecureResources</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">super</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 hostName <span class="token operator">=</span> <span class="token function">getHostName</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Configured hostname is {}&quot;</span><span class="token punctuation">,</span> hostName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 启动 DN</span>
 <span class="token function">startDataNode</span><span class="token punctuation">(</span>dataDirs<span class="token punctuation">,</span> resources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> ie<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">startDataNode</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageLocation</span><span class="token punctuation">&gt;</span></span> dataDirectories<span class="token punctuation">,</span>
 <span class="token class-name">SecureResources</span> resources
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// 创建数据存储对象</span>
 storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// global DN settings</span>
 <span class="token function">registerMXBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 初始化 DataXceiver</span>
 <span class="token function">initDataXceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 启动 HttpServer</span>
 <span class="token function">startInfoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pauseMonitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JvmPauseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pauseMonitor<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pauseMonitor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// BlockPoolTokenSecretManager is required to create ipc server.</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>blockPoolTokenSecretManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockPoolTokenSecretManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Login is done by now. Set the DN user name.</span>
 dnUserName <span class="token operator">=</span> <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;dnUserName = {}&quot;</span><span class="token punctuation">,</span> dnUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;supergroup = {}&quot;</span><span class="token punctuation">,</span> supergroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 初始化 RPC 服务</span>
 <span class="token function">initIpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 metrics <span class="token operator">=</span> <span class="token class-name">DataNodeMetrics</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 peerMetrics <span class="token operator">=</span> dnConf<span class="token punctuation">.</span>peerStatsEnabled <span class="token operator">?</span>
 <span class="token class-name">DataNodePeerMetrics</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 metrics<span class="token punctuation">.</span><span class="token function">getJvmMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPauseMonitor</span><span class="token punctuation">(</span>pauseMonitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
 ecWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErasureCodingWorker</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockRecoveryWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockRecoveryWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 创建 BlockPoolManager</span>
 blockPoolManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlockPoolManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 心跳管理</span>
 blockPoolManager<span class="token punctuation">.</span><span class="token function">refreshNamenodes</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Create the ReadaheadPool from the DataNode context so we can</span>
 <span class="token comment">// exit without having to explicitly shutdown its thread pool.</span>
 readaheadPool <span class="token operator">=</span> <span class="token class-name">ReadaheadPool</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 saslClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaslDataTransferClient</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dnConf<span class="token punctuation">.</span>saslPropsResolver<span class="token punctuation">,</span> dnConf<span class="token punctuation">.</span>trustedChannelResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
 saslServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SaslDataTransferServer</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">,</span> blockPoolTokenSecretManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startMetricsLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>diskStatsEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 diskMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataNodeDiskMetrics</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
 dnConf<span class="token punctuation">.</span>outliersReportIntervalMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br></div></div><p><strong>初始化 <code>DataXceiverServer</code></strong></p> <p>点击 <code>initDataXceiver</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDataXceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// dataXceiverServer 是一个服务，DN 用来接收客户端和其他 DN 发送过来的数据服务</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>dataXceiverServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span>threadGroup<span class="token punctuation">,</span> xserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>threadGroup<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// auto destroy when empty</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>初始化 HTTP 服务</strong></p> <p>点击 <code>startInfoServer();</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// DN.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInfoServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// SecureDataNodeStarter will bind the privileged port to the channel if</span>
 <span class="token comment">// the DN is started by JSVC, pass it along.</span>
 <span class="token class-name">ServerSocketChannel</span> httpServerChannel <span class="token operator">=</span> secureResources <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
 secureResources<span class="token punctuation">.</span><span class="token function">getHttpServerChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 httpServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatanodeHttpServer</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> httpServerChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
 httpServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>httpServer<span class="token punctuation">.</span><span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 infoPort <span class="token operator">=</span> httpServer<span class="token punctuation">.</span><span class="token function">getHttpAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>httpServer<span class="token punctuation">.</span><span class="token function">getHttpsAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 infoSecurePort <span class="token operator">=</span> httpServer<span class="token punctuation">.</span><span class="token function">getHttpsAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeHttpServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeHttpServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> datanode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">ServerSocketChannel</span> externalHttpChannel<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpServer2<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;datanode&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setConf</span><span class="token punctuation">(</span>confForInfoServer<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setACL</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AccessControlList</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>DFS_ADMIN<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">hostName</span><span class="token punctuation">(</span><span class="token function">getHostnameForSpnegoPrincipal</span><span class="token punctuation">(</span>confForInfoServer<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:&quot;</span> <span class="token operator">+</span> proxyPort<span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setFindPort</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><strong>初始化 DN 的 RPC 服务端</strong></p> <p>点击 <code>initIpcServer</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initIpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> ipcAddr <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTrimmed</span><span class="token punctuation">(</span>DFS_DATANODE_IPC_ADDRESS_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 ipcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPC<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setProtocol</span><span class="token punctuation">(</span><span class="token class-name">ClientDatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setInstance</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBindAddress</span><span class="token punctuation">(</span>ipcAddr<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>ipcAddr<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setNumHandlers</span><span class="token punctuation">(</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>DFS_DATANODE_HANDLER_COUNT_KEY<span class="token punctuation">,</span>
 DFS_DATANODE_HANDLER_COUNT_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setSecretManager</span><span class="token punctuation">(</span>blockPoolTokenSecretManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>DN 向 NN 注册</strong></p> <p>点击<code>refreshNamenodes</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// BlockPoolManager.java</span>
<span class="token keyword">void</span> <span class="token function">refreshNamenodes</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>refreshNamenodesLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">doRefreshNamenodes</span><span class="token punctuation">(</span>newAddressMap<span class="token punctuation">,</span> newLifelineAddressMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doRefreshNamenodes</span><span class="token punctuation">(</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> addrMap<span class="token punctuation">,</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> lifelineAddrMap<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 … …<span class="token punctuation">.</span>
 
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 … …
 <span class="token comment">// Step 3. Start new nameservices</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>toAdd<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> nsToAdd <span class="token operator">:</span> toAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 … …
 <span class="token class-name">BPOfferService</span> bpos <span class="token operator">=</span> <span class="token function">createBPOS</span><span class="token punctuation">(</span>nsToAdd<span class="token punctuation">,</span> addrs<span class="token punctuation">,</span> lifelineAddrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpByNameserviceId<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nsToAdd<span class="token punctuation">,</span> bpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 offerServices<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">startAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 … …
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">BPOfferService</span> <span class="token function">createBPOS</span><span class="token punctuation">(</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> nameserviceId<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span></span> nnAddrs<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">&gt;</span></span> lifelineNnAddrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 根据 NameNode 个数创建对应的服务</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BPOfferService</span><span class="token punctuation">(</span>nameserviceId<span class="token punctuation">,</span> nnAddrs<span class="token punctuation">,</span> lifelineNnAddrs<span class="token punctuation">,</span> dn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>点击 <code>startAll()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span>
 <span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BPOfferService</span> bpos <span class="token operator">:</span> offerServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 启动服务</span>
 bpos<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>点击 <code>start ()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPOfferService.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BPServiceActor</span> actor <span class="token operator">:</span> bpServices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 actor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点击 <code>start ()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPServiceActor.java</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 bpThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// needed for JUnit testing</span>
<span class="token comment">// 表示开启一个线程，所有查找该线程的 run 方法</span>
 bpThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lifelineSender <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 lifelineSender<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>ctrl + f</code> 搜索 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; starting to offer service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// init stuff</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// setup storage</span>
<span class="token comment">// 向 NN 注册</span>
 <span class="token function">connectToNNAndHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Initial handshake, storage recovery or registration failed</span>
 runningState <span class="token operator">=</span> <span class="token class-name">RunningState</span><span class="token punctuation">.</span>INIT_FAILED<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldRetryInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Retry until all namenode's of BPOS failed initialization</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Initialization failed for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span>
 <span class="token operator">+</span> ioe<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 注册失败，5s 后重试</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 runningState <span class="token operator">=</span> <span class="token class-name">RunningState</span><span class="token punctuation">.</span>FAILED<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Initialization failed for &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;. Exiting. &quot;</span><span class="token punctuation">,</span> ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 … …
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 发送心跳</span>
 <span class="token function">offerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">connectToNNAndHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// get NN proxy 获取 NN 的 RPC 客户端对象</span>
 bpNamenode <span class="token operator">=</span> dn<span class="token punctuation">.</span><span class="token function">connectToNN</span><span class="token punctuation">(</span>nnAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// First phase of the handshake with NN - get the namespace</span>
 <span class="token comment">// info.</span>
 <span class="token class-name">NamespaceInfo</span> nsInfo <span class="token operator">=</span> <span class="token function">retrieveNamespaceInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Verify that this matches the other NN in this HA pair.</span>
 <span class="token comment">// This also initializes our block pool in the DN if we are</span>
 <span class="token comment">// the first NN connection for this BP.</span>
 bpos<span class="token punctuation">.</span><span class="token function">verifyAndSetNamespaceInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">/* set thread name again to include NamespaceInfo when it's available. */</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>bpThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token function">formatThreadName</span><span class="token punctuation">(</span><span class="token string">&quot;heartbeating&quot;</span><span class="token punctuation">,</span> nnAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 注册</span>
 <span class="token function">register</span><span class="token punctuation">(</span>nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span> <span class="token function">connectToNN</span><span class="token punctuation">(</span>
 <span class="token class-name">InetSocketAddress</span> nnAddr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span><span class="token punctuation">(</span>nnAddr<span class="token punctuation">,</span> <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DatanodeProtocolClientSideTranslatorPB.java</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeProtocolClientSideTranslatorPB</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> nameNodeAddr<span class="token punctuation">,</span>
 <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
RPC<span class="token punctuation">.</span><span class="token function">setProtocolEngine</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
 <span class="token class-name">ProtobufRpcEngine</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">UserGroupInformation</span> ugi <span class="token operator">=</span> <span class="token class-name">UserGroupInformation</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 rpcProxy <span class="token operator">=</span> <span class="token function">createNamenode</span><span class="token punctuation">(</span>nameNodeAddr<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> ugi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DatanodeProtocolPB</span> <span class="token function">createNamenode</span><span class="token punctuation">(</span>
 <span class="token class-name">InetSocketAddress</span> nameNodeAddr<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">,</span>
 <span class="token class-name">UserGroupInformation</span> ugi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> RPC<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
 RPC<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nameNodeAddr<span class="token punctuation">,</span> ugi<span class="token punctuation">,</span>
 conf<span class="token punctuation">,</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getSocketFactory</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">DatanodeProtocolPB</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>点击 <code>register</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BPServiceActor.java</span>
<span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">NamespaceInfo</span> nsInfo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// 创建注册信息</span>
 <span class="token class-name">DatanodeRegistration</span> newBpRegistration <span class="token operator">=</span> bpos<span class="token punctuation">.</span><span class="token function">createRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot; beginning handshake with NN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// Use returned registration from namenode with updated fields</span>
 <span class="token comment">// 把注册信息发送给 NN（DN 调用接口方法，执行在 NN）</span>
 newBpRegistration <span class="token operator">=</span> bpNamenode<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>newBpRegistration<span class="token punctuation">)</span><span class="token punctuation">;</span>
 newBpRegistration<span class="token punctuation">.</span><span class="token function">setNamespaceInfo</span><span class="token punctuation">(</span>nsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bpRegistration <span class="token operator">=</span> newBpRegistration<span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">EOFException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// namenode might have just restarted</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Problem connecting to server: &quot;</span> <span class="token operator">+</span> nnAddr <span class="token operator">+</span> <span class="token string">&quot; :&quot;</span>
 <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">sleepAndLogInterrupts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;connecting to server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">SocketTimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// namenode is busy</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Problem connecting to server: &quot;</span> <span class="token operator">+</span> nnAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">sleepAndLogInterrupts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;connecting to server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 … …
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>ctrl + n 搜索 NameNodeRpcServer
NameNodeRpcServer.java
ctrl + f 在 NameNodeRpcServer.java 中搜索 registerDatanode
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DatanodeRegistration</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">verifySoftwareVersion</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 注册 DN</span>
 namesystem<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> nodeReg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>

<span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 blockManager<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;registerDatanode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//BlockManager.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> namesystem<span class="token punctuation">.</span><span class="token function">hasWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 datanodeManager<span class="token punctuation">.</span><span class="token function">registerDatanode</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 bmSafeMode<span class="token punctuation">.</span><span class="token function">checkSafeMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerDatanode</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">DisallowedDatanodeException</span><span class="token punctuation">,</span> <span class="token class-name">UnresolvedTopologyException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// register new datanode 注册 DN</span>
 <span class="token function">addDatanode</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockManager<span class="token punctuation">.</span><span class="token function">getBlockReportLeaseManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// also treat the registration message as a heartbeat</span>
 <span class="token comment">// no need to update its timestamp</span>
 <span class="token comment">// because its is done when the descriptor is created</span>
<span class="token comment">// 将 DN 添加到心跳管理</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">addDatanode</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">updateDnStat</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">incrementVersionCount</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">.</span><span class="token function">getSoftwareVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">startAdminOperationIfNecessary</span><span class="token punctuation">(</span>nodeDescr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">addDatanode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// To keep host2DatanodeMap consistent with datanodeMap,</span>
 <span class="token comment">// remove from host2DatanodeMap the datanodeDescriptor removed</span>
 <span class="token comment">// from datanodeMap before adding node to host2DatanodeMap.</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 host2DatanodeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>datanodeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getDatanodeUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 networktopology<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// may throw InvalidTopologyException</span>
host2DatanodeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">checkIfClusterIsNowMultiRack</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">resolveUpgradeDomain</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 … …
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p><strong>向 NN 发送心跳</strong></p> <p>点击 <code>BPServiceActor.java</code> 中的 run 方法中的 <code>offerService</code> 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// BPServiceActor.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">offerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HeartbeatResponse</span> resp <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>sendHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">boolean</span> requestBlockReportLease <span class="token operator">=</span> <span class="token punctuation">(</span>fullBlockReportLeaseId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
scheduler<span class="token punctuation">.</span><span class="token function">isBlockReportDue</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dn<span class="token punctuation">.</span><span class="token function">areHeartbeatsDisabledForTests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 发送心跳信息</span>
 resp <span class="token operator">=</span> <span class="token function">sendHeartBeat</span><span class="token punctuation">(</span>requestBlockReportLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">assert</span> resp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getFullBlockReportLeaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>fullBlockReportLeaseId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 fullBlockReportLeaseId <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">getFullBlockReportLeaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatResponse</span> <span class="token function">sendHeartBeat</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> requestBlockReportLease<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 通过 NN 的 RPC 客户端发送给 NN</span>
<span class="token class-name">HeartbeatResponse</span> response <span class="token operator">=</span> bpNamenode<span class="token punctuation">.</span><span class="token function">sendHeartbeat</span><span class="token punctuation">(</span>bpRegistration<span class="token punctuation">,</span>
 reports<span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getFSDataset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getFSDataset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCacheUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getXmitsInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 dn<span class="token punctuation">.</span><span class="token function">getXceiverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 numFailedVolumes<span class="token punctuation">,</span>
 volumeFailureSummary<span class="token punctuation">,</span>
 requestBlockReportLease<span class="token punctuation">,</span>
 slowPeers<span class="token punctuation">,</span>
 slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>ctrl + n 搜索 NameNodeRpcServer
NameNodeRpcServer.java
ctrl + f 在 NameNodeRpcServer.java 中搜索 sendHeartbeat
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HeartbeatResponse</span> <span class="token function">sendHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> report<span class="token punctuation">,</span> <span class="token keyword">long</span> dnCacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> dnCacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xmitsInProgress<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span>
 <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span> <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> requestFullBlockReportLease<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
<span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">verifyRequest</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 处理 DN 发送的心跳</span>
 <span class="token keyword">return</span> namesystem<span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">,</span> report<span class="token punctuation">,</span>
 dnCacheCapacity<span class="token punctuation">,</span> dnCacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span> xmitsInProgress<span class="token punctuation">,</span>
 failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">,</span> requestFullBlockReportLease<span class="token punctuation">,</span>
slowPeers<span class="token punctuation">,</span> slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatResponse</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> xmitsInProgress<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> requestFullBlockReportLease<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">//get datanode commands</span>
 <span class="token keyword">final</span> <span class="token keyword">int</span> maxTransfer <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getMaxReplicationStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">-</span> xmitsInProgress<span class="token punctuation">;</span>
<span class="token comment">// 处理 DN 发送过来的心跳</span>
 <span class="token class-name">DatanodeCommand</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cmds <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">getDatanodeManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>
 nodeReg<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> <span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span>
 xceiverCount<span class="token punctuation">,</span> maxTransfer<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">,</span>
 slowPeers<span class="token punctuation">,</span> slowDisks<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> blockReportLeaseId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>requestFullBlockReportLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 blockReportLeaseId <span class="token operator">=</span> blockManager<span class="token punctuation">.</span><span class="token function">requestBlockReportLeaseId</span><span class="token punctuation">(</span>nodeReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//create ha status</span>
 <span class="token keyword">final</span> <span class="token class-name">NNHAStatusHeartbeat</span> haState <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NNHAStatusHeartbeat</span><span class="token punctuation">(</span>
 haContext<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getFSImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrectLastAppliedOrWrittenTxId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 响应 DN 的心跳</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeartbeatResponse</span><span class="token punctuation">(</span>cmds<span class="token punctuation">,</span> haState<span class="token punctuation">,</span> rollingUpgradeInfo<span class="token punctuation">,</span>
 blockReportLeaseId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">readUnlock</span><span class="token punctuation">(</span><span class="token string">&quot;handleHeartbeat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>点击 <code>handleHeartbeat</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">DatanodeManager</span><span class="token punctuation">.</span>java
<span class="token keyword">public</span> <span class="token class-name">DatanodeCommand</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeRegistration</span> nodeReg<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> blockPoolId<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> 
 <span class="token keyword">int</span> maxTransfers<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowPeerReports</span> slowPeers<span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Nonnull</span> <span class="token class-name">SlowDiskReports</span> slowDisks<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 heartbeatManager<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>nodeinfo<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span>
 cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">}</span>
<span class="token class-name">HeartbeatManager</span><span class="token punctuation">.</span>java
<span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">,</span>
 <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span>
 <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
stats<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockManager<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span>
 xceiverCount<span class="token punctuation">,</span> failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 stats<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockManager</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">DatanodeDescriptor</span> node<span class="token punctuation">,</span> <span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> failedVolumes<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StorageReport</span> report<span class="token operator">:</span> reports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 providedStorageMap<span class="token punctuation">.</span><span class="token function">updateStorage</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> report<span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 node<span class="token punctuation">.</span><span class="token function">updateHeartbeat</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 failedVolumes<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">.</span>java
<span class="token keyword">void</span> <span class="token function">updateHeartbeat</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">updateHeartbeatState</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 volFailures<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 heartbeatedSinceRegistration <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">updateHeartbeatState</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 更新存储</span>
 <span class="token function">updateStorageStats</span><span class="token punctuation">(</span>reports<span class="token punctuation">,</span> cacheCapacity<span class="token punctuation">,</span> cacheUsed<span class="token punctuation">,</span> xceiverCount<span class="token punctuation">,</span>
 volFailures<span class="token punctuation">,</span> volumeFailureSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 更新心跳时间</span>
 <span class="token function">setLastUpdate</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">rollBlocksScheduled</span><span class="token punctuation">(</span><span class="token function">getLastUpdateMonotonic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateStorageStats</span><span class="token punctuation">(</span><span class="token class-name">StorageReport</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reports<span class="token punctuation">,</span> <span class="token keyword">long</span> cacheCapacity<span class="token punctuation">,</span>
 <span class="token keyword">long</span> cacheUsed<span class="token punctuation">,</span> <span class="token keyword">int</span> xceiverCount<span class="token punctuation">,</span> <span class="token keyword">int</span> volFailures<span class="token punctuation">,</span>
 <span class="token class-name">VolumeFailureSummary</span> volumeFailureSummary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">long</span> totalCapacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalRemaining <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalBlockPoolUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalDfsUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> totalNonDfsUsed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 … …
 <span class="token function">setCacheCapacity</span><span class="token punctuation">(</span>cacheCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setCacheUsed</span><span class="token punctuation">(</span>cacheUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setXceiverCount</span><span class="token punctuation">(</span>xceiverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>volumeFailures <span class="token operator">=</span> volFailures<span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>volumeFailureSummary <span class="token operator">=</span> volumeFailureSummary<span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StorageReport</span> report <span class="token operator">:</span> reports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">DatanodeStorageInfo</span> storage <span class="token operator">=</span>
 storageMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>report<span class="token punctuation">.</span><span class="token function">getStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorageID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>checkFailedStorages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 failedStorageInfos<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>storage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 storage<span class="token punctuation">.</span><span class="token function">receivedHeartbeat</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// skip accounting for capacity of PROVIDED storages!</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span>PROVIDED<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getStorageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 totalCapacity <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalRemaining <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalBlockPoolUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getBlockPoolUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalDfsUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getDfsUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 totalNonDfsUsed <span class="token operator">+=</span> report<span class="token punctuation">.</span><span class="token function">getNonDfsUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// Update total metrics for the node.</span>
 <span class="token comment">// 更新存储相关信息</span>
 <span class="token function">setCapacity</span><span class="token punctuation">(</span>totalCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setRemaining</span><span class="token punctuation">(</span>totalRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setBlockPoolUsed</span><span class="token punctuation">(</span>totalBlockPoolUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setDfsUsed</span><span class="token punctuation">(</span>totalDfsUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setNonDfsUsed</span><span class="token punctuation">(</span>totalNonDfsUsed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>checkFailedStorages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">updateFailedStorage</span><span class="token punctuation">(</span>failedStorageInfos<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> storageMapSize<span class="token punctuation">;</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>storageMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 storageMapSize <span class="token operator">=</span> storageMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>storageMapSize <span class="token operator">!=</span> reports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">pruneStorageMap</span><span class="token punctuation">(</span>reports<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div></details> <h2 id="hdfs-上传源码解析"><a href="#hdfs-上传源码解析" class="header-anchor">#</a> HDFS 上传源码解析</h2> <p><strong>HDFS的写数据流程</strong>：<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210902180939.png" alt=""></p> <p><strong>上传源码解析</strong>：<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904144121.png" alt=""></p> <p><strong>源码解析</strong></p> <details class="custom-block details"><summary>🦓🦓🦓</summary> <p><strong>create 创建过程</strong></p> <p>添加依赖:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.hadoop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hadoop-hdfs-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.7.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>DN 向 NN 发起创建请求</strong></p> <p>用户自己写的代码:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPut2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">FSDataOutputStream</span> fos <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FileSystem.java</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token keyword">boolean</span> overwrite<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span>
 <span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>IO_FILE_BUFFER_SIZE_KEY<span class="token punctuation">,</span>
 IO_FILE_BUFFER_SIZE_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getDefaultReplication</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getDefaultBlockSize</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
<span class="token class-name">Progressable</span> progress
<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token class-name">FsCreateModes</span><span class="token punctuation">.</span><span class="token function">applyUMask</span><span class="token punctuation">(</span>
<span class="token class-name">FsPermission</span><span class="token punctuation">.</span><span class="token function">getFileDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FsPermission</span><span class="token punctuation">.</span><span class="token function">getUMask</span><span class="token punctuation">(</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
overwrite<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span>
<span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
<span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span>
<span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
<span class="token keyword">short</span> replication<span class="token punctuation">,</span>
<span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
<span class="token class-name">Progressable</span> progress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>选中 create，点击<code>ctrl+h</code>，找到实现类 <code>DistributedFileSystem.java</code>，查找 create 方法。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DistributedFileSystem.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> overwrite<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">Progressable</span> progress<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> permission<span class="token punctuation">,</span>
overwrite <span class="token operator">?</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">,</span> <span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>OVERWRITE<span class="token punctuation">)</span>
<span class="token operator">:</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">)</span><span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Path</span> f<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> cflags<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
statistics<span class="token punctuation">.</span><span class="token function">incrementWriteOps</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
storageStatistics<span class="token punctuation">.</span><span class="token function">incrementOpCounter</span><span class="token punctuation">(</span><span class="token class-name">OpType</span><span class="token punctuation">.</span>CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Path</span> absF <span class="token operator">=</span> <span class="token function">fixRelativePart</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileSystemLinkResolver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FSDataOutputStream</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Path</span> p<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token comment">// 创建获取了一个输出流对象</span>
<span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> dfsos <span class="token operator">=</span> dfs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">getPathName</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">,</span> permission<span class="token punctuation">,</span>
cflags<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span>
checksumOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这里将上面创建的 dfsos 进行包装并返回</span>
<span class="token keyword">return</span> dfs<span class="token punctuation">.</span><span class="token function">createWrappedOutputStream</span><span class="token punctuation">(</span>dfsos<span class="token punctuation">,</span> statistics<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">FSDataOutputStream</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FileSystem</span> fs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Path</span> p<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> cflags<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span>
replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> absF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>点击 create，进入<code>DFSClient.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span> <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> buffersize<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span>
 <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">return</span> <span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permission<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span>
progress<span class="token punctuation">,</span> buffersize<span class="token punctuation">,</span> checksumOpt<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> permission<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span> <span class="token keyword">int</span> buffersize<span class="token punctuation">,</span>
 <span class="token class-name">ChecksumOpt</span> checksumOpt<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token function">checkOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">FsPermission</span> masked <span class="token operator">=</span> <span class="token function">applyUMask</span><span class="token punctuation">(</span>permission<span class="token punctuation">)</span><span class="token punctuation">;</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{}: masked={}&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> masked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> result <span class="token operator">=</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">.</span><span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> progress<span class="token punctuation">,</span>
dfsClientConf<span class="token punctuation">.</span><span class="token function">createChecksum</span><span class="token punctuation">(</span>checksumOpt<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">getFavoredNodesStr</span><span class="token punctuation">(</span>favoredNodes<span class="token punctuation">)</span><span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">beginFileLease</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getFileId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>点击 <code>newStreamForCreate</code>，进入 1DFSOutputStream.java`</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span>
 <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span>
dfsClient<span class="token punctuation">.</span><span class="token function">newPathTraceScope</span><span class="token punctuation">(</span><span class="token string">&quot;newStreamForCreate&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">HdfsFileStatus</span> stat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// Retry the create if we get a RetryStartFileException up to a maximum</span>
 <span class="token comment">// number of times</span>
 <span class="token keyword">boolean</span> shouldRetry <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> retryCount <span class="token operator">=</span> CREATE_RETRY_COUNT<span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>shouldRetry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
shouldRetry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// DN 将创建请求发送给 NN（RPC）</span>
 stat <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>namenode<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
 blockSize<span class="token punctuation">,</span> SUPPORTED_CRYPTO_VERSIONS<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 … …<span class="token punctuation">.</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> <span class="token string">&quot;HdfsFileStatus should not be null!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">DFSOutputStream</span> out<span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">getErasureCodingPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSStripedOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 开启线程 run，DataStreamer extends Daemon extends Thread</span>
out<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><strong>NN 处理 DN 的创建请求</strong></p> <p>点击 create</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//ClientProtocol.java
HdfsFileStatus create(String src, FsPermission masked,
 String clientName, EnumSetWritable&lt;CreateFlag&gt; flag,
 boolean createParent, short replication, long blockSize,
 CryptoProtocolVersion[] supportedVersions, String ecPolicyName)
 throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>Ctrl + h</code> 查找 create 实现类，点击 <code>NameNodeRpcServer</code>，在 <code>NameNodeRpcServer.java</code>中搜 索 create</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span>
 <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// 检查 NN 启动</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">HdfsFileStatus</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">PermissionStatus</span> perm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PermissionStatus</span><span class="token punctuation">(</span><span class="token function">getRemoteUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">getShortUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> masked<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 重要</span>
 status <span class="token operator">=</span> namesystem<span class="token punctuation">.</span><span class="token function">startFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> perm<span class="token punctuation">,</span> clientName<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span>
 flag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> supportedVersions<span class="token punctuation">,</span>
 ecPolicyName<span class="token punctuation">,</span> cacheEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token class-name">RetryCache</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>cacheEntry<span class="token punctuation">,</span> status <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 metrics<span class="token punctuation">.</span><span class="token function">incrFilesCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
metrics<span class="token punctuation">.</span><span class="token function">incrCreateFileOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystem.java</span>
<span class="token class-name">HdfsFileStatus</span> <span class="token function">startFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span>
 <span class="token class-name">String</span> holder<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span>
 <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> logRetryCache<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">HdfsFileStatus</span> status<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 status <span class="token operator">=</span> <span class="token function">startFileInt</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> flag<span class="token punctuation">,</span>
 createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> supportedVersions<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">,</span>
 logRetryCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccessControlException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">logAuditEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">logAuditEvent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">startFileInt</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span> <span class="token class-name">String</span> holder<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">CryptoProtocolVersion</span><span class="token punctuation">[</span><span class="token punctuation">]</span> supportedVersions<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> logRetryCache<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span> 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
stat <span class="token operator">=</span> <span class="token class-name">FSDirWriteFileOp</span><span class="token punctuation">.</span><span class="token function">startFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> iip<span class="token punctuation">,</span> permissions<span class="token punctuation">,</span> holder<span class="token punctuation">,</span>
 clientMachine<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> feInfo<span class="token punctuation">,</span>
 toRemoveBlocks<span class="token punctuation">,</span> shouldReplicate<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">,</span> logRetryCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">HdfsFileStatus</span> <span class="token function">startFile</span><span class="token punctuation">(</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token class-name">FSDirectory</span> fsd <span class="token operator">=</span> fsn<span class="token punctuation">.</span><span class="token function">getFSDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 文件路径是否存在校验</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>iip<span class="token punctuation">.</span><span class="token function">getLastINode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>overwrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">INode</span><span class="token punctuation">&gt;</span></span> toRemoveINodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkedArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> toRemoveUCFiles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkedArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> ret <span class="token operator">=</span> <span class="token class-name">FSDirDeleteOp</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> toRemoveBlocks<span class="token punctuation">,</span>
 toRemoveINodes<span class="token punctuation">,</span> toRemoveUCFiles<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 iip <span class="token operator">=</span> <span class="token class-name">INodesInPath</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>iip<span class="token punctuation">,</span> iip<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">FSDirDeleteOp</span><span class="token punctuation">.</span><span class="token function">incrDeletedFileCount</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsn<span class="token punctuation">.</span><span class="token function">removeLeasesAndINodes</span><span class="token punctuation">(</span>toRemoveUCFiles<span class="token punctuation">,</span> toRemoveINodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// If lease soft limit time is expired, recover the lease</span>
 fsn<span class="token punctuation">.</span><span class="token function">recoverLeaseInternal</span><span class="token punctuation">(</span><span class="token class-name">FSNamesystem<span class="token punctuation">.</span>RecoverLeaseOp</span><span class="token punctuation">.</span>CREATE_FILE<span class="token punctuation">,</span> iip<span class="token punctuation">,</span>
 src<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FileAlreadyExistsException</span><span class="token punctuation">(</span>src <span class="token operator">+</span> <span class="token string">&quot; for client &quot;</span> <span class="token operator">+</span>
 clientMachine <span class="token operator">+</span> <span class="token string">&quot; already exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 fsn<span class="token punctuation">.</span><span class="token function">checkFsObjectLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">INodeFile</span> newNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token class-name">INodesInPath</span> parent <span class="token operator">=</span> <span class="token class-name">FSDirMkdirOp</span><span class="token punctuation">.</span><span class="token function">createAncestorDirectories</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 添加文件元数据信息</span>
 iip <span class="token operator">=</span> <span class="token function">addFile</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> iip<span class="token punctuation">.</span><span class="token function">getLastLocalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> permissions<span class="token punctuation">,</span>
 replication<span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> holder<span class="token punctuation">,</span> clientMachine<span class="token punctuation">,</span> shouldReplicate<span class="token punctuation">,</span>
 ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 newNode <span class="token operator">=</span> iip <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> iip<span class="token punctuation">.</span><span class="token function">getLastINode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">setNewINodeStoragePolicy</span><span class="token punctuation">(</span>fsd<span class="token punctuation">.</span><span class="token function">getBlockManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> iip<span class="token punctuation">,</span> isLazyPersist<span class="token punctuation">)</span><span class="token punctuation">;</span>
 fsd<span class="token punctuation">.</span><span class="token function">getEditLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logOpenFile</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> overwrite<span class="token punctuation">,</span> logRetryEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;DIR* NameSystem.startFile: added &quot;</span> <span class="token operator">+</span>
 src <span class="token operator">+</span> <span class="token string">&quot; inode &quot;</span> <span class="token operator">+</span> newNode<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token class-name">FSDirStatAndListingOp</span><span class="token punctuation">.</span><span class="token function">getFileInfo</span><span class="token punctuation">(</span>fsd<span class="token punctuation">,</span> iip<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">INodesInPath</span> <span class="token function">addFile</span><span class="token punctuation">(</span>
 <span class="token class-name">FSDirectory</span> fsd<span class="token punctuation">,</span> <span class="token class-name">INodesInPath</span> existing<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> localName<span class="token punctuation">,</span>
 <span class="token class-name">PermissionStatus</span> permissions<span class="token punctuation">,</span> <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> preferredBlockSize<span class="token punctuation">,</span>
 <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">String</span> clientMachine<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldReplicate<span class="token punctuation">,</span>
 <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> modTime <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">INodesInPath</span> newiip<span class="token punctuation">;</span>
 fsd<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 … …
 newiip <span class="token operator">=</span> fsd<span class="token punctuation">.</span><span class="token function">addINode</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> newNode<span class="token punctuation">,</span> permissions<span class="token punctuation">.</span><span class="token function">getPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 fsd<span class="token punctuation">.</span><span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> newiip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">INodesInPath</span> <span class="token function">addINode</span><span class="token punctuation">(</span><span class="token class-name">INodesInPath</span> existing<span class="token punctuation">,</span> <span class="token class-name">INode</span> child<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> modes<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">QuotaExceededException</span><span class="token punctuation">,</span> <span class="token class-name">UnresolvedLinkException</span> <span class="token punctuation">{</span>
 <span class="token function">cacheName</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 将数据写入到 INode 的目录树中</span>
 <span class="token keyword">return</span> <span class="token function">addLastINode</span><span class="token punctuation">(</span>existing<span class="token punctuation">,</span> child<span class="token punctuation">,</span> modes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">writeUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br></div></div><p><strong>DataStreamer 启动流程</strong></p> <p>NN 处理完 DN 请求后，再次回到 DN 端，启动对应的线程</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DFSOutputStream.java</span>
<span class="token keyword">static</span> <span class="token class-name">DFSOutputStream</span> <span class="token function">newStreamForCreate</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token class-name">FsPermission</span> masked<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createParent<span class="token punctuation">,</span>
 <span class="token keyword">short</span> replication<span class="token punctuation">,</span> <span class="token keyword">long</span> blockSize<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">String</span> ecPolicyName<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// DN 将创建请求发送给 NN（RPC）</span>
stat <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>namenode<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> masked<span class="token punctuation">,</span> dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span>
 <span class="token keyword">new</span> <span class="token class-name">EnumSetWritable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">,</span> createParent<span class="token punctuation">,</span> replication<span class="token punctuation">,</span>
 blockSize<span class="token punctuation">,</span> SUPPORTED_CRYPTO_VERSIONS<span class="token punctuation">,</span> ecPolicyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 创建输出流</span>
out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> stat<span class="token punctuation">,</span>
 flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 开启线程 run，DataStreamer extends Daemon extends Thread</span>
out<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>点击 <code>DFSOutputStream</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DFSOutputStream</span><span class="token punctuation">(</span><span class="token class-name">DFSClient</span> dfsClient<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span>
<span class="token class-name">HdfsFileStatus</span> stat<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CreateFlag</span><span class="token punctuation">&gt;</span></span> flag<span class="token punctuation">,</span> <span class="token class-name">Progressable</span> progress<span class="token punctuation">,</span>
 <span class="token class-name">DataChecksum</span> checksum<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token keyword">boolean</span> createStreamer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> flag<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> stat<span class="token punctuation">,</span> checksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>shouldSyncBlock <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">CreateFlag</span><span class="token punctuation">.</span>SYNC_BLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Directory =&gt; File =&gt; Block(128M) =&gt; packet(64K) =&gt; chunk（chunk 512byte + </span>
chunksum <span class="token number">4</span>byte）
 <span class="token function">computePacketChunkSize</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWritePacketSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 bytesPerChecksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>createStreamer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 streamer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataStreamer</span><span class="token punctuation">(</span>stat<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> dfsClient<span class="token punctuation">,</span> src<span class="token punctuation">,</span> progress<span class="token punctuation">,</span>
 checksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span> byteArrayManager<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span>
 addBlockFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>点击 <code>newStreamForCreate</code> 方法中的 <code>out.start()</code>，进入 <code>DFSOutputStream.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">DataStreamer</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> streamer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>点击 <code>DataStreamer，</code>进入 <code>DataStreamer.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">DataStreamer</span> <span class="token keyword">extends</span> <span class="token class-name">Daemon</span> <span class="token punctuation">{</span>
 。。。 。。。
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>点击 <code>Daemon</code>，进入 <code>Daemon.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Daemon</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
 。。。 。。。
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>说明：<code>out.start()</code>;实际是开启线程，点击 <code>DataStreamer</code>，搜索 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 … …
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果 dataQueue 里面没有数据，代码会阻塞在这儿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 … …
<span class="token comment">// 队列不为空，从队列中取出 packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
… …
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p><strong>write 上传过程</strong></p> <p><strong>向 DataStreamer 的队列里面写数据</strong></p> <p>用户写的代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testPut2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">FSDataOutputStream</span> fos <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 fos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>点击 write</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FilterOutputStream.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>off <span class="token operator">|</span> len <span class="token operator">|</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span>len <span class="token operator">+</span> off<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IndexOutOfBoundsException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>off <span class="token operator">+</span> i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>点击 write</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//OutputStream.java
public abstract void write(int b) throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>ctrl + h</code> 查找 write 实现类，选择 <code>FSOutputSummer.java</code>，在该类中查找 write</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSOutputSummer.java</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 buf<span class="token punctuation">[</span>count<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>b<span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keep<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> flushPartial<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> bufLen <span class="token operator">=</span> count<span class="token punctuation">;</span>
 <span class="token keyword">int</span> partialLen <span class="token operator">=</span> bufLen <span class="token operator">%</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> lenToFlush <span class="token operator">=</span> flushPartial <span class="token operator">?</span> bufLen <span class="token operator">:</span> bufLen <span class="token operator">-</span> partialLen<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>lenToFlush <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 向队列中写数据 </span>
<span class="token comment">// Directory =&gt; File =&gt; Block(128M) =&gt; package(64K) =&gt; chunk（chunk 512byte + </span>
chunksum <span class="token number">4</span>byte）
<span class="token function">writeChecksumChunks</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> lenToFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushPartial <span class="token operator">||</span> keep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 count <span class="token operator">=</span> partialLen<span class="token punctuation">;</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufLen <span class="token operator">-</span> count<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// total bytes left minus unflushed bytes left</span>
 <span class="token keyword">return</span> count <span class="token operator">-</span> <span class="token punctuation">(</span>bufLen <span class="token operator">-</span> lenToFlush<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeChecksumChunks</span><span class="token punctuation">(</span><span class="token keyword">byte</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">int</span> off<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token comment">// 计算 chunk 的校验和</span>
 sum<span class="token punctuation">.</span><span class="token function">calculateChunkedSums</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> off<span class="token punctuation">,</span> len<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token function">createWriteTraceScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 按照 chunk 的大小遍历数据</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i <span class="token operator">+=</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">int</span> chunkLen <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> ckOffset <span class="token operator">=</span> i <span class="token operator">/</span> sum<span class="token punctuation">.</span><span class="token function">getBytesPerChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">getChecksumSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 一个 chunk 一个 chunk 的将数据写入队列</span>
 <span class="token function">writeChunk</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> off <span class="token operator">+</span> i<span class="token punctuation">,</span> chunkLen<span class="token punctuation">,</span> checksum<span class="token punctuation">,</span> ckOffset<span class="token punctuation">,</span>
 <span class="token function">getChecksumSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">writeChunk</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> bOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> bLen<span class="token punctuation">,</span>
 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> checksum<span class="token punctuation">,</span> <span class="token keyword">int</span> checksumOffset<span class="token punctuation">,</span> <span class="token keyword">int</span> checksumLen<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><code>ctrl + h</code>查找 <code>writeChunk</code> 实现类 <code>DFSOutputStream.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">writeChunk</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span>
 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> checksum<span class="token punctuation">,</span> <span class="token keyword">int</span> ckoff<span class="token punctuation">,</span> <span class="token keyword">int</span> cklen<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 
 <span class="token function">writeChunkPrepare</span><span class="token punctuation">(</span>len<span class="token punctuation">,</span> ckoff<span class="token punctuation">,</span> cklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 往 packet 里面写 chunk 的校验和 4byte</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">writeChecksum</span><span class="token punctuation">(</span>checksum<span class="token punctuation">,</span> ckoff<span class="token punctuation">,</span> cklen<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 往 packet 里面写一个 chunk 512 byte</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">writeData</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 记录写入 packet 中的 chunk 个数，累计到 127 个 chuck，这个 packet 就满了</span>
 currentPacket<span class="token punctuation">.</span><span class="token function">incNumChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incBytesCurBlock</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// If packet is full, enqueue it for transmission</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPacket<span class="token punctuation">.</span><span class="token function">getNumChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> currentPacket<span class="token punctuation">.</span><span class="token function">getMaxChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytesCurBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> blockSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">enqueueCurrentPacketFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">enqueueCurrentPacketFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;enqueue full {}, src={}, bytesCurBlock={}, blockSize={},&quot;</span>
 <span class="token operator">+</span> <span class="token string">&quot; appendChunk={}, {}&quot;</span><span class="token punctuation">,</span> currentPacket<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">getBytesCurBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> blockSize<span class="token punctuation">,</span> <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAppendChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">enqueueCurrentPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">adjustChunkBoundary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">endBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">enqueueCurrentPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">getStreamer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">waitAndQueuePacket</span><span class="token punctuation">(</span>currentPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
 currentPacket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">waitAndQueuePacket</span><span class="token punctuation">(</span><span class="token class-name">DFSPacket</span> packet<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果队列满了，等待</span>
 <span class="token comment">// If queue is full, then wait till we have enough space</span>
 <span class="token keyword">boolean</span> firstWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span>
 dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWriteMaxPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>firstWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Span</span> span <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>span <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 span<span class="token punctuation">.</span><span class="token function">addTimelineAnnotation</span><span class="token punctuation">(</span><span class="token string">&quot;dataQueue.wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 firstWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token class-name">Span</span> span <span class="token operator">=</span> <span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>span <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>firstWait<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 span<span class="token punctuation">.</span><span class="token function">addTimelineAnnotation</span><span class="token punctuation">(</span><span class="token string">&quot;end.wait&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">checkClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 如果队列没满，向队列中添加数据</span>
 <span class="token function">queuePacket</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClosedChannelException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token keyword">void</span> <span class="token function">queuePacket</span><span class="token punctuation">(</span><span class="token class-name">DFSPacket</span> packet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>packet <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
 packet<span class="token punctuation">.</span><span class="token function">addTraceParent</span><span class="token punctuation">(</span><span class="token class-name">Tracer</span><span class="token punctuation">.</span><span class="token function">getCurrentSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 向队列中添加数据</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastQueuedSeqno <span class="token operator">=</span> packet<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Queued {}, {}&quot;</span><span class="token punctuation">,</span> packet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通知队列添加数据完成</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>建立管道之机架感知（块存储位置）</strong></p> <p><code>Ctrl + n</code>全局查找 <code>DataStreamer</code>，搜索 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span>stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING <span class="token operator">||</span>
 now <span class="token operator">-</span> lastPacket <span class="token operator">&lt;</span> halfSocketTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> doSleep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> timeout <span class="token operator">=</span> halfSocketTimeout <span class="token operator">-</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>lastPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
timeout <span class="token operator">=</span> timeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> timeout<span class="token punctuation">;</span>
timeout <span class="token operator">=</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">)</span><span class="token operator">?</span>
timeout <span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果 dataQueue 里面没有数据，代码会阻塞在这儿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收到 notify 消息</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// get packet to be sent.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
one <span class="token operator">=</span> <span class="token function">createHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">backOffIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 队列不为空，从队列中取出 packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// get new block from namenode.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;stage=&quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_CREATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating new block: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 步骤一：向 NameNode 申请 block 并建立数据管道</span>
 <span class="token function">setPipeline</span><span class="token punctuation">(</span><span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 步骤二：启动 ResponseProcessor 用来监听 packet 发送是否成功</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_APPEND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">setupPipelineForAppendOrRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>streamerClosed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> lastByteOffsetInBlock <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lastByteOffsetInBlock <span class="token operator">&gt;</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;BlockSize &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
 <span class="token string">&quot; &lt; lastByteOffsetInBlock, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
… …
<span class="token comment">// send the packet</span>
<span class="token class-name">SpanId</span> spanId <span class="token operator">=</span> <span class="token class-name">SpanId</span><span class="token punctuation">.</span>INVALID<span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// move packet from dataQueue to ackQueue</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>one<span class="token punctuation">.</span><span class="token function">isHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 spanId <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 one<span class="token punctuation">.</span><span class="token function">setTraceScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 步骤三：从 dataQueue 把要发送的这个 packet 移除出去</span>
dataQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 步骤四：然后往 ackQueue 里面添加这个 packet</span>
ackQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} sending {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// write out data to remote datanode</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer#writeTo&quot;</span><span class="token punctuation">,</span> spanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 将数据写出去</span>
 one<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>blockStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">markFirstNodeIfNotMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
… …
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br></div></div><p>点击 <code>nextBlockOutputStream</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>protected LocatedBlock nextBlockOutputStream() throws IOException {
 LocatedBlock lb;
 DatanodeInfo[] nodes;
 StorageType[] nextStorageTypes;
 String[] nextStorageIDs;
 int count = dfsClient.getConf().getNumBlockWriteRetry();
 boolean success;
 final ExtendedBlock oldBlock = block.getCurrentBlock();
 do {
 errorState.resetInternalError();
 lastException.clear();
 DatanodeInfo[] excluded = getExcludedNodes();
// 向 NN 获取向哪个 DN 写数据
 lb = locateFollowingBlock(
 excluded.length &gt; 0 ? excluded : null, oldBlock);
 // 创建管道
 success = createBlockOutputStream(nodes, nextStorageTypes, nextStorageIDs,
 0L, false);
 … …
 } while (!success &amp;&amp; --count &gt;= 0);
 if (!success) {
 throw new IOException(&quot;Unable to create new block.&quot;);
 }
 return lb;
}
private LocatedBlock locateFollowingBlock(DatanodeInfo[] excluded,
 ExtendedBlock oldBlock) throws IOException {
 return DFSOutputStream.addBlock(excluded, dfsClient, src, oldBlock,
 stat.getFileId(), favoredNodes, addBlockFlags);
}
static LocatedBlock addBlock(DatanodeInfo[] excludedNodes,
 DFSClient dfsClient, String src, ExtendedBlock prevBlock, long fileId,
 String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; allocFlags)
 throws IOException {
 ... ...
 // 向 NN 获取向哪个 DN 写数据
return dfsClient.namenode.addBlock(src, dfsClient.clientName, prevBlock,
 excludedNodes, fileId, favoredNodes, allocFlags);
 ... ...
}
LocatedBlock addBlock(String src, String clientName,
 ExtendedBlock previous, DatanodeInfo[] excludeNodes, long fileId,
 String[] favoredNodes, EnumSet&lt;AddBlockFlag&gt; addBlockFlags)
 throws IOException;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p><code>ctrl + h</code> 点击 <code>NameNodeRpcServer</code>，在该类中搜索 <code>addBlock</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//NameNodeRpcServer.java</span>
<span class="token keyword">public</span> <span class="token class-name">LocatedBlock</span> <span class="token function">addBlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">,</span>
 <span class="token class-name">ExtendedBlock</span> previous<span class="token punctuation">,</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span> <span class="token keyword">long</span> fileId<span class="token punctuation">,</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> addBlockFlags<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token function">checkNNStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">LocatedBlock</span> locatedBlock <span class="token operator">=</span> namesystem<span class="token punctuation">.</span><span class="token function">getAdditionalBlock</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> fileId<span class="token punctuation">,</span>
 clientName<span class="token punctuation">,</span> previous<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> addBlockFlags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>locatedBlock <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 metrics<span class="token punctuation">.</span><span class="token function">incrAddBlockOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> locatedBlock<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//FSNamesystrm.java</span>
<span class="token class-name">LocatedBlock</span> <span class="token function">getAdditionalBlock</span><span class="token punctuation">(</span>
 <span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token keyword">long</span> fileId<span class="token punctuation">,</span> <span class="token class-name">String</span> clientName<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> previous<span class="token punctuation">,</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> operationName <span class="token operator">=</span> <span class="token string">&quot;getAdditionalBlock&quot;</span><span class="token punctuation">;</span>
 <span class="token class-name">NameNode</span><span class="token punctuation">.</span>stateChangeLog<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;BLOCK* getAdditionalBlock: {} inodeId {}&quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot; for {}&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">,</span> fileId<span class="token punctuation">,</span> clientName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// 选择块存储位置</span>
 <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> <span class="token class-name">FSDirWriteFileOp</span><span class="token punctuation">.</span><span class="token function">chooseTargetForNewBlock</span><span class="token punctuation">(</span>
 blockManager<span class="token punctuation">,</span> src<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> favoredNodes<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTargetForNewBlock</span><span class="token punctuation">(</span>
 <span class="token class-name">BlockManager</span> bm<span class="token punctuation">,</span> <span class="token class-name">String</span> src<span class="token punctuation">,</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excludedNodes<span class="token punctuation">,</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> favoredNodes<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">,</span>
 <span class="token class-name">ValidateAddBlockResult</span> r<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> bm<span class="token punctuation">.</span><span class="token function">chooseTarget4NewBlock</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> r<span class="token punctuation">.</span>numTargets<span class="token punctuation">,</span> clientNode<span class="token punctuation">,</span>
 excludedNodesSet<span class="token punctuation">,</span> r<span class="token punctuation">.</span>blockSize<span class="token punctuation">,</span>
favoredNodesList<span class="token punctuation">,</span> r<span class="token punctuation">.</span>storagePolicyID<span class="token punctuation">,</span>
r<span class="token punctuation">.</span>blockType<span class="token punctuation">,</span> r<span class="token punctuation">.</span>ecPolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget4NewBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 
 <span class="token keyword">final</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> blockplacement<span class="token punctuation">.</span><span class="token function">chooseTarget</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span>
 numOfReplicas<span class="token punctuation">,</span> client<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> 
 favoredDatanodeDescriptors<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> targets<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> src<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span> <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">&gt;</span></span> favoredNodes<span class="token punctuation">,</span>
 <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
 <span class="token keyword">return</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> 
 <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> srcPath<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosen<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
<span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p><code>Crtl + h</code>查找 <code>chooseTarget</code> 实现类 <code>BlockPlacementPolicyDefault.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token class-name">String</span> srcPath<span class="token punctuation">,</span>
 <span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosenNodes<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> chosenNodes<span class="token punctuation">,</span> returnChosenNodes<span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> chosenStorage<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> returnChosenNodes<span class="token punctuation">,</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
 <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockStoragePolicy</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">&gt;</span></span> addBlockFlags<span class="token punctuation">,</span>
 <span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageType</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
… …
 
 <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token function">getMaxNodesPerRack</span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> numOfReplicas<span class="token punctuation">)</span><span class="token punctuation">;</span>
 numOfReplicas <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> maxNodesPerRack <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DatanodeStorageInfo</span> storage <span class="token operator">:</span> chosenStorage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// add localMachine and related nodes to excludedNodes</span>
<span class="token comment">// 获取不可用的 DN</span>
 <span class="token function">addToExcludedNodes</span><span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> excludedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token class-name">Node</span> localNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> avoidStaleNodes <span class="token operator">=</span> <span class="token punctuation">(</span>stats <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span><span class="token function">isAvoidingStaleDataNodesForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// </span>
 <span class="token keyword">boolean</span> avoidLocalNode <span class="token operator">=</span> <span class="token punctuation">(</span>addBlockFlags <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> addBlockFlags<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">AddBlockFlag</span><span class="token punctuation">.</span>NO_LOCAL_WRITE<span class="token punctuation">)</span>
 <span class="token operator">&amp;&amp;</span> writer <span class="token operator">!=</span> <span class="token keyword">null</span>
 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>excludedNodes<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Attempt to exclude local node if the client suggests so. If no enough</span>
 <span class="token comment">// nodes can be obtained, it falls back to the default block placement</span>
 <span class="token comment">// policy.</span>
 <span class="token comment">// 有数据正在写，避免都写入本地</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>avoidLocalNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodeCopy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>excludedNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 excludedNodeCopy<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 localNode <span class="token operator">=</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span>
 excludedNodeCopy<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span>
 avoidStaleNodes<span class="token punctuation">,</span> storagePolicy<span class="token punctuation">,</span>
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">noneOf</span><span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> numOfReplicas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// not enough nodes; discard results and fall back</span>
 results <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>results <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 真正的选择 DN 节点</span>
 localNode <span class="token operator">=</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span>
 blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span>
 storagePolicy<span class="token punctuation">,</span> <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">noneOf</span><span class="token punctuation">(</span><span class="token class-name">StorageType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 sTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnChosenNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
 results<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>chosenStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token comment">// sorting nodes to form a pipeline</span>
 <span class="token keyword">return</span> <span class="token function">getPipeline</span><span class="token punctuation">(</span>
<span class="token punctuation">(</span>writer <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> writer <span class="token keyword">instanceof</span> <span class="token class-name">DatanodeDescriptor</span><span class="token punctuation">)</span> <span class="token operator">?</span> writer
 <span class="token operator">:</span> localNode<span class="token punctuation">,</span>
 results<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">[</span>results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">Node</span> <span class="token function">chooseTarget</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 writer <span class="token operator">=</span> <span class="token function">chooseTargetInOrder</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span>
 maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> newBlock<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">Node</span> <span class="token function">chooseTargetInOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> numOfReplicas<span class="token punctuation">,</span> 
 <span class="token class-name">Node</span> writer<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> excludedNodes<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">long</span> blocksize<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> maxNodesPerRack<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DatanodeStorageInfo</span><span class="token punctuation">&gt;</span></span> results<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> avoidStaleNodes<span class="token punctuation">,</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> newBlock<span class="token punctuation">,</span>
<span class="token class-name">EnumMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">StorageType</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> storageTypes<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">NotEnoughReplicasException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token keyword">int</span> numOfResults <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 第一个块存储在当前节点</span>
 <span class="token class-name">DatanodeStorageInfo</span> storageInfo <span class="token operator">=</span> <span class="token function">chooseLocalStorage</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span>
 excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span>
 storageTypes<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 writer <span class="token operator">=</span> <span class="token punctuation">(</span>storageInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> storageInfo<span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> dn0 <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 第二个块存储在另外一个机架</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">chooseRemoteRack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dn0<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>numOfResults <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeDescriptor</span> dn1 <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatanodeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果第一个和第二个在同一个机架，那么第三个放在其他机架</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterMap<span class="token punctuation">.</span><span class="token function">isOnSameRack</span><span class="token punctuation">(</span>dn0<span class="token punctuation">,</span> dn1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">chooseRemoteRack</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dn0<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newBlock<span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// 如果是新块，和第二个块存储在同一个机架</span>
 <span class="token function">chooseLocalRack</span><span class="token punctuation">(</span>dn1<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果不是新块，放在当前机架</span>
 <span class="token function">chooseLocalRack</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span> maxNodesPerRack<span class="token punctuation">,</span>
 results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>numOfReplicas <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token function">chooseRandom</span><span class="token punctuation">(</span>numOfReplicas<span class="token punctuation">,</span> <span class="token class-name">NodeBase</span><span class="token punctuation">.</span>ROOT<span class="token punctuation">,</span> excludedNodes<span class="token punctuation">,</span> blocksize<span class="token punctuation">,</span>
 maxNodesPerRack<span class="token punctuation">,</span> results<span class="token punctuation">,</span> avoidStaleNodes<span class="token punctuation">,</span> storageTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> writer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br></div></div><p><strong>建立管道之 Socket 发送</strong></p> <p>点击 <code>nextBlockOutputStream</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">LocatedBlock</span> <span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">LocatedBlock</span> lb<span class="token punctuation">;</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodes<span class="token punctuation">;</span>
 <span class="token class-name">StorageType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextStorageTypes<span class="token punctuation">;</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextStorageIDs<span class="token punctuation">;</span>
 <span class="token keyword">int</span> count <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNumBlockWriteRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> oldBlock <span class="token operator">=</span> block<span class="token punctuation">.</span><span class="token function">getCurrentBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">resetInternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 lastException<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> excluded <span class="token operator">=</span> <span class="token function">getExcludedNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 向 NN 获取向哪个 DN 写数据</span>
 lb <span class="token operator">=</span> <span class="token function">locateFollowingBlock</span><span class="token punctuation">(</span>
 excluded<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> excluded <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> oldBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 创建管道</span>
 success <span class="token operator">=</span> <span class="token function">createBlockOutputStream</span><span class="token punctuation">(</span>nodes<span class="token punctuation">,</span> nextStorageTypes<span class="token punctuation">,</span> nextStorageIDs<span class="token punctuation">,</span>
 <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 … …
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>success <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>count <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to create new block.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> lb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">boolean</span> <span class="token function">createBlockOutputStream</span><span class="token punctuation">(</span><span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodes<span class="token punctuation">,</span>
 <span class="token class-name">StorageType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodeStorageTypes<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nodeStorageIDs<span class="token punctuation">,</span>
 <span class="token keyword">long</span> newGS<span class="token punctuation">,</span> <span class="token keyword">boolean</span> recoveryFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 和 DN 创建 socket</span>
s <span class="token operator">=</span> <span class="token function">createSocketForPipeline</span><span class="token punctuation">(</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nodes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> dfsClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取输出流，用于写数据到 DN</span>
<span class="token class-name">OutputStream</span> unbufOut <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> writeTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取输入流，用于读取写数据到 DN 的结果</span>
 <span class="token class-name">InputStream</span> unbufIn <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> readTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">IOStreamPair</span> saslStreams <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span>saslClient<span class="token punctuation">.</span><span class="token function">socketSend</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span>
 unbufOut<span class="token punctuation">,</span> unbufIn<span class="token punctuation">,</span> dfsClient<span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span> nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 unbufOut <span class="token operator">=</span> saslStreams<span class="token punctuation">.</span>out<span class="token punctuation">;</span>
 unbufIn <span class="token operator">=</span> saslStreams<span class="token punctuation">.</span>in<span class="token punctuation">;</span>
 out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>unbufOut<span class="token punctuation">,</span>
 <span class="token class-name">DFSUtilClient</span><span class="token punctuation">.</span><span class="token function">getSmallBufferSize</span><span class="token punctuation">(</span>dfsClient<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockReplyStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>unbufIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送数据</span>
<span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>blockCopy<span class="token punctuation">,</span> nodeStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> accessToken<span class="token punctuation">,</span>
 dfsClient<span class="token punctuation">.</span>clientName<span class="token punctuation">,</span> nodes<span class="token punctuation">,</span> nodeStorageTypes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> bcs<span class="token punctuation">,</span>
 nodes<span class="token punctuation">.</span>length<span class="token punctuation">,</span> block<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytesSent<span class="token punctuation">,</span> newGS<span class="token punctuation">,</span>
 checksum4WriteBlock<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isLazyPersistFile<span class="token punctuation">,</span>
 <span class="token punctuation">(</span>targetPinnings <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetPinnings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 nodeStorageIDs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nodeStorageIDs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token function">send</span><span class="token punctuation">(</span>out<span class="token punctuation">,</span> <span class="token class-name">Op</span><span class="token punctuation">.</span>WRITE_BLOCK<span class="token punctuation">,</span> proto<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p><strong>建立管道之 Socket 接收</strong></p> <p><code>Ctrl +n</code> 全局查找 <code>DataXceiverServer.java</code>，在该类中查找 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Peer</span> peer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>datanode<span class="token punctuation">.</span>shouldRun <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>datanode<span class="token punctuation">.</span>shutdownForUpgrade<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 接收 socket 的请求</span>
 peer <span class="token operator">=</span> peerServer<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Make sure the xceiver count is not exceeded</span>
 <span class="token keyword">int</span> curXceiverCount <span class="token operator">=</span> datanode<span class="token punctuation">.</span><span class="token function">getXceiverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>curXceiverCount <span class="token operator">&gt;</span> maxXceiverCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Xceiver count &quot;</span> <span class="token operator">+</span> curXceiverCount
 <span class="token operator">+</span> <span class="token string">&quot; exceeds the limit of concurrent xcievers: &quot;</span>
 <span class="token operator">+</span> maxXceiverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 客户端每发送一个 block，都启动一个 DataXceiver 去处理 block</span>
 <span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span>datanode<span class="token punctuation">.</span>threadGroup<span class="token punctuation">,</span>
 <span class="token class-name">DataXceiver</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> datanode<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketTimeoutException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>点击 <code>DataXceiver（线程）</code>，查找 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">int</span> opsProcessed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token class-name">Op</span> op <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 xceiver <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 dataXceiverServer<span class="token punctuation">.</span><span class="token function">addPeer</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 peer<span class="token punctuation">.</span><span class="token function">setWriteTimeout</span><span class="token punctuation">(</span>datanode<span class="token punctuation">.</span><span class="token function">getDnConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>socketWriteTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">InputStream</span> input <span class="token operator">=</span> socketIn<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOStreamPair</span> saslStreams <span class="token operator">=</span> datanode<span class="token punctuation">.</span>saslServer<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> socketOut<span class="token punctuation">,</span>
 socketIn<span class="token punctuation">,</span> datanode<span class="token punctuation">.</span><span class="token function">getXferAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
 <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token keyword">do</span> <span class="token punctuation">{</span>
 <span class="token function">updateCurrentThreadName</span><span class="token punctuation">(</span><span class="token string">&quot;Waiting for operation #&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">assert</span> dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token comment">// 读取这次数据的请求类型</span>
 op <span class="token operator">=</span> <span class="token function">readOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Time out while we wait for client rpc</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EOFException</span> <span class="token operator">|</span> <span class="token class-name">ClosedChannelException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// Since we optimistically expect the next op, it's quite normal to</span>
 <span class="token comment">// get EOF here.</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Cached {} closing after {} ops. &quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;This message is usually benign.&quot;</span><span class="token punctuation">,</span> peer<span class="token punctuation">,</span> opsProcessed<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">incrDatanodeNetworkErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// restore normal timeout</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>opsProcessed <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 peer<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>dnConf<span class="token punctuation">.</span>socketTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 opStartTime <span class="token operator">=</span> <span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 根据操作类型处理我们的数据</span>
 <span class="token function">processOp</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">++</span>opsProcessed<span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>peer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span><span class="token operator">!</span>peer<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dnConf<span class="token punctuation">.</span>socketKeepaliveTimeout <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">processOp</span><span class="token punctuation">(</span><span class="token class-name">Op</span> op<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">switch</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">case</span> WRITE_BLOCK<span class="token operator">:</span>
 <span class="token function">opWriteBlock</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">default</span><span class="token operator">:</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown op &quot;</span> <span class="token operator">+</span> op <span class="token operator">+</span> <span class="token string">&quot; in data stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">opWriteBlock</span><span class="token punctuation">(</span><span class="token class-name">DataInputStream</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">OpWriteBlockProto</span> proto <span class="token operator">=</span> <span class="token class-name">OpWriteBlockProto</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span><span class="token function">vintPrefixed</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> targets <span class="token operator">=</span> <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">TraceScope</span> traceScope <span class="token operator">=</span> <span class="token function">continueTraceSpan</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertStorageType</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getStorageType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 targets<span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertStorageTypes</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetStorageTypesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">fromProto</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getStage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getPipelineSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getMinBytesRcvd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proto<span class="token punctuation">.</span><span class="token function">getMaxBytesRcvd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getLatestGenerationStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token function">fromProto</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getRequestedChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasCachingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
 <span class="token function">getCachingStrategy</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getCachingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
 <span class="token class-name">CachingStrategy</span><span class="token punctuation">.</span><span class="token function">newDefaultStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasAllowLazyPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> proto<span class="token punctuation">.</span><span class="token function">getAllowLazyPersist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">hasPinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> proto<span class="token punctuation">.</span><span class="token function">getPinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">convertBooleanList</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span><span class="token function">getTargetPinningsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getStorageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 proto<span class="token punctuation">.</span><span class="token function">getTargetStorageIdsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>traceScope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> traceScope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p><code>Ctrl +alt +b</code> 查找 <code>writeBlock</code> 的实现类 <code>DataXceiver.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeBlock</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">Replica</span> replica<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isDatanode <span class="token operator">||</span> 
 stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_CLOSE_RECOVERY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// open a block receiver</span>
 <span class="token comment">// 创建一个 BlockReceiver</span>
 <span class="token function">setCurrentBlockReceiver</span><span class="token punctuation">(</span><span class="token function">getBlockReceiver</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> storageType<span class="token punctuation">,</span> in<span class="token punctuation">,</span>
 peer<span class="token punctuation">.</span><span class="token function">getRemoteAddressString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 peer<span class="token punctuation">.</span><span class="token function">getLocalAddressString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 stage<span class="token punctuation">,</span> latestGenerationStamp<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 clientname<span class="token punctuation">,</span> srcDataNode<span class="token punctuation">,</span> datanode<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span>
 cachingStrategy<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">,</span> pinning<span class="token punctuation">,</span> storageId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 replica <span class="token operator">=</span> blockReceiver<span class="token punctuation">.</span><span class="token function">getReplica</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 replica <span class="token operator">=</span> datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">recoverClose</span><span class="token punctuation">(</span>
 block<span class="token punctuation">,</span> latestGenerationStamp<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 storageUuid <span class="token operator">=</span> replica<span class="token punctuation">.</span><span class="token function">getStorageUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 isOnTransientStorage <span class="token operator">=</span> replica<span class="token punctuation">.</span><span class="token function">isOnTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//</span>
 <span class="token comment">// Connect to downstream machine, if appropriate</span>
 <span class="token comment">// 继续连接下游的机器</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>targets<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">InetSocketAddress</span> mirrorTarget <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token comment">// Connect to backup machine</span>
 mirrorNode <span class="token operator">=</span> targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getXferAddr</span><span class="token punctuation">(</span>connectToDnViaHostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Connecting to datanode {}&quot;</span><span class="token punctuation">,</span> mirrorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 mirrorTarget <span class="token operator">=</span> <span class="token class-name">NetUtils</span><span class="token punctuation">.</span><span class="token function">createSocketAddr</span><span class="token punctuation">(</span>mirrorNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 向新的副本发送 socket</span>
 mirrorSock <span class="token operator">=</span> datanode<span class="token punctuation">.</span><span class="token function">newSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>targetPinnings <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetPinnings<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 往下游 socket 发送数据</span>
 <span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>mirrorOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>originalBlock<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 blockToken<span class="token punctuation">,</span> clientname<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">,</span>
 srcDataNode<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> pipelineSize<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 latestGenerationStamp<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span>
 allowLazyPersist<span class="token punctuation">,</span> targetPinnings<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 targetStorageId<span class="token punctuation">,</span> targetStorageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span>mirrorOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlock</span><span class="token punctuation">(</span>originalBlock<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 blockToken<span class="token punctuation">,</span> clientname<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> targetStorageTypes<span class="token punctuation">,</span>
 srcDataNode<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> pipelineSize<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 latestGenerationStamp<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span> cachingStrategy<span class="token punctuation">,</span>
 allowLazyPersist<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> targetPinnings<span class="token punctuation">,</span>
 targetStorageId<span class="token punctuation">,</span> targetStorageIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 mirrorOut<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">DataNodeFaultInjector</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeBlockAfterFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// read connect ack (only for clients, not for replication req)</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>isClient<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">BlockOpResponseProto</span> connectAck <span class="token operator">=</span>
 <span class="token class-name">BlockOpResponseProto</span><span class="token punctuation">.</span><span class="token function">parseFrom</span><span class="token punctuation">(</span><span class="token class-name">PBHelperClient</span><span class="token punctuation">.</span><span class="token function">vintPrefixed</span><span class="token punctuation">(</span>mirrorIn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 mirrorInStatus <span class="token operator">=</span> connectAck<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 firstBadLink <span class="token operator">=</span> connectAck<span class="token punctuation">.</span><span class="token function">getFirstBadLink</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>mirrorInStatus <span class="token operator">!=</span> SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Datanode {} got response for connect&quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;ack from downstream datanode with firstbadlink as {}&quot;</span><span class="token punctuation">,</span>
 targets<span class="token punctuation">.</span>length<span class="token punctuation">,</span> firstBadLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 … …
 <span class="token comment">//update metrics</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWriteBlockOp</span><span class="token punctuation">(</span><span class="token function">elapsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrWritesFromClient</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">isLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockReceiver</span> <span class="token function">getBlockReceiver</span><span class="token punctuation">(</span>
 <span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> block<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> in<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> inAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> myAddr<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockConstructionStage</span> stage<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">long</span> newGs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minBytesRcvd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxBytesRcvd<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> clientname<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span> srcDataNode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> dn<span class="token punctuation">,</span> <span class="token class-name">DataChecksum</span> requestedChecksum<span class="token punctuation">,</span>
 <span class="token class-name">CachingStrategy</span> cachingStrategy<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> pinning<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> storageId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BlockReceiver</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> storageType<span class="token punctuation">,</span> in<span class="token punctuation">,</span>
 inAddr<span class="token punctuation">,</span> myAddr<span class="token punctuation">,</span> stage<span class="token punctuation">,</span> newGs<span class="token punctuation">,</span> minBytesRcvd<span class="token punctuation">,</span> maxBytesRcvd<span class="token punctuation">,</span>
 clientname<span class="token punctuation">,</span> srcDataNode<span class="token punctuation">,</span> dn<span class="token punctuation">,</span> requestedChecksum<span class="token punctuation">,</span>
 cachingStrategy<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">,</span> pinning<span class="token punctuation">,</span> storageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BlockReceiver</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ExtendedBlock</span> block<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> in<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> inAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> myAddr<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">BlockConstructionStage</span> stage<span class="token punctuation">,</span> 
 <span class="token keyword">final</span> <span class="token keyword">long</span> newGs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> minBytesRcvd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxBytesRcvd<span class="token punctuation">,</span> 
 <span class="token keyword">final</span> <span class="token class-name">String</span> clientname<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">DatanodeInfo</span> srcDataNode<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">DataNode</span> datanode<span class="token punctuation">,</span> <span class="token class-name">DataChecksum</span> requestedChecksum<span class="token punctuation">,</span>
 <span class="token class-name">CachingStrategy</span> cachingStrategy<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token keyword">boolean</span> pinning<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> storageId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>isDatanode<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//replication or move</span>
 replicaHandler <span class="token operator">=</span>
 datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">createTemporary</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> block<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>stage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">case</span> PIPELINE_SETUP_CREATE<span class="token operator">:</span>
 <span class="token comment">// 创建管道</span>
 replicaHandler <span class="token operator">=</span> datanode<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span>
 block<span class="token punctuation">,</span> allowLazyPersist<span class="token punctuation">)</span><span class="token punctuation">;</span>
datanode<span class="token punctuation">.</span><span class="token function">notifyNamenodeReceivingBlock</span><span class="token punctuation">(</span>
 block<span class="token punctuation">,</span> replicaHandler<span class="token punctuation">.</span><span class="token function">getReplica</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorageUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Unsupported stage &quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> 
 <span class="token string">&quot; while receiving block &quot;</span> <span class="token operator">+</span> block <span class="token operator">+</span> <span class="token string">&quot; from &quot;</span> <span class="token operator">+</span> inAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaHandler</span> <span class="token function">createRbw</span><span class="token punctuation">(</span>
 <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span> <span class="token class-name">String</span> storageId<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseableLock</span> lock <span class="token operator">=</span> datasetLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 ref <span class="token operator">=</span> volumes<span class="token punctuation">.</span><span class="token function">getNextVolume</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">FsVolumeImpl</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FsVolumeImpl</span><span class="token punctuation">)</span> ref<span class="token punctuation">.</span><span class="token function">getVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// create an rbw file to hold block in the designated volume</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>allowLazyPersist <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>v<span class="token punctuation">.</span><span class="token function">isTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrRamDiskBlocksWriteFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">ReplicaInPipeline</span> newReplicaInfo<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 创建输出流的临时写文件</span>
 newReplicaInfo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;CreateRBW returned a replica of state &quot;</span>
 <span class="token operator">+</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot; for block &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 volumeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaHandler</span><span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaHandler</span> <span class="token function">createRbw</span><span class="token punctuation">(</span>
 <span class="token class-name">StorageType</span> storageType<span class="token punctuation">,</span> <span class="token class-name">String</span> storageId<span class="token punctuation">,</span> <span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">,</span>
 <span class="token keyword">boolean</span> allowLazyPersist<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">AutoCloseableLock</span> lock <span class="token operator">=</span> datasetLock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>ref <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 有可能有多个临时写文件</span>
 ref <span class="token operator">=</span> volumes<span class="token punctuation">.</span><span class="token function">getNextVolume</span><span class="token punctuation">(</span>storageType<span class="token punctuation">,</span> storageId<span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token class-name">FsVolumeImpl</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FsVolumeImpl</span><span class="token punctuation">)</span> ref<span class="token punctuation">.</span><span class="token function">getVolume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// create an rbw file to hold block in the designated volume</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>allowLazyPersist <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>v<span class="token punctuation">.</span><span class="token function">isTransientStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 datanode<span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incrRamDiskBlocksWriteFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token class-name">ReplicaInPipeline</span> newReplicaInfo<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 创建输出流的临时写文件</span>
 newReplicaInfo <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">createRbw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;CreateRBW returned a replica of state &quot;</span>
 <span class="token operator">+</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot; for block &quot;</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 volumeMap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newReplicaInfo<span class="token punctuation">.</span><span class="token function">getReplicaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaHandler</span><span class="token punctuation">(</span>newReplicaInfo<span class="token punctuation">,</span> ref<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ReplicaInPipeline</span> <span class="token function">createRbw</span><span class="token punctuation">(</span><span class="token class-name">ExtendedBlock</span> b<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
<span class="token class-name">File</span> f <span class="token operator">=</span> <span class="token function">createRbwFile</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockPoolId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">getLocalBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">LocalReplicaInPipeline</span> newReplicaInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaBuilder</span><span class="token punctuation">(</span><span class="token class-name">ReplicaState</span><span class="token punctuation">.</span>RBW<span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBlockId</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getBlockId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setGenerationStamp</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getGenerationStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setFsVolume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setDirectoryToUse</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">setBytesToReserve</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">getNumBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">buildLocalReplicaInPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> newReplicaInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br></div></div><p><strong>客户端接收 DN 写数据应答 Response</strong></p> <p><code>Ctrl + n</code>全局查找 <code>DataStreamer</code>，搜索 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//DataStreamer.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">TraceScope</span> scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>streamerClosed <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// if the Responder encountered an error, shutdown Responder</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>errorState<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">closeResponder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token class-name">DFSPacket</span> one<span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// process datanode IO errors if any</span>
<span class="token keyword">boolean</span> doSleep <span class="token operator">=</span> <span class="token function">processDatanodeOrExternalError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> halfSocketTimeout <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSocketTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for a packet to be sent.</span>
 <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> dataQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
 <span class="token punctuation">(</span>stage <span class="token operator">!=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING <span class="token operator">||</span>
 now <span class="token operator">-</span> lastPacket <span class="token operator">&lt;</span> halfSocketTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> doSleep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">long</span> timeout <span class="token operator">=</span> halfSocketTimeout <span class="token operator">-</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>lastPacket<span class="token punctuation">)</span><span class="token punctuation">;</span>
timeout <span class="token operator">=</span> timeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1000</span> <span class="token operator">:</span> timeout<span class="token punctuation">;</span>
timeout <span class="token operator">=</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">)</span><span class="token operator">?</span>
timeout <span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 如果 dataQueue 里面没有数据，代码会阻塞在这儿</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 接收到 notify 消息</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
doSleep <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
now <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// get packet to be sent.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
one <span class="token operator">=</span> <span class="token function">createHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token function">backOffIfNecessary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 队列不为空，从队列中取出 packet</span>
one <span class="token operator">=</span> dataQueue<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// regular data packet</span>
<span class="token class-name">SpanId</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parents <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getTraceParents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>parents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
 <span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;dataStreamer&quot;</span><span class="token punctuation">,</span> parents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">getSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParents</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// get new block from namenode.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;stage=&quot;</span> <span class="token operator">+</span> stage <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_CREATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating new block: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 步骤一：向 NameNode 申请 block 并建立数据管道</span>
<span class="token function">setPipeline</span><span class="token punctuation">(</span><span class="token function">nextBlockOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 步骤二：启动 ResponseProcessor 用来监听 packet 发送是否成功</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stage <span class="token operator">==</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_SETUP_APPEND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Append to block {}&quot;</span><span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setupPipelineForAppendOrRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>streamerClosed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">long</span> lastByteOffsetInBlock <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lastByteOffsetInBlock <span class="token operator">&gt;</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;BlockSize &quot;</span> <span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
 <span class="token string">&quot; &lt; lastByteOffsetInBlock, &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">&quot;, &quot;</span> <span class="token operator">+</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">isLastPacketInBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for all data packets have been successfully acked</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token comment">// wait for acks to arrive from datanodes</span>
dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Caught exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 stage <span class="token operator">=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>PIPELINE_CLOSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// send the packet</span>
<span class="token class-name">SpanId</span> spanId <span class="token operator">=</span> <span class="token class-name">SpanId</span><span class="token punctuation">.</span>INVALID<span class="token punctuation">;</span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// move packet from dataQueue to ackQueue</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>one<span class="token punctuation">.</span><span class="token function">isHeartbeatPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 spanId <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 one<span class="token punctuation">.</span><span class="token function">setTraceScope</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 步骤三：从 dataQueue 把要发送的这个 packet 移除出去</span>
dataQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 步骤四：然后往 ackQueue 里面添加这个 packet</span>
ackQueue<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">getSeqno</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;{} sending {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// write out data to remote datanode</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">TraceScope</span> ignored <span class="token operator">=</span> dfsClient<span class="token punctuation">.</span><span class="token function">getTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token function">newScope</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer#writeTo&quot;</span><span class="token punctuation">,</span> spanId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 将数据写出去</span>
 one<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>blockStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
 blockStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 errorState<span class="token punctuation">.</span><span class="token function">markFirstNodeIfNotMarked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
lastPacket <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">monotonicNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// update bytesSent</span>
<span class="token keyword">long</span> tmpBytesSent <span class="token operator">=</span> one<span class="token punctuation">.</span><span class="token function">getLastByteOffsetBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bytesSent <span class="token operator">&lt;</span> tmpBytesSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 bytesSent <span class="token operator">=</span> tmpBytesSent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Is this block full?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>one<span class="token punctuation">.</span><span class="token function">isLastPacketInBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// wait for the close packet has been acked</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dataQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> ackQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 dataQueue<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// wait for acks to arrive from datanodes</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">continue</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">endBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>progress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> progress<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// This is used by unit test to trigger race conditions.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>artificialSlowdown <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> dfsClient<span class="token punctuation">.</span>clientRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>artificialSlowdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 scope<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 scope <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">closeInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initDataStreaming</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;DataStreamer for file &quot;</span> <span class="token operator">+</span> src <span class="token operator">+</span>
 <span class="token string">&quot; block &quot;</span> <span class="token operator">+</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseProcessor</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
 response<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 stage <span class="token operator">=</span> <span class="token class-name">BlockConstructionStage</span><span class="token punctuation">.</span>DATA_STREAMING<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br></div></div><p>点击 <code>response</code> 再点击 <code>ResponseProcessor</code>，<code>ctrl + f</code> 查找 run 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ackQueue<span class="token punctuation">.</span><span class="token function">removeFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
packetSendTime<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>seqno<span class="token punctuation">)</span><span class="token punctuation">;</span>
dataQueue<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></details> <h2 id="yarn-源码解析"><a href="#yarn-源码解析" class="header-anchor">#</a> Yarn 源码解析</h2> <p><strong>Yarn工作机制</strong>：<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210903162200.png" alt=""></p> <p><strong>源码解析图</strong>：<img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904151511.png" alt=""></p> <p><strong>源码解析</strong>：</p> <details class="custom-block details"><summary>🦓🦓🦓🦓</summary> <p>Yarn 客户端向 RM 提交作业</p> <p>在 <code>wordcount</code> 程序的驱动类中点击</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Job.java</span>
<span class="token keyword">boolean</span> result <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> verbose
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span>
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">JobState</span><span class="token punctuation">.</span>DEFINE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">monitorAndPrintJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// get the completion poll interval from the client.</span>
 <span class="token keyword">int</span> completionPollIntervalMillis <span class="token operator">=</span> 
 <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getCompletionPollInterval</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>completionPollIntervalMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token function">isSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token function">ensureState</span><span class="token punctuation">(</span><span class="token class-name">JobState</span><span class="token punctuation">.</span>DEFINE<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setUseNewAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">final</span> <span class="token class-name">JobSubmitter</span> submitter <span class="token operator">=</span> 
 <span class="token function">getJobSubmitter</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 status <span class="token operator">=</span> ugi<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">JobStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> submitter<span class="token punctuation">.</span><span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 state <span class="token operator">=</span> <span class="token class-name">JobState</span><span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The url to track the job: &quot;</span> <span class="token operator">+</span> <span class="token function">getTrackingURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>点击 <code>submitJobInternal()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//JobSubmitter.java</span>
<span class="token class-name">JobStatus</span> <span class="token function">submitJobInternal</span><span class="token punctuation">(</span><span class="token class-name">Job</span> job<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> 
 <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 status <span class="token operator">=</span> submitClient<span class="token punctuation">.</span><span class="token function">submitJob</span><span class="token punctuation">(</span>
 jobId<span class="token punctuation">,</span> submitJobDir<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">submitJob</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> 
ts<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>创建提交环境</strong></p> <p><code>ctrl + alt +B</code> 查找 <code>submitJob</code> 实现类，<code>YARNRunner.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">JobStatus</span> <span class="token function">submitJob</span><span class="token punctuation">(</span><span class="token class-name">JobID</span> jobId<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> 
ts<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 
 <span class="token function">addHistoryToken</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 创建提交环境：</span>
 <span class="token class-name">ApplicationSubmissionContext</span> appContext <span class="token operator">=</span>
 <span class="token function">createApplicationSubmissionContext</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">,</span> ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Submit to ResourceManager</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 向 RM 提交一个应用程序，appContext 里面封装了启动 mrappMaster 和运行 container</span>
的命令
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span>
 resMgrDelegate<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 获取提交响应</span>
 <span class="token class-name">ApplicationReport</span> appMaster <span class="token operator">=</span> resMgrDelegate
 <span class="token punctuation">.</span><span class="token function">getApplicationReport</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">String</span> diagnostics <span class="token operator">=</span>
 <span class="token punctuation">(</span>appMaster <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span>
 <span class="token string">&quot;application report is null&quot;</span> <span class="token operator">:</span> appMaster<span class="token punctuation">.</span><span class="token function">getDiagnostics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>appMaster <span class="token operator">==</span> <span class="token keyword">null</span>
 <span class="token operator">||</span> appMaster<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> 
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>FAILED
 <span class="token operator">||</span> appMaster<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> 
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>KILLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to run job : &quot;</span> <span class="token operator">+</span>
 diagnostics<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> clientCache<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getJobStatus</span><span class="token punctuation">(</span>jobId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">YarnException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ApplicationSubmissionContext</span> <span class="token function">createApplicationSubmissionContext</span><span class="token punctuation">(</span>
 <span class="token class-name">Configuration</span> jobConf<span class="token punctuation">,</span> <span class="token class-name">String</span> jobSubmitDir<span class="token punctuation">,</span> <span class="token class-name">Credentials</span> ts<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> resMgrDelegate<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup LocalResources</span>
 <span class="token comment">// 封装了本地资源相关路径</span>
 <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LocalResource</span><span class="token punctuation">&gt;</span></span> localResources <span class="token operator">=</span>
 <span class="token function">setupLocalResources</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">,</span> jobSubmitDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup security tokens</span>
 <span class="token class-name">DataOutputBuffer</span> dob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 ts<span class="token punctuation">.</span><span class="token function">writeTokenStorageToStream</span><span class="token punctuation">(</span>dob<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ByteBuffer</span> securityTokens <span class="token operator">=</span>
 <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>dob<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> dob<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Setup ContainerLaunchContext for AM container</span>
 <span class="token comment">// 封装了启动 mrappMaster 和运行 container 的命令</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vargs <span class="token operator">=</span> <span class="token function">setupAMCommand</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ContainerLaunchContext</span> amContainer <span class="token operator">=</span> <span class="token function">setupContainerLaunchContextForAM</span><span class="token punctuation">(</span>
 jobConf<span class="token punctuation">,</span> localResources<span class="token punctuation">,</span> securityTokens<span class="token punctuation">,</span> vargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">return</span> appContext<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">setupAMCommand</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> jobConf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> vargs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Java 进程启动命令开始</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">crossPlatformifyMREnv</span><span class="token punctuation">(</span>jobConf<span class="token punctuation">,</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span>JAVA_HOME<span class="token punctuation">)</span>
 <span class="token operator">+</span> <span class="token string">&quot;/bin/java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">Path</span> amTmpDir <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">crossPlatformifyMREnv</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token class-name">Environment</span><span class="token punctuation">.</span>PWD<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">YarnConfiguration</span><span class="token punctuation">.</span>DEFAULT_CONTAINER_TEMP_DIR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-Djava.io.tmpdir=&quot;</span> <span class="token operator">+</span> amTmpDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">MRApps</span><span class="token punctuation">.</span><span class="token function">addLog4jSystemProperties</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vargs<span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Check for Java Lib Path usage in MAP and REDUCE configs</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAP_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_MAP_ADMIN_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_MAP_ADMIN_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_JAVA_OPTS<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;reduce&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>REDUCE_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_REDUCE_ADMIN_JAVA_OPTS<span class="token punctuation">,</span> 
<span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token string">&quot;reduce&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_REDUCE_ADMIN_JAVA_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MAPRED_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Add AM admin command opts before user command opts</span>
 <span class="token comment">// so that it can be overridden by user</span>
 <span class="token class-name">String</span> mrAppMasterAdminOptions <span class="token operator">=</span> 
conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>mrAppMasterAdminOptions<span class="token punctuation">,</span> <span class="token string">&quot;app master&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_COMMAND_OPTS<span class="token punctuation">,</span> 
<span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ADMIN_USER_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mrAppMasterAdminOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// Add AM user command opts 用户命令参数</span>
 <span class="token class-name">String</span> mrAppMasterUserOptions <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_COMMAND_OPTS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_COMMAND_OPTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">warnForJavaLibPath</span><span class="token punctuation">(</span>mrAppMasterUserOptions<span class="token punctuation">,</span> <span class="token string">&quot;app master&quot;</span><span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_COMMAND_OPTS<span class="token punctuation">,</span> <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_ENV<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mrAppMasterUserOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>jobConf<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_PROFILE<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_MR_AM_PROFILE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">final</span> <span class="token class-name">String</span> profileParams <span class="token operator">=</span> 
jobConf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>MR_AM_PROFILE_PARAMS<span class="token punctuation">,</span>
 <span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>DEFAULT_TASK_PROFILE_PARAMS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>profileParams <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>profileParams<span class="token punctuation">,</span>
 <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span> <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR
 <span class="token operator">+</span> <span class="token class-name">TaskLog<span class="token punctuation">.</span>LogName</span><span class="token punctuation">.</span>PROFILE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 封装了要启动的 mrappmaster 全类名</span>
 <span class="token comment">// org.apache.hadoop.mapreduce.v2.app.MRAppMaster</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MRJobConfig</span><span class="token punctuation">.</span>APPLICATION_MASTER_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;1&gt;&quot;</span> <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span>
 <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>STDOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 vargs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;2&gt;&quot;</span> <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>LOG_DIR_EXPANSION_VAR <span class="token operator">+</span>
 <span class="token class-name">Path</span><span class="token punctuation">.</span>SEPARATOR <span class="token operator">+</span> <span class="token class-name">ApplicationConstants</span><span class="token punctuation">.</span>STDERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">return</span> vargs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br></div></div><p><strong>向 Yarn 提交</strong></p> <p>点击 <code>submitJob</code> 方法中的 <code>submitApplication()</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//YARNRunner.java</span>
<span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> 
resMgrDelegate<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">ApplicationId</span>
 <span class="token function">submitApplication</span><span class="token punctuation">(</span><span class="token class-name">ApplicationSubmissionContext</span> appContext<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>ctrl + alt +B</code>查找 <code>submitApplication</code> 实现类，<code>YarnClientImpl.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ApplicationId</span>
 <span class="token function">submitApplication</span><span class="token punctuation">(</span><span class="token class-name">ApplicationSubmissionContext</span> appContext<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationIdNotProvidedException</span><span class="token punctuation">(</span>
 <span class="token string">&quot;ApplicationId is not provided in ApplicationSubmissionContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">// 创建一个提交请求</span>
<span class="token class-name">SubmitApplicationRequest</span> request <span class="token operator">=</span>
 <span class="token class-name">Records</span><span class="token punctuation">.</span><span class="token function">newRecord</span><span class="token punctuation">(</span><span class="token class-name">SubmitApplicationRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 request<span class="token punctuation">.</span><span class="token function">setApplicationSubmissionContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">//TODO: YARN-1763:Handle RM failovers during the submitApplication call.</span>
 <span class="token comment">// 继续提交，实现类是 ApplicationClientProtocolPBClientImpl</span>
 rmClient<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> pollCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">&gt;</span></span> waitingStates <span class="token operator">=</span> 
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>NEW<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>NEW_SAVING<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>SUBMITTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">EnumSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">&gt;</span></span> failToSubmitStates <span class="token operator">=</span> 
 <span class="token class-name">EnumSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>FAILED<span class="token punctuation">,</span>
<span class="token class-name">YarnApplicationState</span><span class="token punctuation">.</span>KILLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 获取提交给 Yarn 的反馈</span>
 <span class="token class-name">ApplicationReport</span> appReport <span class="token operator">=</span> <span class="token function">getApplicationReport</span><span class="token punctuation">(</span>applicationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">YarnApplicationState</span> state <span class="token operator">=</span> appReport<span class="token punctuation">.</span><span class="token function">getYarnApplicationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ApplicationNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// FailOver or RM restart happens before RMStateStore saves</span>
 <span class="token comment">// ApplicationState</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Re-submit application &quot;</span> <span class="token operator">+</span> applicationId <span class="token operator">+</span> <span class="token string">&quot;with the &quot;</span> <span class="token operator">+</span>
 <span class="token string">&quot;same ApplicationSubmissionContext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 如果提交失败，则再次提交</span>
 rmClient<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> applicationId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><code>ctrl + alt +B</code>查找 <code>submitApplication</code> 实现类，<code>ClientRMService.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SubmitApplicationResponse</span> <span class="token function">submitApplication</span><span class="token punctuation">(</span>
 <span class="token class-name">SubmitApplicationRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">YarnException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
 <span class="token class-name">ApplicationSubmissionContext</span> submissionContext <span class="token operator">=</span> request
 <span class="token punctuation">.</span><span class="token function">getApplicationSubmissionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ApplicationId</span> applicationId <span class="token operator">=</span> submissionContext<span class="token punctuation">.</span><span class="token function">getApplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">CallerContext</span> callerContext <span class="token operator">=</span> <span class="token class-name">CallerContext</span><span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// call RMAppManager to submit application directly</span>
 rmAppManager<span class="token punctuation">.</span><span class="token function">submitApplication</span><span class="token punctuation">(</span>submissionContext<span class="token punctuation">,</span>
 <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Application with id &quot;</span> <span class="token operator">+</span> applicationId<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
 <span class="token string">&quot; submitted by user &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">RMAuditLogger</span><span class="token punctuation">.</span><span class="token function">logSuccess</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">AuditConstants</span><span class="token punctuation">.</span>SUBMIT_APP_REQUEST<span class="token punctuation">,</span>
 <span class="token string">&quot;ClientRMService&quot;</span><span class="token punctuation">,</span> applicationId<span class="token punctuation">,</span> callerContext<span class="token punctuation">,</span>
 submissionContext<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">YarnException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Exception in submitting &quot;</span> <span class="token operator">+</span> applicationId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">RMAuditLogger</span><span class="token punctuation">.</span><span class="token function">logFailure</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token class-name">AuditConstants</span><span class="token punctuation">.</span>SUBMIT_APP_REQUEST<span class="token punctuation">,</span>
 e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;ClientRMService&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;Exception in submitting application&quot;</span><span class="token punctuation">,</span> applicationId<span class="token punctuation">,</span> callerContext<span class="token punctuation">,</span>
submissionContext<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> recordFactory
 <span class="token punctuation">.</span><span class="token function">newRecordInstance</span><span class="token punctuation">(</span><span class="token class-name">SubmitApplicationResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><strong>RM 启动 MRAppMaster</strong></p> <p>在 <code>pom.xml</code> 中增加如下依赖</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
 <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
 <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>hadoop<span class="token operator">-</span>mapreduce<span class="token operator">-</span>client<span class="token operator">-</span>app<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
 <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">3.1</span><span class="token number">.3</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>ctrl +n</code>查找 <code>MRAppMaster</code>，搜索 main 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 初始化一个 container</span>
 <span class="token class-name">ContainerId</span> containerId <span class="token operator">=</span> <span class="token class-name">ContainerId</span><span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>containerIdStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ApplicationAttemptId</span> applicationAttemptId <span class="token operator">=</span>
 containerId<span class="token punctuation">.</span><span class="token function">getApplicationAttemptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationAttemptId <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">CallerContext</span><span class="token punctuation">.</span><span class="token function">setCurrent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CallerContext<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>
 <span class="token string">&quot;mr_appmaster_&quot;</span> <span class="token operator">+</span> applicationAttemptId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">long</span> appSubmitTime <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>appSubmitTimeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 创建 appMaster 对象</span>
 <span class="token class-name">MRAppMaster</span> appMaster <span class="token operator">=</span>
 <span class="token keyword">new</span> <span class="token class-name">MRAppMaster</span><span class="token punctuation">(</span>applicationAttemptId<span class="token punctuation">,</span> containerId<span class="token punctuation">,</span> nodeHostString<span class="token punctuation">,</span>
 <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>nodePortString<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>nodeHttpPortString<span class="token punctuation">)</span><span class="token punctuation">,</span> appSubmitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">// 初始化并启动 AppMaster</span>
 <span class="token function">initAndStartAppMaster</span><span class="token punctuation">(</span>appMaster<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> jobUserName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error starting MRAppMaster&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ExitUtil</span><span class="token punctuation">.</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initAndStartAppMaster</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MRAppMaster</span> appMaster<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">JobConf</span> conf<span class="token punctuation">,</span> <span class="token class-name">String</span> jobUserName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
 <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 conf<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
 appMasterUgi<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token comment">// 初始化</span>
appMaster<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 启动</span>
 appMaster<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>appMaster<span class="token punctuation">.</span>errorHappenedShutDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Was asked to shut down.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateChangeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">enterState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span> <span class="token operator">!=</span> STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">setConfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 调用 MRAppMaster 中的 serviceInit()方法</span>
 <span class="token function">serviceInit</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>INITED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//if the service ended up here during init,</span>
 <span class="token comment">//notify the listeners</span>
 <span class="token comment">// 如果初始化完成，通知监听器</span>
 <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">noteFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ServiceOperations</span><span class="token punctuation">.</span><span class="token function">stopQuietly</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token class-name">ServiceStateException</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p><code>ctrl + alt +B</code> 查找 <code>serviceInit</code> 实现类，<code>MRAppMaster.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">serviceInit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Configuration</span> conf<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// 创建提交路径</span>
 clientService <span class="token operator">=</span> <span class="token function">createClientService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 创建调度器</span>
 clientService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment">// 创建 job 提交 RPC 客户端</span>
 containerAllocator <span class="token operator">=</span> <span class="token function">createContainerAllocator</span><span class="token punctuation">(</span>clientService<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>点击 <code>MRAppMaster.java</code> 中的 <code>initAndStartAppMaster</code>方法中的 <code>appMaster.start()</code>;</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token comment">//enter the started state</span>
 <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stateChangeLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>stateModel<span class="token punctuation">.</span><span class="token function">enterState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token operator">!=</span> STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
 startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用 MRAppMaster 中的 serviceStart()方法</span>
 <span class="token function">serviceStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInState</span><span class="token punctuation">(</span>STATE<span class="token punctuation">.</span>STARTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//if the service started (and isn't now in a later state), notify</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Service {} is started&quot;</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">notifyListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">noteFailure</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">ServiceOperations</span><span class="token punctuation">.</span><span class="token function">stopQuietly</span><span class="token punctuation">(</span>LOG<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">throw</span> <span class="token class-name">ServiceStateException</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">serviceStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>initFailed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token class-name">JobEvent</span> initFailedEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobEvent</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token class-name">JobEventType</span><span class="token punctuation">.</span>JOB_INIT_FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>
 jobEventDispatcher<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>initFailedEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// All components have started, start the job.</span>
<span class="token comment">// 初始化成功后，提交 Job 到队列中</span>
 <span class="token function">startJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">/** create a job-start event to get this ball rolling */</span>
 <span class="token class-name">JobEvent</span> startJobEvent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobStartEvent</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 recoveredJobStartTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">/** send the job-start event. this triggers the job execution. */</span>
 <span class="token comment">// 这里将 job 存放到 yarn 队列</span>
 <span class="token comment">// dispatcher = AsyncDispatcher</span>
 <span class="token comment">// getEventHandler()返回的是 GenericEventHandler</span>
 dispatcher<span class="token punctuation">.</span><span class="token function">getEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>startJobEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><code>ctrl + alt +B</code> 查找 handle 实现类，<code>GenericEventHandler.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">GenericEventHandler</span> <span class="token keyword">implements</span> <span class="token class-name">EventHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Event</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 将 job 存储到 yarn 队列中</span>
 eventQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>调度器任务执行（YarnChild）</strong></p> <p>启动 <code>MapTask</code></p> <p><code>ctrl +n 查找 YarnChild，</code>搜索 main 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
 <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">setDefaultUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">YarnUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Child starting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 task <span class="token operator">=</span> myTask<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">YarnChild</span><span class="token punctuation">.</span>taskid <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token comment">// Create a final reference to the task for the doAs block</span>
 <span class="token keyword">final</span> <span class="token class-name">Task</span> taskFinal <span class="token operator">=</span> task<span class="token punctuation">;</span>
 childUGI<span class="token punctuation">.</span><span class="token function">doAs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token comment">// use job-specified working directory</span>
 <span class="token function">setEncryptedSpillKeyIfRequired</span><span class="token punctuation">(</span>taskFinal<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setWorkingDirectory</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getWorkingDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 调用 task 执行（maptask 或者 reducetask）</span>
 taskFinal<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// run the task</span>
 <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> 
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>ctrl + alt +B 查找 run 实现类，maptask.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JobConf</span> job<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>umbilical <span class="token operator">=</span> umbilical<span class="token punctuation">;</span>
 <span class="token comment">// 判断是否是 MapTask</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMapTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are no reducers then there won't be any sort. Hence the map </span>
 <span class="token comment">// phase will govern the entire attempt's progress.</span>
<span class="token comment">// 如果 reducetask 个数为零，maptask 占用整个任务的 100%</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 mapPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token comment">// If there are reducers then the entire attempt's progress will be </span>
 <span class="token comment">// split between the map phase (67%) and the sort phase (33%).</span>
 <span class="token comment">// 如果 reduceTask 个数不为零，MapTask 占用整个任务的 66.7% sort 阶段占比</span>
 mapPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;map&quot;</span><span class="token punctuation">,</span> <span class="token number">0.667f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 sortPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">,</span> <span class="token number">0.333f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 调用新的 API 执行 maptask</span>
<span class="token function">runNewMapper</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> splitMetaInfo<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token function">runOldMapper</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> splitMetaInfo<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token function">done</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">runNewMapper</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskSplitIndex</span> splitIndex<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
 <span class="token class-name">TaskReporter</span> reporter
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span>
 <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 input<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>split<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 运行 maptask</span>
 mapper<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 mapPhase<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">setPhase</span><span class="token punctuation">(</span><span class="token class-name">TaskStatus<span class="token punctuation">.</span>Phase</span><span class="token punctuation">.</span>SORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">statusUpdate</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span>
 input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">closeQuietly</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">closeQuietly</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p><code>Mapper.java</code>（和 Map 联系在一起）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token function">setup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">map</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">cleanup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>启动 <code>ReduceTask</code></p> <p>在<code>YarnChild.java 类中的 main 方法中 ctrl + alt +B 查找 run 实现类，reducetask.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">)</span>
 <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>SKIP_RECORDS<span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 调用新 API 执行 reduce</span>
 <span class="token function">runNewReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span>
 keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
 <span class="token function">runOldReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span> 
 keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 shuffleConsumerPlugin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token function">done</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">runNewReducer</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
 <span class="token keyword">final</span> <span class="token class-name">TaskReporter</span> reporter<span class="token punctuation">,</span>
 <span class="token class-name">RawKeyValueIterator</span> rIter<span class="token punctuation">,</span>
 <span class="token class-name">RawComparator</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">,</span>
 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> keyClass<span class="token punctuation">,</span>
 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INVALUE<span class="token punctuation">&gt;</span></span> valueClass
 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
 <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token comment">// 调用 reducetask 的 run 方法</span>
 reducer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 trackedRW<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//Reduce.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
 <span class="token function">setup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">try</span> <span class="token punctuation">{</span>
 <span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">nextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token function">reduce</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// If a back up store is used, reset it</span>
 <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span>VALUEIN<span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>iter <span class="token keyword">instanceof</span> <span class="token class-name">ReduceContext<span class="token punctuation">.</span>ValueIterator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ReduceContext<span class="token punctuation">.</span>ValueIterator</span><span class="token generics"><span class="token punctuation">&lt;</span>VALUEIN<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>iter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resetBackupStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
 <span class="token function">cleanup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details> <h2 id="mapreduce-源码解析"><a href="#mapreduce-源码解析" class="header-anchor">#</a> MapReduce 源码解析</h2> <p><strong>maptask工作机制：</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904155306.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）Read 阶段：MapTask 通过 InputFormat 获得的 RecordReader，
从输入 InputSplit 中解析出一个个 key/value。

（2）Map 阶段：该节点主要是将解析出的 key/value 
交给用户编写 map()函数处理，并产生一系列新的 key/value。

（3）Collect 收集阶段：在用户编写 map()函数中，
当数据处理完成后，一般会调用OutputCollector.collect()输出结果。
在该函数内部，它会将生成的 key/value 分区（调用Partitioner），
并写入一个环形内存缓冲区中。

（4）Spill 阶段：即“溢写”，当环形缓冲区满后，MapReduce 会将数据
写到本地磁盘上，生成一个临时文件。需要注意的是，将数据写入本地磁盘之前，
先要对数据进行一次本地排序，并在必要时对数据进行合并、压缩等操作。
溢写阶段详情：
	步骤 1：利用快速排序算法对缓存区内的数据进行排序，排序方式是，
	先按照分区编号Partition 进行排序，然后按照 key 进行排序。
	这样，经过排序后，数据以分区为单位聚集在一起，且同一分区内所有数据按照 key 有序。
	
	步骤 2：按照分区编号由小到大依次将每个分区中的数据写入任务工作目录下的临时文件
	output/spillN.out（N 表示当前溢写次数中。如果用户设置了 Combiner，
	则写入文件之前，对每个分区中的数据进行一次聚集操作。
	
	步骤 3：将分区数据的元信息写到内存索引数据结构 SpillRecord 中，其中每个分区的元信息
	包括在临时文件中的偏移量、压缩前数据大小和压缩后数据大小。如果当前内存索引大小超过 1MB，
	则将内存索引写到文件 output/spillN.out.index 中。
		
（5）Merge 阶段：当所有数据处理完成后，MapTask 对所有临时文件进行一次合并，
以确保最终只会生成一个数据文件。当所有数据处理完后，MapTask 会将所有临时文件合
并成一个大文件，并保存到文件output/file.out 中，同时生成相应的索引文件 
output/file.out.index。在进行文件合并过程中，MapTask 以分区为单位进行合并。
对于某个分区，它将采用多轮递归合并的方式。每轮合并 mapreduce.task.io.sort.factor
（默认 10）个文件，并将产生的文件重新加入待合并列表中，对文件排序后，重复以上过程，
直到最终得到一个大文件。让每个 MapTask 最终只生成一个数据文件，可避免同时打开大量文件
和同时读取大量小文件产生的随机读取带来的开销。

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p><strong>reducetask工作机制：</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/image-20210904160240511.png" alt=""></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）Copy 阶段：ReduceTask 从各个 MapTask 上远程拷贝一片数据，
并针对某一片数据，如果其大小超过一定阈值，则写到磁盘上，否则直接放到内存中。

（2）Sort 阶段：在远程拷贝数据的同时，ReduceTask 启动了两个后台线程
对内存和磁盘上的文件进行合并，以防止内存使用过多或磁盘上文件过多。
按照 MapReduce 语义，用户编写 reduce()函数输入数据是按 key 进行聚集的一组数据。
为了将 key 相同的数据聚在一起，Hadoop 采用了基于排序的策略。
由于各个 MapTask 已经实现对自己的处理结果进行了局部排序，
因此，ReduceTask 只需对所有数据进行一次归并排序即可。

（3）Reduce 阶段：reduce()函数将计算结果写到 HDFS 上。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Job 提交流程源码和切片源码详解：</strong><img src="https://gitee.com/axcmsm/tmp/raw/master/bigdata/20210904153311.png" alt=""></p> <details class="custom-block details"><summary>🦓🦓🦓🦓🦓</summary> <p>Job 提交流程源码详解</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>waitForCompletion()
submit();
// 1 建立连接
connect();
// 1）创建提交 Job 的代理
new Cluster(getConfiguration());
// （1）判断是本地运行环境还是 yarn 集群运行环境
initialize(jobTrackAddr, conf); 
// 2 提交 job
submitter.submitJobInternal(Job.this, cluster)
// 1）创建给集群提交数据的 Stag 路径
Path jobStagingArea = JobSubmissionFiles.getStagingDir(cluster, conf);
// 2）获取 jobid ，并创建 Job 路径
JobID jobId = submitClient.getNewJobID();
// 3）拷贝 jar 包到集群
copyAndConfigureFiles(job, submitJobDir);
rUploader.uploadFiles(job, jobSubmitDir);
// 4）计算切片，生成切片规划文件
writeSplits(job, submitJobDir);
maps = writeNewSplits(job, jobSubmitDir);
input.getSplits(job);
// 5）向 Stag 路径写 XML 配置文件
writeConf(conf, submitJobFile);
conf.writeXml(out);
// 6）提交 Job,返回提交状态
status = submitClient.submitJob(jobId, submitJobDir.toString(), 
job.getCredentials());
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>FileInputFormat</code> 切片源码解析<code>（input.getSplits(job)）</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>（1）程序先找到你数据存储的目录。
（2）开始遍历处理（规划切片）目录下的每一个文件
（3）遍历第一个文件ss.txt
	a）获取文件大小fs.sizeOf(ss.txt)
	b）计算切片大小
	computeSplitSize(Math.max(minSize,Math.min(maxSize,blocksize)))=blocksize=128M
	c）默认情况下，切片大小=blocksize
	d）开始切，形成第1个切片：ss.txt—0:128M 第2个切片ss.txt—128:256M 第3个切片ss.txt—256M:300M
		（每次切片时，都要判断切完剩下的部分是否大于块的1.1倍，不大于1.1倍就划分一块切片）
	e）将切片信息写到一个切片规划文件中
	f）整个切片的核心过程在getSplit()方法中完成
	g）InputSplit只记录了切片的元数据信息，比如起始位置、长度以及所在的节点列表等。
（4）提交切片规划文件到YARN上，YARN上的MrAppMaster就可以根据切片规划文件计算开启MapTask个数。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></details> <p><strong>MapTask &amp; ReduceTask 源码解析</strong></p> <details class="custom-block details"><summary>🦓🦓🦓🦓🦓</summary> <p><strong>MapTask 源码解析流程</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>=================== MapTask ===================
context.write(k, NullWritable.get()); //自定义的 map 方法的写出，进入
output.write(key, value); 
//MapTask727 行，收集方法，进入两次
collector.collect(key, value,partitioner.getPartition(key, value, partitions));
HashPartitioner(); //默认分区器
collect() //MapTask1082 行 map 端所有的 kv 全部写出后会走下面的 close 方法
close() //MapTask732 行
collector.flush() // 溢出刷写方法，MapTask735 行，提前打个断点，进入
sortAndSpill() //溢写排序，MapTask1505 行，进入
sorter.sort() QuickSort //溢写排序方法，MapTask1625 行，进入
mergeParts(); //合并文件，MapTask1527 行，进入
collector.close(); //MapTask739 行,收集器关闭,即将进入 ReduceTask
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>ReduceTask 源码解析流程</strong>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>=================== ReduceTask ===================
if (isMapOrReduce()) //reduceTask324 行，提前打断点
initialize() // reduceTask333 行,进入
init(shuffleContext); // reduceTask375 行,走到这需要先给下面的打断点
 totalMaps = job.getNumMapTasks(); // ShuffleSchedulerImpl 第 120 行，提前打断点
 merger = createMergeManager(context); //合并方法，Shuffle 第 80 行
// MergeManagerImpl 第 232 235 行，提前打断点
this.inMemoryMerger = createInMemoryMerger(); //内存合并
this.onDiskMerger = new OnDiskMerger(this); //磁盘合并
rIter = shuffleConsumerPlugin.run();
eventFetcher.start(); //开始抓取数据，Shuffle 第 107 行，提前打断点
eventFetcher.shutDown(); //抓取结束，Shuffle 第 141 行，提前打断点
copyPhase.complete(); //copy 阶段完成，Shuffle 第 151 行
taskStatus.setPhase(TaskStatus.Phase.SORT); //开始排序阶段，Shuffle 第 152 行
sortPhase.complete(); //排序阶段完成，即将进入 reduce 阶段 reduceTask382 行
reduce(); //reduce 阶段调用的就是我们自定义的 reduce 方法，会被调用多次
cleanup(context); //reduce 完成之前，会最后调用一次 Reducer 里面的 cleanup 方法
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></details> <h2 id="hadoop-源码编译"><a href="#hadoop-源码编译" class="header-anchor">#</a> Hadoop 源码编译</h2> <p><strong>官网下载源码</strong>&lt;<a href="https://hadoop.apache.org/release/3.1.3.html" target="_blank" rel="noopener noreferrer">Apache Hadoop<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>&gt;</p> <ul><li><p>下载源码</p></li> <li><p>修改源码</p></li> <li><p>准备虚拟机</p> <ul><li>联网</li> <li>jar包准备（Hadoop 源码、JDK8、Maven、Ant 、Protobuf）</li> <li>全部解压到指定目录，配置环境变量（jdk、maven）</li></ul></li> <li><p>安装依赖（按照顺序，否则会出现依赖找不到问题)</p> <ul><li>安装 gcc make  <code>yum install -y gcc* make</code></li> <li>安装压缩工具 <code>yum -y install snappy* bzip2* lzo* zlib* lz4* gzip*</code></li> <li>安装一些基本工具 <code>yum -y install openssl* svn ncurses* autoconf automake libtool</code></li> <li>安装扩展源，才可安装 zstd <code>yum -y install epel-release</code></li> <li>安装 zstd <code>yum -y install *zstd*</code></li></ul></li> <li><p>安装 cmake （进入<code>.bootstrap</code>执行<code>make &amp;&amp; make install</code>)</p></li> <li><p>安装 protobuf</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/configure -- <span class="token assign-left variable">prefix</span><span class="token operator">=</span>/opt/module/hadoop_source/protobuf-2.5.0 
<span class="token comment">##  --prefix 指定安装到当前目录</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>编译源码 <code>mvn clean package -DskipTests - Pdist,native -Dta</code></p></li></ul></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/22, 21:16:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/ad2s1a123s2fa/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Hadoop生产调优</div></a> <a href="/pages/e7984e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">总结hadoop</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/ad2s1a123s2fa/" class="prev">Hadoop生产调优</a></span> <span class="next"><a href="/pages/e7984e/">总结hadoop</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f53939/"><div>Spring6</div></a> <span>06-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba69ad/"><div>若依二开</div></a> <span>06-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/998714/"><div>MongoDB</div></a> <span>06-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=2461475139&amp;site=qq&amp;menu=yes" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/axcmsm" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=6757658477" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>axcmsm | 转载注明出处 </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e7d9515b.js" defer></script><script src="/assets/js/2.125ae6e8.js" defer></script><script src="/assets/js/21.74a586bf.js" defer></script>
  </body>
</html>