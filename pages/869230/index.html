<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>商城项目_高级篇 | 🦏</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="个人技术博客,后端,大数据,技术文档,学习,js,vue,python,css3,java,javaEE,SpringBoot,Spring,Hadoop,html5,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.546f0649.css" as="style"><link rel="preload" href="/assets/js/app.e7d9515b.js" as="script"><link rel="preload" href="/assets/js/2.125ae6e8.js" as="script"><link rel="preload" href="/assets/js/105.e9f9588c.js" as="script"><link rel="prefetch" href="/assets/js/10.95c2d7b0.js"><link rel="prefetch" href="/assets/js/100.b4e10546.js"><link rel="prefetch" href="/assets/js/101.d6d23fe2.js"><link rel="prefetch" href="/assets/js/102.b368fb26.js"><link rel="prefetch" href="/assets/js/103.b87bfabc.js"><link rel="prefetch" href="/assets/js/104.3d0ae07d.js"><link rel="prefetch" href="/assets/js/106.76130cbc.js"><link rel="prefetch" href="/assets/js/107.11dd35ba.js"><link rel="prefetch" href="/assets/js/108.de8bb9b7.js"><link rel="prefetch" href="/assets/js/109.e26f138c.js"><link rel="prefetch" href="/assets/js/11.5682c637.js"><link rel="prefetch" href="/assets/js/110.2c9036b9.js"><link rel="prefetch" href="/assets/js/111.d91b7424.js"><link rel="prefetch" href="/assets/js/112.0edf9093.js"><link rel="prefetch" href="/assets/js/113.dbc0bf4d.js"><link rel="prefetch" href="/assets/js/114.439ad4ee.js"><link rel="prefetch" href="/assets/js/115.0cff9cd8.js"><link rel="prefetch" href="/assets/js/116.fd44dc61.js"><link rel="prefetch" href="/assets/js/117.e893d264.js"><link rel="prefetch" href="/assets/js/118.ec4b3d32.js"><link rel="prefetch" href="/assets/js/119.ea5c3eba.js"><link rel="prefetch" href="/assets/js/12.5a51d307.js"><link rel="prefetch" href="/assets/js/120.9aaee23f.js"><link rel="prefetch" href="/assets/js/121.4fc7842c.js"><link rel="prefetch" href="/assets/js/122.2b8f75d1.js"><link rel="prefetch" href="/assets/js/123.78dbfead.js"><link rel="prefetch" href="/assets/js/124.84b6382a.js"><link rel="prefetch" href="/assets/js/125.c2a2a818.js"><link rel="prefetch" href="/assets/js/126.83ea2963.js"><link rel="prefetch" href="/assets/js/127.dffd5eae.js"><link rel="prefetch" href="/assets/js/128.bb0a0738.js"><link rel="prefetch" href="/assets/js/129.45a56702.js"><link rel="prefetch" href="/assets/js/13.d1b5b29f.js"><link rel="prefetch" href="/assets/js/130.7fee331a.js"><link rel="prefetch" href="/assets/js/131.6aaa557b.js"><link rel="prefetch" href="/assets/js/132.9526e280.js"><link rel="prefetch" href="/assets/js/133.610c1c84.js"><link rel="prefetch" href="/assets/js/134.1dcf27f7.js"><link rel="prefetch" href="/assets/js/14.83de980a.js"><link rel="prefetch" href="/assets/js/15.0fa06ae1.js"><link rel="prefetch" href="/assets/js/16.d1d3c9c1.js"><link rel="prefetch" href="/assets/js/17.c9772d78.js"><link rel="prefetch" href="/assets/js/18.7cbf0ef4.js"><link rel="prefetch" href="/assets/js/19.66ee7cfc.js"><link rel="prefetch" href="/assets/js/20.8fbb5432.js"><link rel="prefetch" href="/assets/js/21.74a586bf.js"><link rel="prefetch" href="/assets/js/22.f85a2ced.js"><link rel="prefetch" href="/assets/js/23.a65163b5.js"><link rel="prefetch" href="/assets/js/24.5c2898c6.js"><link rel="prefetch" href="/assets/js/25.929f22ff.js"><link rel="prefetch" href="/assets/js/26.20d74c65.js"><link rel="prefetch" href="/assets/js/27.e790af79.js"><link rel="prefetch" href="/assets/js/28.6b84abe6.js"><link rel="prefetch" href="/assets/js/29.acc0fc34.js"><link rel="prefetch" href="/assets/js/3.dd3750e6.js"><link rel="prefetch" href="/assets/js/30.fadb6cbd.js"><link rel="prefetch" href="/assets/js/31.386f82c2.js"><link rel="prefetch" href="/assets/js/32.e934f71c.js"><link rel="prefetch" href="/assets/js/33.684ac64c.js"><link rel="prefetch" href="/assets/js/34.38f8fd76.js"><link rel="prefetch" href="/assets/js/35.3fe27233.js"><link rel="prefetch" href="/assets/js/36.993695b7.js"><link rel="prefetch" href="/assets/js/37.d735018c.js"><link rel="prefetch" href="/assets/js/38.0d23a384.js"><link rel="prefetch" href="/assets/js/39.808de65c.js"><link rel="prefetch" href="/assets/js/4.4a137b18.js"><link rel="prefetch" href="/assets/js/40.2fc7d5f7.js"><link rel="prefetch" href="/assets/js/41.6647cff7.js"><link rel="prefetch" href="/assets/js/42.f4d93aa6.js"><link rel="prefetch" href="/assets/js/43.a5d40107.js"><link rel="prefetch" href="/assets/js/44.3ae864d3.js"><link rel="prefetch" href="/assets/js/45.c66f1afe.js"><link rel="prefetch" href="/assets/js/46.750f2be2.js"><link rel="prefetch" href="/assets/js/47.1722c1b9.js"><link rel="prefetch" href="/assets/js/48.7c8df7cc.js"><link rel="prefetch" href="/assets/js/49.f9b58d70.js"><link rel="prefetch" href="/assets/js/5.51ca929a.js"><link rel="prefetch" href="/assets/js/50.fad73ad9.js"><link rel="prefetch" href="/assets/js/51.b88c6213.js"><link rel="prefetch" href="/assets/js/52.21244293.js"><link rel="prefetch" href="/assets/js/53.1c2189f3.js"><link rel="prefetch" href="/assets/js/54.95ba12bc.js"><link rel="prefetch" href="/assets/js/55.d8f79989.js"><link rel="prefetch" href="/assets/js/56.63c36b2d.js"><link rel="prefetch" href="/assets/js/57.270857ec.js"><link rel="prefetch" href="/assets/js/58.156073cc.js"><link rel="prefetch" href="/assets/js/59.5a300643.js"><link rel="prefetch" href="/assets/js/6.2dccf462.js"><link rel="prefetch" href="/assets/js/60.92f4ce87.js"><link rel="prefetch" href="/assets/js/61.0f312cea.js"><link rel="prefetch" href="/assets/js/62.0c55901b.js"><link rel="prefetch" href="/assets/js/63.613b1add.js"><link rel="prefetch" href="/assets/js/64.1e5070b6.js"><link rel="prefetch" href="/assets/js/65.dc215238.js"><link rel="prefetch" href="/assets/js/66.4a1319e4.js"><link rel="prefetch" href="/assets/js/67.841428fe.js"><link rel="prefetch" href="/assets/js/68.7380e054.js"><link rel="prefetch" href="/assets/js/69.0a503182.js"><link rel="prefetch" href="/assets/js/7.1096b6fa.js"><link rel="prefetch" href="/assets/js/70.09f4c416.js"><link rel="prefetch" href="/assets/js/71.a279d635.js"><link rel="prefetch" href="/assets/js/72.057aa49f.js"><link rel="prefetch" href="/assets/js/73.767f542c.js"><link rel="prefetch" href="/assets/js/74.3eb6f7e5.js"><link rel="prefetch" href="/assets/js/75.50ecd31e.js"><link rel="prefetch" href="/assets/js/76.602f67fb.js"><link rel="prefetch" href="/assets/js/77.3b5a8e7d.js"><link rel="prefetch" href="/assets/js/78.40c6990e.js"><link rel="prefetch" href="/assets/js/79.ecb155e0.js"><link rel="prefetch" href="/assets/js/8.4b82b135.js"><link rel="prefetch" href="/assets/js/80.d7279b34.js"><link rel="prefetch" href="/assets/js/81.f58f78af.js"><link rel="prefetch" href="/assets/js/82.8399bcab.js"><link rel="prefetch" href="/assets/js/83.67c3c861.js"><link rel="prefetch" href="/assets/js/84.5a8f7c4b.js"><link rel="prefetch" href="/assets/js/85.c6f0af81.js"><link rel="prefetch" href="/assets/js/86.f9f3d0b8.js"><link rel="prefetch" href="/assets/js/87.fec83ae4.js"><link rel="prefetch" href="/assets/js/88.ca11e236.js"><link rel="prefetch" href="/assets/js/89.ae243724.js"><link rel="prefetch" href="/assets/js/9.b8d3ed93.js"><link rel="prefetch" href="/assets/js/90.c242e238.js"><link rel="prefetch" href="/assets/js/91.ad0080a6.js"><link rel="prefetch" href="/assets/js/92.a435d70c.js"><link rel="prefetch" href="/assets/js/93.3232bfbf.js"><link rel="prefetch" href="/assets/js/94.6101d03c.js"><link rel="prefetch" href="/assets/js/95.8c95af7a.js"><link rel="prefetch" href="/assets/js/96.a582908e.js"><link rel="prefetch" href="/assets/js/97.1b560b4f.js"><link rel="prefetch" href="/assets/js/98.a686266f.js"><link rel="prefetch" href="/assets/js/99.e03a81a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.546f0649.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/favicon.ico" alt="🦏" class="logo"> <span class="site-name can-hide">🦏</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/zzx.jpg"> <div class="blogger-info"><h3>Axcmsm🐼</h3> <span>纵有疾风起，人生不言弃🐅</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Big数据" class="dropdown-title"><a href="/BigData/" class="link-title">Big数据</a> <span class="title" style="display:none;">Big数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>大数据路线</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/2asd1/" class="nav-link">开发路线</a></li><li class="dropdown-subitem"><a href="/pages/5cda13/" class="nav-link">linux导图</a></li></ul></li><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/l2sdd2ad123/" class="nav-link">《Linux》</a></li><li class="dropdown-subitem"><a href="/pages/hdf2shad2o4p3/" class="nav-link">《Hadoop》</a></li><li class="dropdown-subitem"><a href="/pages/f2l2im24e/" class="nav-link">《生态圈组件》</a></li><li class="dropdown-subitem"><a href="/pages/ka1f3k4a/" class="nav-link">《消息队列》</a></li><li class="dropdown-subitem"><a href="/pages/spa123ra12sd2/" class="nav-link">《spark》</a></li><li class="dropdown-subitem"><a href="/pages/f1l2i3n4k5/" class="nav-link">《flink》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/TechnologyStack/" class="nav-link">技术栈🎈</a></div><div class="nav-item"><a href="/python/" class="nav-link">python</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="⛳🖥" class="dropdown-title"><a href="/technology/" class="link-title">⛳🖥</a> <span class="title" style="display:none;">⛳🖥</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/b08e81/" class="nav-link">计算机必备</a></li><li class="dropdown-item"><!----> <a href="/pages/fba33e/" class="nav-link">数学基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="more" class="dropdown-title"><a href="/more/" class="link-title">more</a> <span class="title" style="display:none;">more</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/vscode123/" class="nav-link">技巧</a></li><li class="dropdown-item"><!----> <a href="/pages/4c76s2s6d8b3/" class="nav-link">技术文档</a></li><li class="dropdown-item"><!----> <a href="/pages/4c778760be26d8b3/" class="nav-link">GitHub技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">本站关联</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/axcmsm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JAVA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/338272/" class="sidebar-link">商城项目_基础篇</a></li><li><a href="/pages/869230/" aria-current="page" class="active sidebar-link">商城项目_高级篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/869230/#商城项目-高级篇" class="sidebar-link">商城项目_高级篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/869230/#环境安装" class="sidebar-link">环境安装</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#商品上架功能" class="sidebar-link">商品上架功能</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#性能压测" class="sidebar-link">性能压测</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#缓存与分布式锁" class="sidebar-link">缓存与分布式锁</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#检索服务开发" class="sidebar-link">检索服务开发</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#异步-线程池" class="sidebar-link">异步&amp;线程池</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#商品详情" class="sidebar-link">商品详情</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#认证服务" class="sidebar-link">认证服务</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#购物车" class="sidebar-link">购物车</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#消息队列" class="sidebar-link">消息队列</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#订单服务" class="sidebar-link">订单服务</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#秒杀服务" class="sidebar-link">秒杀服务</a></li><li class="sidebar-sub-header"><a href="/pages/869230/#自动化监控" class="sidebar-link">自动化监控</a></li></ul></li></ul></li><li><a href="/pages/994b31/" class="sidebar-link">商城项目_运维篇</a></li><li><a href="/pages/8df937/" class="sidebar-link">Docker入门🐑</a></li><li><a href="/pages/55c6c0/" class="sidebar-link">内网穿透</a></li><li><a href="/pages/ca8614/" class="sidebar-link">ElasticSearch使用</a></li><li><a href="/pages/a40f9d/" class="sidebar-link">spring Data基本操作</a></li><li><a href="/pages/3cdc51/" class="sidebar-link">JAVA工具类</a></li><li><a href="/pages/3534a6/" class="sidebar-link">MybatisPlus使用</a></li><li><a href="/pages/377cfd/" class="sidebar-link">Spring入门</a></li><li><a href="/pages/13efac/" class="sidebar-link">SpringBoot配置多数据源</a></li><li><a href="/pages/546e04/" class="sidebar-link">设计模式</a></li><li><a href="/pages/998714/" class="sidebar-link">MongoDB</a></li><li><a href="/pages/ba69ad/" class="sidebar-link">若依二开</a></li><li><a href="/pages/f53939/" class="sidebar-link">Spring6</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>MQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GO</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日常操作</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/TechnologyStack" title="技术栈-目录页" data-v-1cd794fe>技术栈</a></li> <li data-v-1cd794fe><a href="/TechnologyStack/#JAVA" title="技术栈#JAVA" data-v-1cd794fe>JAVA</a></li> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/axcmsm" target="_blank" title="作者" class="beLink" data-v-1cd794fe>axcmsm</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2022-06-30</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="/img/bj3.jpg">
          商城项目_高级篇
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h2 id="商城项目-高级篇"><a href="#商城项目-高级篇" class="header-anchor">#</a> 商城项目_高级篇</h2> <h3 id="环境安装"><a href="#环境安装" class="header-anchor">#</a> 环境安装</h3> <h4 id="全文检索es"><a href="#全文检索es" class="header-anchor">#</a> 全文检索Es</h4> <blockquote><p>全文检索、日志存储ELK</p></blockquote> <p><strong>安装es</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#1. 拉取镜像</span>
docker pull elasticsearch:7.4.2 <span class="token comment">#存储和检索数据</span>
docker pull kibana:7.17.2 <span class="token comment">#可视化检索数据</span>
<span class="token comment">#2. 准备工作</span>
<span class="token function">mkdir</span> -p /mydata/elasticsearch/config
<span class="token function">mkdir</span> -p /mydata/elasticsearch/data
<span class="token builtin class-name">echo</span> <span class="token string">&quot;http.host: 0.0.0.0&quot;</span> <span class="token operator">&gt;&gt;</span> /mydata/elasticsearch/config/elasticsearch.yml
<span class="token function">chmod</span> -R <span class="token number">777</span> /mydata/elasticsearch/
<span class="token comment">#3. 启动容器</span>
<span class="token comment">#es容器</span>
docker run --name elasticsearch7162 -p <span class="token number">9200</span>:9200 -p <span class="token number">9300</span>:9300  -e <span class="token string">&quot;discovery.type=single-node&quot;</span> -e <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">&quot;-Xms64m -Xmx512m&quot;</span> -v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v /mydata/elasticsearch/data:/usr/share/elasticsearch/data -v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins -d elasticsearch:7.16.2
<span class="token comment">#kibana容器</span>
docker run --name kibana -e <span class="token assign-left variable">ELASTICSEARCH_URL</span><span class="token operator">=</span>http://192.168.67.210:9200 -p <span class="token number">5601</span>:5601 -d kibana:7.17.2
<span class="token comment">#安装IK分词器</span>
docker <span class="token builtin class-name">exec</span> -it estest /bin/bash
./bin/elasticsearch-plugin <span class="token function">install</span> https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.16.2/elasticsearch-analysis-ik-7.16.2.zip
<span class="token comment">#重启</span>
docker restart es7162
<span class="token comment">#查看依赖</span>
./bin/elasticsearch-plugin list
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><blockquote><p>下载ik分词器：<a href="https://github.com/medcl/elasticsearch-analysis-ik/releases?page=1" target="_blank" rel="noopener noreferrer">github地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  选择对应的版本</p> <p>上传解压</p> <p>配置外部解耦分词器配合nginx</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>vim /mydata/elasticsearch/plugins/ik/config/IKAnalyzer.cfg.xml
#添加远程nginx挂载的配置文件
<span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>remote_ext_dict<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>http://192.168.67.210/es/fenci.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>重启es即可</p></blockquote> <h4 id="反向代理nginx"><a href="#反向代理nginx" class="header-anchor">#</a> <strong>反向代理Nginx</strong></h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#设置需要挂载的配置文件</span>
<span class="token function">mkdir</span> -p /mydata/nginx
docker run -p <span class="token number">80</span>:80 --name nginx -d nginx:1.10
docker container <span class="token function">cp</span> nginx:/etc/nginx /mydata/nginx
修改文件名 <span class="token function">mv</span> /mydata/nginx/nginx  /mydata/nginx/conf 
docker stop nginx
docker <span class="token function">rm</span> nginx
<span class="token comment">#启动挂载配置文件</span>
docker run -p <span class="token number">80</span>:80 --name nginx  -v /mydata/nginx/html:/usr/share/nginx/html -v /mydata/nginx/logs:/var/log/nginx -v /mydata/nginx/conf:/etc/nginx/ -d nginx:1.10
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>相关配置</strong>：</p> <ul><li><p>匹配规则</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token number">1</span>）最低级别匹配规则：
location / <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello Nginx！&quot;</span>
<span class="token punctuation">}</span>
<span class="token number">2</span>）最高级别匹配规则：
location /user <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello user.hmtl&quot;</span>
<span class="token punctuation">}</span>
<span class="token number">3</span>）其它级别匹配规则：
location ^~ /user <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello user.hmtl&quot;</span>
<span class="token punctuation">}</span>
location ~^ /user <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello user.hmtl&quot;</span>
<span class="token punctuation">}</span>
location ~ ^/<span class="token punctuation">[</span>a-z<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello user.hmtl&quot;</span>
<span class="token punctuation">}</span>
location ~ ^/<span class="token punctuation">\</span>a <span class="token punctuation">{</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;hello user.hmtl&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li> <li><p>反向代理</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>ocation /user <span class="token punctuation">{</span>
    proxy_pass http://ip<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
location /order/ <span class="token punctuation">{</span>
    proxy_pass http://ip/<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
访问结果：
http://ip/user/xx<span class="token punctuation">..</span>.
http://ip/xx<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>负载均衡</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>upstream order <span class="token punctuation">{</span>
    server <span class="token number">192.168</span>.5.18:8080 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    server <span class="token number">192.168</span>.5.18:8081 <span class="token assign-left variable">weight</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
server<span class="token punctuation">{</span>
    location /order/ <span class="token punctuation">{</span>
        proxy_pass http://order/<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
注：weight<span class="token operator">=</span><span class="token number">1</span>，配置的为权重，值越高权重越高
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>配置文件介绍 <code>nginx.conf</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>全局块： 配置营销nginx全局指令，如用户组、nginx进程、pid存放路径、日志、配置文件等
events块：配置影响nginx服务器或与用户网络连接
http块：嵌套多个server：配置代理、缓存、自定义等
	- http块 如upstream；错误页面、连接超时等
	- server块 配置虚拟主机的相关参数、一个http可以有个server.
	   -localtion
	   -localtion
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p><strong>include /etc/nginx/conf.d/*.conf;</strong>  将配置文件进拆分</p></blockquote></li></ul> <h3 id="商品上架功能"><a href="#商品上架功能" class="header-anchor">#</a> 商品上架功能</h3> <p><strong>封装查询数据保存到ES中、修改商品状态为上架</strong></p> <p><strong>动静分离</strong>：nginx-&gt;网关-&gt;微服务</p> <blockquote><p>每个微服务都可以独立部署、运行、升级、独立自治、技术、架构、业务</p> <p>使用 <a href="https://www.thymeleaf.org/documentation.html" target="_blank" rel="noopener noreferrer">thymeleaf<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 进行开发</p> <ol><li><p>关闭缓存、开发可看见实时效果</p></li> <li><p>静态资源放置在static文件下、可根据路径直接访问</p></li> <li><p>页面放在templates下、直接访问、springboot访问项目时默认会找index</p></li> <li><p>页面修改不重启服务器实时更新\如果是代码配置还是推荐重启服务器</p> <ol><li>导入dev-tools</li></ol></li></ol> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        热更新--&gt;</span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language- extra-class"><pre><code>  2. 当页面修改时按下Ctrl+F9 编译一下就可以了 或只对当前页面重新编译Ctrl+shift+f9
</code></pre></div><div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        thymeleaf--&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-thymeleaf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>导入语法&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
语法标签： ${取值}
th:text=&quot;${category.name}&quot; 文本取值
th:each=&quot;category : ${categorys}&quot;  循环遍历
th:attr=&quot;ctg-data=${category.catId}&quot; 设置自定义属性
th:text=${#numbers.formatDecimal(item.price,1,2)}//整数位最小为1位，保存俩位小数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></blockquote> <p><strong>es映射</strong></p> <div class="language-json line-numbers-mode"><pre class="language-json"><code>PUT gulimall_product
<span class="token punctuation">{</span>
    <span class="token property">&quot;mappings&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;nested&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token property">&quot;attrId&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;long&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;attrName&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">&quot;attrValue&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
              <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brandId&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brandImg&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;brandName&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;catalogId&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;catalogName&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;hasStock&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;hotScore&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;saleCount&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;skuId&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;skuImg&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;skuPrice&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;keyword&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;skuTitle&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
          <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span><span class="token string">&quot;ik_smart&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;spuId&quot;</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;type&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;long&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="性能压测"><a href="#性能压测" class="header-anchor">#</a> 性能压测</h3> <h4 id="压力测试"><a href="#压力测试" class="header-anchor">#</a> 压力测试</h4> <blockquote><p>问题：内存泄漏、并发与同步</p></blockquote> <p><strong>性能指标</strong>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>响应时间
HPS:每秒点击次数    表示对服务器单击请求
TPS:系统每秒处理交易数  衡量整个业务流程
OPS:系统每秒处理查询次数  衡量接口查询次数
	HPS、TPS、OPS是衡量系统处理能力重要指标、越大越好
	经验：
		金融：1000TPS~50000Tps 不包括互联网化的活动
		保险：100TPS~100000Tps 不包括互联网化的活动
		制造：10Tps~5000Tps
		互联网电子商务：10000Tps ~ 1000000Tps
		互联网中型网站：1000Tps ~ 50000Tps
		互联网小型网站：500Tps ~ 10000Tps
最大响应时间
最少响应时间
90%响应时间
从外部看，主要关注：吞吐量、响应时间、错误率
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="jmeter安装使用"><a href="#jmeter安装使用" class="header-anchor">#</a> JMeter安装使用</h4> <p>下载: <a href="https://jmeter.apache.org" target="_blank" rel="noopener noreferrer">https://jmeter.apache.org<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="性能监控"><a href="#性能监控" class="header-anchor">#</a> 性能监控</h4> <p><strong>jconsole\jvisualvm(升级版)</strong>:可用于监控本地和远程应用。</p> <blockquote><p>中间件越多、性能损失越大、大多都是损失在网络交互中</p></blockquote> <p><strong>调优</strong>：</p> <ul><li><strong>业务</strong>：调整性能参数
<ul><li>Db(Mysql调优：关闭日志、给字段添加索引等、一次查询多次处理</li> <li>模板渲染(开启缓存)</li> <li>静态资源(动静分离)：nginx判断是否是static路径跳转到静态路径中</li></ul></li></ul> <h3 id="缓存与分布式锁"><a href="#缓存与分布式锁" class="header-anchor">#</a> 缓存与分布式锁</h3> <blockquote><p>那些数据适合放入缓存：</p> <ul><li>及时性、数据一致性要求不高</li> <li>访问量大且更新频率不高的数据（读多、写少）</li></ul></blockquote> <p><strong>缓存</strong>：</p> <ul><li><p>本地缓存 Map =&gt; 单体应用 （数据一致性问题）</p></li> <li><p>缓存中间件：Redis</p> <ol><li><p>添加依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        redis--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>配置主机+端口号</p></li> <li><p>使用springboot自动配置的好的模板<strong>StringRedisTemplate</strong>来操作redis</p></li></ol></li></ul> <p><strong>注意事项</strong>：产生堆外内存溢出</p> <blockquote><p>springboot2.x 默认使用lettcuce作为操作Redis的客户端、使用netty进行网络通信</p> <p>lettcuce的bug导致netty出现堆外内存溢出、出现的原因是堆外内存没有被及时释放</p> <p>如果netty没有指定堆外内存默认使用-Xmx300m、可以通过-Dio.netty.maxDirectMemory进行设置</p> <p><strong>解决方案</strong>：TODO 待补充</p> <ol><li>升级lettuce客户端</li> <li>切换Jedis客户端  (版本比较老、吞吐量不高，稳定)</li></ol></blockquote> <p><strong>问题</strong>：高并发直接落库</p> <ul><li><p>缓存穿透：查询没有的值，高并发直接落库 =&gt; <strong>空结果进行缓存</strong>、加入短暂过期时间</p></li> <li><p>缓存雪崩：缓存值大面积同时失效，高并发直接落库 =&gt; <strong>失效时间</strong></p></li> <li><p>缓存击穿：高频访问的key数据失效，高并发直接落库 =&gt; <strong>加锁</strong>、大量并发让一个人去查、其他人等待。</p> <ul><li><p>本地锁：锁住当前进程、每个微服务都是一个单例</p></li> <li><p>分布式锁</p> <ul><li><div class="language- line-numbers-mode"><pre class="language-text"><code>加锁：SetEx设置过期时间
解锁：Lua脚本
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>其他分布式锁框架 <strong>Redisson</strong></p></li></ul></li></ul></li></ul> <h4 id="redisson"><a href="#redisson" class="header-anchor">#</a> Redisson</h4> <blockquote><p>操作redis的客户端、且提供<strong>分布式锁</strong>等、并且提供了其他更强大的特性</p></blockquote> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.12.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 所有对Redisson的使用都是经过RedissonClient对象
     * @return
     * @throws IOException
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">&quot;shutdown&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RedissonClient</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*config.useClusterServers()
                .addNodeAddress(&quot;&quot;);*/</span>
        <span class="token comment">//单节点模式</span>
        <span class="token comment">//redis://   rediss://</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis:// master:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>可重复锁</strong>：避免死锁问题</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
 		<span class="token comment">//底层实现JUC的lock 方便上手</span>
    <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token string">&quot;lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//名字相同就是同一把锁</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//堵塞式 加锁 //默认30秒</span>
            <span class="token comment">//1/3的internalLockLeaseTime 秒时间后：锁自动续期、无需担心锁自动过期被删掉</span>
            <span class="token comment">//业务处理完毕，及时不解锁，也会30秒后自动解锁、不会出现死锁</span>

    <span class="token comment">//1. 如果设置过期时间，就不会自动续期    </span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁</span>

最佳实战：
     手动设置过期时间 <span class="token operator">:</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
     手动解锁，省掉整个续期的操作
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>公平锁、读写锁、闭锁、信号量</p></blockquote> <p><strong>缓存数据一致性</strong>：</p> <ul><li>双写模式：修改数据库数据、同时修改缓存数据</li> <li>失效模式：修改数据库数据、删掉缓存数据</li></ul> <blockquote><p><strong>会产生脏数据的风险</strong>：但会保证最终一致性。</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>实时性、一致性要求高的：到数据库查
数据一致性：缓存数据+过期时间、或加读写锁保证数据一致性
或用中间件Canal同步数据库数据
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="spring-cache"><a href="#spring-cache" class="header-anchor">#</a> spring Cache</h4> <blockquote><p>接口<code>CacheManager</code>、<code>Cache</code>来统一不同的缓存技术</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Cacheable  将数据保存到缓存
@CacheEvict 将数据从缓存中删除
@CachePut   不影响方法执行更新缓存
@Caching    组合以上多操作
@CacheConfig 在类级别共享缓存的相同配置
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>整合</strong>：cache+redis作为缓存</p> <ol><li><p>导入依赖</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        整合 spring cache--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-cache<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--        redis 默认采用lettuce客户端--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>编写配置</p> <p>分析一波缓存的自动配置<code>CacheAutoConfiguration.class</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span> 导入不同类型的<span class="token class-name">CacheConfigurations</span><span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>的配置
<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfigurationImportSelector</span> <span class="token keyword">implements</span> <span class="token class-name">ImportSelector</span> <span class="token punctuation">{</span>
        <span class="token class-name">CacheConfigurationImportSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">CacheType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> imports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> types<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                imports<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">CacheConfigurations</span><span class="token punctuation">.</span><span class="token function">getConfigurationClass</span><span class="token punctuation">(</span>types<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> imports<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token number">2.</span> 具体类型 <span class="token operator">=</span><span class="token operator">&gt;</span>  <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CacheType</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> mappings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>GENERIC<span class="token punctuation">,</span> <span class="token class-name">GenericCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>EHCACHE<span class="token punctuation">,</span> <span class="token class-name">EhCacheCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>HAZELCAST<span class="token punctuation">,</span> <span class="token class-name">HazelcastCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>INFINISPAN<span class="token punctuation">,</span> <span class="token class-name">InfinispanCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>JCACHE<span class="token punctuation">,</span> <span class="token class-name">JCacheCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>COUCHBASE<span class="token punctuation">,</span> <span class="token class-name">CouchbaseCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>REDIS<span class="token punctuation">,</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>CAFFEINE<span class="token punctuation">,</span> <span class="token class-name">CaffeineCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>SIMPLE<span class="token punctuation">,</span> <span class="token class-name">SimpleCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mappings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">CacheType</span><span class="token punctuation">.</span>NONE<span class="token punctuation">,</span> <span class="token class-name">NoOpCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MAPPINGS <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>mappings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token number">3.</span> 查看 <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span>
    已自动配好了缓存管理器
     <span class="token annotation punctuation">@Bean</span>
       <span class="token class-name">RedisCacheManager</span> <span class="token function">cacheManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#在配置文件中配置Redis做为缓存</span>
<span class="token attr-name">spring.cache.type</span><span class="token punctuation">=</span><span class="token attr-value">redis</span>
<span class="token comment">#spring.cache.redis.time-to-live=360000 设置过期时间 毫秒为单位</span>
<span class="token comment">#缓存前缀 默认使用分区作为前缀</span>
<span class="token comment">#spring.cache.redis.key-prefix=CACHE_</span>
<span class="token comment">#开启前缀</span>
<span class="token comment">#spring.cache.redis.use-key-prefix=true</span>
<span class="token comment">#是否缓存空值 防止缓存穿透</span>
<span class="token attr-name">spring.cache.redis.cache-null-values</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>开启缓存功能 <code>@EnableCaching</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 配置缓存
 */</span>

<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCacheConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedisCacheConfiguration</span> <span class="token function">redisCacheConfiguration</span><span class="token punctuation">(</span><span class="token class-name">CacheProperties</span> properties<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RedisCacheConfiguration</span> config <span class="token operator">=</span> <span class="token class-name">RedisCacheConfiguration</span><span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//修改序列化规则 string\JSON</span>
        config<span class="token operator">=</span>config<span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token operator">=</span>config<span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializationContext<span class="token punctuation">.</span>SerializationPair</span><span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置默认配置</span>
        <span class="token class-name">CacheProperties<span class="token punctuation">.</span>Redis</span> redisProperties <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">prefixKeysWith</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isCacheNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>redisProperties<span class="token punctuation">.</span><span class="token function">isUseKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            config <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">disableKeyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div></li> <li><p><strong>不足</strong>：</p> <ul><li><p>读模式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- 缓存穿透：spring.cache.redis.cache-null-values=true
- 缓存击穿：加锁：默认不加锁、加上属性sync=&gt;true 加本地锁
- 缓存雪崩：指定过期时间就行 spring.cache.redis.time-to-live=360000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>写模式：数据一致性问题</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>读写加锁
引入canal、感知mysql更新缓存
读多写多，直接查询数据库
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <blockquote><p>常规数据（读多写少的，及时性要求不高的完整可以使用）</p></blockquote></li></ol> <h3 id="检索服务开发"><a href="#检索服务开发" class="header-anchor">#</a> 检索服务开发</h3> <blockquote><p><strong>es</strong></p></blockquote> <p>配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallElasticSearchConfig</span> <span class="token punctuation">{</span>


    <span class="token comment">//单例模式  配置es设置项</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">RequestOptions</span> COMMON_OPTIONS<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token class-name">RequestOptions<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">.</span><span class="token function">toBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        builder.addHeader(&quot;Authorization&quot;,&quot;Bearer&quot;,TOKEN);</span>
<span class="token comment">//        builder.setHttpAsyncResponseConsumerFactory(</span>
<span class="token comment">//                new HttpAsyncResponseConsumerFactory.HeapBufferedResponseConsumerFactory(30*1024*1024*1024)</span>
<span class="token comment">//        );</span>
        COMMON_OPTIONS<span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//配置高阶客户端</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestHighLevelClient</span> <span class="token function">esRestClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RestHighLevelClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestHighLevelClient</span><span class="token punctuation">(</span>
                <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
                        <span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">//es进行检查</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchResult</span> result<span class="token operator">=</span><span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//1. 设置检索条件</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token function">buildSearchRequest</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//2. 进行搜索</span>
            <span class="token class-name">SearchResponse</span> search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">GulimallElasticSearchConfig</span><span class="token punctuation">.</span>COMMON_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3. 封装响应数据</span>
            result<span class="token operator">=</span><span class="token function">buildSearchResult</span><span class="token punctuation">(</span>search<span class="token punctuation">,</span>searchParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 封装查询结果
     * @param search
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">SearchResult</span> <span class="token function">buildSearchResult</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> search<span class="token punctuation">,</span><span class="token class-name">SearchParam</span> searchParam<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//1.设置商品信息</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">&gt;</span></span> skuEsModels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//判断是否有高亮</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//设置高亮 标题</span>
                    <span class="token class-name">HighlightField</span> skuTitle <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> <span class="token class-name">HighlightTitle</span> <span class="token operator">=</span> skuTitle<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    esModel<span class="token punctuation">.</span><span class="token function">setSkuTitle</span><span class="token punctuation">(</span><span class="token class-name">HighlightTitle</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                skuEsModels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>esModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">setProducts</span><span class="token punctuation">(</span>skuEsModels<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.设置品牌信息</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">&gt;</span></span> brandVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParsedLongTerms</span> brand_agg <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> brand_agg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span> brandVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//1. 得到品牌的id</span>
            <span class="token keyword">long</span> brandId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3. 得到品牌图片</span>
            <span class="token class-name">String</span> brand_img <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Terms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_img_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2. 得到品牌的名字</span>
<span class="token comment">//            String brand_name = ((Terms) bucket.getAggregations().get(&quot;brand_name_agg&quot;)).getBuckets().get(0).getKeyAsString();</span>
            <span class="token class-name">String</span> brand_name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Terms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            brandVo<span class="token punctuation">.</span><span class="token function">setBrandId</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            brandVo<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brand_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            brandVo<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brand_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//添加到集合</span>
            brandVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brandVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        result<span class="token punctuation">.</span><span class="token function">setBrands</span><span class="token punctuation">(</span>brandVos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//3.设置分类信息</span>
        <span class="token class-name">ParsedLongTerms</span> catalog_agg <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span><span class="token punctuation">&gt;</span></span> buckets <span class="token operator">=</span> catalog_agg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">&gt;</span></span> catalogVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> buckets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span> catalogVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>keyAsString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//得到分类名的子聚合</span>
            <span class="token class-name">Terms</span> catalog_name_agg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> catalogName <span class="token operator">=</span> catalog_name_agg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>catalogName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            catalogVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>catalogVo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加到分类集合中</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">setCatalogs</span><span class="token punctuation">(</span>catalogVos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4. 设置属性信息</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">&gt;</span></span> attrVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParsedNested</span> attr_agg <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParsedLongTerms</span> attr_id_agg <span class="token operator">=</span> attr_agg<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_id_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> attr_id_agg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span> attrVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> attrId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> attr_name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Terms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attr_value <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Terms</span><span class="token punctuation">)</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;attr_value_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> keyAsString<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrVo<span class="token punctuation">.</span><span class="token function">setAttrId</span><span class="token punctuation">(</span>attrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrVo<span class="token punctuation">.</span><span class="token function">setAttrName</span><span class="token punctuation">(</span>attr_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrVo<span class="token punctuation">.</span><span class="token function">setAttrValue</span><span class="token punctuation">(</span>attr_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            attrVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>attrVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        result<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//5.设置分页信息-页码-总记录-页码</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">int</span> totalPages<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>total<span class="token operator">%</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token operator">==</span><span class="token number">0</span><span class="token operator">?</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>total<span class="token operator">/</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token operator">:</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>total<span class="token operator">/</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span>totalPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>searchParam<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> pageNavs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalPages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pageNavs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">setPageNavs</span><span class="token punctuation">(</span>pageNavs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 构建检索请求
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">SearchRequest</span> <span class="token function">buildSearchRequest</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> param<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchSourceBuilder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构建DSL语句</span>

        <span class="token comment">/**
         * 模糊匹配 过滤(属性、分类、品牌、价格区间、库存）
         */</span>

        <span class="token comment">//bool 组合多个query</span>
        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//1. 模糊品牌 must</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//模糊匹配match</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         <span class="token comment">// 过滤 filter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//过滤出三级分类Id</span>
                <span class="token comment">//精确匹配term</span>
                boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//过滤出品牌id</span>
                <span class="token comment">//精确匹配term 所有品牌id</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> aLong <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">,</span>aLong<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>


                <span class="token comment">//精确匹配term  //过滤出是否拥有库存</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;hasStock&quot;</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token comment">//按照价格区间进行查询</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//过滤出品牌id</span>
            <span class="token comment">//范围查询 range</span>
            <span class="token class-name">RangeQueryBuilder</span> rangeQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">&quot;skuPrice&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//约定 1_500/_500/500_</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                rangeQuery<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    rangeQuery<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    rangeQuery<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token keyword">null</span><span class="token operator">&amp;&amp;</span>param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//过滤出属性</span>
            <span class="token comment">//约定 attrs=1_5寸:8寸&amp;attrs=2_16G:8G</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> attr <span class="token operator">:</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BoolQueryBuilder</span> nestedboolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> attrId<span class="token operator">=</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrValues <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                nestedboolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">,</span>attrId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attrValues<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> attrValue <span class="token operator">:</span> attrValues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        nestedboolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">,</span>attrValue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//嵌入式查询 每一个必须都生成一个</span>
                <span class="token class-name">NestedQueryBuilder</span> nestedQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">nestedQuery</span><span class="token punctuation">(</span><span class="token string">&quot;attrs&quot;</span><span class="token punctuation">,</span> nestedboolQuery<span class="token punctuation">,</span> <span class="token class-name">ScoreMode<span class="token punctuation">.</span>None</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不参与评分</span>
                boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>nestedQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//封装查询条件</span>

        <span class="token comment">/**
         * 排序、分页、高亮、
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//排序</span>
            <span class="token class-name">String</span> sort <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//约定 sort=hosScore_asc/desc</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> sort<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SortOrder</span> sorder<span class="token operator">=</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">&quot;asc&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token operator">:</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sorder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//分页</span>
        builder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//高亮 模糊查询才显示高亮</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">HighlightBuilder</span> hbuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hbuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;skuTitle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hbuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;b style='color:red'&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hbuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/b&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>hbuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 聚合分析  品牌、分类、属性
         */</span>

        <span class="token comment">//品牌</span>
        <span class="token class-name">TermsAggregationBuilder</span> brand_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        brand_agg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//品牌聚合</span>
        brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//子聚合查出名称</span>
        brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;brand_img_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;brandImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//子聚合查出图片</span>
        builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>brand_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分类</span>
        <span class="token class-name">TermsAggregationBuilder</span> catalog_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        catalog_agg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;catalogId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        catalog_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;catalog_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;catalogName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>catalog_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//属性</span>
        <span class="token class-name">NestedAggregationBuilder</span> nested <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">nested</span><span class="token punctuation">(</span><span class="token string">&quot;attr_agg&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;attrs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TermsAggregationBuilder</span> attr_id_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_id_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_name_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">&quot;attr_value_agg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;attrs.attrValue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nested<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>attr_id_agg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>nested<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_INDEX<span class="token punctuation">}</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> request<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br></div></div><h3 id="异步-线程池"><a href="#异步-线程池" class="header-anchor">#</a> 异步&amp;线程池</h3> <h4 id="线程"><a href="#线程" class="header-anchor">#</a> <strong>线程</strong></h4> <p><strong>初始化线程</strong>：</p> <ol><li>继承Thred</li> <li>实现Runable接口</li> <li>实现Callable接口+FutureTask （可以拿到返回结果、可以处理异常）</li> <li><strong>线程池</strong></li></ol> <blockquote><p>12不能得到返回值，123都不能控制资源、4可控制资源、性能稳定。</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">/*
         * 七大参数：
         * corePoolSize:[5] 核心线程数[一直存在(除非设置了 allowCoreThreadTimeOut)]；线程池，创建好后回准备就绪的线程数量、等待接受异步任务去执行
         * maximumPoolSize:最大线程数量 （控制资源）
         * keepAliveTime ：存活时间
         * unit ：单位时间
         * workQueue ： 堵塞队列（存储任务）
         * threadFactory ：线程创建工厂
         * handler：如果队列满了，按照指定拒绝策略执行任务
         */</span>
        <span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
         * 工作流程：
         *  1. 线程池创建，准备好core数量的核心线程，准备接受任务
         *  2. 新的任务进来，用core准备好的空闲线程执行
         *  3. 堵塞队列满了、就直接开启新线程执行，最大只能开到max指定数量
         *  4. 如果线程开到max的数量、新任务进来，就会使用reject指定拒绝策略进行处理
         *  5. 所有的线程创造都有指定的factory创建。
         */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="异步编排completablefuture"><a href="#异步编排completablefuture" class="header-anchor">#</a> 异步编排CompletableFuture</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//异步编排</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">/*System.out.println(&quot;开始！&quot;);
            CompletableFuture.runAsync(()-&gt;{ //无返回值
            System.out.println(&quot;当前线程池:&quot;+Thread.currentThread().getId());
            int i=10/2;
            System.out.println(&quot;结果：&quot;+i);
            },executor);*/</span>

        <span class="token comment">/*CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; {//有返回值
            System.out.println(&quot;当前线程池:&quot; + Thread.currentThread().getId());
            int i = 10 / 2;
            System.out.println(&quot;结果：&quot; + i);
            return i;
        }, executor);
        Integer integer = future.get();
        System.out.println(integer);*/</span>

        <span class="token comment">//成功回调 感知 whenComplete+exceptionally</span>
        <span class="token comment">/*CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; {//有返回值
            System.out.println(&quot;当前线程池:&quot; + Thread.currentThread().getId());
            int i = 10 / 2;
            System.out.println(&quot;结果：&quot; + i);
            return i;
        }, executor).whenComplete((res,error)-&gt;{
            System.out.println(&quot;回调:&quot;+res);
        }).exceptionally(error-&gt;{
            return -1;//返回默认值
        });*/</span>

        <span class="token comment">//成功回调处理</span>
        <span class="token comment">/*CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; {//有返回值
            System.out.println(&quot;当前线程池:&quot; + Thread.currentThread().getId());
            int i = 10 / 2;
            System.out.println(&quot;结果：&quot; + i);
            return i;
        }, executor).handle((res,error)-&gt;{
            if (res!=null){
                return res;
            }
            return 0;//默认返回值
        });*/</span>

        <span class="token comment">//线程串行化 thenRunAsync、thenAcceptAsync、thenApplyAsync</span>
         <span class="token comment">/*CompletableFuture.supplyAsync(() -&gt; {//有返回值
            System.out.println(&quot;当前线程:&quot; + Thread.currentThread().getId());
            int i = 10 / 2;
            System.out.println(&quot;结果：&quot; + i);
            return i;
        }, executor).thenApplyAsync((res)-&gt;{
            return res;
         },executor);*/</span>

        <span class="token comment">//任务组合   俩个：完成一个、都要完成</span>
        <span class="token comment">// runAfterEitherAsync 不感知结果，自己没有返回值</span>
        <span class="token comment">// acceptEitherAsync:感知结果，自己没有返回值</span>
        <span class="token comment">// applyToEitherAsync：感知结果，没有返回值</span>

        <span class="token comment">//多任务组合</span>
        <span class="token comment">//allOf 都做完 ：get等待</span>
        <span class="token comment">//anyOf 只有一个成功：get获取成功那个的数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="商品详情"><a href="#商品详情" class="header-anchor">#</a> 商品详情</h3> <ul><li><p>控制层</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 展示当前的sku详情
     * @param skuId
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{skuId}.html&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">skuItem</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;skuId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">//查询sku详情</span>
        <span class="token class-name">SkuItemVo</span> result<span class="token operator">=</span>skuInfoService<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>业务层</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * CompletableFuture 异步编排
     * @param skuId
     * @return
     * @throws ExecutionException
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SkuItemVo</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SkuItemVo</span> skuItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//线程池异步编排</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">&gt;</span></span> infoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//1. sku基本信息 pms_sku_info</span>
            <span class="token class-name">SkuInfoEntity</span> info <span class="token operator">=</span> <span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> saleAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//3. 获取spu的销售属性组合</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuItemSaleAttrsVo</span><span class="token punctuation">&gt;</span></span> skuItemSaleAttrsVos <span class="token operator">=</span> skuSaleAttrValueService<span class="token punctuation">.</span><span class="token function">getSaleAttrsBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setSaleAttr</span><span class="token punctuation">(</span>skuItemSaleAttrsVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> descFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>res <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//4. 获取spu的介绍</span>
            <span class="token class-name">SpuInfoDescEntity</span> spuInfoDescEntity <span class="token operator">=</span> spuInfoDescService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//根据spuid查询详情</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setDesp</span><span class="token punctuation">(</span>spuInfoDescEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> baseAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span>res <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//5. 获取当前spu规格参数</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpuItemAttrGroupVo</span><span class="token punctuation">&gt;</span></span> attrGroupVos <span class="token operator">=</span> attrGroupService<span class="token punctuation">.</span><span class="token function">getAttrGroupWithAttrsBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setGroupAttrs</span><span class="token punctuation">(</span>attrGroupVos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token comment">//2. sku的图片信息 pms_sku_images 由于跟上面线程没有关系又开启一个线程 也没有返回结果</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> imageFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuImagesEntity</span><span class="token punctuation">&gt;</span></span> imagesEntities <span class="token operator">=</span> skuImagesService<span class="token punctuation">.</span><span class="token function">getImagesBySkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            skuItemVo<span class="token punctuation">.</span><span class="token function">setImages</span><span class="token punctuation">(</span>imagesEntities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//等待所有异步任务都完成后结束！</span>
        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>saleAttrFuture<span class="token punctuation">,</span>descFuture<span class="token punctuation">,</span>baseAttrFuture<span class="token punctuation">,</span>imageFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> skuItemVo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div></li> <li><p>线程池配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 配置文件
 */</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;gulimall.thread&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfigProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> coreSize<span class="token punctuation">;</span><span class="token comment">//核心线程大小</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> <span class="token class-name">MaxSize</span><span class="token punctuation">;</span><span class="token comment">//最大大小</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> keepAliveTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 业务线程池
 */</span>
<span class="token comment">//@EnableConfigurationProperties(ThreadPoolConfigProperties.class) //放入容器：Component 中就 就不需要添加 该注解</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">//配置线程池</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">threadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolConfigProperties</span> pool<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span>   <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getCoreSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              pool<span class="token punctuation">.</span><span class="token function">getMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pool<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div></li></ul> <h3 id="认证服务"><a href="#认证服务" class="header-anchor">#</a> 认证服务</h3> <p>社交登录、单点登录</p> <p><strong>整合阿里云短信服务</strong>：待整理...</p> <h4 id="注册服务"><a href="#注册服务" class="header-anchor">#</a> 注册服务</h4> <blockquote><ol><li>校验短信验证码消息成功后远程调用会员服务进行注册</li> <li>判断手机号、用户名是否唯一、抛出异常、捕获</li> <li>密码加密机制
<ol><li>md5盐加密（需要添加盐字段）</li> <li><code>new BCryptPasswordEncoder() 密码加密器</code> <strong>推荐</strong></li></ol></li></ol></blockquote> <h4 id="登录功能"><a href="#登录功能" class="header-anchor">#</a> 登录功能</h4> <ol><li><strong>普通登录</strong>：认证服务=&gt;调用用户服务：查询用户加密比对密码</li> <li><strong>社交登录</strong>:   QAuth2.0
<ol><li>像申请用户求证=&gt;用户授权（社交账号的以后密码）</li> <li>使用授权，进行认证=&gt;认证通过返回访问令牌</li> <li>使用访问令牌=&gt;获取开放的保护信息</li> <li>认证令牌，返回受保护信息。</li></ol></li> <li><strong>单点登录</strong>：<strong>解决多域名、多系统</strong>：一处登录、处处登录</li></ol> <p><strong>分布式Session</strong>：<strong>统一存储</strong>、<strong>单个域名</strong></p> <ul><li><p>SpringSession =&gt; redis</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        设置session--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.session<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-session-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--        redis配置--&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">spring.session.store-type</span><span class="token punctuation">=</span><span class="token attr-value">redis</span>
<span class="token attr-name">server.servlet.session.timeout</span><span class="token punctuation">=</span><span class="token attr-value">30m</span>

<span class="token comment">#reids 配置</span>
<span class="token attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token attr-value">master</span>
<span class="token attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token attr-value">6379</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@EnableRedisHttpSession</span><span class="token comment">//整合redis作为session管理</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>作用域+json存储</p></li></ul> <p><strong>springsession原理</strong>; 装饰者模式</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. @EnableRedisHttpSession导入了RedisHttpSessionConfiguration.class
	sessionRepository=&gt;RedisIndexedSessionRepository @Bean 标注了Redis操作session操作增删改查
	继承了SpringHttpSessionConfiguration 
	SessionRepositoryFilter @Bean 存储过滤器
	 1. 创建的时候、自动冲容器中获取sessionRepository
	 2. 原生的request、response都被包装了 wrappedRequest.getSession()=&gt;SessionRepository
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="单点登录"><a href="#单点登录" class="header-anchor">#</a> 单点登录</h4> <p><strong>待实现</strong></p> <p><strong>认证流程</strong>：</p> <ul><li>中央认证服务器：</li> <li>其他系统（cookie、token）</li></ul> <h3 id="购物车"><a href="#购物车" class="header-anchor">#</a> 购物车</h3> <p><strong>用户/在线购物车</strong></p> <ul><li>放入数据库、mongodb、<strong>reids</strong>（登录后。讲离线购物车数据合并过来，并清空离线购物车）</li></ul> <p><strong>游客/离线购物车</strong></p> <ul><li>放入localstorage、cookie、webSQL、<strong>redis</strong>（浏览器即使关闭、下次访问仍然显示）</li></ul> <p><strong>功能分析</strong>：存储hash类型 <strong>Map&lt;String 用户,Map&lt;String 商品id,cartinfo 商品详情&gt;&gt;</strong></p> <ol><li>结算下单</li> <li>查询自己购物车</li> <li>在购物车中修改购买商品数量</li> <li>删除购物车商品</li> <li>展示商品优惠信息</li> <li>提示商品价格变化</li></ol> <p><strong>具体实现</strong>：</p> <ol><li><p>拦截器判断用户身是否登录</p></li> <li><p>Threadlocal-同一个线程共享数据：Map&lt;String,Object&gt; threadLocal</p> <blockquote><p>例：拦截器=&gt;controller=&gt;service=&gt;dao</p></blockquote></li></ol> <h3 id="消息队列"><a href="#消息队列" class="header-anchor">#</a> 消息队列</h3> <p>异步处理、应用解耦、流量控制。</p> <p>**RabbitMQ **:是AMQP的开源实现</p> <ul><li>消息代理</li> <li>目的地
<ul><li>队列：点对点消息通信 (可多有多个接收者，最终消息只能由一个人收到)</li> <li>主题：发布/订阅  消息通信 （广播）</li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>spring支持  JMS(JAVA API) AMQP(规范协议、兼容jms)
	@EnableJms\@EnableRabbit开启支持
	@JmsListener(jms)\@RabbitListener(AMQP) 注解在方法上监听消息代理发布的消息
springboot自动配置： jmsAutoConfiguration、RabbitAutoConfiguration
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>RQ概念</strong>：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>publisher生产者发消息message到Broker消息代理里面的exchange交换机，交换机跟每一个队列进行绑定，交换机根据消息的路由键把消息发送到不同的队列当中。
一个客户端跟Broker建立一条连接，在连接里面有很多信道Channel,消息的内容通过信道传输。
message包含头和体（体是消息、头是携带的交互信息，例：route-key：路由键
exchange交换机类型：
  1. direct 点对点（完全匹配路由键）
  2. tanout 广播模式，绑定的队列都收到(不区分路由键)
  3. topic  发布订阅模式（可模糊匹配路由键）
  4. headers 点对点 性能低下 基本不用

虚拟主机Vhost
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="docker安装rq"><a href="#docker安装rq" class="header-anchor">#</a> <strong>docker安装RQ</strong></h4> <div class="language-xshell line-numbers-mode"><pre class="language-text"><code>docker run -d --name rabbitmq -p 5671:5671 -p 5672:5672 -p 4369:4369 -p 25672:25672 -p 15671:15671 -p 15672:15672 rabbitmq:3-management
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>解释：
4369,25672 Erlang发现&amp;集群端口
5672，5671 AMQP端口
15672 web管理后台端口 默认：账号密码：guest
61613，61614 STOMP协议端口
1883，8883 MQTT协议端口
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>可添加自启命令：<code>docker update rabbitmq --restart=always</code></p></blockquote> <h4 id="springboot整合rabbitmq"><a href="#springboot整合rabbitmq" class="header-anchor">#</a> Springboot整合RabbitMQ</h4> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--        RMQ--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">master</span>
<span class="token attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/</span>
<span class="token comment">#用户密码 使用默认即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>使用 RabbitMQ
1. 导入amqp场景，RabbitAutoConfiguration就会自动生效
2. 给容器中自动配置了
	RabbitTemplate、AmapAdmin、CachingConnectionFactory、RabbitMessagingTemplate
3. 开启了 @EnableRabbit
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">AmqpAdmin</span> amqpAdmin<span class="token punctuation">;</span> 
	<span class="token comment">/**
     * 创建Exchange、Queue、 绑定关系
     *  使用 AmqpAdmin测试使用
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token class-name">AmqpAdminTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DirectExchange</span> directExchange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//名称,是否持久化，是否自动删除：还可以传入参数等</span>
        amqpAdmin<span class="token punctuation">.</span><span class="token function">declareExchange</span><span class="token punctuation">(</span>directExchange<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建交换机</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;交换机【{}】创建完成！&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//名称，是否持久化，是否排他，自动删除，参数</span>
        amqpAdmin<span class="token punctuation">.</span><span class="token function">declareQueue</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建队列</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;queue【{}】创建完成！&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//目的地（队列）,目的地类型,交换机,路由建，参数</span>
        <span class="token class-name">Binding</span> binding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">,</span>
                <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        amqpAdmin<span class="token punctuation">.</span><span class="token function">declareBinding</span><span class="token punctuation">(</span>binding<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建队列</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;binding【{}】创建完成！&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello-java-binding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>#可配置转化消息策略 json
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 配置转化消息策略   对象转成json
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 发送消息
     *  使用 rabbitTemplate
     */</span>
      <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">sendTestMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> msg<span class="token operator">=</span><span class="token string">&quot;啊实打实打算&quot;</span><span class="token punctuation">;</span><span class="token comment">//任意类型 如果是对象要实现序列化、也可以转成json进行发送</span>
        <span class="token comment">//第四个参数： new CorrelationData(UUID.randomUUID().toString())</span>
        <span class="token comment">//可设置ID 确认回调会收到这个id.</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;hello-java-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello.java&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送完成！【{}】&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//监听消息 </span>
	<span class="token comment">// 使用@RabbitListener 可标注在类和方法上 （监听那些队列即可）</span>
    <span class="token comment">// 使用@RabbitHadndler 标注方法上 根据接收参数的类型接收不同的数据 （重载区分不同的消息）</span>
 
   <span class="token comment">/**
     * 参数类型
     *   参数1，Message原生消息体  消息头+消息体
     *   参数2：T（Object) 发送时使用什么类型发送，接收也可以使用该类型接收
     *   参数3：channel channel 当天传输数据通道
     *
     * @param message
     */</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;hello-java-queue&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">//@RabbitHandler 根据参数类型自动判断接收方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">revieveMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//内容</span>
        <span class="token class-name">MessageProperties</span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//属性 消息头</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;接收到消息&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;==》内容：&quot;</span><span class="token operator">+</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="消息确认机制"><a href="#消息确认机制" class="header-anchor">#</a> <strong>消息确认机制</strong></h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>RabbitMq消息确认机制-可靠抵达
	保证消息不丢失、可使用事务消息、性能会下降到250倍，一般不使用
可使用消息确认机制：
    生产者：publisher 
    	confirmCallback 确认模式
    	returnCallback 未投递到queue 退回模式
    消费者：consumer
    	ack 机制
    
    流程：
		 p =&gt;（Broker:exchange -&gt; queue) =&gt; c
  	p-&gt;b:confirmCallback  e-&gt;q:returnCallback    q-&gt;c:ack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 开启 发送端到broker的确认</span>
<span class="token attr-name">spring.rabbitmq.publisher-confirm-type</span><span class="token punctuation">=</span><span class="token attr-value">correlated</span>
<span class="token comment">#spring.rabbitmq.publisher-confirms=true</span>
<span class="token comment"># 开启 交换机到队列的确认</span>
<span class="token attr-name">spring.rabbitmq.publisher-returns</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token comment"># 只要抵达队列就异步触发回调returnconfirms</span>
<span class="token attr-name">spring.rabbitmq.template.mandatory</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token comment"># 手动ack确认机制</span>
<span class="token attr-name">spring.rabbitmq.listener.simple.acknowledge-mode</span><span class="token punctuation">=</span><span class="token attr-value">manual</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span><span class="token comment">//注入进行定制化操作</span>

    <span class="token comment">/**
     * 使用Json序列化机制,进行消息转换
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 定制化RabbitTemplate
     *  1. Broker 服务收到回调
     *  2. 交换机消息抵达队列 失败回调
     *  3. 服务端确认回调
     *      默认：自动确认，消费自动移除消息   问题：会发送消息丢失
     *     手动确认：
     *           在监听消息时，处理完消息后
     *           channel.basicAck(deliveryTag,false);签收
     *           channel.basicNack(deliveryTag,false,true);拒签；业务失败，拒签
     *
     *
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>  <span class="token comment">//该注解标注MyRabbitConfig对象创建完后执行该方法</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initRabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//设置消息抵达Broker确认回调</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 只要消息抵达服务器 就会显示true 生产者确认回调
             * @param correlationData  当前消息的唯一关联数据
             * @param ack  消息是否成功被收到
             * @param error 失败的原因
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token keyword">boolean</span> ack<span class="token punctuation">,</span> <span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//correlationData 消息唯一Id</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;确认回调：【&quot;</span><span class="token operator">+</span>correlationData<span class="token operator">+</span><span class="token string">&quot;】===&gt;ack【&quot;</span><span class="token operator">+</span>ack<span class="token operator">+</span><span class="token string">&quot;】 ==》 error=》【&quot;</span><span class="token operator">+</span>error<span class="token operator">+</span><span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置交换机抵达队列 =&gt; 投递成功不会触发</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RabbitTemplate<span class="token punctuation">.</span>ReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             * 只要消息没有投递给指定队列，就触发这个失败的回调
             * @param message  投递失败消息
             * @param replyCode 回复状态码
             * @param replyText 回复文本内容
             * @param exchange 交换机
             * @param rk  路由键
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">returnedMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token keyword">int</span> replyCode<span class="token punctuation">,</span> <span class="token class-name">String</span> replyText<span class="token punctuation">,</span> <span class="token class-name">String</span> exchange<span class="token punctuation">,</span> <span class="token class-name">String</span> rk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Fail message【&quot;</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">&quot;】==&gt;replyCode=&gt;【&quot;</span><span class="token operator">+</span>replyCode<span class="token operator">+</span><span class="token string">&quot;】==&gt;exchange==&gt;【&quot;</span><span class="token operator">+</span>exchange<span class="token operator">+</span><span class="token string">&quot;】=rk=》【&quot;</span><span class="token operator">+</span>rk<span class="token operator">+</span><span class="token string">&quot;】&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recieveMessage1</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Cart</span> cart<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息处理完成&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//非批量签收模式</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//手动确认回复</span>
            <span class="token comment">//不签收模式 //id、是否批量、 是否重新放回队列中：否则被丢弃</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//网络中断</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="延迟队列-定时任务"><a href="#延迟队列-定时任务" class="header-anchor">#</a> 延迟队列（定时任务）</h4> <p><strong>场景</strong>： 为付款订单，超过一定时间后、系统回自动取消订单并且释放占有的物品</p> <ul><li>spring 的schedule定时任务轮询数据库（消耗系统内存、增加数据库压力、存在较大时间差）</li> <li><strong>消息TTL(存活时间</strong>):只要在指定的时间没有被消费的数据</li> <li><strong>死信Exchange</strong>:死信路由
<ol><li>拒收、丢弃</li> <li>TTL的存活时间到了、消息过期了</li> <li>队列的长度满了、排在前面的消息会被丢弃或者扔到死信路由上</li></ol></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * MQ自动创建配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyMQConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;收到过期的订单消息,关闭订单&quot;</span><span class="token operator">+</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//@Bean 如果RabbitMq中没有会自动创建</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.release.order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//一分钟</span>
        <span class="token comment">//持久、不排他、不自动删除</span>
        <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;order.delay.queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderReleaseOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//持久、不排他、不自动删除</span>
        <span class="token class-name">Queue</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> queue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">orderEventExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//持久主题交换机</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchangs&quot;</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderCreateOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;order.delay.queue&quot;</span><span class="token punctuation">,</span><span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span>
                <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderReleaseOrderBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;order.release.order.queue&quot;</span><span class="token punctuation">,</span><span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span>
                <span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.release.order&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//测试创建订单   </span>
<span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test/createOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createOrderTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//发送消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;order-event-exchange&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;order.create.order&quot;</span><span class="token punctuation">,</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="订单服务"><a href="#订单服务" class="header-anchor">#</a> 订单服务</h3> <p><strong>订单构成</strong>：订单生成=&gt;订单支付=&gt;卖家发货=&gt;确认收货=&gt;交易成功。（实际略有不同）</p> <blockquote><p>三流：信息流、资金流、物流：订单系统作为中枢将三者有机的集合起来。</p> <p>故会查询很多消息：用户信息、订单信息、商品信息、促销信息、支付信息、物流流量</p></blockquote> <p><strong>订单状态</strong>：</p> <blockquote><p>待付款（锁定库存）、已付款/待发货（仓库）、待收货/已收货（物流状态）</p> <p>已完成（售后状态）、已取消、售后中</p></blockquote> <p><strong>Feign远程调用丢失请求头问题</strong>：构建feign拦截器添加上请求头信息</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token comment">//请求方法需要加上 HttpServletRequest request 该参数</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFeignConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;requestInterceptor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//使用 上下文环境保持器 获取请求属性 RequestContextHolder拿到刚进来的请求数据</span>
                <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//老请求，新请求</span>
                    <span class="token comment">//同步请求头中的数据，Cookie</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;Cookie&quot;</span><span class="token punctuation">,</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>Feign异步丢失上下文问题</strong>： 拷贝一份主线程的上下文环境</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>例：

        <span class="token comment">//使用了异步编排，给每个线程先设置一下上下文的环境信息</span>
        <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主线程</span>

        <span class="token comment">//使用异步编排</span>
        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> addressTask <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//共享主线程的上下文环境</span>
            <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">&gt;</span></span> getaddr <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getaddr</span><span class="token punctuation">(</span>memberResVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderConfirmVo<span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>getaddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//地址</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><strong>幂等性处理</strong>：防重令牌</p> <blockquote><p>防止多次点击、页面退回再次提交、 feign重试机制、其他业务</p></blockquote> <ul><li>token机制：获取、对比、删除令牌（原子性）redis lua脚本</li> <li>各种锁机制：（悲观锁、乐观锁|数据库）\（分布式锁|业务层）</li> <li>各种唯一机制</li> <li>防止重表</li> <li>全局请求唯一Id</li></ul> <p><strong>库存解锁</strong>:</p> <ul><li>下单成功,订单过期没有支付被系统自动取消,被用户手动取消,都需解锁库存</li> <li>下单订单成功,库存锁定成功,接下来的业务调用失败,导致订单回滚,解锁库存</li></ul> <h3 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h3> <h4 id="本地事务"><a href="#本地事务" class="header-anchor">#</a> <strong>本地事务</strong></h4> <p><strong>性质</strong>：ACID（原子性、一致性、隔离性、持久性）</p> <p><strong>使用</strong>：<code>@Transactional</code>（isolation隔离级别、propagation传播行为）</p> <p><strong>本地事务失效问题</strong>：同一个对象内事务方法互调默认失效，原因绕过了代理对象。（事务使用代理对象来控制的）</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>解决方案：使用代理对象来调用事务方法 （默认是使用JDK按照接口动态代理）
1. 引入aop-starter模块:spring-boot-starter-aop;引入了aspectj
2. 开启动态代理功能@EnableAspectJAutoProxy（exposeProxy=true)（好处：不需要接口也能创建动态代理）
	（exposeProxy=true)：对外暴露代理对象
3. 本类互调用代理对象调即可
	AopContext.currentProxy() //调用即可
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h4> <p><strong>CAP定理</strong>：一致性、可用性、分区容错性（这三个原生最多只能同时实现俩个，不可三者兼顾）CP\AP</p> <p><strong>BASE理论</strong>：基本可用、软状态、最终一致性（强、弱、最终）</p> <p><strong>方案：</strong></p> <ul><li>2PC模式：强一致性（AT 自动）不适合高并发(<strong>后台</strong>)</li> <li>柔性事务-TCC事务补偿型方案（最终一致性）手动</li> <li>柔性事务-最大努力通知型方案（最终一致性）消息队列  （高并发）</li> <li>柔性事务-可靠消息+最终一致性方案（异步确保型）消息队列   (<strong>高并发</strong>)</li></ul> <p><strong><a href="https://seata.io/zh-cn/" target="_blank" rel="noopener noreferrer">Seata<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>：开源的分布式事务解决方案</p> <ul><li><p>TC-事务协调者</p></li> <li><p>TM-事务管理者</p></li> <li><p>RM-资源管理者</p></li> <li><p>使用：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1. 给每个微服务创建回滚日志表
2. 安装事务协调的服务器seata-server 解压并启动 注意对应版本
	 registry.conf 可配置注册中心：方式和地址
	 flie.conf 是配置seata的配置：也可以搬家到nacos
3. 导入依赖
	spring-cloud-starter-alibaba-seata :=&gt;seata-all-0.7.1
4. 将俩个配置文件放置在resources中
	file.conf 中 需要配置service
		vgroup_mapping.服务名-fescar-service-group=&quot;defalut&quot;
5. 整合分布式事务的服务 都需要配置，使用seata作为代理数据源
6、给分布式大事务的入口添加全局事务 @GlobalTransactional
7. 给远程调用的小事务用本地事务 @Transactional
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//配置代理数据源</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySeataConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">DataSourceProperties</span> dataSourceProperties<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> properties<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">HikariDataSource</span> build <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            build<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>build<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li></ul> <h3 id="秒杀服务"><a href="#秒杀服务" class="header-anchor">#</a> 秒杀服务</h3> <h3 id="自动化监控"><a href="#自动化监控" class="header-anchor">#</a> 自动化监控</h3> <p><strong>Sentinel</strong>:限流\熔断\降级</p> <ul><li>自定义受保护资源</li> <li>网关流控</li> <li>自定义网络流控返回</li></ul> <p><strong>Sleuth</strong>:链路追踪  (zipkin)可视化观察</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/03/22, 21:16:55</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/338272/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">商城项目_基础篇</div></a> <a href="/pages/994b31/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">商城项目_运维篇</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/338272/" class="prev">商城项目_基础篇</a></span> <span class="next"><a href="/pages/994b31/">商城项目_运维篇</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f53939/"><div>Spring6</div></a> <span>06-18</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba69ad/"><div>若依二开</div></a> <span>06-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/998714/"><div>MongoDB</div></a> <span>06-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=2461475139&amp;site=qq&amp;menu=yes" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/axcmsm" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=6757658477" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2023
    <span>axcmsm | 转载注明出处 </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e7d9515b.js" defer></script><script src="/assets/js/2.125ae6e8.js" defer></script><script src="/assets/js/105.e9f9588c.js" defer></script>
  </body>
</html>